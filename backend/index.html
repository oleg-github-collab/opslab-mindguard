<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpsLab Mindguard ¬∑ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ú–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –ó–¥–æ—Ä–æ–≤'—è —Ç–∞ –§—ñ–¥–±–µ–∫—É</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ===== NEOBRUTAL DESIGN SYSTEM ===== */
    :root {
      --primary: #FF6B35;
      --secondary: #FFB347;
      --accent: #00D9FF;
      --success: #00F5A0;
      --warning: #FFB800;
      --danger: #FF4B4B;
      --dark: #1a1a1a;
      --white: #ffffff;
      --gray-light: #f5f5f5;
      --gray: #666666;
      --border: 4px;
      --shadow: 8px 8px 0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--gray-light);
      color: var(--dark);
      line-height: 1.6;
      overflow-x: hidden;
      padding-top: 90px;
    }

    .mono { font-family: 'Space Mono', monospace; }

    /* ===== ACCESS CONTROL ===== */
    .admin-only {
      display: block !important;
    }

    .employee-only {
      display: none !important;
    }

    body.employee-view .admin-only {
      display: none !important;
    }

    body.employee-view .employee-only {
      display: block !important;
    }

    /* ===== NAVIGATION ===== */
    .nav {
      background: linear-gradient(135deg, #fff4ea 0%, #ffffff 55%, #eefbff 100%);
      border-bottom: var(--border) solid var(--dark);
      padding: 1rem 2rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 6px 0 var(--dark);
      overflow: hidden;
      transition: transform 0.3s ease-out;
    }

    .nav.hidden {
      transform: translateY(-100%);
    }

    /* Don't hide header on mobile - keep hamburger accessible */
    @media (max-width: 980px) {
      .nav.hidden {
        transform: none;
      }
    }

    .nav::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(255, 107, 53, 0.15), transparent 55%);
      pointer-events: none;
    }

    .nav::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: repeating-linear-gradient(
        90deg,
        var(--dark) 0 14px,
        var(--primary) 14px 28px,
        var(--accent) 28px 42px
      );
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      position: relative;
      z-index: 1;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-shrink: 0;
    }

    .nav-logo {
      font-size: 1.55rem;
      font-weight: 800;
      color: var(--dark);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      letter-spacing: -0.02em;
    }

    .logo-mark {
      width: 40px;
      height: 40px;
      border: 3px solid var(--dark);
      background: var(--primary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.15rem;
      box-shadow: 4px 4px 0 var(--dark);
    }

    .logo-text {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .nav-badge {
      font-size: 0.75rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--dark);
      background: var(--accent);
      border: 2px solid var(--dark);
      padding: 0.35rem 0.6rem;
      box-shadow: 3px 3px 0 var(--dark);
    }

    .nav-panel {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex: 1;
      min-width: 0;
    }

    .nav-menu {
      display: flex;
      gap: 0.85rem;
      list-style: none;
      flex-wrap: wrap;
      justify-content: center;
      flex: 1;
      min-width: 0;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: flex-end;
      min-width: 0;
    }

    .nav-user {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      min-width: 0;
      border: 3px solid var(--dark);
      padding: 0.45rem 0.75rem;
      background: var(--white);
      box-shadow: 3px 3px 0 var(--dark);
    }

    #user-name {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .nav-toggle {
      display: none;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border: 3px solid var(--dark);
      background: var(--white);
      font-weight: 800;
      box-shadow: 4px 4px 0 var(--dark);
      cursor: pointer;
    }

    .nav-toggle:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .nav-link {
      padding: 0.65rem 1.35rem;
      border: 3px solid var(--dark);
      background: var(--white);
      color: var(--dark);
      text-decoration: none;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 4px 4px 0 var(--dark);
      white-space: nowrap;
      border-radius: 999px;
      position: relative;
    }

    .nav-link:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .nav-link.active {
      background: var(--primary);
      color: var(--white);
    }

    .nav-link.active::after {
      content: '';
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: -8px;
      height: 4px;
      background: var(--dark);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: 3px solid var(--dark);
      font-weight: 700;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
    }

    .btn-primary:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .btn-secondary {
      background: var(--white);
      color: var(--dark);
      box-shadow: 4px 4px 0 var(--dark);
    }

    .btn-success {
      background: var(--success);
      color: var(--dark);
      box-shadow: 4px 4px 0 var(--dark);
    }

    /* ===== CONTAINERS ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .section { display: none; }
    .section.active { display: block; }
    .hidden { display: none !important; }

    /* ===== CARDS ===== */
    .card {
      background: var(--white);
      border: var(--border) solid var(--dark);
      padding: 2rem;
      box-shadow: var(--shadow) var(--dark);
      margin-bottom: 2rem;
    }

    .card-header {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid var(--dark);
    }

    /* ===== GRID ===== */
    .grid {
      display: grid;
      gap: 1.5rem;
    }

    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

    /* ===== METRIC CARDS ===== */
    .metric-card {
      background: var(--white);
      border: 3px solid var(--dark);
      padding: 1.5rem;
      box-shadow: 6px 6px 0 var(--dark);
      position: relative;
      overflow: visible;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
    }

    .metric-card.positive::before { background: var(--success); }
    .metric-card.warning::before { background: var(--warning); }
    .metric-card.danger::before { background: var(--danger); }

    .metric-label {
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--gray);
      margin-bottom: 0.5rem;
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      font-family: 'Space Mono', monospace;
      margin-bottom: 0.5rem;
    }

    .metric-desc {
      font-size: 0.875rem;
      color: var(--gray);
    }

    .metric-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border: 2px solid var(--dark);
      font-size: 0.75rem;
      font-weight: 700;
      margin-top: 0.5rem;
    }

    .metric-pinpoints {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 2px dashed var(--gray-light);
      font-size: 0.8rem;
      line-height: 1.5;
      color: #4b5563;
      min-height: 24px;
    }

    .metric-pinpoints:empty {
      display: none;
    }

    .badge-success { background: var(--success); }
    .badge-warning { background: var(--warning); }
    .badge-danger { background: var(--danger); }

    /* ===== LOGIN SCREEN ===== */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      padding: 2rem;
    }

    .login-container {
      max-width: 450px;
      width: 100%;
      background: var(--white);
      border: var(--border) solid var(--dark);
      padding: 3rem;
      box-shadow: 12px 12px 0 var(--dark);
    }

    .login-container h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .login-container p {
      color: var(--gray);
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 3px solid var(--dark);
      font-family: inherit;
      font-size: 1rem;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .error-message {
      padding: 1rem;
      background: #FFE5E5;
      border: 3px solid var(--danger);
      margin-bottom: 1rem;
      font-weight: 700;
      color: var(--danger);
    }

    /* ===== MONTH SELECTOR ===== */
    .month-selector {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .month-btn {
      padding: 0.75rem 1.5rem;
      border: 3px solid var(--dark);
      background: var(--white);
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--dark);
      transition: all 0.2s;
    }

    .month-btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .month-btn.active {
      background: var(--accent);
      color: var(--dark);
    }

    .month-btn.disabled {
      opacity: 0.5;
      cursor: default;
    }

    .month-btn.disabled:hover {
      transform: none;
      box-shadow: 4px 4px 0 var(--dark);
    }

    /* ===== DASHBOARD / ADVANCED UI ===== */
    .dashboard-block {
      background: var(--white);
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 800;
      margin-bottom: 1rem;
    }

    .section-heading {
      margin-bottom: 1.25rem;
    }

    .section-subtitle {
      color: var(--gray);
      margin-top: 0.25rem;
    }

    .metrics-section {
      margin-top: 1rem;
    }

    .metrics-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .metric-label-wrapper {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .metric-description {
      color: var(--gray);
      font-size: 0.85rem;
    }

    .employee-month-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .employee-month-btn {
      padding: 0.6rem 1.1rem;
      border: 3px solid var(--dark);
      background: var(--white);
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--dark);
      transition: all 0.2s;
    }

    .employee-month-btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .employee-month-btn.active {
      background: var(--accent);
      color: var(--dark);
    }

    .employee-month-btn.disabled {
      opacity: 0.5;
      cursor: default;
    }

    .employee-month-btn.disabled:hover {
      transform: none;
      box-shadow: 4px 4px 0 var(--dark);
    }

    .info-icon {
      width: 20px;
      height: 20px;
      border: 2px solid var(--dark);
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 800;
      cursor: help;
      position: relative;
      background: var(--accent);
    }

    .info-icon::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      bottom: 130%;
      transform: translateX(-50%);
      background: var(--white);
      color: var(--dark);
      border: 2px solid var(--dark);
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      width: 220px;
      box-shadow: 4px 4px 0 var(--dark);
      opacity: 0;
      pointer-events: none;
      z-index: 5;
    }

    .info-icon:hover::after {
      opacity: 1;
    }

    .risk-indicator {
      display: inline-flex;
      padding: 0.25rem 0.6rem;
      border: 2px solid var(--dark);
      font-weight: 700;
      margin-top: 0.5rem;
      background: var(--gray-light);
      font-size: 0.75rem;
    }

    .risk-low { background: var(--success); }
    .risk-medium { background: var(--warning); }
    .risk-high { background: var(--danger); color: var(--white); }
    .risk-critical { background: var(--danger); color: var(--white); }
    .risk-unknown { background: #e5e7eb; color: #111827; }

    .chart-container {
      border: 3px solid var(--dark);
      background: var(--white);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1rem;
    }

    .risk-matrix-container {
      min-height: 320px;
    }

    .table-container {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      overflow-x: auto;
      background: var(--white);
    }

    #employee-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    #employee-table th,
    #employee-table td {
      border: 2px solid var(--dark);
      padding: 0.6rem;
      text-align: center;
      white-space: nowrap;
    }

    #employee-table th {
      background: var(--gray-light);
      font-weight: 800;
    }

    .employee-name.clickable {
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .score-good { background: #e8f9e8; }
    .score-warning { background: #fff0c2; }
    .score-danger { background: #ffd6d6; }
    .score-muted { background: #f1f5f9; color: var(--gray); }

    .risk-items {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }

    .risk-item {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1.25rem;
      background: var(--white);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .risk-item:hover {
      transform: translate(-2px, -2px);
      box-shadow: 8px 8px 0 var(--dark);
    }

    .risk-item.critical {
      background: #ffb3b3;
      border-color: #dc2626;
    }

    .risk-item.high {
      background: #ffd6d6;
      border-color: #f87171;
    }

    .risk-item.medium {
      background: #fff1c2;
      border-color: #fb923c;
    }

    .risk-item.low {
      background: #e8f9e8;
      border-color: #22c55e;
    }

    .risk-item-title {
      font-weight: 800;
      font-size: 1.05rem;
      margin-bottom: 0.5rem;
      color: var(--dark);
    }

    .risk-item-description {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #374151;
    }

    .risk-summary {
      display: grid;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .risk-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .risk-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      border: 2px solid var(--dark);
      padding: 0.35rem 0.65rem;
      font-weight: 800;
      background: var(--white);
    }

    .risk-chip-critical { background: #dc2626; color: white; font-weight: 700; }
    .risk-chip-high { background: #ffedd5; border: 1px solid #f97316; }
    .risk-chip-medium { background: #fef3c7; border: 1px solid #f59e0b; }
    .risk-chip-low { background: #dcfce7; border: 1px solid #22c55e; }

    .risk-top {
      border: 2px dashed var(--dark);
      padding: 0.75rem;
      background: #fffaf2;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .risk-meta {
      font-size: 0.85rem;
      color: var(--gray);
    }

    .data-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .data-pill {
      border: 2px solid var(--dark);
      padding: 0.4rem 0.75rem;
      background: var(--white);
      font-size: 0.85rem;
      font-weight: 700;
    }

    /* ===== MODAL ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 15, 15, 0.65);
      z-index: 50;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      backdrop-filter: blur(8px);
      animation: fadeIn 0.2s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-content {
      background: #fffef9;
      border: 4px solid var(--dark);
      box-shadow: 12px 12px 0 var(--dark);
      padding: 2rem;
      max-width: 1000px;
      width: min(1000px, 94vw);
      max-height: 88vh;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      animation: slideUp 0.3s ease-out;
      display: flex;
      flex-direction: column;
    }

    .modal-close {
      position: fixed;
      right: max(calc((100vw - 1000px) / 2 + 1rem), 1.5rem);
      top: max(calc((100vh - 88vh) / 2 + 1rem), 1.5rem);
      font-size: 1.8rem;
      cursor: pointer;
      width: 44px;
      height: 44px;
      border: 3px solid var(--dark);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--white);
      box-shadow: 5px 5px 0 var(--dark);
      transition: all 0.2s;
      font-weight: 800;
      z-index: 52;
      line-height: 1;
    }

    .modal-close:hover {
      transform: translate(-2px, -2px);
      box-shadow: 7px 7px 0 var(--dark);
      background: var(--danger);
      color: var(--white);
      border-color: var(--dark);
    }

    .modal-close:active {
      transform: translate(2px, 2px);
      box-shadow: 3px 3px 0 var(--dark);
    }

    .modal-title {
      font-size: 1.85rem;
      font-weight: 800;
      margin-bottom: 1.25rem;
      padding-right: 3rem;
      line-height: 1.3;
    }

    .modal-notes,
    .modal-metrics,
    .modal-chart,
    .modal-risk {
      margin-top: 1.5rem;
      padding-top: 1.25rem;
      border-top: 3px dashed var(--dark);
    }

    .modal-notes h3,
    .modal-metrics h3,
    .modal-chart h3,
    .modal-risk h3 {
      font-size: 1.15rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .modal-metrics-grid {
      display: grid;
      gap: 0.85rem;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    }

    .modal-metric {
      border: 3px solid var(--dark);
      padding: 0.85rem 1rem;
      background: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.85rem;
      transition: all 0.2s;
    }

    .modal-metric:hover {
      transform: translate(-1px, -1px);
      box-shadow: 5px 5px 0 var(--dark);
    }

    .modal-metric .metric-label {
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--gray);
      font-weight: 700;
    }

    .modal-metric .metric-value {
      font-size: 1.2rem;
      font-weight: 800;
    }

    .modal-pinpoints {
      margin-top: 1.5rem;
      padding-top: 1.25rem;
      border-top: 3px dashed var(--dark);
      width: 100%;
    }

    .modal-pinpoints h3 {
      font-size: 1.15rem;
      font-weight: 800;
      margin-bottom: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .pinpoint-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.85rem;
    }

    .pinpoint-item {
      border: 3px solid var(--dark);
      padding: 1rem;
      background: #fefefe;
      box-shadow: 4px 4px 0 var(--dark);
      display: grid;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .pinpoint-item:hover {
      transform: translate(-1px, -1px);
      box-shadow: 5px 5px 0 var(--dark);
      background: #fff;
    }

    .pinpoint-title {
      font-weight: 800;
      font-size: 1rem;
      line-height: 1.4;
      color: var(--dark);
    }

    .pinpoint-meta {
      font-size: 0.9rem;
      line-height: 1.5;
      color: #4b5563;
    }

    /* ===== ADVANCED ===== */
    .health-score-card {
      border: 4px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1.5rem;
      background: var(--white);
      text-align: center;
    }

    .health-score-value {
      font-size: 3rem;
      font-weight: 900;
    }

    .health-score-label,
    .health-score-indicator,
    .benchmark-status {
      font-weight: 700;
      color: var(--gray);
    }

    .benchmark-grid,
    .roi-grid,
    .forecast-grid,
    .sleep-debt-summary,
    .insight-grid,
    .recommendations-grid,
    .playbooks-grid,
    .alerts-grid,
    .priority-grid,
    .metadata-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .benchmark-card,
    .forecast-card,
    .roi-card,
    .insight-card,
    .recommendation-card,
    .playbook-card {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1rem;
      background: var(--white);
    }

    .alert-card {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1rem;
      background: var(--white);
    }

    .alert-card.critical { background: #ffe0e0; }
    .alert-card.positive { background: #e7ffe7; }
    .alert-card.info { background: #fff7d6; }

    .alert-pill,
    .priority-pill {
      display: inline-block;
      border: 2px solid var(--dark);
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      background: var(--white);
    }

    .alert-title {
      font-weight: 800;
      margin: 0.5rem 0;
    }

    .alert-meta {
      font-size: 0.8rem;
      color: var(--gray);
    }

    .priority-card {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1rem;
      background: var(--white);
    }

    .priority-card.critical { background: #ffe5e5; }
    .priority-card.high { background: #fff1c2; }

    .priority-title {
      font-weight: 800;
      margin: 0.5rem 0;
    }

    .priority-list {
      margin-top: 0.5rem;
      padding-left: 1.2rem;
    }

    .metadata-card {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1rem;
      background: var(--white);
    }

    .metadata-title {
      font-weight: 800;
      margin-bottom: 0.35rem;
    }

    .metadata-value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .metadata-list {
      margin-top: 0.5rem;
      padding-left: 1.2rem;
      color: var(--dark);
    }

    .benchmark-bar {
      position: relative;
      height: 14px;
      border: 2px solid var(--dark);
      background: var(--gray-light);
      margin: 0.75rem 0;
    }

    .benchmark-your {
      height: 100%;
      background: var(--primary);
    }

    .benchmark-industry {
      position: absolute;
      top: 0;
      height: 100%;
      background: var(--accent);
      opacity: 0.7;
    }

    .benchmark-values {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--gray);
    }

    .chart-note,
    .chart-comment {
      color: var(--gray);
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    .forecast-value {
      font-size: 1.4rem;
      font-weight: 800;
      margin: 0.5rem 0;
    }

    .forecast-trend,
    .forecast-change {
      font-size: 0.85rem;
      color: var(--gray);
    }

    .chart-card.full-width {
      margin-top: 1rem;
    }

    .chart-card.lift {
      cursor: pointer;
    }

    .chart-title {
      font-weight: 800;
      margin-bottom: 0.75rem;
    }

    .forecast-warning {
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .sleep-debt-summary {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-bottom: 1rem;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 800;
    }

    .insight-pill {
      display: inline-flex;
      border: 2px solid var(--dark);
      padding: 0.25rem 0.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: var(--accent);
    }

    .rec-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .rec-category {
      font-weight: 800;
      padding: 0.2rem 0.5rem;
      border: 2px solid var(--dark);
      background: var(--gray-light);
    }

    .rec-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .copy-btn {
      border: 2px solid var(--dark);
      background: var(--white);
      padding: 0.4rem 0.8rem;
      font-weight: 700;
      cursor: pointer;
    }

    .call-kit {
      display: none;
      margin-top: 0.75rem;
      border-top: 2px solid var(--dark);
      padding-top: 0.75rem;
    }

    .call-kit.open {
      display: block;
    }

    .insight-title {
      font-weight: 800;
      margin: 0.5rem 0;
    }

    .insight-list {
      margin: 0.5rem 0 0;
      padding-left: 1.2rem;
    }

    .insight-plan {
      margin-top: 0.75rem;
      font-weight: 700;
    }

    .rec-message {
      margin-top: 0.5rem;
    }

    .rec-action {
      font-weight: 700;
    }

    .playbook-employee-name {
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .playbook-risk-level {
      padding: 0.4rem 0.6rem;
      border: 2px solid var(--dark);
      font-weight: 700;
      background: var(--gray-light);
      margin-bottom: 0.75rem;
    }

    .playbook-section h4 {
      margin: 0.5rem 0;
      font-weight: 800;
    }

    .playbook-bullets,
    .playbook-microactions {
      padding-left: 1.2rem;
      margin: 0.5rem 0 0.75rem;
    }

    .call-kit-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .call-block {
      border: 2px solid var(--dark);
      padding: 0.75rem;
      background: var(--gray-light);
    }

    .december-notice {
      margin-top: 1rem;
      border: 3px solid var(--dark);
      background: #fff1c2;
      padding: 0.75rem 1rem;
      font-weight: 700;
    }

    .form-hint {
      color: var(--gray);
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .toggle-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .status-chip {
      padding: 0.25rem 0.6rem;
      border: 2px solid var(--dark);
      background: var(--gray-light);
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* ===== WEB CHECKIN ===== */
    .checkin-status {
      display: flex;
      flex-wrap: wrap;
      gap: 1.25rem;
      align-items: center;
      justify-content: space-between;
      border: 3px solid var(--dark);
      padding: 1.25rem;
      background: linear-gradient(135deg, #fff4ea 0%, #ffffff 60%, #eefbff 100%);
      box-shadow: 6px 6px 0 var(--dark);
      margin-bottom: 1.5rem;
    }

    .checkin-status-title {
      font-size: 1.15rem;
      font-weight: 700;
    }

    .checkin-status-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .checkin-frequency-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-bottom: 1.5rem;
    }

    .frequency-card {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      border: 3px solid var(--dark);
      padding: 1rem;
      background: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .frequency-card:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .frequency-card.selected {
      border-color: var(--primary);
      background: #fff1e6;
    }

    .frequency-card input {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
      flex-shrink: 0;
    }

    .checkin-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .checkin-question {
      border: 3px solid var(--dark);
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      background: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
    }

    .checkin-question-header {
      display: flex;
      gap: 0.9rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .checkin-question-emoji {
      width: 46px;
      height: 46px;
      border: 3px solid var(--dark);
      background: var(--secondary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      box-shadow: 3px 3px 0 var(--dark);
      flex-shrink: 0;
    }

    .checkin-question-text {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .checkin-question-type {
      font-size: 0.8rem;
      color: var(--gray);
      margin-top: 0.25rem;
    }

    .checkin-scale {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .checkin-scale input[type="range"] {
      flex: 1;
      accent-color: var(--primary);
    }

    .checkin-scale-value {
      min-width: 48px;
      padding: 0.35rem 0.6rem;
      border: 2px solid var(--dark);
      background: var(--gray-light);
      font-weight: 700;
      text-align: center;
    }

    .checkin-scale-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .checkin-textarea {
      width: 100%;
      min-height: 110px;
      padding: 1rem;
      border: 3px solid var(--dark);
      font-family: inherit;
      font-size: 1rem;
    }

    .checkin-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .audio-block {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 2px dashed var(--dark);
    }

    .audio-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .audio-record-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 3px solid var(--dark);
      background: var(--danger);
      color: var(--white);
      font-size: 1.1rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 4px 4px 0 var(--dark);
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .audio-record-btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .audio-record-btn.recording {
      background: var(--accent);
      animation: recordPulse 1.2s infinite ease-in-out;
    }

    @keyframes recordPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.07); }
      100% { transform: scale(1); }
    }

    .audio-btn {
      padding: 0.5rem 0.95rem;
      border: 2px solid var(--dark);
      background: var(--white);
      font-weight: 700;
      cursor: pointer;
    }

    .audio-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .audio-status {
      padding: 0.3rem 0.6rem;
      border: 2px solid var(--dark);
      background: #fff4ea;
      font-size: 0.85rem;
      font-weight: 700;
    }

    .audio-player {
      margin-top: 0.6rem;
      width: 100%;
    }

    @media (max-width: 900px) {
      .checkin-status {
        align-items: flex-start;
      }

      .checkin-status-meta {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .checkin-status {
        padding: 1rem;
      }

      .checkin-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .checkin-actions .btn {
        width: 100%;
        text-align: center;
      }

      .checkin-question {
        padding: 1.25rem;
      }

      .checkin-question-header {
        align-items: flex-start;
      }

      .checkin-scale {
        flex-direction: column;
        align-items: stretch;
      }

      .checkin-scale-value {
        align-self: flex-end;
      }

      .audio-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .audio-record-btn {
        width: 56px;
        height: 56px;
      }

      .audio-status {
        text-align: center;
      }
    }

    /* ===== ADMIN USERS ===== */
    .admin-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin: 1.5rem 0 1rem;
    }

    .admin-table-wrap {
      overflow-x: auto;
      border: 3px solid var(--dark);
      background: var(--white);
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .admin-table th,
    .admin-table td {
      border: 2px solid var(--dark);
      padding: 0.75rem 0.9rem;
      text-align: left;
      vertical-align: top;
    }

    .admin-table th {
      background: var(--gray-light);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.04em;
    }

    .admin-row-inactive {
      opacity: 0.6;
      background: #fff7f7;
    }

    .admin-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* ===== WELLNESS + INSIGHTS ===== */
    .plan-list,
    .insight-list,
    .kudos-list,
    .pulse-list,
    .moderation-queue {
      display: grid;
      gap: 0.75rem;
    }

    .plan-item,
    .kudos-item,
    .pulse-message,
    .insight-item,
    .moderation-card {
      border: 3px solid var(--dark);
      padding: 1rem;
      background: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
    }

    .plan-title,
    .kudos-message,
    .insight-title {
      font-weight: 700;
    }

    .plan-meta,
    .kudos-meta,
    .insight-meta {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.35rem;
    }

    .tag-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .tag-chip {
      padding: 0.25rem 0.6rem;
      border: 2px solid var(--dark);
      background: var(--accent);
      font-size: 0.75rem;
      font-weight: 700;
    }

    .insight-banner {
      margin-top: 1rem;
      border: 3px solid var(--dark);
      padding: 1rem;
      font-weight: 700;
    }

    .insight-banner.level-critical { background: #ffe5e5; }
    .insight-banner.level-alert { background: #fff3e0; }
    .insight-banner.level-watch { background: #f0f6ff; }

    /* ===== ONBOARDING ===== */
    .onboarding-card { border: 3px dashed var(--dark); background: #fff7d6; }
    .onboarding-steps { display: grid; gap: 0.75rem; }
    .onboarding-step {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border: 3px solid var(--dark);
      background: var(--light);
      font-weight: 600;
      flex-wrap: wrap;
    }
    .onboarding-step.complete {
      background: #d9f7da;
    }
    .step-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 2px solid var(--dark);
      background: var(--accent);
      font-weight: 800;
    }
    #onboarding-telegram-status {
      margin-left: auto;
    }
    #onboarding-reminder-preview {
      display: block;
      width: 100%;
      margin-top: 0.25rem;
    }

    /* ===== PULSE ROOMS ===== */
    .pulse-room-card {
      border: 3px solid var(--dark);
      padding: 1rem;
      background: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
      cursor: pointer;
      transition: all 0.2s;
    }

    .pulse-room-card:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .pulse-room-card.active {
      background: var(--accent);
    }

    .pulse-message.pending {
      background: #fff3e0;
    }

    .moderation-card {
      border-style: dashed;
      background: #fff7f7;
    }

    .action-card {
      border: 2px dashed var(--dark);
      padding: 0.65rem;
      margin-top: 0.5rem;
      background: #fff7f7;
      font-size: 0.85rem;
    }

    .heatmap-pinpoints {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.6rem;
    }

    .pinpoint-badge {
      display: inline-block;
      border: 2px solid var(--dark);
      padding: 0.25rem 0.5rem;
      background: #fff3cd;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--dark);
      box-shadow: 2px 2px 0 var(--dark);
    }

    /* ===== ANIMATIONS ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in { animation: fadeIn 0.5s ease-out; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 980px) {
      body { padding-top: 70px; }

      .nav { padding: 0.75rem 1rem; }

      .nav-container {
        flex-wrap: nowrap;
        justify-content: space-between;
        gap: 1rem;
      }

      .nav-left { gap: 0.5rem; }

      .nav-logo { font-size: 1.2rem; }

      .logo-mark {
        width: 36px;
        height: 36px;
        font-size: 1rem;
        box-shadow: 3px 3px 0 var(--dark);
      }

      .logo-text { font-size: 0.9rem; }

      .nav-badge { display: none; }

      .nav-toggle {
        display: inline-flex;
        order: 3;
        margin-left: auto;
      }

      .nav-panel {
        display: none;
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(26, 26, 26, 0.95);
        backdrop-filter: blur(10px);
        z-index: 999;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        gap: 0;
        padding: 2rem 1.5rem;
        overflow-y: auto;
      }

      .nav-panel.open {
        display: flex;
        animation: slideInDown 0.3s ease-out;
      }

      @keyframes slideInDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .nav-menu {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        max-width: 400px;
        gap: 0.75rem;
        margin-bottom: 2rem;
      }

      .nav-link {
        width: 100%;
        text-align: center;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        background: var(--white);
        color: var(--dark);
      }

      .nav-link.active {
        background: var(--primary);
        color: var(--white);
      }

      .nav-link-external {
        background: var(--accent);
      }

      .nav-actions {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        max-width: 400px;
        gap: 0.75rem;
      }

      .nav-user {
        width: 100%;
        justify-content: center;
        padding: 1rem 1.5rem;
        background: var(--white);
      }

      #user-name {
        max-width: 200px;
      }

      #logout-btn {
        width: 100%;
        padding: 1rem 1.5rem;
        font-size: 1rem;
      }
    }

    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .month-selector { justify-content: center; flex-wrap: wrap; }
      .login-container { padding: 2rem; }
      .card { padding: 1.5rem; }
      .modal-content { padding: 1.5rem; max-height: 90vh; }
      .modal-metrics-grid { grid-template-columns: 1fr; }
      .modal-title { font-size: 1.5rem; }
      .modal-close { right: 0.75rem; top: 0.75rem; width: 36px; height: 36px; }
      .risk-chip-row { flex-direction: column; align-items: flex-start; }
      .risk-items { grid-template-columns: 1fr; }
      .admin-table thead { display: none; }
      .admin-table tr { display: block; margin-bottom: 1rem; }
      .admin-table td { display: flex; justify-content: space-between; gap: 1rem; }
      .admin-table td::before { content: attr(data-label); font-weight: 700; }
      #employee-table { font-size: 0.85rem; }
      #employee-table th, #employee-table td { padding: 0.5rem 0.35rem; }
      .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    }

    @media (max-width: 560px) {
      body { padding-top: 60px; }

      .container { padding: 1rem; }

      .nav { padding: 0.65rem 0.85rem; }

      .nav-panel { top: 60px; padding: 1.5rem 1rem; }

      .nav-logo { font-size: 1.1rem; }

      .logo-mark {
        width: 32px;
        height: 32px;
        font-size: 0.95rem;
        box-shadow: 2px 2px 0 var(--dark);
      }

      .logo-text { display: none; }

      .nav-toggle {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }

      .nav-menu {
        max-width: 100%;
        gap: 0.65rem;
      }

      .nav-link {
        padding: 0.85rem 1.25rem;
        font-size: 1rem;
      }

      .nav-actions {
        max-width: 100%;
        gap: 0.65rem;
      }

      .nav-user {
        padding: 0.85rem 1.25rem;
      }

      #logout-btn {
        padding: 0.85rem 1.25rem;
        font-size: 0.95rem;
      }

      .btn { padding: 0.65rem 0.95rem; font-size: 0.9rem; }
      .modal { padding: 0.75rem; }
      .modal-content { padding: 1.25rem; }
      .modal-title { font-size: 1.35rem; }
      .card-header { font-size: 1.2rem; }
      .risk-item { padding: 1rem; }
      .risk-item-title { font-size: 0.95rem; }
      .risk-item-description { font-size: 0.9rem; }
    }

    /* ===== LOADING ===== */
    .loading {
      text-align: center;
      padding: 3rem;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--dark);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== FOOTER ===== */
    .app-footer {
      margin-top: 4rem;
      padding: 2rem;
      background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
      border-top: 3px solid var(--dark);
      text-align: center;
      font-size: 0.9rem;
      color: var(--gray);
    }

    .footer-content {
      max-width: 800px;
      margin: 0 auto;
    }

    .footer-text {
      margin-bottom: 0.75rem;
      line-height: 1.8;
    }

    .footer-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }

    .footer-link:hover {
      color: var(--dark);
      border-bottom-color: var(--primary);
    }
  </style>
</head>
<body>

  <!-- ===== LOGIN SCREEN ===== -->
  <div id="login-screen" class="login-screen">
    <div class="login-container fade-in">
      <h1>üß† OpsLab Mindguard</h1>
      <p>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤'—è —Ç–∞ —Ñ—ñ–¥–±–µ–∫—É –∫–æ–º–∞–Ω–¥–∏</p>

      <div id="error-container"></div>

      <form id="login-form">
        <div class="form-group">
          <label for="email">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–æ—à—Ç–∞</label>
          <input type="email" id="email" name="email" required placeholder="your@opslab.uk" autocomplete="email" />
        </div>

        <div class="form-group">
          <label for="code">–í–∞—à —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π 4-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥</label>
          <input type="password" id="code" name="code" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" autocomplete="current-password" />
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;">–£–≤—ñ–π—Ç–∏</button>
        <div class="form-hint" style="margin-top: 0.75rem;">
          üîó –ü—Ä–∏–≤ º—è–∑–∫–∞ Telegram: <span class="mono">/start email@opslab.uk 1234</span>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== MAIN APP ===== -->
  <div id="app" class="hidden">

    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-container">
        <div class="nav-left">
          <a href="#" class="nav-logo">
            <span class="logo-mark">üß†</span>
            <span class="logo-text">OpsLab Mindguard</span>
          </a>
          <span class="nav-badge">TeamPulse Analytics</span>
        </div>

        <button class="nav-toggle" id="nav-toggle" type="button" aria-expanded="false" aria-controls="nav-panel" aria-label="–ú–µ–Ω—é –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó">‚ò∞</button>

        <div class="nav-panel" id="nav-panel">
          <ul class="nav-menu">
            <li><a href="#" class="nav-link active" data-section="mindguard">üìä Mindguard</a></li>
            <li><a href="#" class="nav-link hidden" data-section="checkin" id="checkin-link">üìù Web-—á–µ–∫—ñ–Ω</a></li>
            <li><a href="#" class="nav-link hidden" data-section="advanced" id="advanced-link">üß† Advanced</a></li>
            <li><a href="#" class="nav-link" data-section="pulse">üó£ Pulse Rooms</a></li>
            <li><a href="https://opslab-feedback-production.up.railway.app/" class="nav-link nav-link-external" target="_blank" rel="noopener">üí¨ –°—Ç—ñ–Ω–∞ –ø–ª–∞—á—É</a></li>
            <li><a href="#" class="nav-link hidden" data-section="admin" id="admin-link">üß© –ö–æ–º–∞–Ω–¥–∞</a></li>
          </ul>

          <div class="nav-actions">
            <div class="nav-user">
              <span id="user-name" class="mono"></span>
              <span id="user-role" class="status-chip"></span>
            </div>
            <button id="logout-btn" class="btn btn-secondary">–í–∏–π—Ç–∏</button>
          </div>
        </div>
      </div>
    </nav>

    <!-- ===== MINDGUARD SECTION ===== -->
    <div id="mindguard-section" class="section active">
      <div class="container">
        <div class="card onboarding-card hidden" id="onboarding-card">
          <div class="card-header">üöÄ –°—Ç–∞—Ä—Ç —É Mindguard</div>
          <p style="color: var(--gray); margin-bottom: 1rem;">
            –ö–æ—Ä–æ—Ç–∫–∏–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –¥–æ–ø–æ–º–æ–∂–µ —É–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Ç–∞ –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —è–∫ –ø—Ä–∞—Ü—é—î —Å–∏—Å—Ç–µ–º–∞.
          </p>
          <div class="onboarding-steps">
            <div class="onboarding-step complete" id="onboarding-step-1">
              <span class="step-badge">1</span>
              –û–∑–Ω–∞–π–æ–º—Ç–µ—Å—å –∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ—é —Ç–∞ —Å–≤–æ—ó–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∑–∞ –º–∏–Ω—É–ª—ñ –º—ñ—Å—è—Ü—ñ.
            </div>
            <div class="onboarding-step" id="onboarding-step-2">
              <span class="step-badge">2</span>
              –ü—Ä–∏–≤ º—è–∂—ñ—Ç—å Telegram: <span class="mono">/link email@opslab.uk 1234</span>
              <span id="onboarding-telegram-status" class="status-chip">–°—Ç–∞—Ç—É—Å...</span>
            </div>
            <div class="onboarding-step" id="onboarding-step-3">
              <span class="step-badge">3</span>
              –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —á–∞—Å –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å —Ç–∞ —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å.
              <span id="onboarding-reminder-preview" class="form-hint"></span>
              <button id="onboarding-scroll-settings" class="btn btn-secondary" type="button">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å</button>
            </div>
            <div class="onboarding-step" id="onboarding-step-4">
              <span class="step-badge">4</span>
              –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥—É –±–æ—Ç –ø–æ—á–Ω–µ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —á–µ–∫—ñ–Ω–∏ —Ç–∞ –∑–≤—ñ—Ç–∏.
            </div>
          </div>
          <div class="toggle-row" style="margin-top: 1rem;">
            <button id="onboarding-refresh" class="btn btn-secondary" type="button">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–∏–≤ º—è–∑–∫—É</button>
            <button id="complete-onboarding-btn" class="btn btn-primary" type="button">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥</button>
            <span id="onboarding-status" class="form-hint"></span>
          </div>
        </div>

        <!-- Employee Personal Data Card -->
        <div class="card employee-only" id="employee-personal-card">
          <div class="card-header">üß† –ú–æ—ó –ø–æ–∫–∞–∑–Ω–∏–∫–∏</div>
          <div id="employee-no-data-message" class="hidden" style="padding: 2rem; text-align: center; color: var(--gray);">
            <p style="font-size: 1.1rem; margin-bottom: 1rem;">üìä –î–∞–Ω—ñ –∑'—è–≤–ª—è—Ç—å—Å—è —Ç—É—Ç –ø—ñ—Å–ª—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –æ–ø–∏—Ç—É–≤–∞–Ω—å</p>
            <p>–ü—Ä–æ–π–¥—ñ—Ç—å –∫—ñ–ª—å–∫–∞ —â–æ–¥–µ–Ω–Ω–∏—Ö —á–µ–∫—ñ–Ω—ñ–≤ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç, —â–æ–± —Å–∏—Å—Ç–µ–º–∞ –º–æ–≥–ª–∞ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –≤–∞—à–æ–≥–æ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤'—è.</p>
            <p style="margin-top: 1rem; font-size: 0.9rem;">–†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –ø—Ä–æ–π—Ç–∏ –º—ñ–Ω—ñ–º—É–º 5-7 —á–µ–∫—ñ–Ω—ñ–≤ –¥–ª—è —è–∫—ñ—Å–Ω–æ—ó –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.</p>
          </div>
          <div id="employee-personal-data" class="hidden">
            <p style="color: var(--gray); margin-bottom: 1.5rem;">
              –ü–æ–≤–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ –≤–∞—à–æ–≥–æ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤'—è –∑–∞ –≤—Å—ñ –º—ñ—Å—è—Ü—ñ –∑ –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ –∫–ª—é—á–æ–≤–∏—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö.
              –î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –ø—ñ—Å–ª—è —â–æ–¥–µ–Ω–Ω–∏—Ö —á–µ–∫—ñ–Ω—ñ–≤ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å –≤–∞—à—É –æ—Å–æ–±–∏—Å—Ç—É —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ –º—ñ—Å—è—Ü—è—Ö.
            </p>
            <div class="data-meta" id="employee-data-meta"></div>

            <div id="employee-month-selector-personal" class="month-selector"></div>

            <section class="metrics-section">
              <h3 class="section-title">–ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h3>
              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-header">
                    <div class="metric-label-wrapper">
                      <span class="metric-label">WHO-5 –ë–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</span>
                      <span class="info-icon" data-tooltip="–Ü–Ω–¥–µ–∫—Å –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è –í–û–û–ó (0-100). <50 ‚Äî –Ω–∏–∑—å–∫–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è.">i</span>
                    </div>
                  </div>
                  <div class="metric-value" id="employee-who5-value">‚Äî</div>
                  <div class="metric-description">–í–∞—à –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                  <span class="risk-indicator" id="employee-who5-risk">‚Äî</span>
                </div>

                <div class="metric-card">
                  <div class="metric-header">
                    <div class="metric-label-wrapper">
                      <span class="metric-label">PHQ-9 –î–µ–ø—Ä–µ—Å—ñ—è</span>
                      <span class="info-icon" data-tooltip="PHQ-9 (0-27). 5-9: –ª–µ–≥–∫–∞, 10-14: –ø–æ–º—ñ—Ä–Ω–∞, 15+: —Ç—è–∂–∫–∞.">i</span>
                    </div>
                  </div>
                  <div class="metric-value" id="employee-phq9-value">‚Äî</div>
                  <div class="metric-description">–í–∞—à –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                  <span class="risk-indicator" id="employee-phq9-risk">‚Äî</span>
                </div>

                <div class="metric-card">
                  <div class="metric-header">
                    <div class="metric-label-wrapper">
                      <span class="metric-label">GAD-7 –¢—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å</span>
                      <span class="info-icon" data-tooltip="GAD-7 (0-21). 5-9: –ª–µ–≥–∫–∞, 10-14: –ø–æ–º—ñ—Ä–Ω–∞, 15+: —Ç—è–∂–∫–∞.">i</span>
                    </div>
                  </div>
                  <div class="metric-value" id="employee-gad7-value">‚Äî</div>
                  <div class="metric-description">–í–∞—à –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                  <span class="risk-indicator" id="employee-gad7-risk">‚Äî</span>
                </div>

                <div class="metric-card">
                  <div class="metric-header">
                    <div class="metric-label-wrapper">
                      <span class="metric-label">MBI –í–∏–≥–æ—Ä–∞–Ω–Ω—è</span>
                      <span class="info-icon" data-tooltip="MBI (0-100%). 25-50%: —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫, >50%: –≤–∏—Å–æ–∫–∏–π.">i</span>
                    </div>
                  </div>
                  <div class="metric-value" id="employee-mbi-value">‚Äî</div>
                  <div class="metric-description">–í–∞—à –ø–æ–∫–∞–∑–Ω–∏–∫ (%)</div>
                  <span class="risk-indicator" id="employee-mbi-risk">‚Äî</span>
                </div>

                <div class="metric-card">
                  <div class="metric-header">
                    <div class="metric-label-wrapper">
                      <span class="metric-label">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É</span>
                      <span class="info-icon" data-tooltip="–°–µ—Ä–µ–¥–Ω—è —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ 7-9 –≥–æ–¥.">i</span>
                    </div>
                  </div>
                  <div class="metric-value" id="employee-sleep-duration-value">‚Äî</div>
                  <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω</div>
                  <span class="risk-indicator" id="employee-sleep-duration-risk">‚Äî</span>
                </div>

                <div class="metric-card">
                  <div class="metric-header">
                    <div class="metric-label-wrapper">
                      <span class="metric-label">–Ø–∫—ñ—Å—Ç—å —Å–Ω—É</span>
                      <span class="info-icon" data-tooltip="–Ø–∫—ñ—Å—Ç—å —Å–Ω—É (1-10). 7-10: –¥–æ–±—Ä–∞, <4: –ø–æ–≥–∞–Ω–∞.">i</span>
                    </div>
                  </div>
                  <div class="metric-value" id="employee-sleep-quality-value">‚Äî</div>
                  <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞ (1-10)</div>
                  <span class="risk-indicator" id="employee-sleep-quality-risk">‚Äî</span>
                </div>

                <div class="metric-card">
                  <div class="metric-header">
                    <div class="metric-label-wrapper">
                      <span class="metric-label">–ë–∞–ª–∞–Ω—Å –∂–∏—Ç—Ç—è</span>
                      <span class="info-icon" data-tooltip="–ë–∞–ª–∞–Ω—Å —Ä–æ–±–æ—Ç–∞/–∂–∏—Ç—Ç—è (1-10). 7-10: –∑–¥–æ—Ä–æ–≤–∏–π.">i</span>
                    </div>
                  </div>
                  <div class="metric-value" id="employee-work-life-value">‚Äî</div>
                  <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞ (1-10)</div>
                  <span class="risk-indicator" id="employee-work-life-risk">‚Äî</span>
                </div>

                <div class="metric-card">
                  <div class="metric-header">
                    <div class="metric-label-wrapper">
                      <span class="metric-label">–†—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É</span>
                      <span class="info-icon" data-tooltip="PSS (0-40). 0-13: –Ω–∏–∑—å–∫–∏–π, 14-26: –ø–æ–º—ñ—Ä–Ω–∏–π, 27-40: –≤–∏—Å–æ–∫–∏–π.">i</span>
                    </div>
                  </div>
                  <div class="metric-value" id="employee-stress-value">‚Äî</div>
                  <div class="metric-description">–í–∞—à –ø–æ–∫–∞–∑–Ω–∏–∫ (0-40)</div>
                  <span class="risk-indicator" id="employee-stress-risk">‚Äî</span>
                </div>
              </div>
            </section>
          </div>
        </div>

        <!-- Employee Personal Trend Chart -->
        <div class="card employee-only" id="employee-trend-card" style="display: none;">
          <div class="card-header">üìà –ú–æ—è –¥–∏–Ω–∞–º—ñ–∫–∞</div>
          <div class="chart-container" style="position: relative; height: 420px;">
            <canvas id="employeeTrendChart"></canvas>
          </div>
          <div style="padding: 1rem; background: var(--gray-light); border-left: 4px solid var(--primary); margin-top: 1.5rem;">
            <p style="margin: 0; font-size: 0.9rem;">üí° –í–∞—à—ñ –¥–∞–Ω—ñ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ. –í–æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ –≤–∞–º —Ç–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—ó –¥–ª—è –Ω–∞–¥–∞–Ω–Ω—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ.</p>
          </div>
        </div>

        <!-- Admin Team Dashboard Card -->
        <div class="card admin-only" id="team-dashboard-card">
          <div class="card-header">üìä TeamPulse Mindguard Analytics</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –ü–æ–≤–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤'—è –∑–∞ –≤—Å—ñ –º—ñ—Å—è—Ü—ñ –∑ –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ –∫–ª—é—á–æ–≤–∏—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö.
            –î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –ø—ñ—Å–ª—è —â–æ–¥–µ–Ω–Ω–∏—Ö —á–µ–∫—ñ–Ω—ñ–≤ —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ –º—ñ—Å—è—Ü—è—Ö.
          </p>
          <div class="data-meta" id="team-data-meta"></div>
          <div class="data-meta" id="team-data-coverage"></div>

          <div id="team-month-selector" class="month-selector"></div>
          <div class="december-notice" id="dashboardDecemberNotice" style="display: none;">
            ‚ö†Ô∏è –ì—Ä—É–¥–µ–Ω—å: —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–æ –≤–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∏ —Ç–∞ –ø—ñ–¥—Å—É–º–∫–∏ —Ä–æ–∫—É.
          </div>

          <section class="metrics-section">
            <h3 class="section-title">–ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h3>
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">WHO-5 –ë–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</span>
                    <span class="info-icon" data-tooltip="–Ü–Ω–¥–µ–∫—Å –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è –í–û–û–ó (0-100). <50 ‚Äî –Ω–∏–∑—å–∫–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="who5-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                <span class="risk-indicator" id="who5-risk">‚Äî</span>
                <div class="metric-pinpoints" id="who5-pinpoints"></div>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">PHQ-9 –î–µ–ø—Ä–µ—Å—ñ—è</span>
                    <span class="info-icon" data-tooltip="PHQ-9 (0-27). 5-9: –ª–µ–≥–∫–∞, 10-14: –ø–æ–º—ñ—Ä–Ω–∞, 15+: —Ç—è–∂–∫–∞.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="phq9-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                <span class="risk-indicator" id="phq9-risk">‚Äî</span>
                <div class="metric-pinpoints" id="phq9-pinpoints"></div>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">GAD-7 –¢—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å</span>
                    <span class="info-icon" data-tooltip="GAD-7 (0-21). 5-9: –ª–µ–≥–∫–∞, 10-14: –ø–æ–º—ñ—Ä–Ω–∞, 15+: —Ç—è–∂–∫–∞.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="gad7-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                <span class="risk-indicator" id="gad7-risk">‚Äî</span>
                <div class="metric-pinpoints" id="gad7-pinpoints"></div>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">MBI –í–∏–≥–æ—Ä–∞–Ω–Ω—è</span>
                    <span class="info-icon" data-tooltip="MBI (0-100%). 25-50%: —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫, >50%: –≤–∏—Å–æ–∫–∏–π.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="mbi-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫ (%)</div>
                <span class="risk-indicator" id="mbi-risk">‚Äî</span>
                <div class="metric-pinpoints" id="mbi-pinpoints"></div>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É</span>
                    <span class="info-icon" data-tooltip="–°–µ—Ä–µ–¥–Ω—è —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ 7-9 –≥–æ–¥.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="sleep-duration-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω</div>
                <span class="risk-indicator" id="sleep-duration-risk">‚Äî</span>
                <div class="metric-pinpoints" id="sleep-duration-pinpoints"></div>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">–Ø–∫—ñ—Å—Ç—å —Å–Ω—É</span>
                    <span class="info-icon" data-tooltip="–Ø–∫—ñ—Å—Ç—å —Å–Ω—É (1-10). 7-10: –¥–æ–±—Ä–∞, <4: –ø–æ–≥–∞–Ω–∞.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="sleep-quality-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞ (1-10)</div>
                <span class="risk-indicator" id="sleep-quality-risk">‚Äî</span>
                <div class="metric-pinpoints" id="sleep-quality-pinpoints"></div>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">–ë–∞–ª–∞–Ω—Å –∂–∏—Ç—Ç—è</span>
                    <span class="info-icon" data-tooltip="–ë–∞–ª–∞–Ω—Å —Ä–æ–±–æ—Ç–∞/–∂–∏—Ç—Ç—è (1-10). 7-10: –∑–¥–æ—Ä–æ–≤–∏–π.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="work-life-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞ (1-10)</div>
                <span class="risk-indicator" id="work-life-risk">‚Äî</span>
                <div class="metric-pinpoints" id="work-life-pinpoints"></div>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">–†—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É</span>
                    <span class="info-icon" data-tooltip="PSS (0-40). 0-13: –Ω–∏–∑—å–∫–∏–π, 14-26: –ø–æ–º—ñ—Ä–Ω–∏–π, 27-40: –≤–∏—Å–æ–∫–∏–π.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="stress-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫ (0-40)</div>
                <span class="risk-indicator" id="stress-risk">‚Äî</span>
                <div class="metric-pinpoints" id="stress-pinpoints"></div>
              </div>
            </div>
          </section>
        </div>

        <div class="card admin-only">
          <div class="card-header">üìà –î–∏–Ω–∞–º—ñ–∫–∞ –∫–æ–º–∞–Ω–¥–∏</div>
          <div class="chart-container" style="position: relative; height: 420px;">
            <canvas id="teamTrendChart"></canvas>
          </div>
        </div>

        <div class="card admin-only" id="employee-analysis-card">
          <div class="card-header">üßë‚Äçü§ù‚Äçüßë –ê–Ω–∞–ª—ñ–∑ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤</div>
          <div id="employee-month-selector" class="employee-month-selector"></div>
          <div class="table-container">
            <table id="employee-table">
              <thead>
                <tr>
                  <th>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</th>
                  <th>WHO-5</th>
                  <th>PHQ-9</th>
                  <th>GAD-7</th>
                  <th>MBI (%)</th>
                  <th>–°–æ–Ω (–≥–æ–¥)</th>
                  <th>–Ø–∫—ñ—Å—Ç—å —Å–Ω—É</th>
                  <th>–ë–∞–ª–∞–Ω—Å</th>
                  <th>–°—Ç—Ä–µ—Å</th>
                  <th>–†–∏–∑–∏–∫</th>
                </tr>
              </thead>
              <tbody id="employee-table-body">
                <tr>
                  <td colspan="10" style="text-align: center; padding: 2rem;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card admin-only" id="risk-assessment-card">
          <div class="card-header">‚ö†Ô∏è –û—Ü—ñ–Ω–∫–∞ —Ä–∏–∑–∏–∫—ñ–≤</div>
          <div class="risk-items" id="risk-items">
            <div class="risk-item medium">
              <div class="risk-item-title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
              <div class="risk-item-description">–ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞</div>
            </div>
          </div>
        </div>

        <!-- Employee Details Modal -->
        <div id="employeeModal" class="modal">
          <div class="modal-content">
            <span class="modal-close" onclick="closeEmployeeModal()">&times;</span>
            <h2 id="modalEmployeeName" class="modal-title"></h2>

            <div class="modal-metrics">
              <h3>–ü–æ—Ç–æ—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h3>
              <div class="modal-metrics-grid" id="modalMetrics"></div>
            </div>

            <div class="modal-chart">
              <h3>–î–∏–Ω–∞–º—ñ–∫–∞ –∑–∞ –º—ñ—Å—è—Ü—è–º–∏</h3>
              <div class="chart-container" style="position: relative; height: 300px; max-height: 300px;">
                <canvas id="modalTrendChart"></canvas>
              </div>
            </div>

            <div class="modal-risk">
              <h3>–†—ñ–≤–µ–Ω—å —Ä–∏–∑–∏–∫—É</h3>
              <p id="modalRiskLevel"></p>
            </div>

            <div class="modal-notes">
              <h3>–ü—Ä–∏–º—ñ—Ç–∫–∏</h3>
              <p id="modalNotes"></p>
            </div>

            <div class="modal-pinpoints">
              <h3>–ö–ª—é—á–æ–≤—ñ –ø—ñ–Ω–ø–æ—ñ–Ω—Ç–∏</h3>
              <ul id="modalPinpoints" class="pinpoint-list"></ul>
            </div>
          </div>
        </div>

        <!-- Quick Links for Employees -->
        <div class="card employee-only">
          <div class="card-header">üîó –ö–æ—Ä–∏—Å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</div>
          <div class="grid grid-2" style="gap: 1.5rem;">
            <a href="#" onclick="event.preventDefault(); switchSection('pulse');" class="btn btn-primary" style="display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 1.5rem;">
              üó£ <span style="margin-left: 0.5rem;">Pulse Rooms</span>
            </a>
            <a href="https://opslab-feedback-production.up.railway.app/" target="_blank" rel="noopener" class="btn btn-secondary" style="display: flex; align-items: center; justify-content: center; text-decoration: none; padding: 1.5rem;">
              üí¨ <span style="margin-left: 0.5rem;">–°—Ç—ñ–Ω–∞ –ø–ª–∞—á—É</span>
            </a>
          </div>
          <p style="margin-top: 1rem; color: var(--gray); font-size: 0.9rem;">
            <strong>Pulse Rooms</strong> ‚Äî –∞–Ω–æ–Ω—ñ–º–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏ –¥–ª—è —Ñ—ñ–¥–±–µ–∫—É —Ç–∞ —ñ–¥–µ–π<br>
            <strong>–°—Ç—ñ–Ω–∞ –ø–ª–∞—á—É</strong> ‚Äî –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–∞ —Å—Ç—ñ–Ω–∞ –¥–ª—è –≤–∞–∂–ª–∏–≤–∏—Ö —Å–∏–≥–Ω–∞–ª—ñ–≤ —Ç–∞ —Ñ—ñ–¥–±–µ–∫—É
          </p>
        </div>

        <div class="card admin-only" id="insights-card">
          <div class="card-header">üîç –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —ñ–Ω—Å–∞–π—Ç–∏</div>
          <div class="grid grid-2">
            <div>
              <h4 style="margin-bottom: 0.5rem;">Self-benchmark ¬∑ —Ç–∏ vs —Ç–∏</h4>
              <div id="self-benchmark" class="insight-list">
                <div class="form-hint">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö</div>
              </div>
            </div>
            <div>
              <h4 style="margin-bottom: 0.5rem;">–ö–æ—Ä–µ–ª—è—Ü—ñ—ó + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h4>
              <div id="correlations-list" class="insight-list">
                <div class="form-hint">–î–∞–Ω—ñ —â–µ –∑–±–∏—Ä–∞—é—Ç—å—Å—è</div>
              </div>
            </div>
          </div>
          <div id="early-signal-banner" class="insight-banner hidden"></div>
        </div>

        <!-- Telegram Bot Info -->
        <div class="card">
          <div class="card-header">ü§ñ Telegram Bot Integration</div>
          <p style="margin-bottom: 1rem;">
            –©–æ–¥–µ–Ω–Ω—ñ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—é –∞–Ω–∞–ª—ñ—Ç–∏–∫–æ—é —Ç–∞ AI-–ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é.
          </p>
          <div class="grid grid-2">
            <div>
              <h4 style="margin-bottom: 0.5rem;">–î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:</h4>
              <ul style="list-style: none; padding-left: 0;">
                <li class="mono" style="margin: 0.5rem 0;">üìã /help - –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥</li>
                <li class="mono" style="margin: 0.5rem 0;">‚úÖ /checkin - –©–æ–¥–µ–Ω–Ω–∏–π —á–µ–∫—ñ–Ω</li>
                <li class="mono" style="margin: 0.5rem 0;">üìä /status - –í–∞—à —Å—Ç–∞–Ω</li>
                <li class="mono" style="margin: 0.5rem 0;">üîó /weblogin - –í—Ö—ñ–¥ –≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</li>
                <li class="mono" style="margin: 0.5rem 0;">üí¨ /feedback - –°—Ç—ñ–Ω–∞ –ø–ª–∞—á—É</li>
                <li class="mono" style="margin: 0.5rem 0;">‚è∞ /settime - –ß–∞—Å –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å</li>
                <li class="mono" style="margin: 0.5rem 0;">üåç /timezone - –ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å</li>
                <li class="mono" style="margin: 0.5rem 0;">üîî /notify - –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è on/off</li>
                <li class="mono" style="margin: 0.5rem 0;">‚öôÔ∏è /settings - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</li>
                <li class="mono" style="margin: 0.5rem 0;">üó£ /pulse - –ê–Ω–æ–Ω—ñ–º–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏ –¥–ª—è —Ñ—ñ–¥–±–µ–∫—É</li>
                <li class="mono" style="margin: 0.5rem 0;">‚ú® /insight - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π —ñ–Ω—Å–∞–π—Ç</li>
              </ul>
            </div>
            <div>
              <h4 style="margin-bottom: 0.5rem;">–ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:</h4>
              <ul style="padding-left: 1.5rem;">
                <li>–ì–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—î—é</li>
                <li>AI-–∞–Ω–∞–ª—ñ–∑ –µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ —Å—Ç–∞–Ω—É</li>
                <li>–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞ –ø—Ä–∏–≤ º—è–∑–∫–∞: /start email –∫–æ–¥</li>
                <li>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è</li>
                <li>–©–æ—Ç–∏–∂–Ω–µ–≤—ñ –∑–≤—ñ—Ç–∏ (–ü'—è—Ç–Ω–∏—Ü—è 17:00)</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card" id="telegram-settings-card">
          <div class="card-header">üîî –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å</div>
          <div class="grid grid-2">
            <div>
              <h4 style="margin-bottom: 0.5rem;">–°—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</h4>
              <div id="telegram-connection-status" class="form-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
              <div id="telegram-pin-info" class="form-hint"></div>
              <div class="form-hint">–ü—Ä–∏–≤ º—è–∑–∫–∞: <span class="mono">/start email@opslab.uk 1234</span>.</div>
              <div class="form-hint">–ö–æ–¥ –¥–æ—Å—Ç—É–ø—É –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ –∑–≤ º—è–∑—É—î Telegram –∑ –∞–∫–∞—É–Ω—Ç–æ–º.</div>
            </div>
            <div>
              <h4 style="margin-bottom: 0.5rem;">–û—Å–æ–±–∏—Å—Ç—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h4>
              <form id="telegram-settings-form">
                <div class="form-group">
                  <label for="reminder-time">–ß–∞—Å –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å</label>
                  <input type="time" id="reminder-time" />
                </div>
                <div class="form-group">
                  <label for="timezone-input">–ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å</label>
                  <select id="timezone-input">
                    <option value="">–û–±–µ—Ä—ñ—Ç—å —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å...</option>
                    <optgroup label="–Ñ–≤—Ä–æ–ø–∞">
                      <option value="Europe/Kyiv">Europe/Kyiv (–ö–∏—ó–≤, UTC+2/+3)</option>
                      <option value="Europe/London">Europe/London (–õ–æ–Ω–¥–æ–Ω, UTC+0/+1)</option>
                      <option value="Europe/Paris">Europe/Paris (–ü–∞—Ä–∏–∂, UTC+1/+2)</option>
                      <option value="Europe/Berlin">Europe/Berlin (–ë–µ—Ä–ª—ñ–Ω, UTC+1/+2)</option>
                      <option value="Europe/Moscow">Europe/Moscow (–ú–æ—Å–∫–≤–∞, UTC+3)</option>
                      <option value="Europe/Istanbul">Europe/Istanbul (–°—Ç–∞–º–±—É–ª, UTC+3)</option>
                      <option value="Europe/Warsaw">Europe/Warsaw (–í–∞—Ä—à–∞–≤–∞, UTC+1/+2)</option>
                      <option value="Europe/Bucharest">Europe/Bucharest (–ë—É—Ö–∞—Ä–µ—Å—Ç, UTC+2/+3)</option>
                      <option value="Europe/Athens">Europe/Athens (–ê—Ñ—ñ–Ω–∏, UTC+2/+3)</option>
                      <option value="Europe/Helsinki">Europe/Helsinki (–ì–µ–ª—å—Å—ñ–Ω–∫—ñ, UTC+2/+3)</option>
                    </optgroup>
                    <optgroup label="–ê–º–µ—Ä–∏–∫–∞">
                      <option value="America/New_York">America/New_York (–ù—å—é-–ô–æ—Ä–∫, UTC-5/-4)</option>
                      <option value="America/Chicago">America/Chicago (–ß–∏–∫–∞–≥–æ, UTC-6/-5)</option>
                      <option value="America/Denver">America/Denver (–î–µ–Ω–≤–µ—Ä, UTC-7/-6)</option>
                      <option value="America/Los_Angeles">America/Los_Angeles (–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å, UTC-8/-7)</option>
                      <option value="America/Toronto">America/Toronto (–¢–æ—Ä–æ–Ω—Ç–æ, UTC-5/-4)</option>
                      <option value="America/Sao_Paulo">America/Sao_Paulo (–°–∞–Ω-–ü–∞—É–ª—É, UTC-3)</option>
                      <option value="America/Mexico_City">America/Mexico_City (–ú–µ—Ö—ñ–∫–æ, UTC-6/-5)</option>
                    </optgroup>
                    <optgroup label="–ê–∑—ñ—è">
                      <option value="Asia/Dubai">Asia/Dubai (–î—É–±–∞–π, UTC+4)</option>
                      <option value="Asia/Kolkata">Asia/Kolkata (–ú—É–º–±–∞—ó, UTC+5:30)</option>
                      <option value="Asia/Shanghai">Asia/Shanghai (–®–∞–Ω—Ö–∞–π, UTC+8)</option>
                      <option value="Asia/Tokyo">Asia/Tokyo (–¢–æ–∫—ñ–æ, UTC+9)</option>
                      <option value="Asia/Singapore">Asia/Singapore (–°—ñ–Ω–≥–∞–ø—É—Ä, UTC+8)</option>
                      <option value="Asia/Hong_Kong">Asia/Hong_Kong (–ì–æ–Ω–∫–æ–Ω–≥, UTC+8)</option>
                      <option value="Asia/Seoul">Asia/Seoul (–°–µ—É–ª, UTC+9)</option>
                      <option value="Asia/Bangkok">Asia/Bangkok (–ë–∞–Ω–≥–∫–æ–∫, UTC+7)</option>
                      <option value="Asia/Jakarta">Asia/Jakarta (–î–∂–∞–∫–∞—Ä—Ç–∞, UTC+7)</option>
                    </optgroup>
                    <optgroup label="–û–∫–µ–∞–Ω—ñ—è">
                      <option value="Australia/Sydney">Australia/Sydney (–°—ñ–¥–Ω–µ–π, UTC+10/+11)</option>
                      <option value="Australia/Melbourne">Australia/Melbourne (–ú–µ–ª—å–±—É—Ä–Ω, UTC+10/+11)</option>
                      <option value="Pacific/Auckland">Pacific/Auckland (–û–∫–ª–µ–Ω–¥, UTC+12/+13)</option>
                    </optgroup>
                    <optgroup label="–ê—Ñ—Ä–∏–∫–∞">
                      <option value="Africa/Cairo">Africa/Cairo (–ö–∞—ó—Ä, UTC+2)</option>
                      <option value="Africa/Johannesburg">Africa/Johannesburg (–ô–æ–≥–∞–Ω–Ω–µ—Å–±—É—Ä–≥, UTC+2)</option>
                      <option value="Africa/Lagos">Africa/Lagos (–õ–∞–≥–æ—Å, UTC+1)</option>
                    </optgroup>
                    <optgroup label="UTC">
                      <option value="UTC">UTC (–ö–æ–æ—Ä–¥–∏–Ω–æ–≤–∞–Ω–∏–π –≤—Å–µ—Å–≤—ñ—Ç–Ω—ñ–π —á–∞—Å)</option>
                      <option value="Etc/GMT+12">UTC-12</option>
                      <option value="Etc/GMT+11">UTC-11</option>
                      <option value="Etc/GMT+10">UTC-10</option>
                      <option value="Etc/GMT+9">UTC-9</option>
                      <option value="Etc/GMT+8">UTC-8</option>
                      <option value="Etc/GMT+7">UTC-7</option>
                      <option value="Etc/GMT+6">UTC-6</option>
                      <option value="Etc/GMT+5">UTC-5</option>
                      <option value="Etc/GMT+4">UTC-4</option>
                      <option value="Etc/GMT+3">UTC-3</option>
                      <option value="Etc/GMT+2">UTC-2</option>
                      <option value="Etc/GMT+1">UTC-1</option>
                      <option value="Etc/GMT-1">UTC+1</option>
                      <option value="Etc/GMT-2">UTC+2</option>
                      <option value="Etc/GMT-3">UTC+3</option>
                      <option value="Etc/GMT-4">UTC+4</option>
                      <option value="Etc/GMT-5">UTC+5</option>
                      <option value="Etc/GMT-6">UTC+6</option>
                      <option value="Etc/GMT-7">UTC+7</option>
                      <option value="Etc/GMT-8">UTC+8</option>
                      <option value="Etc/GMT-9">UTC+9</option>
                      <option value="Etc/GMT-10">UTC+10</option>
                      <option value="Etc/GMT-11">UTC+11</option>
                      <option value="Etc/GMT-12">UTC+12</option>
                    </optgroup>
                  </select>
                </div>
                <div class="toggle-row">
                  <input type="checkbox" id="notifications-enabled" />
                  <label for="notifications-enabled">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è</label>
                </div>
                <div class="toggle-row">
                  <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                  <span id="telegram-settings-status" class="form-hint"></span>
                </div>
              </form>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ===== WEB CHECKIN SECTION ===== -->
    <div id="checkin-section" class="section">
      <div class="container">
        <div class="card">
          <div class="card-header">üìù Web-—á–µ–∫—ñ–Ω (—Ç–µ—Å—Ç –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞)</div>
          <div class="checkin-status">
            <div class="checkin-status-main">
              <div id="checkin-status-title" class="checkin-status-title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
              <div id="checkin-status-detail" class="form-hint"></div>
            </div>
            <div class="checkin-status-meta">
              <span id="checkin-frequency-chip" class="status-chip">‚Äî</span>
              <span id="checkin-next-chip" class="status-chip">‚Äî</span>
            </div>
          </div>

          <div class="checkin-frequency-grid" id="checkin-frequency-grid">
            <label class="frequency-card">
              <input type="radio" name="checkin-frequency" value="daily" />
              <div>
                <div class="mono">–©–æ–¥–Ω—è</div>
                <div class="form-hint">2-3 –ø–∏—Ç–∞–Ω–Ω—è, —à–≤–∏–¥–∫–∏–π –ø—É–ª—å—Å –∫–æ–º–∞–Ω–¥–∏</div>
              </div>
            </label>
            <label class="frequency-card">
              <input type="radio" name="checkin-frequency" value="every_3_days" />
              <div>
                <div class="mono">–ö–æ–∂–Ω—ñ 3 –¥–Ω—ñ</div>
                <div class="form-hint">10 –ø–∏—Ç–∞–Ω—å, –≥–ª–∏–±—à–∏–π –∑—Ä—ñ–∑</div>
              </div>
            </label>
            <label class="frequency-card">
              <input type="radio" name="checkin-frequency" value="weekly" />
              <div>
                <div class="mono">–©–æ—Ç–∏–∂–Ω—è</div>
                <div class="form-hint">–ü–æ–≤–Ω–∏–π —Ç–µ—Å—Ç, –¥–µ—Ç–∞–ª—å–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∞</div>
              </div>
            </label>
          </div>

          <div class="checkin-actions">
            <button id="checkin-start-btn" class="btn btn-primary" type="button">–ü–æ—á–∞—Ç–∏ —á–µ–∫—ñ–Ω</button>
            <button id="checkin-force-btn" class="btn btn-secondary hidden" type="button">–¢–µ—Å—Ç–æ–≤–∏–π —Å—Ç–∞—Ä—Ç</button>
            <span id="checkin-start-hint" class="form-hint"></span>
          </div>
        </div>

        <div class="card hidden" id="checkin-form-card">
          <div class="card-header">‚úÖ –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —á–µ–∫—ñ–Ω—É</div>
          <div id="checkin-intro" class="form-hint" style="margin-bottom: 1rem;"></div>
          <div id="checkin-questions"></div>
          <div class="form-hint" id="checkin-audio-hint" style="margin-bottom: 1rem;">
            üéß –ê—É–¥—ñ–æ –¥–æ—Å—Ç—É–ø–Ω–µ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –ø–∏—Ç–∞–Ω—å (–ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞).
          </div>
          <div class="checkin-actions">
            <button id="checkin-submit-btn" class="btn btn-primary" type="button">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</button>
            <span id="checkin-submit-status" class="form-hint"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ADVANCED ANALYTICS SECTION ===== -->
    <div id="advanced-section" class="section">
      <div class="container">
        <div class="card">
          <div class="card-header">üß† Advanced Analytics</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –†–æ–∑—à–∏—Ä–µ–Ω—ñ —ñ–Ω—Å–∞–π—Ç–∏, —Ä–∏–∑–∏–∫–∏ —Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏ –¥–ª—è –≥–ª–∏–±–æ–∫–æ—ó —Ä–æ–±–æ—Ç–∏ –∑ –∫–æ–º–∞–Ω–¥–æ—é.
          </p>
        </div>

        <section class="health-score-section dashboard-block">
          <h2 class="section-title">Team Health Score</h2>
          <div class="health-score-card">
            <div class="health-score-value" id="healthScore">‚Äî</div>
            <div class="health-score-label">–∑ 100</div>
            <div class="health-score-indicator" id="healthIndicator"></div>
          </div>
          <div class="december-notice" id="decemberNotice" style="display: none;">
            ‚ö†Ô∏è –ì—Ä—É–¥–µ–Ω—å: —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–æ –≤–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∏ —Ç–∞ –ø—ñ–¥—Å—É–º–∫–∏ —Ä–æ–∫—É.
          </div>
        </section>

        <section class="alerts-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–ê–ª–µ—Ä—Ç–∏ —Ç–∞ —Å–∏–≥–Ω–∞–ª–∏</h2>
            <p class="section-subtitle">–ö—Ä–∏—Ç–∏—á–Ω—ñ —Ä–∏–∑–∏–∫–∏ –π –ø–æ–∑–∏—Ç–∏–≤–Ω—ñ –∑—Ä—É—à–µ–Ω–Ω—è –ø–æ –∫–æ–º–∞–Ω–¥—ñ.</p>
          </div>
          <div class="alerts-grid" id="alertsGrid"></div>
        </section>

        <section class="priority-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h2>
            <p class="section-subtitle">–§–æ–∫—É—Å–æ–≤–∞–Ω—ñ –¥—ñ—ó –¥–ª—è –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞ —Ç–∞ HR.</p>
          </div>
          <div class="priority-grid" id="priorityGrid"></div>
        </section>

        <section class="benchmarking-section dashboard-block">
          <h2 class="section-title">–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ —ñ–Ω–¥—É—Å—Ç—Ä—ñ—î—é</h2>
          <div class="benchmark-grid">
            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>WHO-5 –ë–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</h3>
                <span class="benchmark-status" id="who5Status"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="who5Your"></div>
                  <div class="benchmark-industry" id="who5Industry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="who5YourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong id="who5IndustryValue">‚Äî</strong></span>
                </div>
              </div>
            </div>

            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>PHQ-9 –î–µ–ø—Ä–µ—Å—ñ—è</h3>
                <span class="benchmark-status" id="phq9Status"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="phq9Your"></div>
                  <div class="benchmark-industry" id="phq9Industry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="phq9YourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong id="phq9IndustryValue">‚Äî</strong></span>
                </div>
              </div>
            </div>

            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>GAD-7 –¢—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å</h3>
                <span class="benchmark-status" id="gad7Status"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="gad7Your"></div>
                  <div class="benchmark-industry" id="gad7Industry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="gad7YourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong id="gad7IndustryValue">‚Äî</strong></span>
                </div>
              </div>
            </div>

            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>MBI –í–∏–≥–æ—Ä–∞–Ω–Ω—è</h3>
                <span class="benchmark-status" id="mbiStatus"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="mbiYour"></div>
                  <div class="benchmark-industry" id="mbiIndustry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="mbiYourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong id="mbiIndustryValue">‚Äî</strong></span>
                </div>
              </div>
            </div>

            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>–†—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É</h3>
                <span class="benchmark-status" id="stressStatus"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="stressYour"></div>
                  <div class="benchmark-industry" id="stressIndustry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="stressYourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong id="stressIndustryValue">‚Äî</strong></span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="charts-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–î–∏–Ω–∞–º—ñ–∫–∞ —Ç–∞ —Ä–∏–∑–∏–∫–∏</h2>
            <p class="section-subtitle">–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è, —Ä–∞–Ω–Ω—ñ —Å–∏–≥–Ω–∞–ª–∏ —Ç–∞ –º–∞—Ç—Ä–∏—Ü—è —Ä–∏–∑–∏–∫—ñ–≤.</p>
          </div>

          <div class="chart-card full-width lift" onclick="openChartModal('trajectoryModal')">
            <div class="chart-title">–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</div>
            <div class="chart-container trajectory-container">
              <canvas id="trajectoryChart"></canvas>
            </div>
            <p class="chart-note">WHO-5, —Å—Ç—Ä–µ—Å —ñ —Å–æ–Ω –Ω–æ—Ä–º–æ–≤–∞–Ω—ñ –¥–æ 100 –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.</p>
            <p class="chart-comment" id="trajectoryComment">–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è...</p>
          </div>

          <div class="chart-card full-width lift" onclick="openChartModal('riskModal')">
            <div class="chart-title">–ú–∞—Ç—Ä–∏—Ü—è —Ä–∏–∑–∏–∫—ñ–≤ 1:1</div>
            <div class="chart-container risk-matrix-container">
              <canvas id="riskBubbleChart"></canvas>
            </div>
            <div class="risk-summary" id="riskComment">–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è...</div>
          </div>
        </section>

        <section class="forecast-section dashboard-block">
          <h2 class="section-title">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –º—ñ—Å—è—Ü—å</h2>
          <div class="forecast-warning">‚ö†Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ç–æ—á–Ω—ñ–π –¥–∏–Ω–∞–º—ñ—Ü—ñ</div>
          <div class="forecast-grid" id="forecastGrid"></div>
        </section>

        <section class="sleep-debt-section dashboard-block">
          <h2 class="section-title">–ê–Ω–∞–ª—ñ–∑ –±–æ—Ä–≥—É —Å–Ω—É</h2>
          <div class="sleep-debt-summary">
            <div class="sleep-debt-stat">
              <div class="stat-value" id="totalSleepDebt">‚Äî</div>
              <div class="stat-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –±–æ—Ä–≥ —Å–Ω—É (–≥–æ–¥)</div>
            </div>
            <div class="sleep-debt-stat">
              <div class="stat-value" id="avgSleepDebt">‚Äî</div>
              <div class="stat-label">–°–µ—Ä–µ–¥–Ω—ñ–π –±–æ—Ä–≥ –Ω–∞ –ª—é–¥–∏–Ω—É (–≥–æ–¥/—Ç–∏–∂–¥–µ–Ω—å)</div>
            </div>
            <div class="sleep-debt-stat">
              <div class="stat-value" id="atRiskCount">‚Äî</div>
              <div class="stat-label">–õ—é–¥–µ–π —É –∑–æ–Ω—ñ —Ä–∏–∑–∏–∫—É</div>
            </div>
          </div>
          <div class="chart-container" style="height: 320px;">
            <canvas id="sleepDebtChart"></canvas>
          </div>
        </section>

        <section class="insights-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–ö–ª—é—á–æ–≤—ñ —ñ–Ω—Å–∞–π—Ç–∏ –ø–æ –ª—é–¥—è–º</h2>
            <p class="section-subtitle">–¢–æ–ø-—Ä–∏–∑–∏–∫–∏, –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –µ—Ç–∞–ª–æ–Ω–Ω—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏.</p>
          </div>
          <div class="insight-grid" id="insightGrid"></div>
        </section>

        <section class="roi-section dashboard-block">
          <h2 class="section-title">ROI Calculator</h2>
          <div class="roi-grid">
            <div class="roi-card">
              <div class="roi-label">–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å–Ω—É</div>
              <div class="roi-value" id="roiSleep">+1.2 –≥–æ–¥/–¥–µ–Ω—å</div>
            </div>
            <div class="roi-card">
              <div class="roi-label">–ó—Ä–æ—Å—Ç–∞–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>
              <div class="roi-value" id="roiProductivity">+18%</div>
            </div>
            <div class="roi-card">
              <div class="roi-label">–ó–Ω–∏–∂–µ–Ω–Ω—è –≤–∏–≥–æ—Ä–∞–Ω–Ω—è</div>
              <div class="roi-value" id="roiBurnout">-35%</div>
            </div>
            <div class="roi-card roi-highlight">
              <div class="roi-label">–†—ñ—á–Ω–∞ –µ–∫–æ–Ω–æ–º—ñ—è</div>
              <div class="roi-value" id="roiSavings">$21,500</div>
            </div>
          </div>
        </section>

        <section class="playbooks-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">üéØ 1:1 –ü–ª–µ–π–±—É–∫–∏ —Ç–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏</h2>
            <p class="section-subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó 1:1 –¥–ª—è —Ñ–æ–∫—É—Å—É –Ω–∞ —Ä–∏–∑–∏–∫–∞—Ö.</p>
          </div>
          <div id="playbooks-grid" class="playbooks-grid"></div>
        </section>

        <section class="recommendations-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h2>
            <p class="section-subtitle">–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –º–µ—Ç—Ä–∏–∫ —Ç–∞ —Ç—Ä–µ–Ω–¥—ñ–≤.</p>
          </div>
          <div class="recommendations-grid" id="recommendationsGrid"></div>
        </section>

        <section class="metadata-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–î–∞–Ω—ñ —Ç–∞ –º–µ—Ç–æ–¥–æ–ª–æ–≥—ñ—è</h2>
            <p class="section-subtitle">–ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–±–æ—Ä—É, —á–∞—Å—Ç–æ—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è.</p>
          </div>
          <div class="metadata-grid" id="metadataGrid"></div>
        </section>

        <div id="trajectoryModal" class="modal" onclick="modalBgClick(event, 'trajectoryModal')">
          <div class="modal-content">
            <span class="modal-close" onclick="closeChartModal('trajectoryModal')">&times;</span>
            <h2 class="modal-title">–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</h2>
            <div class="modal-notes">
              <p id="trajectorySummary">–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è...</p>
            </div>
            <div class="modal-metrics">
              <h3>–ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h3>
              <div class="modal-metrics-grid" id="trajectoryMetrics"></div>
            </div>
          </div>
        </div>

        <div id="riskModal" class="modal" onclick="modalBgClick(event, 'riskModal')">
          <div class="modal-content">
            <span class="modal-close" onclick="closeChartModal('riskModal')">&times;</span>
            <h2 class="modal-title">–ú–∞—Ç—Ä–∏—Ü—è —Ä–∏–∑–∏–∫—ñ–≤ 1:1</h2>
            <div class="modal-notes">
              <p id="riskSummary">–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è...</p>
            </div>
            <div class="modal-metrics">
              <h3>–†–æ–∑–∫–ª–∞–¥–∞–Ω–Ω—è —Ä–∏–∑–∏–∫—É</h3>
              <div class="modal-metrics-grid" id="riskMetrics"></div>
            </div>
            <div class="modal-pinpoints">
              <h3>–ü—ñ–Ω–ø–æ—ñ–Ω—Ç–∏</h3>
              <ul id="riskPinpoints" class="pinpoint-list"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PULSE ROOMS SECTION ===== -->
    <div id="pulse-section" class="section">
      <div class="container">
        <div class="card">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <span>üó£ Pulse Rooms</span>
            <button id="create-room-btn" class="btn btn-primary" type="button">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</button>
          </div>
          <p style="color: var(--gray); margin-bottom: 0.75rem;">
            Pulse rooms ‚Äî —Ç–µ–º–∞—Ç–∏—á–Ω—ñ –ø—Ä–æ—Å—Ç–æ—Ä–∏ –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ñ—ñ–¥–±–µ–∫—É, —ñ–¥–µ–π —Ç–∞ –≤–∞–∂–ª–∏–≤–∏—Ö —Å–∏–≥–Ω–∞–ª—ñ–≤. –ü–∏—à—ñ—Ç—å —á–µ—Å–Ω–æ –π –∫–æ—Ä–æ—Ç–∫–æ, –º–æ–∂–Ω–∞ –∞–Ω–æ–Ω—ñ–º–Ω–æ.
          </p>
          <div class="form-hint" style="margin-bottom: 1.5rem;">
            <strong>–Ø–∫ –ø—Ä–∞—Ü—é—î:</strong>
            <ul style="margin: 0.5rem 0 0 1.2rem;">
              <li>–û–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É –∑ —Ç–µ–º–æ—é –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å —Å–≤–æ—é.</li>
              <li>–í—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—É–±–ª—ñ–∫—É—é—Ç—å—Å—è –≤—ñ–¥—Ä–∞–∑—É –±–µ–∑ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó.</li>
              <li>–ê–Ω–æ–Ω—ñ–º–Ω—ñ—Å—Ç—å –ø—Ä–∏—Ö–æ–≤—É—î —ñ–º º—è –¥–ª—è —ñ–Ω—à–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤.</li>
            </ul>
          </div>
          <div id="pulse-rooms" class="grid grid-3"></div>
        </div>

        <!-- Create Room Modal -->
        <div id="create-room-modal" class="modal" style="display: none;">
          <div class="modal-content" style="max-width: 600px;">
            <span class="modal-close" onclick="closeCreateRoomModal()">&times;</span>
            <h2 style="margin-top: 0; margin-bottom: 1.5rem;">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –∫—ñ–º–Ω–∞—Ç—É</h2>
            <form id="create-room-form">
              <div class="form-group">
                <label for="room-name">–ù–∞–∑–≤–∞ –∫—ñ–º–Ω–∞—Ç–∏</label>
                <input type="text" id="room-name" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—ñ–≤" required maxlength="100" />
              </div>
              <div class="form-group">
                <label for="room-description">–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <textarea id="room-description" rows="3" maxlength="500" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Ç–µ–º–∏ –∫—ñ–º–Ω–∞—Ç–∏..."></textarea>
              </div>
              <div class="form-group">
                <label for="room-emoji">–ï–º–æ–¥–∑—ñ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
                <input type="text" id="room-emoji" placeholder="üí°" maxlength="2" />
                <div class="form-hint">–û–¥–∏–Ω –µ–º–æ–¥–∑—ñ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫—ñ–º–Ω–∞—Ç–∏</div>
              </div>
              <div class="toggle-row" style="margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                <button type="button" class="btn btn-secondary" onclick="closeCreateRoomModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <span id="create-room-status" class="form-hint"></span>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header">üí¨ –û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏</div>
          <div id="pulse-room-meta" class="form-hint">–û–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É</div>
          <div id="pulse-room-guidance" class="form-hint"></div>
          <div id="pulse-messages" class="pulse-list"></div>
          <form id="pulse-message-form" style="margin-top: 1rem;">
            <div class="form-group">
              <label for="pulse-message-content">–í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</label>
              <textarea id="pulse-message-content" rows="3" maxlength="3000" placeholder="–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –¥—É–º–∫–∞–º–∏..."></textarea>
              <div class="toggle-row">
                <input type="checkbox" id="pulse-anonymous" checked />
                <label for="pulse-anonymous">–ù–∞–¥—Å–∏–ª–∞—Ç–∏ –∞–Ω–æ–Ω—ñ–º–Ω–æ</label>
              </div>
              <div class="form-hint" id="pulse-anonymity-hint">–ú–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ –∞–Ω–æ–Ω—ñ–º–Ω–æ ‚Äî —ñ–º º—è –Ω–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —ñ–Ω—à–∏–º —É—á–∞—Å–Ω–∏–∫–∞–º.</div>
            </div>
            <div class="toggle-row">
              <button type="submit" class="btn btn-success">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
              <span id="pulse-message-status" class="form-hint"></span>
            </div>
          </form>
        </div>

      </div>
    </div>

    <!-- ===== ADMIN SECTION ===== -->
    <div id="admin-section" class="section">
      <div class="container">
        <div class="card">
          <div class="card-header">üë• –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –°—Ç–≤–æ—Ä—é–π—Ç–µ –Ω–æ–≤—ñ –∞–∫–∞—É–Ω—Ç–∏, –¥–µ–∞–∫—Ç–∏–≤—É–π—Ç–µ –∑–≤—ñ–ª—å–Ω–µ–Ω–∏—Ö —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª—é–π—Ç–µ –¥–æ—Å—Ç—É–ø –∑–∞ –ø–æ—Ç—Ä–µ–±–∏.
            –î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º—ñ –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.
          </p>

          <div class="grid grid-2">
            <form id="admin-user-form">
              <div class="form-group">
                <label for="admin-user-name">–Ü–º º—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</label>
                <input id="admin-user-name" type="text" placeholder="–Ü–º º—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" required />
              </div>
              <div class="form-group">
                <label for="admin-user-email">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–æ—à—Ç–∞</label>
                <input id="admin-user-email" type="email" placeholder="user@opslab.uk" required />
              </div>
              <div class="form-group">
                <label for="admin-user-role">–†–æ–ª—å</label>
                <select id="admin-user-role">
                  <option value="EMPLOYEE">EMPLOYEE</option>
                  <option value="FOUNDER">FOUNDER</option>
                  <option value="ADMIN">ADMIN</option>
                </select>
              </div>
              <div class="form-group">
                <label for="admin-user-code">4-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥</label>
                <div class="toggle-row">
                  <input id="admin-user-code" type="text" maxlength="4" placeholder="1234" />
                  <button id="generate-user-code" class="btn btn-secondary" type="button">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
                </div>
              </div>
              <div class="form-group">
                <label for="admin-user-note">–ù–æ—Ç–∞—Ç–∫–∞ (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                <input id="admin-user-note" type="text" placeholder="–ö–æ–º–∞–Ω–¥–∞, –≤—ñ–¥–¥—ñ–ª –∞–±–æ —Ä–æ–ª—å" />
              </div>
              <div class="toggle-row">
                <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
                <span id="admin-user-status" class="form-hint"></span>
              </div>
            </form>
            <div>
              <h4 style="margin-bottom: 0.75rem;">–ü—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h4>
              <ul style="padding-left: 1.2rem;">
                <li>–ö–æ–¥ –¥–æ—Å—Ç—É–ø—É –ø–æ–≤—ñ–¥–æ–º–ª—è—î—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –æ–∫—Ä–µ–º–∏–º –∫–∞–Ω–∞–ª–æ–º.</li>
                <li>–¶–µ–π –∫–æ–¥ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—ó –ø—Ä–∏–≤ º—è–∑–∫–∏ Telegram: /start email –∫–æ–¥.</li>
                <li>–ü—Ä–∏–≤ º—è–∑–∫—É Telegram –º–æ–∂–Ω–∞ —Å–∫–∏–Ω—É—Ç–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó.</li>
                <li>–ü—ñ—Å–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó Telegram ID –æ—á–∏—â—É—î—Ç—å—Å—è –¥–ª—è –±–µ–∑–ø–µ–∫–∏.</li>
                <li>–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –Ω–µ –≤–∏–¥–∞–ª—è—î —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ.</li>
              </ul>
            </div>
          </div>

          <div class="admin-toolbar">
            <input id="admin-user-search" type="text" placeholder="–ü–æ—à—É–∫ –∑–∞ —ñ–º º—è–º –∞–±–æ email" />
            <label class="toggle-row" style="margin: 0;">
              <input type="checkbox" id="admin-show-inactive" checked />
              <span>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö</span>
            </label>
          </div>

          <div class="admin-table-wrap">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                  <th>–†–æ–ª—å</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>Telegram</th>
                  <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
                  <th>–í—ñ–¥–∫–ª—é—á–µ–Ω–æ</th>
                  <th>–î—ñ—ó</th>
                </tr>
              </thead>
              <tbody id="admin-users-table"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">üß© –ö–æ–º–∞–Ω–¥–Ω–∏–π Heatmap</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –°—Ç–∞–Ω –∫–æ–º–∞–Ω–¥–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —â–æ–¥–µ–Ω–Ω–∏—Ö —á–µ–∫—ñ–Ω—ñ–≤ (–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è Admin/Founder).
          </p>
          <div id="team-heatmap" class="grid grid-3"></div>
        </div>

      </div>
    </div>

    <!-- ===== FOOTER ===== -->
    <footer class="app-footer">
      <div class="footer-content">
        <div class="footer-text">
          –ü–ª–∞—Ç—Ñ–æ—Ä–º—É <strong>MindGuard</strong> —Å—Ç–≤–æ—Ä–µ–Ω–æ –¥–ª—è <strong>OpsLab</strong> –∫–æ–º–ø–∞–Ω—ñ—î—é <strong>TeamPulse</strong>
        </div>
        <div class="footer-text">
          –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–∞ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ñ–π –º–æ–≤—ñ <a href="#maslo" class="footer-link" onclick="event.preventDefault(); showMASLOPage()">MASLO</a>
        </div>
      </div>
    </footer>

  </div>

  <!-- ===== MASLO PAGE MODAL ===== -->
  <div id="maslo-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
      <span class="modal-close" onclick="closeMASLOPage()">&times;</span>

      <h1 style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--primary); margin-top: 0;">MASLO</h1>
      <p style="font-size: 1.2rem; color: var(--gray); margin-bottom: 2rem; font-weight: 500;">
        Multi-paradigm AI-Aware Statically-typed Low-latency Omni-concurrent
      </p>

      <div class="card" style="margin-bottom: 2rem;">
        <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">üöÄ –ü—Ä–æ –º–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è</h2>
        <p style="margin-bottom: 1rem; line-height: 1.8;">
          <strong>MASLO</strong> ‚Äî —Ü–µ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞ –º–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ø–æ–∫–æ–ª—ñ–Ω–Ω—è, —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∞ –∑ —Ñ–æ–∫—É—Å–æ–º –Ω–∞
          –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º, –Ω–∏–∑—å–∫—É –∑–∞—Ç—Ä–∏–º–∫—É —Ç–∞ –±–µ–∑–ø–µ–∫—É —Ç–∏–ø—ñ–≤. –ú–æ–≤–∞ –ø–æ—î–¥–Ω—É—î –Ω–∞–π–∫—Ä–∞—â—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Å—É—á–∞—Å–Ω–∏—Ö –º–æ–≤ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
          –∑ —ñ–Ω–Ω–æ–≤–∞—Ü—ñ–π–Ω–∏–º–∏ –ø—ñ–¥—Ö–æ–¥–∞–º–∏ –¥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ñ—Å—Ç—é —Ç–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—î—é –∑ AI.
        </p>

        <h3 style="font-size: 1.2rem; margin: 1.5rem 0 0.75rem; color: var(--dark);">–ö–ª—é—á–æ–≤—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
        <ul style="margin-left: 1.5rem; line-height: 2;">
          <li><strong>Multi-paradigm</strong> ‚Äî –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ, –æ–±'—î–∫—Ç–Ω–æ-–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–æ–≥–æ —Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ —Å—Ç–∏–ª—ñ–≤</li>
          <li><strong>AI-Aware</strong> ‚Äî –≤–±—É–¥–æ–≤–∞–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –º–∞—à–∏–Ω–Ω–æ–≥–æ –Ω–∞–≤—á–∞–Ω–Ω—è —Ç–∞ AI-–º–æ–¥–µ–ª–µ–π –Ω–∞ —Ä—ñ–≤–Ω—ñ –º–æ–≤–∏</li>
          <li><strong>Statically-typed</strong> ‚Äî —Å—Ç—Ä–æ–≥–∞ —Ç–∏–ø—ñ–∑–∞—Ü—ñ—è –∑ –ø–æ—Ç—É–∂–Ω–∏–º –≤–∏–≤–µ–¥–µ–Ω–Ω—è–º —Ç–∏–ø—ñ–≤ –¥–ª—è –±–µ–∑–ø–µ–∫–∏ –∫–æ–¥—É</li>
          <li><strong>Low-latency</strong> ‚Äî –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –¥–ª—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</li>
          <li><strong>Omni-concurrent</strong> ‚Äî —Ä–µ–≤–æ–ª—é—Ü—ñ–π–Ω–∞ –º–æ–¥–µ–ª—å –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –∫–µ—Ä—É–≤–∞–Ω–Ω—è–º –ø–æ—Ç–æ–∫–∞–º–∏</li>
        </ul>
      </div>

      <div class="card" style="margin-bottom: 2rem;">
        <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">üéØ –ü–µ—Ä–µ–≤–∞–≥–∏</h2>
        <div class="grid grid-2" style="gap: 1rem;">
          <div style="padding: 1rem; background: var(--gray-light); border-left: 4px solid var(--success);">
            <h4 style="margin-bottom: 0.5rem;">‚ö° –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</h4>
            <p style="font-size: 0.9rem;">Zero-cost abstractions —Ç–∞ ahead-of-time –∫–æ–º–ø—ñ–ª—è—Ü—ñ—è –∑–∞–±–µ–∑–ø–µ—á—É—é—Ç—å —à–≤–∏–¥–∫—ñ—Å—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è</p>
          </div>
          <div style="padding: 1rem; background: var(--gray-light); border-left: 4px solid var(--accent);">
            <h4 style="margin-bottom: 0.5rem;">üîí –ë–µ–∑–ø–µ–∫–∞</h4>
            <p style="font-size: 0.9rem;">–°—Ç—Ä–æ–≥–∞ —Ç–∏–ø—ñ–∑–∞—Ü—ñ—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∞–º'—è—Ç—ñ –Ω–∞ –µ—Ç–∞–ø—ñ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó –ø–æ–ø–µ—Ä–µ–¥–∂–∞—é—Ç—å –ø–æ–º–∏–ª–∫–∏</p>
          </div>
          <div style="padding: 1rem; background: var(--gray-light); border-left: 4px solid var(--warning);">
            <h4 style="margin-bottom: 0.5rem;">ü§ñ AI Integration</h4>
            <p style="font-size: 0.9rem;">–ù–∞—Ç–∏–≤–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ç–µ–Ω–∑–æ—Ä—ñ–≤, –º–æ–¥–µ–ª–µ–π —Ç–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å –¥–ª—è AI</p>
          </div>
          <div style="padding: 1rem; background: var(--gray-light); border-left: 4px solid var(--primary);">
            <h4 style="margin-bottom: 0.5rem;">üåê –ü–∞—Ä–∞–ª–µ–ª—ñ–∑–º</h4>
            <p style="font-size: 0.9rem;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –∫–æ–¥—É –±–µ–∑ race conditions</p>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #fff4ea 0%, #ffffff 100%); border: 3px solid var(--primary);">
        <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">üìÖ –†–µ–ª—ñ–∑ —Ç–∞ —Ä–æ–∑—Ä–æ–±–∫–∞</h2>
        <p style="margin-bottom: 1rem; line-height: 1.8;">
          –ù–∞ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç MASLO –ø–µ—Ä–µ–±—É–≤–∞—î –≤ –∞–∫—Ç–∏–≤–Ω—ñ–π —Å—Ç–∞–¥—ñ—ó —Ä–æ–∑—Ä–æ–±–∫–∏. –°—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤–ª–∞—Å–Ω–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∞ –º–∞—à–∏–Ω–∞
          –∑ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–º runtime –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é –Ω–∞–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º.
        </p>
        <div style="padding: 1.5rem; background: white; border: 2px solid var(--dark); box-shadow: 4px 4px 0 var(--dark); margin-top: 1.5rem;">
          <p style="font-size: 1.1rem; margin: 0; font-weight: 600;">
            üéâ –ü–µ—Ä—à–∏–π —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π —Ä–µ–ª—ñ–∑ –Ω–∞ –≤–ª–∞—Å–Ω—ñ–π –≤—ñ—Ä—Ç—É–∞–ª—å–Ω—ñ–π –º–∞—à–∏–Ω—ñ –æ—á—ñ–∫—É—î—Ç—å—Å—è –≤ <span style="color: var(--primary);">–ª–∏—Å—Ç–æ–ø–∞–¥—ñ 2026</span>
          </p>
        </div>
      </div>

      <div class="card">
        <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">üí° –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è</h2>
        <p style="line-height: 1.8;">
          MASLO —ñ–¥–µ–∞–ª—å–Ω–æ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –≤–∏—Å–æ–∫–æ–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Å–∏—Å—Ç–µ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É, AI-–¥–æ–¥–∞—Ç–∫—ñ–≤,
          —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏—Ö —Å–∏—Å—Ç–µ–º, —Ñ—ñ–Ω—Ç–µ—Ö-–ø–ª–∞—Ç—Ñ–æ—Ä–º —Ç–∞ —ñ–Ω—à–∏—Ö –ø—Ä–æ–µ–∫—Ç—ñ–≤, –¥–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —ñ –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å.
        </p>
      </div>
    </div>
  </div>

  <script>
    // ===== GLOBAL STATE =====
    let currentUser = null;
    let currentSection = 'mindguard';
    let teamDashboardData = null;
    let teamDashboardSelectedKey = null;
    let teamDashboardEmployeeKey = null;
    let teamDashboardCharts = {};
    let advancedCharts = {};
    let advancedData = null;
    let telegramStatus = null;
    let teamHeatmap = null;
    let adminUsers = [];
    let adminSearch = '';
    let showInactiveUsers = true;
    let wellnessPlan = null;
    let wellnessGoals = null;
    let insights = { selfBenchmark: null, correlations: [], earlySignal: null };
    let pulseRooms = [];
    let activePulseRoom = null;
    let pulseMessages = [];
    let checkinSession = null;
    let checkinAudioStates = new Map();
    let activeRecordingState = null;
    let checkinPendingSection = null;
    let checkinAutoStart = false;
    const TEST_CHECKIN_EMAIL = 'work.olegkaminskyi@gmail.com';
    const CHECKIN_MAX_AUDIO_SECONDS = 120;
    const CHECKIN_MAX_AUDIO_BYTES = 6_000_000;

    // ===== API HELPERS =====
    async function apiCall(endpoint, options = {}) {
      const response = await fetch(endpoint, {
        ...options,
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...options.headers,
        },
      });

      if (response.status === 401) {
        showLogin();
        throw new Error('Unauthorized');
      }

      if (response.status === 204) {
        return null;
      }

      if (!response.ok) {
        const text = await response.text().catch(() => '');
        console.error(`API Error ${response.status} ${endpoint}:`, text);
        throw new Error(text || `HTTP ${response.status}`);
      }

      const contentType = response.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        return response.json();
      }
      return null;
    }

    // ===== LOGIN =====
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value;
      const code = document.getElementById('code').value;
      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = '';

      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code }),
          credentials: 'include',
        });

        if (!response.ok) {
          throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –∫–æ–¥');
        }

        currentUser = await response.json();
        await loadApp();

      } catch (error) {
        errorContainer.innerHTML = `
          <div class="error-message">
            ‚ùå ${error.message}
          </div>
        `;
      }
    });

    // ===== LOGOUT =====
    document.getElementById('logout-btn').addEventListener('click', async () => {
      try {
        await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
      } finally {
        showLogin();
      }
    });

    // ===== NAVIGATION =====
    const navToggle = document.getElementById('nav-toggle');
    const navPanel = document.getElementById('nav-panel');

    function setNavPanel(open) {
      if (!navPanel || !navToggle) return;
      navPanel.classList.toggle('open', open);
      navToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
    }

    function closeNavPanel() {
      setNavPanel(false);
    }

    if (navToggle && navPanel) {
      navToggle.addEventListener('click', () => {
        const isOpen = navPanel.classList.contains('open');
        setNavPanel(!isOpen);
      });
    }

    document.addEventListener('click', (event) => {
      if (!navPanel || !navToggle) return;
      if (!navPanel.contains(event.target) && !navToggle.contains(event.target)) {
        closeNavPanel();
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth > 980) {
        closeNavPanel();
      }
    });

    document.querySelectorAll('.nav-link[data-section]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = link.dataset.section;
        switchSection(section);
      });
    });

    document.querySelectorAll('.nav-link-external').forEach(link => {
      link.addEventListener('click', () => {
        closeNavPanel();
      });
    });

    function switchSection(section) {
      if ((section === 'admin' || section === 'advanced') && !isAdmin()) {
        return;
      }
      if (section === 'checkin' && !isTestCheckinUser()) {
        return;
      }
      currentSection = section;

      // Update nav
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`[data-section="${section}"]`).classList.add('active');
      closeNavPanel();

      // Update sections
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(`${section}-section`).classList.add('active');

      // Load data
      if (section === 'mindguard') {
        loadMindguardData();
      } else if (section === 'advanced') {
        loadAdvancedAnalytics();
      } else if (section === 'pulse') {
        loadPulseRooms();
      } else if (section === 'admin') {
        loadTeamHeatmap();
        loadAdminUsers();
      } else if (section === 'checkin') {
        loadCheckinStatus();
      }
    }

    // ===== LOAD APP =====
    async function loadApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');

      // Set user name
      document.getElementById('user-name').textContent = currentUser?.name || 'User';
      document.getElementById('user-role').textContent = currentUser?.role || '';

      const adminLink = document.getElementById('admin-link');
      const advancedLink = document.getElementById('advanced-link');
      const checkinLink = document.getElementById('checkin-link');
      if (isAdmin()) {
        adminLink.classList.remove('hidden');
        if (advancedLink) {
          advancedLink.classList.remove('hidden');
        }
        // Admin view - show all sections
        document.body.classList.remove('employee-view');
      } else {
        adminLink.classList.add('hidden');
        if (advancedLink) {
          advancedLink.classList.add('hidden');
        }
        // Employee view - hide admin sections
        document.body.classList.add('employee-view');
      }

      if (checkinLink) {
        if (isTestCheckinUser()) {
          checkinLink.classList.remove('hidden');
        } else {
          checkinLink.classList.add('hidden');
        }
      }

      if (checkinPendingSection === 'checkin' && isTestCheckinUser()) {
        checkinPendingSection = null;
        switchSection('checkin');
      }

      try {
        await loadMindguardData();
      } catch (error) {
        console.error('Mindguard data load failed:', error);
      }
    }

    function showLogin() {
      document.getElementById('app').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      currentUser = null;

      // Clear cached data to ensure fresh data on next login
      teamDashboardData = null;
      advancedData = null;
      wellnessPlan = null;
      wellnessGoals = null;
      insights = { selfBenchmark: null, correlations: [], earlySignal: null };
      pulseRooms = [];
      activePulseRoom = null;
      pulseMessages = [];
      checkinSession = null;
      checkinAudioStates = new Map();
      activeRecordingState = null;
      checkinPendingSection = null;
      checkinAutoStart = false;
    }

    function isAdmin() {
      return currentUser?.role === 'ADMIN' || currentUser?.role === 'FOUNDER';
    }

    function isTestCheckinUser() {
      const email = currentUser?.email?.toLowerCase();
      return email === TEST_CHECKIN_EMAIL;
    }

    // ===== MINDGUARD DATA =====
    async function loadMindguardData() {
      await loadTeamDashboardData();
      await loadTelegramStatus();
      await Promise.allSettled([
        loadInsights(),
      ]);

      if (isAdmin()) {
        await loadTeamHeatmap();
      } else {
        // For employees, load and display personal data
        await loadEmployeePersonalData();
      }
    }

    // ===== EMPLOYEE PERSONAL DATA =====
    let employeePersonalSelectedKey = null;
    let employeePersonalCharts = {};

    async function loadEmployeePersonalData() {
      const noDataMsg = document.getElementById('employee-no-data-message');
      const personalDataContainer = document.getElementById('employee-personal-data');
      const trendCard = document.getElementById('employee-trend-card');

      if (!noDataMsg || !personalDataContainer) return;

      // Get employee data from filtered teamDashboardData
      const currentUserId = currentUser?.user_id || currentUser?.id;
      if (!teamDashboardData || !teamDashboardData.months || teamDashboardData.months.length === 0) {
        noDataMsg.classList.remove('hidden');
        personalDataContainer.classList.add('hidden');
        if (trendCard) trendCard.style.display = 'none';
        return;
      }

      // Check if employee has any data
      let hasAnyData = false;
      for (const month of teamDashboardData.months) {
        if (month.employees && month.employees.length > 0) {
          const emp = month.employees.find(e =>
            e.userId === currentUserId || e.user_id === currentUserId || e.id === currentUserId
          );
          if (emp && (emp.hasData || emp.has_data || hasMetricData(emp))) {
            hasAnyData = true;
            break;
          }
        }
      }

      if (!hasAnyData) {
        noDataMsg.classList.remove('hidden');
        personalDataContainer.classList.add('hidden');
        if (trendCard) trendCard.style.display = 'none';
        return;
      }

      // Show personal data
      noDataMsg.classList.add('hidden');
      personalDataContainer.classList.remove('hidden');
      if (trendCard) trendCard.style.display = 'block';

      // Get available months
      const months = getTeamMonthList();
      if (!months.length) return;

      // Set selected month to latest if not set
      const latest = months[months.length - 1];
      const latestKey = monthKeyFromParts(latest.year, latest.month);
      if (!employeePersonalSelectedKey || !months.some(m => monthKeyFromParts(m.year, m.month) === employeePersonalSelectedKey)) {
        employeePersonalSelectedKey = latestKey;
      }

      // Render month selector
      renderEmployeePersonalMonthSelector();

      // Render metrics for selected month
      renderEmployeePersonalMetrics();

      // Render trend chart
      renderEmployeePersonalChart();
    }

    function renderEmployeePersonalMonthSelector() {
      const container = document.getElementById('employee-month-selector-personal');
      if (!container) return;
      container.innerHTML = '';

      const months = getTeamMonthList();
      const display = [...months].reverse();
      display.forEach(month => {
        const key = monthKeyFromParts(month.year, month.month);
        const button = document.createElement('button');
        button.className = `month-btn${key === employeePersonalSelectedKey ? ' active' : ''}`;
        button.textContent = monthLabelFromKey(key);
        button.addEventListener('click', () => {
          employeePersonalSelectedKey = key;
          renderEmployeePersonalMonthSelector();
          renderEmployeePersonalMetrics();
        });
        container.appendChild(button);
      });
    }

    function renderEmployeePersonalMetrics() {
      const currentUserId = currentUser?.user_id || currentUser?.id;
      const selectedMonth = teamDashboardData.months.find(m => monthKeyFromParts(m.year, m.month) === employeePersonalSelectedKey);

      if (!selectedMonth || !selectedMonth.employees) return;

      const emp = selectedMonth.employees.find(e =>
        e.userId === currentUserId || e.user_id === currentUserId || e.id === currentUserId
      );

      // Get metrics
      const metrics = emp?.metrics || emp || {};

      // Update all metric values
      updateMetricElement('employee-who5', metrics.who5);
      updateMetricElement('employee-phq9', metrics.phq9);
      updateMetricElement('employee-gad7', metrics.gad7);
      updateMetricElement('employee-mbi', metrics.mbi);
      updateMetricElement('employee-sleep-duration', metrics.sleepDuration || metrics.sleep_duration);
      updateMetricElement('employee-sleep-quality', metrics.sleepQuality || metrics.sleep_quality);
      updateMetricElement('employee-work-life', metrics.workLifeBalance || metrics.work_life_balance);
      updateMetricElement('employee-stress', metrics.stressLevel || metrics.stress_level);

      // Update meta info
      const metaEl = document.getElementById('employee-data-meta');
      if (metaEl && selectedMonth) {
        const monthLabel = monthLabelFromKey(employeePersonalSelectedKey);
        const participants = selectedMonth.participants || 0;
        const responses = selectedMonth.responses || 0;
        metaEl.innerHTML = `<div class="data-pill">–ü–µ—Ä—ñ–æ–¥: <span class="mono">${monthLabel}</span></div><div class="data-pill">–í—ñ–¥–ø–æ–≤—ñ–¥–µ–π: <span class="mono">${responses}</span></div>`;
      }
    }

    function updateMetricElement(prefix, value) {
      const valueEl = document.getElementById(`${prefix}-value`);
      const riskEl = document.getElementById(`${prefix}-risk`);

      if (valueEl) {
        const metric = prefix.replace('employee-', '').replace(/-/g, '_');
        const formattedValue = metricOrDash(value, metric === 'mbi' ? '%' : '');
        valueEl.textContent = formattedValue;
        valueEl.className = `metric-value ${getScoreClass(metric, value)}`;
      }

      if (riskEl) {
        const metric = prefix.replace('employee-', '').replace(/-/g, '_');
        const risk = getRiskLevel(metric, value);
        riskEl.className = `risk-indicator risk-${risk}`;
        riskEl.textContent = getRiskLabel(risk);
      }
    }

    function renderEmployeePersonalChart() {
      const ctx = document.getElementById('employeeTrendChart');
      if (!ctx) return;

      if (employeePersonalCharts.trend) {
        employeePersonalCharts.trend.destroy();
      }

      const currentUserId = currentUser?.user_id || currentUser?.id;
      const months = getTeamMonthList();
      const labels = months.map(m => monthLabelFromKey(monthKeyFromParts(m.year, m.month), true));

      const values = (key) => months.map(m => {
        const monthKey = monthKeyFromParts(m.year, m.month);
        const monthData = teamDashboardData.months.find(md => monthKeyFromParts(md.year, md.month) === monthKey);
        if (!monthData || !monthData.employees) return null;

        const emp = monthData.employees.find(e =>
          e.userId === currentUserId || e.user_id === currentUserId || e.id === currentUserId
        );
        if (!emp) return null;

        const metrics = emp.metrics || emp;
        const value = metrics[key] ?? metrics[key.replace(/([A-Z])/g, '_$1').toLowerCase()];
        return Number.isFinite(value) ? value : null;
      });

      employeePersonalCharts.trend = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'WHO-5', metricKey: 'who5', data: values('who5'), borderColor: '#1f8f3a', tension: 0.35, borderWidth: 3 },
            { label: 'PHQ-9', metricKey: 'phq9', data: values('phq9'), borderColor: '#ffb000', tension: 0.35, borderWidth: 3 },
            { label: 'GAD-7', metricKey: 'gad7', data: values('gad7'), borderColor: '#ff595e', tension: 0.35, borderWidth: 3 },
            { label: 'MBI (%)', metricKey: 'mbi', data: values('mbi'), borderColor: '#6a4c93', tension: 0.35, borderWidth: 3 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: (context) => {
                  const key = context.dataset.metricKey;
                  const hint = METRIC_HINTS[key] || '';
                  const value = Number.isFinite(context.parsed.y) ? context.parsed.y.toFixed(1) : '‚Äî';
                  return `${context.dataset.label}: ${value}${hint ? ' (' + hint + ')' : ''}`;
                }
              }
            }
          },
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    // ===== TEAM DASHBOARD =====
    const MONTH_LABELS = {
      1: '–°—ñ—á–µ–Ω—å',
      2: '–õ—é—Ç–∏–π',
      3: '–ë–µ—Ä–µ–∑–µ–Ω—å',
      4: '–ö–≤—ñ—Ç–µ–Ω—å',
      5: '–¢—Ä–∞–≤–µ–Ω—å',
      6: '–ß–µ—Ä–≤–µ–Ω—å',
      7: '–õ–∏–ø–µ–Ω—å',
      8: '–°–µ—Ä–ø–µ–Ω—å',
      9: '–í–µ—Ä–µ—Å–µ–Ω—å',
      10: '–ñ–æ–≤—Ç–µ–Ω—å',
      11: '–õ–∏—Å—Ç–æ–ø–∞–¥',
      12: '–ì—Ä—É–¥–µ–Ω—å',
    };

    const MONTH_LABELS_SHORT = {
      1: '–°—ñ—á',
      2: '–õ—é—Ç',
      3: '–ë–µ—Ä',
      4: '–ö–≤—ñ—Ç',
      5: '–¢—Ä–∞–≤',
      6: '–ß–µ—Ä–≤',
      7: '–õ–∏–ø',
      8: '–°–µ—Ä–ø',
      9: '–í–µ—Ä',
      10: '–ñ–æ–≤—Ç',
      11: '–õ–∏—Å—Ç',
      12: '–ì—Ä—É–¥',
    };

    const METRIC_HINTS = {
      who5: 'WHO-5: 0-100, <50 ‚Äî —Ä–∏–∑–∏–∫ –Ω–∏–∑—å–∫–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è',
      phq9: 'PHQ-9: 0-27, >10 ‚Äî –ø–æ–º—ñ—Ä–Ω–∞/–≤–∏—Å–æ–∫–∞ –¥–µ–ø—Ä–µ—Å–∏–≤–Ω–∞ —Å–∏–º–ø—Ç–æ–º–∞—Ç–∏–∫–∞',
      gad7: 'GAD-7: 0-21, >10 ‚Äî –ø–æ–º—ñ—Ä–Ω–∞/–≤–∏—Å–æ–∫–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å',
      mbi: 'MBI: 0-100%, >40% ‚Äî –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è',
      sleepDuration: '–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É: —Ü—ñ–ª—å 7-9 –≥–æ–¥',
      sleepQuality: '–Ø–∫—ñ—Å—Ç—å —Å–Ω—É: 1-10, <6 ‚Äî –ø–æ–≥—ñ—Ä—à–µ–Ω–Ω—è',
      workLifeBalance: '–ë–∞–ª–∞–Ω—Å: 1-10, <6 ‚Äî –¥–∏—Å–±–∞–ª–∞–Ω—Å',
      stressLevel: '–°—Ç—Ä–µ—Å: 0-40, >20 ‚Äî –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π',
    };

    const METRIC_KEYS = [
      'who5',
      'phq9',
      'gad7',
      'mbi',
      'sleepDuration',
      'sleepQuality',
      'workLifeBalance',
      'stressLevel',
    ];

    function hasMetricData(metrics) {
      if (!metrics) return false;
      return METRIC_KEYS.some(key => Number.isFinite(metrics[key]) && metrics[key] !== 0);
    }

    function hasMonthData(month) {
      if (!month) return false;
      const participants = Number.isFinite(month.participants) ? month.participants : null;
      const responses = Number.isFinite(month.responses) ? month.responses : null;
      if (participants !== null) {
        if (participants > 0) return true;
        if (responses !== null) return responses > 0;
        return false;
      }
      if (responses !== null) return responses > 0;
      return hasMetricData(month.averages);
    }

    function metricOrDash(value, suffix = '', digits = 1) {
      if (!Number.isFinite(value)) return '‚Äî';
      return `${value.toFixed(digits)}${suffix}`;
    }

    function hasEmployeeData(employee) {
      if (!employee) return false;
      if (employee.hasData !== undefined) return employee.hasData;
      if (employee.has_data !== undefined) return employee.has_data;
      const metrics = employee.metrics || employee;
      return hasMetricData(metrics);
    }

    function monthKeyFromParts(year, month) {
      return `${year}-${String(month).padStart(2, '0')}`;
    }

    function parseMonthKey(key) {
      const [year, month] = key.split('-').map(Number);
      return { year, month };
    }

    function monthLabelFromKey(key, short = false) {
      const { year, month } = parseMonthKey(key);
      const label = short ? MONTH_LABELS_SHORT[month] : MONTH_LABELS[month];
      return `${label || '–ú—ñ—Å—è—Ü—å'} ${year}`;
    }

    function compareMonthKeys(a, b) {
      const pa = parseMonthKey(a);
      const pb = parseMonthKey(b);
      if (pa.year !== pb.year) return pa.year - pb.year;
      return pa.month - pb.month;
    }

    function formatDate(value) {
      if (!value) return '‚Äî';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleDateString('uk-UA', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatDateTime(value) {
      if (!value) return '‚Äî';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleString('uk-UA', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function getTeamMonthList() {
      if (!teamDashboardData?.months) return [];
      return [...teamDashboardData.months].sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
      });
    }

    function getTeamMonthByKey(key) {
      const months = getTeamMonthList();
      return months.find(m => monthKeyFromParts(m.year, m.month) === key) || null;
    }

    function getCoverageMap() {
      const map = {};
      const months = getTeamMonthList();
      months.forEach(m => {
        const key = monthKeyFromParts(m.year, m.month);
        map[key] = {
          participants: Number.isFinite(m.participants) ? m.participants : 0,
          responses: Number.isFinite(m.responses) ? m.responses : 0,
        };
      });
      return map;
    }

    function hasCoverageForKey(key) {
      const coverage = getCoverageMap();
      const entry = coverage[key];
      if (!entry) return false;
      return entry.participants > 0 || entry.responses > 0;
    }

    async function loadTeamDashboardData() {
      const monthSelector = document.getElementById('team-month-selector');
      const employeeBody = document.getElementById('employee-table-body');
      try {
        teamDashboardData = await apiCall('/api/team-data');
      } catch (error) {
        if (monthSelector) {
          monthSelector.innerHTML = '<span class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ</span>';
        }
        if (employeeBody) {
          employeeBody.innerHTML = '<tr><td colspan="10">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</td></tr>';
        }
        return;
      }

      // Backend already filters data for non-admin users

      const months = getTeamMonthList();
      if (!months.length) {
        if (monthSelector) {
          monthSelector.innerHTML = '<span class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</span>';
        }
        return;
      }

      const latest = months[months.length - 1];
      const latestKey = monthKeyFromParts(latest.year, latest.month);
      if (!teamDashboardSelectedKey || !months.some(m => monthKeyFromParts(m.year, m.month) === teamDashboardSelectedKey)) {
        teamDashboardSelectedKey = latestKey;
      }
      if (!teamDashboardEmployeeKey || !months.some(m => monthKeyFromParts(m.year, m.month) === teamDashboardEmployeeKey)) {
        teamDashboardEmployeeKey = latestKey;
      }

      renderTeamMonthSelector();
      renderEmployeeMonthSelector();
      renderTeamMetrics();
      renderTeamTrendChart();
      renderEmployeeTable();
      renderRiskAssessment();
      renderTeamMeta();
    }

    function renderTeamMonthSelector() {
      const container = document.getElementById('team-month-selector');
      if (!container) return;
      container.innerHTML = '';

      const months = getTeamMonthList();
      const display = [...months].reverse();
      display.forEach(month => {
        const key = monthKeyFromParts(month.year, month.month);
        const hasData = hasMonthData(month);
        const button = document.createElement('button');
        button.className = `month-btn${key === teamDashboardSelectedKey ? ' active' : ''}${hasData ? '' : ' disabled'}`;
        if (!hasData) {
          button.title = '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –º—ñ—Å—è—Ü—å';
        }
        button.textContent = monthLabelFromKey(key);
        button.addEventListener('click', () => {
          teamDashboardSelectedKey = key;
          renderTeamMonthSelector();
          renderTeamMetrics();
          renderRiskAssessment();
        });
        container.appendChild(button);
      });

      updateDashboardDecemberNotice();
    }

    function updateDashboardDecemberNotice() {
      const notice = document.getElementById('dashboardDecemberNotice');
      if (!notice || !teamDashboardSelectedKey) return;
      const { month } = parseMonthKey(teamDashboardSelectedKey);
      notice.style.display = month === 12 ? 'block' : 'none';
    }

    function renderEmployeeMonthSelector() {
      const container = document.getElementById('employee-month-selector');
      if (!container) return;
      container.innerHTML = '';

      const months = getTeamMonthList();
      const display = [...months].reverse();
      display.forEach(month => {
        const key = monthKeyFromParts(month.year, month.month);
        const hasData = hasMonthData(month);
        const button = document.createElement('button');
        button.className = `employee-month-btn${key === teamDashboardEmployeeKey ? ' active' : ''}${hasData ? '' : ' disabled'}`;
        if (!hasData) {
          button.title = '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –º—ñ—Å—è—Ü—å';
        }
        button.textContent = monthLabelFromKey(key);
        button.addEventListener('click', () => {
          teamDashboardEmployeeKey = key;
          renderEmployeeMonthSelector();
          renderEmployeeTable();
        });
        container.appendChild(button);
      });
    }

    function getSelectedTeamMonth() {
      if (!teamDashboardSelectedKey) return null;
      return getTeamMonthByKey(teamDashboardSelectedKey);
    }

    function getRiskLevel(metric, value) {
      // Normalize metric key to camelCase
      const normalizeKey = (key) => {
        // Convert snake_case or kebab-case to camelCase
        return key.replace(/[-_]([a-z])/g, (_, letter) => letter.toUpperCase());
      };

      const normalizedMetric = normalizeKey(metric);

      // Map shortened keys to full threshold keys
      const keyMap = {
        'workLife': 'workLifeBalance',
        'stress': 'stressLevel',
      };

      const finalMetric = keyMap[normalizedMetric] || normalizedMetric;

      const thresholds = {
        who5: { critical: 35, low: 50, medium: 75 },
        phq9: { critical: 15, low: 5, medium: 10 },
        gad7: { critical: 15, low: 5, medium: 10 },
        mbi: { critical: 70, low: 25, medium: 50 },
        sleepDuration: { critical: 5.5, low: 6, medium: 7 },
        sleepQuality: { critical: 3, low: 4, medium: 7 },
        workLifeBalance: { critical: 3, low: 4, medium: 7 },
        stressLevel: { critical: 30, low: 14, medium: 27 },
      };

      const t = thresholds[finalMetric];
      if (!t || value === null || value === undefined || !Number.isFinite(value)) return 'unknown';

      // Lower is worse for these metrics (reverse logic)
      if (['who5', 'sleepDuration', 'sleepQuality', 'workLifeBalance'].includes(finalMetric)) {
        if (value < t.critical) return 'critical';
        if (value < t.low) return 'high';
        if (value < t.medium) return 'medium';
        return 'low';
      }

      // Higher is worse for these metrics (normal logic)
      if (value >= t.critical) return 'critical';
      if (value >= t.medium) return 'high';
      if (value >= t.low) return 'medium';
      return 'low';
    }

    function updateRiskIndicator(elementId, riskLevel) {
      const element = document.getElementById(elementId);
      if (!element) return;

      // Softer, supportive language for employees viewing their own data
      const labels = isAdmin() ? {
        low: '–ù–∏–∑—å–∫–∏–π —Ä–∏–∑–∏–∫',
        medium: '–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫',
        high: '–í–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫',
        critical: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π —Ä–∏–∑–∏–∫',
        unknown: '–ù/–î',
      } : {
        low: '–í—Å–µ –¥–æ–±—Ä–µ',
        medium: '–í–∞—Ä—Ç–æ –ø–æ–¥–±–∞—Ç–∏ –ø—Ä–æ —Å–µ–±–µ',
        high: '–†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –∑–≤–µ—Ä–Ω—É—Ç–∏ —É–≤–∞–≥—É',
        critical: '–í–∞—Ä—Ç–æ –ø–æ—Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é',
        unknown: '–ù/–î',
      };

      const level = riskLevel || 'unknown';
      element.textContent = labels[level] || '–ù/–î';
      element.className = `risk-indicator risk-${level}`;
    }

    function renderTeamMetrics() {
      const data = getSelectedTeamMonth();
      if (!data || !data.averages) return;
      const avg = data.averages;
      const hasData = hasMonthData(data);

      if (!hasData) {
        document.getElementById('who5-value').textContent = '‚Äî';
        updateRiskIndicator('who5-risk', 'unknown');

        document.getElementById('phq9-value').textContent = '‚Äî';
        updateRiskIndicator('phq9-risk', 'unknown');

        document.getElementById('gad7-value').textContent = '‚Äî';
        updateRiskIndicator('gad7-risk', 'unknown');

        document.getElementById('mbi-value').textContent = '‚Äî';
        updateRiskIndicator('mbi-risk', 'unknown');

        document.getElementById('sleep-duration-value').textContent = '‚Äî';
        updateRiskIndicator('sleep-duration-risk', 'unknown');

        document.getElementById('sleep-quality-value').textContent = '‚Äî';
        updateRiskIndicator('sleep-quality-risk', 'unknown');

        document.getElementById('work-life-value').textContent = '‚Äî';
        updateRiskIndicator('work-life-risk', 'unknown');

        document.getElementById('stress-value').textContent = '‚Äî';
        updateRiskIndicator('stress-risk', 'unknown');
      } else {
        document.getElementById('who5-value').textContent = metricOrDash(avg.who5);
        updateRiskIndicator('who5-risk', getRiskLevel('who5', avg.who5));

        document.getElementById('phq9-value').textContent = metricOrDash(avg.phq9);
        updateRiskIndicator('phq9-risk', getRiskLevel('phq9', avg.phq9));

        document.getElementById('gad7-value').textContent = metricOrDash(avg.gad7);
        updateRiskIndicator('gad7-risk', getRiskLevel('gad7', avg.gad7));

        document.getElementById('mbi-value').textContent = metricOrDash(avg.mbi, '%');
        updateRiskIndicator('mbi-risk', getRiskLevel('mbi', avg.mbi));

        document.getElementById('sleep-duration-value').textContent = metricOrDash(avg.sleepDuration, ' –≥–æ–¥');
        updateRiskIndicator('sleep-duration-risk', getRiskLevel('sleepDuration', avg.sleepDuration));

        document.getElementById('sleep-quality-value').textContent = metricOrDash(avg.sleepQuality);
        updateRiskIndicator('sleep-quality-risk', getRiskLevel('sleepQuality', avg.sleepQuality));

        document.getElementById('work-life-value').textContent = metricOrDash(avg.workLifeBalance);
        updateRiskIndicator('work-life-risk', getRiskLevel('workLifeBalance', avg.workLifeBalance));

        document.getElementById('stress-value').textContent = metricOrDash(avg.stressLevel);
        updateRiskIndicator('stress-risk', getRiskLevel('stressLevel', avg.stressLevel));

        // Pinpoints –¥–ª—è –∫–æ–∂–Ω–æ—ó –º–µ—Ç—Ä–∏–∫–∏
        updateMetricPinpoints('who5-pinpoints', 'who5', avg.who5, data);
        updateMetricPinpoints('phq9-pinpoints', 'phq9', avg.phq9, data);
        updateMetricPinpoints('gad7-pinpoints', 'gad7', avg.gad7, data);
        updateMetricPinpoints('mbi-pinpoints', 'mbi', avg.mbi, data);
        updateMetricPinpoints('sleep-duration-pinpoints', 'sleepDuration', avg.sleepDuration, data);
        updateMetricPinpoints('sleep-quality-pinpoints', 'sleepQuality', avg.sleepQuality, data);
        updateMetricPinpoints('work-life-pinpoints', 'workLifeBalance', avg.workLifeBalance, data);
        updateMetricPinpoints('stress-pinpoints', 'stressLevel', avg.stressLevel, data);
      }

      renderTeamCoverage();
    }

    function updateMetricPinpoints(elementId, metric, value, data) {
      const el = document.getElementById(elementId);
      if (!el) return;

      const employees = data?.employees || [];
      const atRisk = employees.filter(emp => {
        const empValue = emp[metric];
        if (empValue === null || empValue === undefined) return false;
        const risk = getRiskLevel(metric, empValue);
        return risk === 'high' || risk === 'critical';
      });

      if (atRisk.length === 0) {
        el.innerHTML = '';
        return;
      }

      const names = atRisk.slice(0, 3).map(e => e.name).join(', ');
      const remaining = atRisk.length > 3 ? ` —Ç–∞ —â–µ ${atRisk.length - 3}` : '';
      el.textContent = `‚ö†Ô∏è –†–∏–∑–∏–∫: ${names}${remaining}`;
    }

    function renderTeamCoverage() {
      const coverageEl = document.getElementById('team-data-coverage');
      if (!coverageEl) return;
      const data = getSelectedTeamMonth();
      if (!data) {
        coverageEl.innerHTML = '';
        return;
      }

      const total = data.employees?.length ?? 0;
      const participants = Number.isFinite(data.participants) ? data.participants : 0;
      const responses = Number.isFinite(data.responses) ? data.responses : 0;

      if (!hasMonthData(data)) {
        coverageEl.innerHTML = '<div class="data-pill">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ —Ü–µ–π –º—ñ—Å—è—Ü—å</div>';
        return;
      }

      const responsesLabel = responses > 0 ? responses : '‚Äî';
      coverageEl.innerHTML = `
        <div class="data-pill">–£—á–∞—Å–Ω–∏–∫—ñ–≤: <span class="mono">${participants}/${total}</span></div>
        <div class="data-pill">–í—ñ–¥–ø–æ–≤—ñ–¥–µ–π: <span class="mono">${responsesLabel}</span></div>
      `;
    }

    function getScoreClass(metric, value) {
      const risk = getRiskLevel(metric, value);
      if (risk === 'low') return 'score-good';
      if (risk === 'medium') return 'score-warning';
      if (risk === 'unknown') return 'score-muted';
      return 'score-danger';
    }

    function getRiskLabel(risk) {
      // Softer, supportive language for employees
      const labels = isAdmin() ? {
        low: '–ù–∏–∑—å–∫–∏–π',
        medium: '–°–µ—Ä–µ–¥–Ω—ñ–π',
        high: '–í–∏—Å–æ–∫–∏–π',
        critical: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π',
        unknown: '–ù/–î',
      } : {
        low: '–í—Å–µ –¥–æ–±—Ä–µ',
        medium: '–í–∞—Ä—Ç–æ –ø–æ–¥–±–∞—Ç–∏ –ø—Ä–æ —Å–µ–±–µ',
        high: '–†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –∑–≤–µ—Ä–Ω—É—Ç–∏ —É–≤–∞–≥—É',
        critical: '–í–∞—Ä—Ç–æ –ø–æ—Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é',
        unknown: '–ù/–î',
      };
      return labels[risk] || '–ù–µ–≤—ñ–¥–æ–º–æ';
    }

    function renderTeamTrendChart() {
      const months = getTeamMonthList();
      if (!months.length) return;

      const labels = months.map(m => monthLabelFromKey(monthKeyFromParts(m.year, m.month), true));
      const ctx = document.getElementById('teamTrendChart');
      if (!ctx) return;

      if (teamDashboardCharts.teamTrend) {
        teamDashboardCharts.teamTrend.destroy();
      }

      const values = (key) => months.map(m => (hasMonthData(m) ? (m.averages?.[key] ?? null) : null));

      teamDashboardCharts.teamTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'WHO-5',
              metricKey: 'who5',
              data: values('who5'),
              borderColor: '#1f8f3a',
              tension: 0.35,
              borderWidth: 3,
            },
            {
              label: 'PHQ-9',
              metricKey: 'phq9',
              data: values('phq9'),
              borderColor: '#ffb000',
              tension: 0.35,
              borderWidth: 3,
            },
            {
              label: 'GAD-7',
              metricKey: 'gad7',
              data: values('gad7'),
              borderColor: '#ff595e',
              tension: 0.35,
              borderWidth: 3,
            },
            {
              label: 'MBI (%)',
              metricKey: 'mbi',
              data: values('mbi'),
              borderColor: '#6a4c93',
              tension: 0.35,
              borderWidth: 3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: (context) => {
                  const key = context.dataset.metricKey;
                  const hint = METRIC_HINTS[key] || '';
                  const value = Number.isFinite(context.parsed.y) ? context.parsed.y.toFixed(1) : '‚Äî';
                  return `${context.dataset.label}: ${value}${hint ? ' (' + hint + ')' : ''}`;
                }
              }
            }
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    function renderEmployeeTable() {
      const data = teamDashboardEmployeeKey ? getTeamMonthByKey(teamDashboardEmployeeKey) : null;
      const tbody = document.getElementById('employee-table-body');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!data || !data.employees || data.employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
        return;
      }

      data.employees.forEach(emp => {
        const hasData = emp.hasData ?? emp.has_data ?? hasMetricData(emp);
        const who5 = hasData ? emp.who5 : null;
        const phq9 = hasData ? emp.phq9 : null;
        const gad7 = hasData ? emp.gad7 : null;
        const mbi = hasData ? emp.mbi : null;
        const sleepDuration = hasData ? emp.sleepDuration : null;
        const sleepQuality = hasData ? emp.sleepQuality : null;
        const workLifeBalance = hasData ? emp.workLifeBalance : null;
        const stressLevel = hasData ? emp.stressLevel : null;

        const risks = [
          getRiskLevel('who5', who5),
          getRiskLevel('phq9', phq9),
          getRiskLevel('gad7', gad7),
          getRiskLevel('mbi', mbi),
          getRiskLevel('sleepDuration', sleepDuration),
          getRiskLevel('sleepQuality', sleepQuality),
          getRiskLevel('workLifeBalance', workLifeBalance),
          getRiskLevel('stressLevel', stressLevel),
        ];

        const criticalCount = risks.filter(r => r === 'critical').length;
        const highCount = risks.filter(r => r === 'high').length;
        const mediumCount = risks.filter(r => r === 'medium').length;

        let overallRisk = 'low';
        if (!hasData) {
          overallRisk = 'unknown';
        } else if (criticalCount >= 1) {
          overallRisk = 'critical';
        } else if (highCount >= 3 || (highCount >= 2 && mediumCount >= 3)) {
          overallRisk = 'high';
        } else if (highCount >= 1 || mediumCount >= 3) {
          overallRisk = 'medium';
        }

        const row = document.createElement('tr');
        const userId = emp.userId || emp.user_id || emp.id || '';
        row.innerHTML = `
          <td class="employee-name clickable" onclick="openEmployeeModal('${userId}')">${emp.name}</td>
          <td class="score-cell ${getScoreClass('who5', who5)}">${metricOrDash(who5)}</td>
          <td class="score-cell ${getScoreClass('phq9', phq9)}">${metricOrDash(phq9)}</td>
          <td class="score-cell ${getScoreClass('gad7', gad7)}">${metricOrDash(gad7)}</td>
          <td class="score-cell ${getScoreClass('mbi', mbi)}">${metricOrDash(mbi, '%')}</td>
          <td class="score-cell ${getScoreClass('sleepDuration', sleepDuration)}">${metricOrDash(sleepDuration)}</td>
          <td class="score-cell ${getScoreClass('sleepQuality', sleepQuality)}">${metricOrDash(sleepQuality)}</td>
          <td class="score-cell ${getScoreClass('workLifeBalance', workLifeBalance)}">${metricOrDash(workLifeBalance)}</td>
          <td class="score-cell ${getScoreClass('stressLevel', stressLevel)}">${metricOrDash(stressLevel)}</td>
          <td class="score-cell"><span class="risk-indicator risk-${overallRisk}">${getRiskLabel(overallRisk)}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderRiskAssessment() {
      const data = getSelectedTeamMonth();
      if (!data || !data.averages) return;

      const container = document.getElementById('risk-items');
      if (!container) return;
      container.innerHTML = '';

      if (!hasMonthData(data)) {
        container.innerHTML = `
          <div class="risk-item low">
            <div class="risk-item-title">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –æ–±—Ä–∞–Ω–∏–π –º—ñ—Å—è—Ü—å</div>
            <div class="risk-item-description">–î–æ–¥–∞–π—Ç–µ —á–µ–∫—ñ–Ω–∏, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –æ—Ü—ñ–Ω–∫—É —Ä–∏–∑–∏–∫—ñ–≤.</div>
          </div>
        `;
        return;
      }

      const avg = data.averages;
      const risks = [];

      if (avg.who5 < 35) {
        risks.push({ level: 'critical', title: '–ö—Ä–∏—Ç–∏—á–Ω–æ –Ω–∏–∑—å–∫–∏–π —Ä—ñ–≤–µ–Ω—å –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è', description: `WHO-5: ${avg.who5.toFixed(1)}.` });
      } else if (avg.who5 < 50) {
        risks.push({ level: 'high', title: '–ù–∏–∑—å–∫–∏–π —Ä—ñ–≤–µ–Ω—å –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è', description: `WHO-5: ${avg.who5.toFixed(1)}.` });
      } else if (avg.who5 < 75) {
        risks.push({ level: 'medium', title: '–ó–Ω–∏–∂–µ–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è', description: `WHO-5: ${avg.who5.toFixed(1)}.` });
      }

      if (avg.phq9 >= 15) {
        risks.push({ level: 'critical', title: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –¥–µ–ø—Ä–µ—Å—ñ—ó', description: `PHQ-9: ${avg.phq9.toFixed(1)}.` });
      } else if (avg.phq9 >= 10) {
        risks.push({ level: 'high', title: '–ü—ñ–¥–≤–∏—â–µ–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –¥–µ–ø—Ä–µ—Å—ñ—ó', description: `PHQ-9: ${avg.phq9.toFixed(1)}.` });
      } else if (avg.phq9 >= 5) {
        risks.push({ level: 'medium', title: '–ü–æ–º—ñ—Ä–Ω—ñ –æ–∑–Ω–∞–∫–∏ –¥–µ–ø—Ä–µ—Å—ñ—ó', description: `PHQ-9: ${avg.phq9.toFixed(1)}.` });
      }

      if (avg.gad7 >= 15) {
        risks.push({ level: 'critical', title: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å —Ç—Ä–∏–≤–æ–∂–Ω–æ—Å—Ç—ñ', description: `GAD-7: ${avg.gad7.toFixed(1)}.` });
      } else if (avg.gad7 >= 10) {
        risks.push({ level: 'high', title: '–í–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Ç—Ä–∏–≤–æ–∂–Ω–æ—Å—Ç—ñ', description: `GAD-7: ${avg.gad7.toFixed(1)}.` });
      } else if (avg.gad7 >= 5) {
        risks.push({ level: 'medium', title: '–ü—ñ–¥–≤–∏—â–µ–Ω–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å', description: `GAD-7: ${avg.gad7.toFixed(1)}.` });
      }

      if (avg.mbi >= 70) {
        risks.push({ level: 'critical', title: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è', description: `MBI: ${avg.mbi.toFixed(1)}%.` });
      } else if (avg.mbi >= 50) {
        risks.push({ level: 'high', title: '–í–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è', description: `MBI: ${avg.mbi.toFixed(1)}%.` });
      } else if (avg.mbi >= 25) {
        risks.push({ level: 'medium', title: '–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è', description: `MBI: ${avg.mbi.toFixed(1)}%.` });
      }

      if (avg.sleepDuration < 5.5) {
        risks.push({ level: 'critical', title: '–ö—Ä–∏—Ç–∏—á–Ω–æ –Ω–∏–∑—å–∫–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É', description: `–°–æ–Ω: ${avg.sleepDuration.toFixed(1)} –≥–æ–¥.` });
      } else if (avg.sleepDuration < 6) {
        risks.push({ level: 'high', title: '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—è —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É', description: `–°–æ–Ω: ${avg.sleepDuration.toFixed(1)} –≥–æ–¥.` });
      } else if (avg.sleepDuration < 7) {
        risks.push({ level: 'medium', title: '–ó–Ω–∏–∂–µ–Ω–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É', description: `–°–æ–Ω: ${avg.sleepDuration.toFixed(1)} –≥–æ–¥.` });
      }

      if (avg.sleepQuality < 3) {
        risks.push({ level: 'critical', title: '–ö—Ä–∏—Ç–∏—á–Ω–æ –ø–æ–≥–∞–Ω–∞ —è–∫—ñ—Å—Ç—å —Å–Ω—É', description: `–Ø–∫—ñ—Å—Ç—å —Å–Ω—É: ${avg.sleepQuality.toFixed(1)}.` });
      } else if (avg.sleepQuality < 4) {
        risks.push({ level: 'high', title: '–ü–æ–≥–∞–Ω–∞ —è–∫—ñ—Å—Ç—å —Å–Ω—É', description: `–Ø–∫—ñ—Å—Ç—å —Å–Ω—É: ${avg.sleepQuality.toFixed(1)}.` });
      } else if (avg.sleepQuality < 7) {
        risks.push({ level: 'medium', title: '–ó–∞–¥–æ–≤—ñ–ª—å–Ω–∞ —è–∫—ñ—Å—Ç—å —Å–Ω—É', description: `–Ø–∫—ñ—Å—Ç—å —Å–Ω—É: ${avg.sleepQuality.toFixed(1)}.` });
      }

      if (avg.workLifeBalance < 3) {
        risks.push({ level: 'critical', title: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å –∂–∏—Ç—Ç—è', description: `–ë–∞–ª–∞–Ω—Å: ${avg.workLifeBalance.toFixed(1)}.` });
      } else if (avg.workLifeBalance < 4) {
        risks.push({ level: 'high', title: '–°–∏–ª—å–Ω–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å –∂–∏—Ç—Ç—è', description: `–ë–∞–ª–∞–Ω—Å: ${avg.workLifeBalance.toFixed(1)}.` });
      } else if (avg.workLifeBalance < 7) {
        risks.push({ level: 'medium', title: '–ü–æ—Ç—Ä–µ–±—É—î –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É', description: `–ë–∞–ª–∞–Ω—Å: ${avg.workLifeBalance.toFixed(1)}.` });
      }

      if (avg.stressLevel >= 30) {
        risks.push({ level: 'critical', title: '–ö—Ä–∏—Ç–∏—á–Ω–æ –≤–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É', description: `–°—Ç—Ä–µ—Å: ${avg.stressLevel.toFixed(1)}.` });
      } else if (avg.stressLevel >= 27) {
        risks.push({ level: 'high', title: '–í–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É', description: `–°—Ç—Ä–µ—Å: ${avg.stressLevel.toFixed(1)}.` });
      } else if (avg.stressLevel >= 14) {
        risks.push({ level: 'medium', title: '–ü–æ–º—ñ—Ä–Ω–∏–π —Ä—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É', description: `–°—Ç—Ä–µ—Å: ${avg.stressLevel.toFixed(1)}.` });
      }

      if (!risks.length) {
        risks.push({ level: 'low', title: '–ö–æ–º–∞–Ω–¥–∞ –≤ —Ö–æ—Ä–æ—à–æ–º—É —Å—Ç–∞–Ω—ñ', description: '–í—Å—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤ –º–µ–∂–∞—Ö –Ω–æ—Ä–º–∏.' });
      }

      risks.sort((a, b) => {
        const order = { critical: 0, high: 1, medium: 2, low: 3 };
        return order[a.level] - order[b.level];
      });

      risks.forEach(risk => {
        const item = document.createElement('div');
        item.className = `risk-item ${risk.level}`;
        item.innerHTML = `
          <div class="risk-item-title">${risk.title}</div>
          <div class="risk-item-description">${risk.description}</div>
        `;
        container.appendChild(item);
      });
    }

    function formatFrequency(value) {
      if (!value) return '‚Äî';
      if (value === 'monthly') return '–©–æ–º—ñ—Å—è—Ü—è';
      if (value === 'weekly') return '–©–æ—Ç–∏–∂–Ω—è';
      return value;
    }

    function renderTeamMeta() {
      const metaEl = document.getElementById('team-data-meta');
      if (!metaEl) return;

      const meta = teamDashboardData?.metadata || {};
      const updated = teamDashboardData?.lastUpdated || teamDashboardData?.last_updated;
      const items = [];

      if (teamDashboardData?.company) items.push({ label: '–ö–æ–º–ø–∞–Ω—ñ—è', value: teamDashboardData.company });
      if (updated) items.push({ label: '–û–Ω–æ–≤–ª–µ–Ω–æ', value: formatDate(updated) });
      if (meta.dataCollectionPeriod) items.push({ label: '–ü–µ—Ä—ñ–æ–¥', value: meta.dataCollectionPeriod });
      if (meta.participationRate) items.push({ label: '–£—á–∞—Å—Ç—å', value: meta.participationRate });
      if (meta.nextAssessment) items.push({ label: '–ù–∞—Å—Ç—É–ø–Ω–∞ –æ—Ü—ñ–Ω–∫–∞', value: formatDate(meta.nextAssessment) });
      if (meta.updateFrequency) items.push({ label: '–û–Ω–æ–≤–ª–µ–Ω–Ω—è', value: formatFrequency(meta.updateFrequency) });

      metaEl.innerHTML = items.length
        ? items.map(item => `<div class="data-pill">${item.label}: <span class="mono">${item.value}</span></div>`).join('')
        : '<div class="form-hint">–ú–µ—Ç–∞–¥–∞–Ω—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ</div>';
    }

    async function openEmployeeModal(employeeId) {
      if (!employeeId) return;

      // Regular employees can only view their own data
      if (!isAdmin()) {
        const currentUserId = currentUser?.user_id || currentUser?.id;
        if (employeeId !== currentUserId) {
          return; // Silently reject access to other employees' data
        }
      }

      try {
        // Always reload data to ensure fresh and correct data
        advancedData = await apiCall('/api/employee-data');
      } catch (error) {
        return;
      }

      // Backend already filters data for non-admin users

      const employee = advancedData?.employees?.find(e => e.userId === employeeId || e.user_id === employeeId || e.id === employeeId);
      if (!employee) return;

      document.getElementById('modalEmployeeName').textContent = employee.name;

      const hasData = hasEmployeeData(employee);
      const m = hasData ? employee.metrics : {};
      const metricsHtml = `
        <div class="modal-metric"><span class="metric-label">WHO-5</span><span class="metric-value ${getScoreClass('who5', m.who5)}">${metricOrDash(m.who5)}</span></div>
        <div class="modal-metric"><span class="metric-label">PHQ-9</span><span class="metric-value ${getScoreClass('phq9', m.phq9)}">${metricOrDash(m.phq9)}</span></div>
        <div class="modal-metric"><span class="metric-label">GAD-7</span><span class="metric-value ${getScoreClass('gad7', m.gad7)}">${metricOrDash(m.gad7)}</span></div>
        <div class="modal-metric"><span class="metric-label">MBI</span><span class="metric-value ${getScoreClass('mbi', m.mbi)}">${metricOrDash(m.mbi, '%')}</span></div>
        <div class="modal-metric"><span class="metric-label">–°–æ–Ω</span><span class="metric-value ${getScoreClass('sleepDuration', m.sleepDuration)}">${metricOrDash(m.sleepDuration, ' –≥–æ–¥')}</span></div>
        <div class="modal-metric"><span class="metric-label">–Ø–∫—ñ—Å—Ç—å —Å–Ω—É</span><span class="metric-value ${getScoreClass('sleepQuality', m.sleepQuality)}">${metricOrDash(m.sleepQuality)}</span></div>
        <div class="modal-metric"><span class="metric-label">–ë–∞–ª–∞–Ω—Å</span><span class="metric-value ${getScoreClass('workLifeBalance', m.workLifeBalance)}">${metricOrDash(m.workLifeBalance)}</span></div>
        <div class="modal-metric"><span class="metric-label">–°—Ç—Ä–µ—Å</span><span class="metric-value ${getScoreClass('stressLevel', m.stressLevel)}">${metricOrDash(m.stressLevel)}</span></div>
      `;
      document.getElementById('modalMetrics').innerHTML = metricsHtml;

      const riskLevel = hasData ? (employee.riskLevel || 'low') : 'unknown';
      document.getElementById('modalRiskLevel').innerHTML = `<span class="risk-indicator risk-${riskLevel}">${getRiskLabel(riskLevel)}</span>`;
      document.getElementById('modalNotes').textContent = hasData
        ? (employee.notes || '–ù–æ—Ç–∞—Ç–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ')
        : '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.';

      // –ü—ñ–Ω–ø–æ—ñ–Ω—Ç–∏ –¥–ª—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞
      const pinpointsEl = document.getElementById('modalPinpoints');
      if (pinpointsEl) {
        pinpointsEl.innerHTML = '';
        if (!hasData) {
          pinpointsEl.innerHTML = '<li class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –ø—ñ–Ω–ø–æ—ñ–Ω—Ç—ñ–≤</li>';
        } else {
          const pinpoints = [];
          if (m.who5 < 50) pinpoints.push({ title: '–ù–∏–∑—å–∫–∏–π WHO-5', value: `${metricOrDash(m.who5)}/100`, level: 'high' });
          if (m.phq9 >= 10) pinpoints.push({ title: '–ü—ñ–¥–≤–∏—â–µ–Ω–∞ –¥–µ–ø—Ä–µ—Å—ñ—è', value: `PHQ-9: ${metricOrDash(m.phq9)}/27`, level: 'high' });
          if (m.gad7 >= 10) pinpoints.push({ title: '–í–∏—Å–æ–∫–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å', value: `GAD-7: ${metricOrDash(m.gad7)}/21`, level: 'high' });
          if (m.mbi > 50) pinpoints.push({ title: '–†–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è', value: `MBI: ${metricOrDash(m.mbi, '%')}`, level: 'critical' });
          if (m.sleepDuration && m.sleepDuration < 6) pinpoints.push({ title: '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ–π —Å–æ–Ω', value: `${metricOrDash(m.sleepDuration, ' –≥–æ–¥')}`, level: 'medium' });
          if (m.sleepQuality && m.sleepQuality < 4) pinpoints.push({ title: '–ü–æ–≥–∞–Ω–∞ —è–∫—ñ—Å—Ç—å —Å–Ω—É', value: `${metricOrDash(m.sleepQuality)}/10`, level: 'medium' });
          if (m.workLifeBalance && m.workLifeBalance < 5) pinpoints.push({ title: '–ù–∏–∑—å–∫–∏–π –±–∞–ª–∞–Ω—Å –∂–∏—Ç—Ç—è', value: `${metricOrDash(m.workLifeBalance)}/10`, level: 'medium' });
          if (m.stressLevel >= 27) pinpoints.push({ title: '–í–∏—Å–æ–∫–∏–π —Å—Ç—Ä–µ—Å', value: `PSS: ${metricOrDash(m.stressLevel)}/40`, level: 'high' });

          if (pinpoints.length === 0) {
            pinpointsEl.innerHTML = '<li class="form-hint">‚úÖ –í—Å—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤ –Ω–æ—Ä–º—ñ</li>';
          } else {
            pinpoints.slice(0, 5).forEach(p => {
              const li = document.createElement('li');
              li.className = 'pinpoint-item';
              li.innerHTML = `
                <div class="pinpoint-title">${p.title}</div>
                <div class="pinpoint-meta">${p.value}</div>
              `;
              pinpointsEl.appendChild(li);
            });
          }
        }
      }

      createModalTrendChart(employee);
      const modal = document.getElementById('employeeModal');
      modal.style.display = 'flex';

      // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –º–æ–¥–∞–ª–∫–æ—é
      setTimeout(() => {
        modal.onclick = (e) => {
          if (e.target === modal) {
            closeEmployeeModal();
          }
        };
      }, 100);
    }

    function closeEmployeeModal() {
      const modal = document.getElementById('employeeModal');
      if (modal) {
        modal.style.display = 'none';
        modal.onclick = null; // –í–∏–¥–∞–ª—è—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫
      }
    }

    function createModalTrendChart(employee) {
      const ctx = document.getElementById('modalTrendChart');
      if (!ctx) return;

      if (teamDashboardCharts.modalTrend) {
        teamDashboardCharts.modalTrend.destroy();
      }

      const months = getTeamMonthList();
      const recent = months.length ? months : [];
      const labels = recent.map(m => monthLabelFromKey(monthKeyFromParts(m.year, m.month), true));

      const history = employee.history || {};
      const values = (key) => recent.map(m => {
        const monthKey = monthKeyFromParts(m.year, m.month);
        const value = history[monthKey]?.[key];
        return Number.isFinite(value) ? value : null;
      });

      teamDashboardCharts.modalTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'WHO-5', data: values('who5'), borderColor: '#1f8f3a', tension: 0.35, borderWidth: 2 },
            { label: 'PHQ-9', data: values('phq9'), borderColor: '#ffb000', tension: 0.35, borderWidth: 2 },
            { label: 'GAD-7', data: values('gad7'), borderColor: '#ff595e', tension: 0.35, borderWidth: 2 },
            { label: 'MBI', data: values('mbi'), borderColor: '#6a4c93', tension: 0.35, borderWidth: 2 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
        },
      });
    }

    // ===== ADVANCED ANALYTICS =====
    async function loadAdvancedAnalytics() {
      if (!isAdmin()) return;
      const container = document.getElementById('advanced-section');
      try {
        advancedData = await apiCall('/api/employee-data');
      } catch (error) {
        if (container) {
          const banner = document.createElement('div');
          banner.className = 'error-message';
          banner.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ advanced –∞–Ω–∞–ª—ñ—Ç–∏–∫—É.';
          container.prepend(banner);
        }
        return;
      }

      checkAndShowDecemberNotice();
      renderAlerts();
      renderPriorityRecommendations();
      calculateTeamHealthScore();
      updateBenchmarking();
      renderTrajectoryChart();
      renderRiskBubbleChart();
      calculateForecast();
      analyzeSleepDebt();
      renderEmployeeInsights();
      renderPlaybooks();
      generateRecommendations();
      renderMetadata();
    }

    function getAdvancedMonthKeys() {
      if (!advancedData?.teamAverages) return [];
      return Object.keys(advancedData.teamAverages)
        .filter(key => key !== 'current')
        .sort(compareMonthKeys);
    }

    function getLatestMonthKey() {
      const months = getAdvancedMonthKeys();
      return months.length ? months[months.length - 1] : null;
    }

    function getPrevMonthKey() {
      const months = getAdvancedMonthKeys();
      if (!months.length) return null;
      return months.length >= 2 ? months[months.length - 2] : months[0];
    }

    function getRecentMonths(limit) {
      const months = getAdvancedMonthKeys();
      return months.slice(Math.max(0, months.length - limit));
    }

    function labelFromKey(key) {
      return monthLabelFromKey(key, true);
    }

    function getLatestAverage() {
      const latestKey = getLatestMonthKey();
      if (latestKey && advancedData.teamAverages[latestKey]) {
        return advancedData.teamAverages[latestKey];
      }
      return advancedData.teamAverages.current || null;
    }

    function checkAndShowDecemberNotice() {
      const noticeEl = document.getElementById('decemberNotice');
      if (!noticeEl || !advancedData) return;
      const months = getAdvancedMonthKeys();
      const hasDecember = months.some(key => parseMonthKey(key).month === 12);
      noticeEl.style.display = hasDecember ? 'block' : 'none';
    }

    function calculateTeamHealthScore() {
      const employees = (advancedData?.employees || []).filter(hasEmployeeData);
      if (!employees.length) {
        const scoreEl = document.getElementById('healthScore');
        if (scoreEl) scoreEl.textContent = '‚Äî';
        const indicatorEl = document.getElementById('healthIndicator');
        if (indicatorEl) indicatorEl.textContent = '–ù/–î';
        return;
      }

      let totalScore = 0;
      employees.forEach(emp => {
        const m = emp.metrics;
        const who5Score = m.who5;
        const phq9Score = 100 - (m.phq9 / 27 * 100);
        const gad7Score = 100 - (m.gad7 / 21 * 100);
        const mbiScore = 100 - m.mbi;
        const sleepScore = (m.sleepDuration / 9) * 100;
        const qualityScore = (m.sleepQuality / 10) * 100;
        const balanceScore = (m.workLifeBalance / 10) * 100;
        const stressScore = 100 - (m.stressLevel / 40 * 100);

        const empScore = (who5Score + phq9Score + gad7Score + mbiScore + sleepScore + qualityScore + balanceScore + stressScore) / 8;
        totalScore += empScore;
      });

      const healthScore = Math.round(totalScore / employees.length);
      const scoreEl = document.getElementById('healthScore');
      if (scoreEl) scoreEl.textContent = healthScore;

      let indicator = '';
      if (healthScore >= 70) {
        indicator = 'üü¢ –í—ñ–¥–º—ñ–Ω–Ω–æ';
      } else if (healthScore >= 50) {
        indicator = 'üü° –ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ';
      } else {
        indicator = 'üî¥ –ü–æ—Ç—Ä–µ–±—É—î —É–≤–∞–≥–∏';
      }
      const indicatorEl = document.getElementById('healthIndicator');
      if (indicatorEl) indicatorEl.textContent = indicator;
    }

    function updateBenchmarking() {
      if (!advancedData) return;
      const avg = getLatestAverage();
      if (!avg) return;
      const industry = advancedData?.industryBenchmarks?.techSector || {};
      const industryDefaults = {
        who5: 62,
        phq9: 6.8,
        gad7: 7.5,
        mbi: 42,
        stressLevel: 18,
      };
      const industryValues = {
        who5: industry.who5 ?? industryDefaults.who5,
        phq9: industry.phq9 ?? industryDefaults.phq9,
        gad7: industry.gad7 ?? industryDefaults.gad7,
        mbi: industry.mbi ?? industryDefaults.mbi,
        stressLevel: industry.stressLevel ?? industryDefaults.stressLevel,
      };

      const benchmarks = {
        who5: { your: avg.who5, industry: industryValues.who5, higherIsBetter: true, max: 100 },
        phq9: { your: avg.phq9, industry: industryValues.phq9, higherIsBetter: false, max: 27 },
        gad7: { your: avg.gad7, industry: industryValues.gad7, higherIsBetter: false, max: 21 },
        mbi: { your: avg.mbi, industry: industryValues.mbi, higherIsBetter: false, max: 100 },
        stress: { your: avg.stressLevel, industry: industryValues.stressLevel, higherIsBetter: false, max: 40 },
      };

      const industryLabels = {
        who5: 'who5IndustryValue',
        phq9: 'phq9IndustryValue',
        gad7: 'gad7IndustryValue',
        mbi: 'mbiIndustryValue',
        stress: 'stressIndustryValue',
      };

      Object.keys(industryLabels).forEach(key => {
        const el = document.getElementById(industryLabels[key]);
        if (el && benchmarks[key]) {
          el.textContent = benchmarks[key].industry.toFixed(1);
        }
      });

      Object.keys(benchmarks).forEach(key => {
        const data = benchmarks[key];
        const yourValue = data.your?.toFixed(1) ?? '‚Äî';

        document.getElementById(key + 'YourValue').textContent = yourValue;

        const yourWidth = Math.min(100, (data.your / data.max) * 100);
        const industryWidth = Math.min(100, (data.industry / data.max) * 100);

        document.getElementById(key + 'Your').style.width = yourWidth + '%';
        document.getElementById(key + 'Industry').style.width = industryWidth + '%';

        let status = '';
        if (data.higherIsBetter) {
          if (data.your >= data.industry * 0.95) status = '‚úÖ –∫—Ä–∞—â–µ';
          else if (data.your >= data.industry * 0.85) status = '‚âà —Å–µ—Ä–µ–¥–Ω—î';
          else status = 'üìâ –≥—ñ—Ä—à–µ';
        } else {
          if (data.your <= data.industry * 1.05) status = '‚úÖ –∫—Ä–∞—â–µ';
          else if (data.your <= data.industry * 1.15) status = '‚âà —Å–µ—Ä–µ–¥–Ω—î';
          else status = 'üìâ –≥—ñ—Ä—à–µ';
        }

        document.getElementById(key + 'Status').textContent = status;
      });
    }

    function renderAlerts() {
      const grid = document.getElementById('alertsGrid');
      if (!grid) return;
      grid.innerHTML = '';

      const alerts = (advancedData?.alerts || []).slice().sort((a, b) => {
        const order = { critical: 0, high: 1, alert: 2, positive: 3 };
        const scoreA = order[a.severity] ?? 9;
        const scoreB = order[b.severity] ?? 9;
        if (scoreA !== scoreB) return scoreA - scoreB;
        return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
      });
      if (!alerts.length) {
        grid.innerHTML = '<div class="form-hint">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∞–ª–µ—Ä—Ç—ñ–≤.</div>';
        return;
      }

      alerts.forEach(alert => {
        const severity = alert.severity || 'info';
        const label = severity === 'critical' ? 'CRITICAL'
          : severity === 'positive' ? 'POSITIVE'
          : 'ALERT';
        const card = document.createElement('div');
        card.className = `alert-card ${severity}`;
        const timestamp = formatDateTime(alert.timestamp);
        card.innerHTML = `
          <span class="alert-pill">${label}</span>
          <div class="alert-title">${alert.employee}</div>
          <div>${alert.message}</div>
          <div class="alert-meta">${timestamp}</div>
        `;
        grid.appendChild(card);
      });
    }

    function renderPriorityRecommendations() {
      const grid = document.getElementById('priorityGrid');
      if (!grid) return;
      grid.innerHTML = '';

      const recommendations = (advancedData?.recommendations || []).slice().sort((a, b) => {
        const order = { critical: 0, high: 1, medium: 2, low: 3 };
        return (order[a.priority] ?? 9) - (order[b.priority] ?? 9);
      });
      if (!recommendations.length) {
        grid.innerHTML = '<div class="form-hint">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π –ø–æ–∫–∏ –Ω–µ–º–∞—î.</div>';
        return;
      }

      recommendations.forEach(rec => {
        const priority = rec.priority || 'high';
        const card = document.createElement('div');
        card.className = `priority-card ${priority}`;
        const affected = Array.isArray(rec.affectedEmployees) ? rec.affectedEmployees : [];
        const affectedLabel = affected.includes('all') ? '–í—Å—è –∫–æ–º–∞–Ω–¥–∞' : affected.join(', ');
        card.innerHTML = `
          <span class="priority-pill">${rec.category || 'action'}</span>
          <div class="priority-title">${rec.title}</div>
          <div>${rec.description}</div>
          <ul class="priority-list">
            <li><strong>–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:</strong> ${priority}</li>
            <li><strong>–û—Ö–æ–ø–ª–µ–Ω–Ω—è:</strong> ${affectedLabel || '‚Äî'}</li>
          </ul>
        `;
        grid.appendChild(card);
      });
    }

    function renderMetadata() {
      const grid = document.getElementById('metadataGrid');
      if (!grid) return;
      grid.innerHTML = '';

      const meta = advancedData?.metadata || {};
      const tools = Array.isArray(meta.assessmentTools) ? meta.assessmentTools : [];
      const cards = [
        {
          title: '–ü–µ—Ä—ñ–æ–¥ –∑–±–æ—Ä—É',
          value: meta.dataCollectionPeriod || '‚Äî',
        },
        {
          title: '–ù–∞—Å—Ç—É–ø–Ω–∞ –æ—Ü—ñ–Ω–∫–∞',
          value: meta.nextAssessment ? formatDate(meta.nextAssessment) : '‚Äî',
        },
        {
          title: '–ß–∞—Å—Ç–æ—Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è',
          value: formatFrequency(meta.updateFrequency),
        },
        {
          title: '–†—ñ–≤–µ–Ω—å —É—á–∞—Å—Ç—ñ',
          value: meta.participationRate || '‚Äî',
        },
      ];

      cards.forEach(card => {
        const el = document.createElement('div');
        el.className = 'metadata-card';
        el.innerHTML = `
          <div class="metadata-title">${card.title}</div>
          <div class="metadata-value">${card.value}</div>
        `;
        grid.appendChild(el);
      });

      if (tools.length) {
        const el = document.createElement('div');
        el.className = 'metadata-card';
        el.innerHTML = `
          <div class="metadata-title">–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è</div>
          <ul class="metadata-list">${tools.map(tool => `<li>${tool}</li>`).join('')}</ul>
        `;
        grid.appendChild(el);
      }
    }

    function calculateEmployeeRisk(metrics) {
      if (metrics.who5 < 28 || metrics.phq9 > 15 || metrics.gad7 > 15 || metrics.mbi >= 70 || metrics.stressLevel >= 30) {
        return 'critical';
      }
      if (metrics.who5 < 50 || metrics.phq9 > 10 || metrics.gad7 > 10 || metrics.mbi > 40) return 'high';
      if (metrics.mbi > 30 || metrics.stressLevel > 20) return 'medium';
      return 'low';
    }

    function renderTrajectoryChart() {
      if (!advancedData) return;
      const ctxEl = document.getElementById('trajectoryChart');
      if (!ctxEl) return;

      const months = getAdvancedMonthKeys();
      if (!months.length) return;
      const averages = advancedData.teamAverages;
      const labels = months.map(labelFromKey);
      const monthHasData = months.map(key => hasCoverageForKey(key));
      const commentEl = document.getElementById('trajectoryComment');
      if (!monthHasData.some(Boolean)) {
        if (advancedCharts.trajectory) advancedCharts.trajectory.destroy();
        if (commentEl) commentEl.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ —Ç—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó.';
        return;
      }

      const who5 = months.map((m, idx) => (monthHasData[idx] ? (averages[m]?.who5 ?? null) : null));
      const stressRaw = months.map((m, idx) => (monthHasData[idx] ? (averages[m]?.stressLevel ?? null) : null));
      const stress = stressRaw.map(v => (Number.isFinite(v) ? (v / 40) * 100 : null));
      const sleepRaw = months.map((m, idx) => (monthHasData[idx] ? (averages[m]?.sleepDuration ?? null) : null));
      const sleep = sleepRaw.map(v => (Number.isFinite(v) ? (v / 9) * 100 : null));

      if (advancedCharts.trajectory) advancedCharts.trajectory.destroy();

      advancedCharts.trajectory = new Chart(ctxEl, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'WHO-5', data: who5, borderColor: '#1f8f3a', tension: 0.3, borderWidth: 3 },
            { label: '–°—Ç—Ä–µ—Å', data: stress, borderColor: '#ffb000', tension: 0.3, borderWidth: 2, borderDash: [6, 6] },
            { label: '–°–æ–Ω', data: sleep, borderColor: '#2b59c3', tension: 0.3, borderWidth: 2 },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false },
      });

      const latestKey = getLatestMonthKey();
      const prevKey = getPrevMonthKey();
      if (!latestKey || !prevKey) return;
      if (!hasCoverageForKey(latestKey) || !hasCoverageForKey(prevKey)) return;
      const latestIdx = months.indexOf(latestKey);
      if (latestIdx < 0) return;
      const prevIdx = Math.max(0, latestIdx - 1);
      const whoDelta = who5[latestIdx] - who5[prevIdx];
      const stressDelta = stressRaw[latestIdx] - stressRaw[prevIdx];
      const sleepDelta = sleepRaw[latestIdx] - sleepRaw[prevIdx];
      const comment = `–û—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å (${labelFromKey(latestKey)}): WHO-5 ${Number.isFinite(who5[latestIdx]) ? who5[latestIdx].toFixed(1) : '‚Äî'}, —Å–æ–Ω ${Number.isFinite(sleepRaw[latestIdx]) ? sleepRaw[latestIdx].toFixed(1) : '‚Äî'} –≥–æ–¥, —Å—Ç—Ä–µ—Å ${Number.isFinite(stressRaw[latestIdx]) ? stressRaw[latestIdx].toFixed(1) : '‚Äî'}/40. Œî vs ${labelFromKey(prevKey)}: WHO-5 ${(whoDelta>=0?'+':'') + whoDelta.toFixed(1)}, —Å–æ–Ω ${(sleepDelta>=0?'+':'') + sleepDelta.toFixed(1)} –≥–æ–¥, —Å—Ç—Ä–µ—Å ${(stressDelta>=0?'+':'') + stressDelta.toFixed(1)}.`;
      if (commentEl) commentEl.textContent = comment;

      const modalMetrics = [
        { key: 'who5', label: 'WHO-5', value: Number.isFinite(who5[latestIdx]) ? who5[latestIdx].toFixed(1) : '‚Äî' },
        { key: 'sleep', label: '–°–æ–Ω (–≥–æ–¥)', value: Number.isFinite(sleepRaw[latestIdx]) ? sleepRaw[latestIdx].toFixed(1) : '‚Äî' },
        { key: 'stress', label: '–°—Ç—Ä–µ—Å (0-40)', value: Number.isFinite(stressRaw[latestIdx]) ? stressRaw[latestIdx].toFixed(1) : '‚Äî' },
      ];
      fillMetricsGrid('trajectoryMetrics', modalMetrics);
      const summary = document.getElementById('trajectorySummary');
      if (summary) summary.textContent = '–§–æ–∫—É—Å: –∑–º—ñ–Ω–∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è, —Å–Ω—É —Ç–∞ —Å—Ç—Ä–µ—Å—É –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å.';
    }

    function renderRiskBubbleChart() {
      if (!advancedData) return;
      const ctxEl = document.getElementById('riskBubbleChart');
      if (!ctxEl) return;

      if (advancedCharts.riskBubble) advancedCharts.riskBubble.destroy();

      const employees = (advancedData.employees || []).filter(hasEmployeeData);
      const points = employees.map(emp => {
        const risk = calculateEmployeeRisk(emp.metrics);
        // X axis: Combined psychological distress (PHQ-9 + GAD-7) / 2, max 27
        const psychDistress = (emp.metrics.phq9 + emp.metrics.gad7) / 2;
        // Y axis: Burnout (MBI), max 100
        const burnout = emp.metrics.mbi;
        // Bubble size: Stress level (0-40)
        const bubbleSize = Math.min(30, Math.max(8, emp.metrics.stressLevel * 0.75));

        return {
          x: psychDistress,
          y: burnout,
          r: bubbleSize,
          name: emp.name,
          risk,
          phq9: emp.metrics.phq9,
          gad7: emp.metrics.gad7,
          stressLevel: emp.metrics.stressLevel,
          who5: emp.metrics.who5,
        };
      });

      advancedCharts.riskBubble = new Chart(ctxEl, {
        type: 'bubble',
        data: {
          datasets: [{
            data: points,
            backgroundColor: points.map(p => p.risk === 'critical' ? 'rgba(220, 38, 38, 0.85)'
              : p.risk === 'high' ? 'rgba(249, 115, 22, 0.7)'
              : p.risk === 'medium' ? 'rgba(251, 191, 36, 0.7)'
              : 'rgba(34, 197, 94, 0.7)'),
            borderColor: points.map(p => p.risk === 'critical' ? '#dc2626'
              : p.risk === 'high' ? '#f97316'
              : p.risk === 'medium' ? '#f59e0b'
              : '#22c55e'),
            borderWidth: 2,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const point = context.raw;
                  const riskLabel = point.risk === 'critical' ? '–ö—Ä–∏—Ç–∏—á–Ω–∏–π üî¥'
                    : point.risk === 'high' ? '–í–∏—Å–æ–∫–∏–π üü†'
                    : point.risk === 'medium' ? '–°–µ—Ä–µ–¥–Ω—ñ–π üü°'
                    : '–ù–∏–∑—å–∫–∏–π üü¢';
                  return [
                    `üë§ ${point.name}`,
                    `‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî`,
                    `–ü—Å–∏—Ö–æ–ª. –¥–∏—Å—Ç—Ä–µ—Å: ${point.x.toFixed(1)}/27`,
                    `  ‚Ä¢ PHQ-9 (–¥–µ–ø—Ä–µ—Å—ñ—è): ${point.phq9.toFixed(1)}/27`,
                    `  ‚Ä¢ GAD-7 (—Ç—Ä–∏–≤–æ–≥–∞): ${point.gad7.toFixed(1)}/21`,
                    `–í–∏–≥–æ—Ä–∞–Ω–Ω—è (MBI): ${point.y.toFixed(1)}%`,
                    `–°—Ç—Ä–µ—Å: ${point.stressLevel.toFixed(1)}/40 (—Ä–æ–∑–º—ñ—Ä –±—É–ª—å–±–∞—à–∫–∏)`,
                    `WHO-5: ${point.who5.toFixed(1)}/100`,
                    `‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî`,
                    `–†—ñ–≤–µ–Ω—å —Ä–∏–∑–∏–∫—É: ${riskLabel}`
                  ];
                }
              },
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              padding: 12,
              displayColors: false,
              bodyFont: { size: 13 },
              titleFont: { size: 14, weight: 'bold' }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              max: 27,
              title: {
                display: true,
                text: '–ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏–π –¥–∏—Å—Ç—Ä–µ—Å (PHQ-9 + GAD-7) / 2',
                font: { size: 11, weight: 'bold' }
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(0);
                }
              }
            },
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: '–í–∏–≥–æ—Ä–∞–Ω–Ω—è (MBI %)',
                font: { size: 12, weight: 'bold' }
              }
            },
          },
        },
      });

      const counts = points.reduce((acc, p) => {
        acc[p.risk] = (acc[p.risk] || 0) + 1;
        return acc;
      }, {});
      const riskWeight = { critical: 4, high: 3, medium: 2, low: 1 };
      const scoreRisk = (p) => (riskWeight[p.risk] || 0) * 100 + p.y + p.x + p.phq9;
      const sorted = points.slice().sort((a, b) => scoreRisk(b) - scoreRisk(a));
      const topRisk = sorted[0];

      const riskEl = document.getElementById('riskComment');
      if (riskEl) {
        riskEl.innerHTML = '';
        if (!points.length) {
          riskEl.innerHTML = '<div class="form-hint">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –º–∞—Ç—Ä–∏—Ü—ñ —Ä–∏–∑–∏–∫—ñ–≤.</div>';
        } else {
          // Legend with color indicators
          const legend = document.createElement('div');
          legend.style.cssText = 'font-size: 11px; color: #6b7280; margin-bottom: 12px; line-height: 1.5;';
          legend.innerHTML = '<strong>–û—Å—ñ:</strong> X = –ü—Å–∏—Ö–æ–ª. –¥–∏—Å—Ç—Ä–µ—Å (PHQ-9 + GAD-7)/2 ¬∑ Y = –í–∏–≥–æ—Ä–∞–Ω–Ω—è (MBI) ¬∑ –†–æ–∑–º—ñ—Ä = –°—Ç—Ä–µ—Å<br>üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∏–π &nbsp; üü† –í–∏—Å–æ–∫–∏–π &nbsp; üü° –°–µ—Ä–µ–¥–Ω—ñ–π &nbsp; üü¢ –ù–∏–∑—å–∫–∏–π';

          const row = document.createElement('div');
          row.className = 'risk-chip-row';
          const criticalChip = document.createElement('span');
          criticalChip.className = 'risk-chip risk-chip-critical';
          criticalChip.innerHTML = `üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∏–π <span class="mono">${counts.critical || 0}</span>`;
          const highChip = document.createElement('span');
          highChip.className = 'risk-chip risk-chip-high';
          highChip.innerHTML = `üü† –í–∏—Å–æ–∫–∏–π <span class="mono">${counts.high || 0}</span>`;
          const mediumChip = document.createElement('span');
          mediumChip.className = 'risk-chip risk-chip-medium';
          mediumChip.innerHTML = `üü° –°–µ—Ä–µ–¥–Ω—ñ–π <span class="mono">${counts.medium || 0}</span>`;
          const lowChip = document.createElement('span');
          lowChip.className = 'risk-chip risk-chip-low';
          lowChip.innerHTML = `üü¢ –ù–∏–∑—å–∫–∏–π <span class="mono">${counts.low || 0}</span>`;
          row.append(criticalChip, highChip, mediumChip, lowChip);

          // Show top 5 risks with names
          const topRisks = document.createElement('div');
          topRisks.className = 'risk-top-list';
          topRisks.innerHTML = '<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">–¢–æ–ø-5 —Ä–∏–∑–∏–∫—ñ–≤ (–Ω–∞–≤–µ–¥—ñ—Ç—å –∫—É—Ä—Å–æ—Ä –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π):</div>';

          sorted.slice(0, 5).forEach((person, idx) => {
            const personCard = document.createElement('div');
            personCard.className = 'risk-person-card';
            personCard.style.cssText = `
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 8px 12px;
              margin: 4px 0;
              background: ${person.risk === 'critical' ? 'rgba(220, 38, 38, 0.12)'
                : person.risk === 'high' ? 'rgba(249, 115, 22, 0.1)'
                : person.risk === 'medium' ? 'rgba(251, 191, 36, 0.1)'
                : 'rgba(34, 197, 94, 0.1)'};
              border-left: 3px solid ${person.risk === 'critical' ? '#dc2626'
                : person.risk === 'high' ? '#f97316'
                : person.risk === 'medium' ? '#f59e0b'
                : '#22c55e'};
              border-radius: 4px;
            `;

            const riskEmoji = person.risk === 'critical' ? 'üî¥'
              : person.risk === 'high' ? 'üü†'
              : person.risk === 'medium' ? 'üü°'
              : 'üü¢';

            const nameDiv = document.createElement('div');
            nameDiv.style.cssText = 'font-weight: 600; font-size: 13px;';
            nameDiv.textContent = `${riskEmoji} ${idx + 1}. ${person.name}`;

            const statsDiv = document.createElement('div');
            statsDiv.style.cssText = 'font-size: 12px; color: #6b7280;';
            statsDiv.textContent = `–î–∏—Å—Ç—Ä–µ—Å ${person.x.toFixed(1)} ¬∑ MBI ${person.y.toFixed(0)}% ¬∑ –°—Ç—Ä–µ—Å ${person.stressLevel.toFixed(0)}`;

            personCard.append(nameDiv, statsDiv);
            topRisks.appendChild(personCard);
          });

          riskEl.append(legend, row, topRisks);
        }
      }

      const pinpointsEl = document.getElementById('riskPinpoints');
      if (pinpointsEl) {
        pinpointsEl.innerHTML = '';
        if (!sorted.length) {
          pinpointsEl.innerHTML = '<li class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –ø—ñ–Ω–ø–æ—ñ–Ω—Ç—ñ–≤.</li>';
        } else {
          sorted.slice(0, 3).forEach((item) => {
            const li = document.createElement('li');
            li.className = 'pinpoint-item';
            const title = document.createElement('div');
            title.className = 'pinpoint-title';
            title.textContent = item.name;
            const meta = document.createElement('div');
            meta.className = 'pinpoint-meta';
            meta.textContent = `MBI ${item.y.toFixed(0)}% ¬∑ –°—Ç—Ä–µ—Å ${item.x.toFixed(0)}/40 ¬∑ PHQ-9 ${item.phq9.toFixed(0)}`;
            li.append(title, meta);
            pinpointsEl.appendChild(li);
          });
        }
      }

      const modalMetrics = [
        { key: 'mbi', label: 'High', value: counts.high || 0 },
        { key: 'mbi', label: 'Medium', value: counts.medium || 0 },
        { key: 'mbi', label: 'Low', value: counts.low || 0 },
        {
          key: 'mbi',
          label: '–ù–∞–π–≤–∏—â–∏–π —Ä–∏–∑–∏–∫',
          value: topRisk
            ? `${topRisk.name} ¬∑ MBI ${topRisk.y.toFixed(0)}%`
            : '‚Äî',
        },
      ];
      fillMetricsGrid('riskMetrics', modalMetrics);
      const riskSummary = document.getElementById('riskSummary');
      if (riskSummary) riskSummary.textContent = '–ú–∞—Ç—Ä–∏—Ü—è –ø–æ—î–¥–Ω—É—î –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏–π –¥–∏—Å—Ç—Ä–µ—Å (PHQ-9 + GAD-7) –Ω–∞ –æ—Å—ñ X, –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–µ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è (MBI) –Ω–∞ –æ—Å—ñ Y, —Ç–∞ –∑–∞–≥–∞–ª—å–Ω–∏–π —Å—Ç—Ä–µ—Å (—Ä–æ–∑–º—ñ—Ä –±—É–ª—å–±–∞—à–∫–∏) –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –±–∞—á–µ–Ω–Ω—è —Ä–∏–∑–∏–∫—ñ–≤ —Ç–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–∏–∑–∞—Ü—ñ—ó 1:1 —Ä–æ–∑–º–æ–≤.';
    }

    function calculateForecast() {
      if (!advancedData) return;
      const history = advancedData.teamAverages;
      const latestKey = getLatestMonthKey();
      const prevKey = getPrevMonthKey();
      const forecastGrid = document.getElementById('forecastGrid');
      if (!forecastGrid) return;
      forecastGrid.innerHTML = '';
      if (!latestKey || !prevKey) {
        forecastGrid.innerHTML = '<div class="form-hint">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É.</div>';
        return;
      }
      if (!hasCoverageForKey(latestKey) || !hasCoverageForKey(prevKey)) {
        forecastGrid.innerHTML = '<div class="form-hint">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É.</div>';
        return;
      }
      const metrics = [
        { key: 'who5', name: 'WHO-5 –ë–ª–∞–≥–æ–ø–æ–ª—É—á—á—è' },
        { key: 'phq9', name: 'PHQ-9 –î–µ–ø—Ä–µ—Å—ñ—è' },
        { key: 'mbi', name: 'MBI –í–∏–≥–æ—Ä–∞–Ω–Ω—è' },
      ];

      metrics.forEach(metric => {
        const prev = history[prevKey]?.[metric.key] ?? history[latestKey]?.[metric.key] ?? 0;
        const curr = history[latestKey]?.[metric.key] ?? prev;
        const trend = curr - prev;
        const forecast = curr + trend;

        const trendArrow = trend > 0 ? 'üìà' : trend < 0 ? 'üìâ' : '‚û°Ô∏è';
        const trendText = trend > 0 ? '–ó—Ä–æ—Å—Ç–∞–Ω–Ω—è' : trend < 0 ? '–ó–Ω–∏–∂–µ–Ω–Ω—è' : '–°—Ç–∞–±—ñ–ª—å–Ω–æ';

        const card = document.createElement('div');
        card.className = 'forecast-card';
        card.innerHTML = `
          <h3>${metric.name}</h3>
          <div class="forecast-value">${forecast.toFixed(1)}</div>
          <div class="forecast-trend">${trendArrow} ${trendText} (${labelFromKey(prevKey)} ‚Üí ${labelFromKey(latestKey)})</div>
          <div class="forecast-change">–ó–º—ñ–Ω–∞: ${(trend > 0 ? '+' : '') + trend.toFixed(1)}</div>
        `;
        forecastGrid.appendChild(card);
      });
    }

    function analyzeSleepDebt() {
      if (!advancedData) return;
      const employees = (advancedData.employees || []).filter(hasEmployeeData);
      if (!employees.length) {
        const totalEl = document.getElementById('totalSleepDebt');
        const avgEl = document.getElementById('avgSleepDebt');
        const riskEl = document.getElementById('atRiskCount');
        if (totalEl) totalEl.textContent = '‚Äî';
        if (avgEl) avgEl.textContent = '‚Äî';
        if (riskEl) riskEl.textContent = '‚Äî';
        if (advancedCharts.sleepDebt) {
          advancedCharts.sleepDebt.destroy();
        }
        return;
      }
      const optimalSleep = 7.5;
      let totalDebt = 0;
      let atRisk = 0;

      const debtData = employees.map(emp => {
        const debt = Math.max(0, (optimalSleep - emp.metrics.sleepDuration) * 7);
        totalDebt += debt;
        if (emp.metrics.sleepDuration < 6.5) atRisk += 1;
        return { name: emp.name, debt };
      });

      const avgDebt = employees.length ? totalDebt / employees.length : 0;

      document.getElementById('totalSleepDebt').textContent = totalDebt.toFixed(0);
      document.getElementById('avgSleepDebt').textContent = avgDebt.toFixed(1);
      document.getElementById('atRiskCount').textContent = atRisk;

      const ctx = document.getElementById('sleepDebtChart');
      if (!ctx) return;
      if (advancedCharts.sleepDebt) advancedCharts.sleepDebt.destroy();

      advancedCharts.sleepDebt = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: debtData.map(d => d.name.split(' ')[0]),
          datasets: [{
            label: '–ë–æ—Ä–≥ —Å–Ω—É (–≥–æ–¥/—Ç–∏–∂–¥–µ–Ω—å)',
            data: debtData.map(d => d.debt),
            backgroundColor: debtData.map(d => d.debt > 10 ? 'rgba(239, 68, 68, 0.8)' : d.debt > 5 ? 'rgba(251, 191, 36, 0.8)' : 'rgba(34, 197, 94, 0.8)'),
            borderColor: debtData.map(d => d.debt > 10 ? '#ef4444' : d.debt > 5 ? '#fbbf24' : '#22c55e'),
            borderWidth: 2,
          }],
        },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' },
      });
    }

    function renderEmployeeInsights() {
      if (!advancedData) return;
      const grid = document.getElementById('insightGrid');
      if (!grid) return;
      const employees = (advancedData.employees || []).filter(hasEmployeeData);
      if (!employees.length) {
        grid.innerHTML = '<div class="form-hint">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è —ñ–Ω—Å–∞–π—Ç—ñ–≤.</div>';
        return;
      }

      const latestKey = getLatestMonthKey();
      const prevKey = getPrevMonthKey();
      if (!latestKey || !prevKey) return;

      const riskSorted = [...employees].sort((a, b) =>
        (b.metrics.mbi + b.metrics.phq9) - (a.metrics.mbi + a.metrics.phq9)
      );
      const topRiskNames = riskSorted.slice(0, 2)
        .map(e => `${e.name.split(' ')[0]} (MBI ${e.metrics.mbi.toFixed(0)}%, PHQ-9 ${e.metrics.phq9})`)
        .join(', ');

      const improvements = employees.map(emp => {
        const prev = emp.history?.[prevKey]?.who5 ?? emp.metrics.who5;
        const latest = emp.history?.[latestKey]?.who5 ?? emp.metrics.who5;
        return { name: emp.name, delta: latest - prev };
      }).sort((a, b) => b.delta - a.delta);

      const topRecovery = improvements.filter(i => i.delta > 0).slice(0, 2)
        .map(i => `${i.name.split(' ')[0]} (+${i.delta.toFixed(0)} WHO-5)`).join(', ');

      const declines = improvements.filter(i => i.delta < 0).slice(0, 2)
        .map(i => `${i.name.split(' ')[0]} (${i.delta.toFixed(0)})`).join(', ');

      const sleepDebt = employees.map(emp => {
        const debt = Math.max(0, (7.5 - emp.metrics.sleepDuration) * 7);
        return { name: emp.name, debt };
      }).sort((a, b) => b.debt - a.debt).slice(0, 2);

      const balanced = [...employees].sort((a, b) =>
        b.metrics.workLifeBalance - a.metrics.workLifeBalance
      ).slice(0, 2);

      const cards = [
        {
          pill: 'CRITICAL',
          title: '–¢–µ—Ä–º—ñ–Ω–æ–≤–∏–π —Ñ–æ–∫—É—Å 1:1',
          body: topRiskNames || '–ù–µ–º–∞—î —á–µ—Ä–≤–æ–Ω–∏—Ö –ø—Ä–∞–ø–æ—Ä—Ü—ñ–≤ —Ü—å–æ–≥–æ –º—ñ—Å—è—Ü—è.',
          bullets: [
            topRiskNames ? '–§–æ–∫—É—Å –Ω–∞ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞—Ö –∑ –Ω–∞–π–≤–∏—â–∏–º MBI/PHQ-9.' : '–ö–æ–º–∞–Ω–¥–∞ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ç—Ä–∏–≥–µ—Ä—ñ–≤.',
            '–£—Ç–æ—á–Ω–∏—Ç–∏, —á–∏ —î —Ä–∞–Ω–Ω—ñ —Å–∏–º–ø—Ç–æ–º–∏ (—Å–æ–Ω <6.5 –≥–æ–¥, PHQ-9>10).'
          ],
          plan: '–ü–ª–∞–Ω: –∫–æ—Ä–æ—Ç–∫—ñ check-in –∑ –≥—Ä—É–ø–æ—é —Ä–∏–∑–∏–∫—É —Ç–∞ —Ñ—ñ–∫—Å–∞—Ü—ñ—è 1-2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –∑–º—ñ–Ω.'
        },
        {
          pill: 'RECOVERY',
          title: '–ù–∞–π–±—ñ–ª—å—à–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è',
          body: topRecovery || '–†—ñ–∑–∫–∏—Ö –ø—ñ–¥–π–æ–º—ñ–≤ –Ω–µ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ.',
          bullets: [
            topRecovery ? '–Ñ —ñ—Å—Ç–æ—Ä—ñ—ó –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è ‚Äî –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ best practices.' : '–ë–µ–∑ —Å—Ç—Ä–∏–±–∫—ñ–≤ ‚Äî –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å.',
            '–ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏, —â–æ —Å–∞–º–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ.'
          ],
          plan: '–ü–ª–∞–Ω: –∫–æ—Ä–æ—Ç–∫–∏–π peer sharing —Ç–∞ –∑–±—ñ—Ä –ø—Ä–∞–∫—Ç–∏–∫ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è.'
        },
        {
          pill: 'DROP',
          title: '–ù–µ–≥–∞—Ç–∏–≤–Ω–∞ –¥–∏–Ω–∞–º—ñ–∫–∞',
          body: declines || '–ù–µ–º–∞—î —Ä—ñ–∑–∫–∏—Ö —Å–ø–∞–¥—ñ–≤.',
          bullets: [
            declines ? '–Ñ –ø–∞–¥—ñ–Ω–Ω—è WHO-5 ‚Äî –ª–æ–∫–∞–ª—å–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏.' : '–ë–µ–∑ —Å—É—Ç—Ç—î–≤–∏—Ö —Å–ø–∞–¥—ñ–≤ ‚Äî —Ç—Ä–∏–º–∞—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥.',
            '–ô–º–æ–≤—ñ—Ä–Ω—ñ –ø—Ä–∏—á–∏–Ω–∏: –ø—ñ–∫–æ–≤–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–±–æ –Ω–µ–¥–æ—Å–∏–ø.'
          ],
          plan: '–ü–ª–∞–Ω: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏ —Ç–∞ –∑–Ω–∏–∑–∏—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–ª—è –≥—Ä—É–ø–∏ —Ä–∏–∑–∏–∫—É.'
        },
        {
          pill: 'SLEEP',
          title: '–ë–æ—Ä–≥ —Å–Ω—É —Ç–∞ –µ–Ω–µ—Ä–≥—ñ—è',
          body: sleepDebt.length
            ? sleepDebt.map(d => `${d.name.split(' ')[0]} (+${d.debt.toFixed(0)} –≥–æ–¥/—Ç–∏–∂–¥)`).join(', ')
            : '–ë–æ—Ä–≥ —Å–Ω—É –≤ –Ω–æ—Ä–º—ñ.',
          bullets: [
            sleepDebt.length ? '–Ñ –ø–æ–º—ñ—Ç–Ω–∏–π –±–æ—Ä–≥ —Å–Ω—É ‚Äî —Ä–∏–∑–∏–∫ –ø–∞–¥—ñ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.' : '–°–æ–Ω —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π ‚Äî –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ä–µ–∂–∏–º.',
            '–ù–µ–¥–æ—Å–∏–ø –∫–æ—Ä–µ–ª—é—î –∑ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è–º —ñ PHQ-9.'
          ],
          plan: '–ü–ª–∞–Ω: –ø—Ä–∞–≤–∏–ª–æ ¬´–±–µ–∑ –ø—ñ–Ω–≥—ñ–≤ –ø—ñ—Å–ª—è 19:00¬ª + –≥–Ω—É—á–∫–∏–π —Å—Ç–∞—Ä—Ç –¥–ª—è –≥—Ä—É–ø–∏ —Ä–∏–∑–∏–∫—É.'
        },
        {
          pill: 'BALANCE',
          title: '–ï—Ç–∞–ª–æ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å',
          body: balanced.map(b =>
            `${b.name.split(' ')[0]} (–±–∞–ª–∞–Ω—Å ${b.metrics.workLifeBalance}/10, —Å—Ç—Ä–µ—Å ${b.metrics.stressLevel}/40)`
          ).join(', '),
          bullets: [
            '–Ñ –µ—Ç–∞–ª–æ–Ω–Ω—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏ work-life balance.',
            '–¶—ñ –ª—é–¥–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ buddy –¥–ª—è –≥—Ä—É–ø–∏ —Ä–∏–∑–∏–∫—É.'
          ],
          plan: '–ü–ª–∞–Ω: –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ —è–∫ buddy —Ç–∞ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç—É–≤–∞—Ç–∏ —Ä–∏—Ç—É–∞–ª–∏.'
        }
      ];

      grid.innerHTML = '';
      cards.forEach(card => {
        const el = document.createElement('div');
        el.className = 'insight-card lift';
        el.innerHTML = `
          <span class="insight-pill">‚òÖ ${card.pill}</span>
          <div class="insight-title">${card.title}</div>
          <div class="insight-body">${card.body}</div>
          <ul class="insight-list">${(card.bullets || []).map(b => `<li>${b}</li>`).join('')}</ul>
          <div class="insight-plan">${card.plan}</div>
        `;
        grid.appendChild(el);
      });
    }

    function renderPlaybooks() {
      const container = document.getElementById('playbooks-grid');
      if (!container) return;
      container.innerHTML = '';

      const employees = (advancedData?.employees || []).filter(hasEmployeeData);
      if (!employees.length) {
        container.innerHTML = '<div class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –ø–ª–µ–π–±—É–∫—ñ–≤</div>';
        return;
      }

      const ranked = [...employees]
        .sort((a, b) => (b.metrics.mbi + b.metrics.phq9 + b.metrics.gad7) - (a.metrics.mbi + a.metrics.phq9 + a.metrics.gad7))
        .slice(0, 3);

      ranked.forEach(emp => {
        const level = calculateEmployeeRisk(emp.metrics);
        const card = document.createElement('div');
        card.className = 'playbook-card';
        card.innerHTML = `
          <h3 class="playbook-employee-name">${emp.name}</h3>
          <div class="playbook-risk-level">–†–∏–∑–∏–∫: ${getRiskLabel(level)} ¬∑ PHQ-9 ${emp.metrics.phq9} ¬∑ MBI ${emp.metrics.mbi.toFixed(1)}%</div>
          <div class="playbook-section">
            <h4>üìû –°—Ü–µ–Ω–∞—Ä—ñ–π —Ä–æ–∑–º–æ–≤–∏</h4>
            <ul class="playbook-bullets">
              <li>–ó–∞–ø–∏—Ç–∞–π—Ç–µ –ø—Ä–æ —Å–∞–º–æ–ø–æ—á—É—Ç—Ç—è —Ç–∞ –∫–ª—é—á–æ–≤—ñ —Å—Ç—Ä–µ—Å–æ—Ä–∏.</li>
              <li>–£—Ç–æ—á–Ω—ñ—Ç—å, —â–æ –¥–æ–ø–æ–º–æ–∂–µ –∑–Ω–∏–∑–∏—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è.</li>
              <li>–î–æ–º–æ–≤—Ç–µ—Å—å –ø—Ä–æ 1-2 –∑–º—ñ–Ω–∏ —Ç–∞ follow-up —á–µ—Ä–µ–∑ 7 –¥–Ω—ñ–≤.</li>
            </ul>
          </div>
          <div class="playbook-section">
            <h4>üìã –ü–ª–∞–Ω –Ω–∞ 7 –¥–Ω—ñ–≤</h4>
            <ul class="playbook-microactions">
              <li>–°–∫–æ—Ä–æ—Ç–∏—Ç–∏ 1-2 –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ñ –∑–∞–¥–∞—á—ñ –∞–±–æ –º—ñ—Ç–∏–Ω–≥–∏.</li>
              <li>–î–æ–¥–∞—Ç–∏ 2 –±–ª–æ–∫–∏ —Ñ–æ–∫—É—Å—É –±–µ–∑ –ø—ñ–Ω–≥—ñ–≤.</li>
              <li>–ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫—É (buddy/–∫–æ—É—á) —ñ —á–∞—Å –∫–æ–Ω—Ç–∞–∫—Ç—É.</li>
            </ul>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function generateRecommendations() {
      if (!advancedData) return;
      const employees = (advancedData.employees || []).filter(hasEmployeeData);
      const plans = employees.map(buildRecommendationPlan).filter(Boolean);

      const grid = document.getElementById('recommendationsGrid');
      if (!grid) return;
      grid.innerHTML = '';

      if (!employees.length) {
        grid.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π.</p>';
        return;
      }

      if (!plans.length) {
        grid.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">–í—Å—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤ –Ω–æ—Ä–º—ñ! üéâ</p>';
        return;
      }

      plans.forEach(plan => {
        const kitId = 'call-kit-' + plan.id;
        const card = document.createElement('div');
        card.className = 'recommendation-card lift';

        card.innerHTML = `
          <div class="rec-header">
            <div>
              <span class="rec-category">${plan.category}</span>
              <div class="rec-insight">${plan.subtitle}</div>
            </div>
            <strong>${plan.employee}</strong>
          </div>
          <div class="rec-message">${plan.message}</div>
          <div class="rec-actions">
            <button class="copy-btn" onclick="toggleCallKit('${kitId}')">–ü–ª–∞–Ω 1:1 (${plan.duration} —Ö–≤)</button>
            <span class="rec-action">${plan.action}</span>
          </div>
          <div class="call-kit" id="${kitId}">
            ${plan.callKit}
          </div>
        `;

        grid.appendChild(card);
      });
    }

    function buildRecommendationPlan(emp) {
      if (!hasEmployeeData(emp)) return null;
      const m = emp.metrics;
      const focusAreas = [];

      if (m.phq9 > 10 || m.gad7 > 10) focusAreas.push('mood');
      if (m.mbi > 35 || m.stressLevel > 17) focusAreas.push('burnout');
      if (m.sleepDuration < 6.5 || m.sleepQuality < 6) focusAreas.push('sleep');
      if (m.workLifeBalance < 6) focusAreas.push('load');

      const latestKey = getLatestMonthKey();
      const prevKey = getPrevMonthKey();
      if (!latestKey || !prevKey) return null;
      const who5Delta = (emp.history?.[latestKey]?.who5 ?? m.who5) - (emp.history?.[prevKey]?.who5 ?? m.who5);
      if (who5Delta >= 15) focusAreas.push('recovery');

      if (focusAreas.length === 0) return null;

      const severity = focusAreas.some(a => a === 'burnout' || a === 'mood') ? 'risk'
        : focusAreas.includes('recovery') && focusAreas.length === 1 ? 'positive'
        : 'focus';

      const category = severity === 'risk' ? 'üö® –†–∏–∑–∏–∫ 1:1'
        : severity === 'positive' ? 'üåü –ú–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ —É—Å–ø—ñ—Ö'
        : 'üõ† –ü—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∞';

      const triggers = [];
      if (focusAreas.includes('burnout')) triggers.push(`MBI ${m.mbi.toFixed(0)}% + —Å—Ç—Ä–µ—Å ${m.stressLevel}/40`);
      if (focusAreas.includes('mood')) triggers.push(`PHQ-9 ${m.phq9}/27, GAD-7 ${m.gad7}/21`);
      if (focusAreas.includes('sleep')) triggers.push(`—Å–æ–Ω ${m.sleepDuration} –≥–æ–¥, —è–∫—ñ—Å—Ç—å ${m.sleepQuality}/10`);
      if (focusAreas.includes('load')) triggers.push(`–±–∞–ª–∞–Ω—Å ${m.workLifeBalance}/10`);
      if (focusAreas.includes('recovery')) triggers.push(`–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è WHO-5 +${who5Delta.toFixed(0)}`);

      const message = `
        <div class="rec-insight">–¢—Ä–∏–≥–µ—Ä–∏: ${triggers.join(' ¬∑ ')}</div>
        <div>–§–æ–∫—É—Å 1:1: ${focusAreas.includes('recovery') ? '–∑–∞–∫—Ä—ñ–ø–∏—Ç–∏ —É—Å–ø—ñ—Ö —ñ –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏' : '–∑–Ω–∏–∑–∏—Ç–∏ —Å—Ç—Ä–µ—Å, –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Å–æ–Ω —Ç–∞ –±–∞–ª–∞–Ω—Å'}</div>
      `.trim();

      const action = severity === 'risk'
        ? '–ü—Ä–∏–∑–Ω–∞—á 1:1 –ø—Ä–æ—Ç—è–≥–æ–º 48 –≥–æ–¥–∏–Ω —Ç–∞ –∑–∞—Ñ—ñ–∫—Å—É–π 2 –∑–º—ñ–Ω–∏'
        : '–ü—Ä–æ–≤–µ—Å—Ç–∏ 1:1 —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è –∑ 7-–¥–µ–Ω–Ω–∏–º –ø–ª–∞–Ω–æ–º';

      return {
        id: emp.userId || emp.user_id || emp.id,
        employee: emp.name,
        category,
        subtitle: `–°—Ç—Ä–µ—Å ${m.stressLevel}/40 ¬∑ –°–æ–Ω ${m.sleepDuration.toFixed(1)} –≥–æ–¥ ¬∑ –ë–∞–ª–∞–Ω—Å ${m.workLifeBalance}/10`,
        message,
        action,
        duration: severity === 'risk' ? 15 : 12,
        callKit: buildCallKit(emp, focusAreas, who5Delta),
      };
    }

    function buildCallKit(emp, focusAreas, who5Delta) {
      const firstName = emp.name.split(' ')[0];
      const m = emp.metrics;

      const questions = [
        '–Ø–∫ —Ç–∏ –∑–∞—Ä–∞–∑ –ø–æ —à–∫–∞–ª—ñ 0-10?',
        '–©–æ –∑–∞–±–∏—Ä–∞—î –Ω–∞–π–±—ñ–ª—å—à–µ –µ–Ω–µ—Ä–≥—ñ—ó —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è?',
        '–©–æ –º–æ–∂–µ–º–æ –ø—Ä–∏–±—Ä–∞—Ç–∏/–¥–µ–ª–µ–≥—É–≤–∞—Ç–∏ –≤–∂–µ –∑–∞—Ä–∞–∑?',
        '–Ø–∫–∞ –æ–¥–Ω–∞ –∑–≤–∏—á–∫–∞ –¥–æ–ø–æ–º–æ–∂–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏—Å—å —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è?'
      ];

      if (focusAreas.includes('sleep')) questions.push('–©–æ –∑–∞–≤–∞–∂–∞—î –ª—è–≥–∞—Ç–∏ —Ä–∞–Ω—ñ—à–µ? –Ø–∫ –∫–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ —Ü–µ –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏?');
      if (focusAreas.includes('load')) questions.push('–Ø–∫—ñ –∑–∞–¥–∞—á—ñ –Ω–∞–π–º–µ–Ω—à –∫—Ä–∏—Ç–∏—á–Ω—ñ —Ç–∞ –≤–∏—Å–Ω–∞–∂—É—é—Ç—å?');
      if (focusAreas.includes('recovery') && who5Delta > 0) questions.push(`–©–æ –¥–∞–ª–æ +${who5Delta.toFixed(0)} –¥–æ WHO-5? –Ø–∫ —Ü–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏?`);

      const microActions = [];
      if (focusAreas.includes('burnout')) microActions.push('–í–∏–ª—É—á–∏—Ç–∏ 1 –Ω–µ-–∫—Ä–∏—Ç–∏—á–Ω–∏–π –º—ñ—Ç–∏–Ω–≥ —ñ –¥–æ–¥–∞—Ç–∏ 2—Ö2 –≥–æ–¥ —Ñ–æ–∫—É—Å—É –±–µ–∑ –ø—ñ–Ω–≥—ñ–≤.');
      if (focusAreas.includes('mood')) microActions.push('–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é –ø—Å–∏—Ö–æ–ª–æ–≥–∞/–∫–æ—É—á–∞ –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º —Å–ª–æ—Ç–æ–º.');
      if (focusAreas.includes('sleep')) microActions.push('2 –≤–µ—á–æ—Ä–∏ –±–µ–∑ —Ä–æ–±–æ—á–∏—Ö —á–∞—Ç—ñ–≤ –ø—ñ—Å–ª—è 19:00 + –ø—ñ–∑–Ω—ñ–π —Å—Ç–µ–Ω–¥–∞–ø 1 —Ä–∞–∑ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å.');
      if (focusAreas.includes('load')) microActions.push('–ü–µ—Ä–µ—Ä–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ 1 –∑–∞–¥–∞—á–∫—É —Ç–∞ –∑–∞–º–æ—Ä–æ–∑–∏—Ç–∏ 1 low-prio –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ø—Ä–∏–Ω—Ç—É.');
      if (focusAreas.includes('recovery')) microActions.push('–ó–∞–¥–æ–∫—É–º–µ–Ω—Ç—É–≤–∞—Ç–∏ –ø—Ä–∞–∫—Ç–∏–∫—É —Ç–∞ –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—å –Ω–∞ —Ç—ñ–º-–º—ñ—Ç—ñ (5 —Ö–≤).');

      return `
        <h4>–§–ª–æ—É 1:1 –¥–ª—è ${firstName}</h4>
        <div class="rec-insight">–§–æ–∫—É—Å: ${focusAreas.join(' ‚Ä¢ ')}</div>
        <div class="call-kit-grid">
          <div class="call-block"><strong>12-15 —Ö–≤</strong>
            <ul>
              <li>1 —Ö–≤: –Ω–æ—Ä–º–∞–ª—ñ–∑—É–π —ñ –∑–∞–ø—Ä–æ—Å–∏ —á–µ—Å–Ω—ñ—Å—Ç—å.</li>
              <li>3 —Ö–≤: –≤—ñ–¥–∑–µ—Ä–∫–∞–ª—å –¥–∞–Ω—ñ (—Å—Ç—Ä–µ—Å ${m.stressLevel}/40, MBI ${m.mbi.toFixed(0)}%, —Å–æ–Ω ${m.sleepDuration} –≥–æ–¥).</li>
              <li>5 —Ö–≤: –¥–æ—Å–ª—ñ–¥–∂—É–π –∫–æ—Ä—ñ–Ω—å –ø—Ä–æ–±–ª–µ–º–∏ –ø–∏—Ç–∞–Ω–Ω—è–º–∏.</li>
              <li>3-4 —Ö–≤: –æ–±–µ—Ä—ñ—Ç—å 1-2 –∑–º—ñ–Ω–∏ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å.</li>
              <li>1 —Ö–≤: –∑–∞—Ñ—ñ–∫—Å—É–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π —á–µ–∫–ø–æ–π–Ω—Ç.</li>
            </ul>
          </div>
          <div class="call-block"><strong>–ü–∏—Ç–∞–Ω–Ω—è</strong>
            <ul>${questions.map(q => '<li>' + q + '</li>').join('')}</ul>
          </div>
          <div class="call-block"><strong>–ú—ñ–∫—Ä–æ–¥—ñ—ó</strong>
            <ul>${microActions.map(a => '<li>' + a + '</li>').join('')}</ul>
          </div>
        </div>
      `;
    }

    function toggleCallKit(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('open');
    }

    function openChartModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'flex';
    }

    function closeChartModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    }

    function modalBgClick(event, id) {
      if (event.target.id === id) {
        closeChartModal(id);
      }
    }

    function fillMetricsGrid(id, metrics) {
      const grid = document.getElementById(id);
      if (!grid) return;
      grid.innerHTML = metrics.map(item => {
        const hint = METRIC_HINTS[item.key] || '';
        const tooltip = hint ? `<span class="info-icon" data-tooltip="${hint}">i</span>` : '';
        return `<div class="modal-metric"><span class="metric-label">${item.label} ${tooltip}</span><span class="metric-value">${item.value}</span></div>`;
      }).join('');
    }

    // ===== WELLNESS =====
    // ===== INSIGHTS =====
    async function loadInsights() {
      try {
        const [benchmark, correlations, earlySignal] = await Promise.all([
          apiCall('/insights/self-benchmark'),
          apiCall('/insights/correlations'),
          apiCall('/insights/early-signal'),
        ]);
        insights.selfBenchmark = benchmark;
        insights.correlations = correlations || [];
        insights.earlySignal = earlySignal;
        renderInsights();
      } catch (error) {
        renderInsights();
      }
    }

    function renderInsights() {
      renderSelfBenchmark(insights.selfBenchmark);
      renderCorrelations(insights.correlations || []);
      renderEarlySignal(insights.earlySignal);
    }

    function renderSelfBenchmark(benchmark) {
      const container = document.getElementById('self-benchmark');
      if (!container) return;

      container.innerHTML = '';
      if (!benchmark) {
        container.innerHTML = '<div class="form-hint">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</div>';
        return;
      }

      const current = benchmark.current;
      const summary = document.createElement('div');
      summary.className = 'insight-item';
      summary.innerHTML = `
        <div class="insight-title">–û—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤</div>
        <div class="insight-meta">WHO-5: ${current.who5.toFixed(1)} ¬∑ Burnout: ${current.burnout.toFixed(1)}%</div>
      `;
      container.appendChild(summary);

      if (!benchmark.deltas || !benchmark.previous) {
        const note = document.createElement('div');
        note.className = 'form-hint';
        note.textContent = '–ó–±–∏—Ä–∞—î–º–æ —â–µ 7 –¥–Ω—ñ–≤ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.';
        container.appendChild(note);
        return;
      }

      const metrics = [
        { key: 'who5', label: 'WHO-5', higherBetter: true, suffix: '' },
        { key: 'phq9', label: 'PHQ-9', higherBetter: false, suffix: '' },
        { key: 'gad7', label: 'GAD-7', higherBetter: false, suffix: '' },
        { key: 'burnout', label: 'Burnout', higherBetter: false, suffix: '%' },
        { key: 'stress', label: '–°—Ç—Ä–µ—Å', higherBetter: false, suffix: '' },
        { key: 'sleep', label: '–°–æ–Ω', higherBetter: true, suffix: 'h' },
        { key: 'balance', label: '–ë–∞–ª–∞–Ω—Å', higherBetter: true, suffix: '' },
      ];

      metrics.forEach(metric => {
        const delta = benchmark.deltas[metric.key];
        if (delta === null || delta === undefined || Math.abs(delta) < 0.4) return;
        const arrow = delta > 0 ? '‚Üë' : '‚Üì';
        const improving = metric.higherBetter ? delta > 0 : delta < 0;
        const color = improving ? 'var(--success)' : 'var(--warning)';
        const item = document.createElement('div');
        item.className = 'insight-item';
        item.innerHTML = `
          <div class="insight-title" style="color:${color};">${metric.label} ${arrow} ${delta.toFixed(1)}${metric.suffix}</div>
          <div class="insight-meta">–¢–µ–ø–µ—Ä: ${benchmark.current[metric.key].toFixed(1)}${metric.suffix} ¬∑ –ë—É–ª–æ: ${benchmark.previous[metric.key].toFixed(1)}${metric.suffix}</div>
        `;
        container.appendChild(item);
      });
    }

    function renderCorrelations(list) {
      const container = document.getElementById('correlations-list');
      if (!container) return;
      container.innerHTML = '';

      if (!list || list.length === 0) {
        container.innerHTML = '<div class="form-hint">–ö–æ—Ä–µ–ª—è—Ü—ñ—ó –∑ º—è–≤–ª—è—Ç—å—Å—è –ø—ñ—Å–ª—è 2-3 —Ç–∏–∂–Ω—ñ–≤ –¥–∞–Ω–∏—Ö</div>';
        return;
      }

      list.slice(0, 4).forEach(item => {
        const card = document.createElement('div');
        card.className = 'insight-item';
        card.innerHTML = `
          <div class="insight-title">${item.description}</div>
          <div class="insight-meta">${item.recommendation}</div>
        `;
        container.appendChild(card);
      });
    }

    function renderEarlySignal(signal) {
      const banner = document.getElementById('early-signal-banner');
      if (!banner) return;

      if (!signal) {
        banner.classList.add('hidden');
        return;
      }

      const labels = {
        critical: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π —Å–∏–≥–Ω–∞–ª',
        alert: '–£–≤–∞–≥–∞: —Ä–∞–Ω–Ω—ñ–π —Å–∏–≥–Ω–∞–ª',
        watch: '–°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î–º–æ —Ç—Ä–µ–Ω–¥',
      };
      banner.classList.remove('hidden', 'level-critical', 'level-alert', 'level-watch');
      banner.classList.add(`level-${signal.level}`);
      banner.innerHTML = `
        ‚ö° ${labels[signal.level] || '–†–∞–Ω–Ω—ñ–π —Å–∏–≥–Ω–∞–ª'} ¬∑ confidence ${(signal.confidence * 100).toFixed(0)}%
        <div class="form-hint">–Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏: ${(signal.indicators || []).join(', ')}</div>
      `;
    }

    // ===== KUDOS =====
    // ===== PULSE ROOMS =====
    async function loadPulseRooms() {
      const container = document.getElementById('pulse-rooms');
      if (container) container.innerHTML = '<div class="form-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç...</div>';

      try {
        pulseRooms = await apiCall('/pulse/rooms');
        renderPulseRooms();
        if (!activePulseRoom && pulseRooms.length) {
          setActivePulseRoom(pulseRooms[0]);
        }
      } catch (error) {
        if (container) {
          container.innerHTML = '<div class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç–∏</div>';
        }
      }
    }

    function setActivePulseRoom(room) {
      activePulseRoom = room;
      renderPulseRooms();
      loadPulseMessages();
    }

    function renderPulseRooms() {
      const container = document.getElementById('pulse-rooms');
      if (!container) return;
      container.innerHTML = '';

      if (!pulseRooms || pulseRooms.length === 0) {
        container.innerHTML = '<div class="form-hint">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç</div>';
        return;
      }

      pulseRooms.forEach(room => {
        const card = document.createElement('div');
        card.className = `pulse-room-card${activePulseRoom?.id === room.id ? ' active' : ''}`;
        const emoji = room.emoji || 'üí¨';
        card.innerHTML = `
          <div class="plan-title">${emoji} ${room.title}</div>
          <div class="plan-meta">${room.description || ''}</div>
        `;
        card.addEventListener('click', () => setActivePulseRoom(room));
        container.appendChild(card);
      });
    }

    async function loadPulseMessages() {
      if (!activePulseRoom) return;
      const container = document.getElementById('pulse-messages');
      if (container) container.innerHTML = '<div class="form-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å...</div>';

      try {
        pulseMessages = await apiCall(`/pulse/rooms/${activePulseRoom.slug}/messages`);
        renderPulseMessages();
      } catch (error) {
        if (container) {
          container.innerHTML = '<div class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>';
        }
      }
    }

    function renderPulseMessages() {
      const container = document.getElementById('pulse-messages');
      const meta = document.getElementById('pulse-room-meta');
      const guidance = document.getElementById('pulse-room-guidance');
      if (!container) return;

      if (meta) {
        meta.textContent = activePulseRoom
          ? `${activePulseRoom.title} ¬∑ ${activePulseRoom.description || ''}`
          : '–û–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É';
      }
      if (guidance) {
        if (!activePulseRoom) {
          guidance.textContent = '';
        } else {
          guidance.textContent = '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É —Ü—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ –∑ º—è–≤–ª—è—é—Ç—å—Å—è –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è.';
        }
      }

      container.innerHTML = '';
      if (!pulseMessages || pulseMessages.length === 0) {
        container.innerHTML = '<div class="form-hint">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div>';
        return;
      }

      pulseMessages.forEach(message => {
        const card = document.createElement('div');
        card.className = 'pulse-message';
        const created = message.created_at ? new Date(message.created_at).toLocaleString('uk-UA') : '–ù–µ—â–æ–¥–∞–≤–Ω–æ';
        const author = message.is_anonymous
          ? '–ê–Ω–æ–Ω—ñ–º'
          : (message.author_name || '–£—á–∞—Å–Ω–∏–∫');
        card.innerHTML = `
          <div class="plan-meta">${created} ¬∑ ${author}</div>
          <div class="plan-title">${message.content}</div>
        `;
        container.appendChild(card);
      });
    }


    // ===== WELLNESS GOALS =====
    // ===== PULSE MESSAGE FORM =====
    const pulseMessageForm = document.getElementById('pulse-message-form');
    if (pulseMessageForm) {
      pulseMessageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('pulse-message-status');
        statusEl.textContent = '';

        if (!activePulseRoom) {
          statusEl.textContent = '–û–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É';
          return;
        }

        const content = document.getElementById('pulse-message-content').value.trim();
        if (!content) {
          statusEl.textContent = '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—î';
          return;
        }

        try {
          await apiCall(`/pulse/rooms/${activePulseRoom.slug}/messages`, {
            method: 'POST',
            body: JSON.stringify({
              content,
              is_anonymous: document.getElementById('pulse-anonymous').checked,
            }),
          });
          document.getElementById('pulse-message-content').value = '';
          statusEl.textContent = '‚úÖ –û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ';
          await loadPulseMessages();
        } catch (error) {
          statusEl.textContent = '‚ùå ' + error.message;
        }
      });
    }

    // ===== CREATE ROOM =====
    const createRoomBtn = document.getElementById('create-room-btn');
    if (createRoomBtn) {
      createRoomBtn.addEventListener('click', () => {
        const modal = document.getElementById('create-room-modal');
        if (modal) {
          modal.style.display = 'flex';
          setTimeout(() => {
            modal.onclick = (e) => {
              if (e.target === modal) {
                closeCreateRoomModal();
              }
            };
          }, 100);
        }
      });
    }

    function closeCreateRoomModal() {
      const modal = document.getElementById('create-room-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.onclick = null;
        document.getElementById('create-room-form').reset();
        document.getElementById('create-room-status').textContent = '';
      }
    }

    const createRoomForm = document.getElementById('create-room-form');
    if (createRoomForm) {
      createRoomForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('create-room-status');
        statusEl.textContent = '–°—Ç–≤–æ—Ä–µ–Ω–Ω—è...';

        const name = document.getElementById('room-name').value.trim();
        const description = document.getElementById('room-description').value.trim();
        const emoji = document.getElementById('room-emoji').value.trim();

        if (!name) {
          statusEl.textContent = '–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∫—ñ–º–Ω–∞—Ç–∏';
          return;
        }

        try {
          await apiCall('/pulse/rooms', {
            method: 'POST',
            body: JSON.stringify({
              title: name,
              description: description || null,
              emoji: emoji || 'üí¨',
            }),
          });
          statusEl.textContent = '‚úÖ –ö—ñ–º–Ω–∞—Ç—É —Å—Ç–≤–æ—Ä–µ–Ω–æ!';
          setTimeout(() => {
            closeCreateRoomModal();
            loadPulseRooms();
          }, 1000);
        } catch (error) {
          statusEl.textContent = '‚ùå ' + error.message;
        }
      });
    }

    // ===== TELEGRAM SETTINGS =====
    async function loadTelegramStatus() {
      let status = null;
      try {
        status = await apiCall('/telegram/status');
      } catch (error) {
        console.error('Telegram status error:', error);
        const connection = document.getElementById('telegram-connection-status');
        if (connection) {
          connection.textContent = `‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Telegram —Å—Ç–∞—Ç—É—Å (${error.message})`;
        }
        return;
      }
      if (!status) return;
      telegramStatus = status;

      const connection = document.getElementById('telegram-connection-status');
      const pinInfo = document.getElementById('telegram-pin-info');

      if (status.connected) {
        connection.textContent = `‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ (ID ${status.telegram_id})`;
        pinInfo.textContent = 'Telegram —É–∂–µ –ø—Ä–∏–≤ º—è–∑–∞–Ω–∏–π. –î–ª—è –≤—Ö–æ–¥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ /weblogin.';
      } else {
        connection.textContent = '‚õî –ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ';
        pinInfo.textContent = '–î–ª—è –ø—Ä–∏–≤ º—è–∑–∫–∏ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —É –±–æ—Ç—ñ /start email@opslab.uk 1234.';
      }

      document.getElementById('reminder-time').value =
        `${String(status.reminder_hour).padStart(2, '0')}:${String(status.reminder_minute).padStart(2, '0')}`;
      document.getElementById('timezone-input').value = status.timezone || 'UTC';
      document.getElementById('notifications-enabled').checked = !!status.notification_enabled;

      renderOnboarding();
    }

    // ===== WEB CHECKIN =====
    function updateCheckinFrequencyCards() {
      document.querySelectorAll('.frequency-card').forEach(card => {
        const input = card.querySelector('input[name="checkin-frequency"]');
        const selected = input ? input.checked : false;
        card.classList.toggle('selected', selected);
      });
    }

    function applyCheckinStatus(status) {
      if (!status) return;
      const titleEl = document.getElementById('checkin-status-title');
      const detailEl = document.getElementById('checkin-status-detail');
      const freqChip = document.getElementById('checkin-frequency-chip');
      const nextChip = document.getElementById('checkin-next-chip');
      const startBtn = document.getElementById('checkin-start-btn');
      const forceBtn = document.getElementById('checkin-force-btn');
      const startHint = document.getElementById('checkin-start-hint');
      const frequencyGrid = document.getElementById('checkin-frequency-grid');

      if (frequencyGrid) frequencyGrid.classList.remove('hidden');

      const nextDays = Math.max(0, status.days_until);
      const lastText = status.last_checkin_date ? `–û—Å—Ç–∞–Ω–Ω—ñ–π —á–µ–∫—ñ–Ω: ${status.last_checkin_date}. ` : '';

      if (titleEl) {
        titleEl.textContent = status.due_today ? '–°—å–æ–≥–æ–¥–Ω—ñ —á–∞—Å —á–µ–∫—ñ–Ω—É' : '–ß–µ–∫—ñ–Ω –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–æ';
      }
      if (detailEl) {
        detailEl.textContent = status.due_today
          ? `–û—á—ñ–∫—É—î—Ç—å—Å—è ${status.question_count_label} –ø–∏—Ç–∞–Ω—å, –ø—Ä–∏–±–ª–∏–∑–Ω–æ ${status.estimated_time}.`
          : `${lastText}–ù–∞—Å—Ç—É–ø–Ω–∏–π —á–µ–∫—ñ–Ω: ${status.next_due_date}.`;
      }
      if (freqChip) {
        freqChip.textContent = `${status.frequency_label} ¬∑ ${status.question_count_label} –ø–∏—Ç–∞–Ω—å`;
      }
      if (nextChip) {
        nextChip.textContent = status.due_today ? '–î–æ—Å—Ç—É–ø–Ω–æ —Å—å–æ–≥–æ–¥–Ω—ñ' : `–ß–µ—Ä–µ–∑ ${nextDays} –¥–Ω.`;
      }
      if (startBtn) {
        if (checkinSession) {
          startBtn.disabled = true;
          startBtn.textContent = '–ß–µ–∫—ñ–Ω —É –ø—Ä–æ—Ü–µ—Å—ñ';
        } else {
          startBtn.disabled = !status.due_today;
          startBtn.textContent = status.due_today ? '–ü–æ—á–∞—Ç–∏ —á–µ–∫—ñ–Ω' : '–ß–µ–∫—ñ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π';
        }
      }
      if (forceBtn) {
        const showForce = !status.due_today && isTestCheckinUser() && !checkinSession;
        forceBtn.classList.toggle('hidden', !showForce);
        forceBtn.disabled = !showForce;
      }
      if (startHint && !checkinSession) {
        if (status.due_today) {
          startHint.textContent = '';
        } else if (isTestCheckinUser()) {
          startHint.textContent = `–ù–∞—Å—Ç—É–ø–Ω–∏–π —á–µ–∫—ñ–Ω ${status.next_due_date}. –î–ª—è —Ç–µ—Å—Ç—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–¢–µ—Å—Ç–æ–≤–∏–π —Å—Ç–∞—Ä—Ç".`;
        } else {
          startHint.textContent = `–ù–∞—Å—Ç—É–ø–Ω–∏–π —á–µ–∫—ñ–Ω ${status.next_due_date}`;
        }
      }

      document.querySelectorAll('input[name="checkin-frequency"]').forEach(input => {
        input.checked = input.value === status.frequency;
      });
      updateCheckinFrequencyCards();
    }

    async function loadCheckinStatus() {
      if (!isTestCheckinUser()) return;
      const titleEl = document.getElementById('checkin-status-title');
      const detailEl = document.getElementById('checkin-status-detail');
      const startBtn = document.getElementById('checkin-start-btn');
      const frequencyGrid = document.getElementById('checkin-frequency-grid');

      if (titleEl) titleEl.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
      if (detailEl) detailEl.textContent = '';
      if (startBtn && !checkinSession) startBtn.disabled = true;

      try {
        const status = await apiCall('/checkin/status');
        applyCheckinStatus(status);
        if (checkinAutoStart) {
          checkinAutoStart = false;
          if (!checkinSession) {
            startCheckin(!status?.due_today);
          }
        }
      } catch (error) {
        if (titleEl) titleEl.textContent = '–î–æ—Å—Ç—É–ø –æ–±–º–µ–∂–µ–Ω–æ';
        if (detailEl) detailEl.textContent = '–†–æ–∑–¥—ñ–ª –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.';
        if (frequencyGrid) frequencyGrid.classList.add('hidden');
        if (startBtn) startBtn.disabled = true;
        checkinAutoStart = false;
      }
    }

    async function updateCheckinFrequency(value) {
      if (!isTestCheckinUser()) return;
      const hintEl = document.getElementById('checkin-start-hint');
      if (hintEl) hintEl.textContent = '–ó–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å—Ç–æ—Ç—É...';
      try {
        const status = await apiCall('/checkin/frequency', {
          method: 'POST',
          body: JSON.stringify({ frequency: value }),
        });
        applyCheckinStatus(status);
        if (hintEl) hintEl.textContent = '‚úÖ –ß–∞—Å—Ç–æ—Ç—É –æ–Ω–æ–≤–ª–µ–Ω–æ';
      } catch (error) {
        if (hintEl) hintEl.textContent = `‚ùå ${error.message}`;
      }
    }

    function isAudioSupported() {
      return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.MediaRecorder);
    }

    function pickAudioMimeType() {
      if (typeof MediaRecorder === 'undefined' || !MediaRecorder.isTypeSupported) {
        return '';
      }
      const candidates = [
        'audio/ogg;codecs=opus',
        'audio/webm;codecs=opus',
        'audio/webm',
      ];
      return candidates.find(type => MediaRecorder.isTypeSupported(type)) || '';
    }

    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function clearAudioState(state) {
      if (!state) return;
      if (state.timer) {
        clearInterval(state.timer);
        state.timer = null;
      }
      if (state.recorder && state.recording) {
        state.ignoreStop = true;
        try {
          state.recorder.stop();
        } catch (_) {
          state.ignoreStop = false;
        }
      } else {
        state.ignoreStop = false;
      }
      if (state.stream) {
        state.stream.getTracks().forEach(track => track.stop());
        state.stream = null;
      }
      if (state.blobUrl) {
        URL.revokeObjectURL(state.blobUrl);
        state.blobUrl = null;
      }
      state.recording = false;
      state.recorder = null;
      state.chunks = [];
      state.audioBase64 = null;
      state.audioMime = null;
      state.durationSeconds = null;
      state.statusEl.textContent = '00:00';
      state.audioEl.src = '';
      state.audioEl.style.display = 'none';
      state.recordBtn.disabled = false;
      state.recordBtn.classList.remove('recording');
      state.stopBtn.disabled = true;
      state.clearBtn.disabled = true;
      if (activeRecordingState === state) {
        activeRecordingState = null;
      }
    }

    function setupAudioRecorder(questionId, recordBtn, stopBtn, clearBtn, statusEl, audioEl) {
      const state = {
        questionId,
        recorder: null,
        stream: null,
        chunks: [],
        startTime: 0,
        timer: null,
        recording: false,
        ignoreStop: false,
        audioBase64: null,
        audioMime: null,
        durationSeconds: null,
        blobUrl: null,
        recordBtn,
        stopBtn,
        clearBtn,
        statusEl,
        audioEl,
      };

      checkinAudioStates.set(questionId, state);

      recordBtn.addEventListener('click', async () => {
        if (!isAudioSupported()) {
          statusEl.textContent = '–ê—É–¥—ñ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ —É —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ';
          return;
        }

        if (activeRecordingState && activeRecordingState !== state) {
          if (activeRecordingState.recorder && activeRecordingState.recording) {
            activeRecordingState.recorder.stop();
          }
        }

        if (state.audioBase64) {
          clearAudioState(state);
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const mimeType = pickAudioMimeType();
          const recorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);

          state.stream = stream;
          state.recorder = recorder;
          state.chunks = [];
          state.startTime = Date.now();
          state.recording = true;
          activeRecordingState = state;
          state.recordBtn.classList.add('recording');
          state.recordBtn.disabled = true;
          state.stopBtn.disabled = false;
          state.clearBtn.disabled = true;
          statusEl.textContent = '00:00';

          state.timer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
            statusEl.textContent = formatDuration(elapsed);
            if (elapsed >= CHECKIN_MAX_AUDIO_SECONDS && state.recorder && state.recording) {
              state.recorder.stop();
            }
          }, 1000);

          recorder.addEventListener('dataavailable', event => {
            if (event.data && event.data.size > 0) {
              state.chunks.push(event.data);
            }
          });

          recorder.addEventListener('stop', async () => {
            if (state.ignoreStop) {
              state.ignoreStop = false;
              return;
            }
            state.recording = false;
            if (activeRecordingState === state) {
              activeRecordingState = null;
            }
            if (state.timer) {
              clearInterval(state.timer);
              state.timer = null;
            }
            if (state.stream) {
              state.stream.getTracks().forEach(track => track.stop());
              state.stream = null;
            }

            const mime = recorder.mimeType || mimeType || 'audio/webm';
            const blob = new Blob(state.chunks, { type: mime });
            state.chunks = [];

            if (blob.size > CHECKIN_MAX_AUDIO_BYTES) {
              statusEl.textContent = '‚ö†Ô∏è –ó–∞–ø–∏—Å –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–π, —Å–∫–æ—Ä–æ—Ç—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å';
              clearAudioState(state);
              return;
            }

            try {
              const base64 = await blobToBase64(blob);
              state.audioBase64 = base64;
              state.audioMime = mime;
              state.durationSeconds = Math.max(
                1,
                Math.round((Date.now() - state.startTime) / 1000)
              );
              state.blobUrl = URL.createObjectURL(blob);
              state.audioEl.src = state.blobUrl;
              state.audioEl.style.display = 'block';
              statusEl.textContent = `–ì–æ—Ç–æ–≤–æ ${formatDuration(state.durationSeconds)}`;
              state.recordBtn.disabled = false;
              state.recordBtn.classList.remove('recording');
              state.stopBtn.disabled = true;
              state.clearBtn.disabled = false;
            } catch (error) {
              statusEl.textContent = '‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –∞—É–¥—ñ–æ';
              clearAudioState(state);
            }
          });

          recorder.start(200);
        } catch (error) {
          statusEl.textContent = '‚ùå –ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞';
          state.recordBtn.disabled = false;
          state.recordBtn.classList.remove('recording');
          state.stopBtn.disabled = true;
        }
      });

      stopBtn.addEventListener('click', () => {
        if (state.recorder && state.recording) {
          state.recorder.stop();
        }
      });

      clearBtn.addEventListener('click', () => {
        clearAudioState(state);
      });
    }

    function resetCheckinForm() {
      checkinSession = null;
      checkinAudioStates.forEach(state => clearAudioState(state));
      checkinAudioStates.clear();
      const formCard = document.getElementById('checkin-form-card');
      const introEl = document.getElementById('checkin-intro');
      const questionsEl = document.getElementById('checkin-questions');
      const audioHint = document.getElementById('checkin-audio-hint');

      if (formCard) formCard.classList.add('hidden');
      if (introEl) introEl.textContent = '';
      if (questionsEl) questionsEl.innerHTML = '';
      if (audioHint) audioHint.classList.add('hidden');
    }

    function renderCheckinQuestions(questions) {
      const container = document.getElementById('checkin-questions');
      if (!container) return;
      container.innerHTML = '';
      checkinAudioStates.forEach(state => clearAudioState(state));
      checkinAudioStates.clear();

      const audioSupported = isAudioSupported();
      let hasOpenQuestions = false;

      questions.forEach((question, index) => {
        if (question.scale === '1-10') {
          container.appendChild(buildScaleQuestion(question, index));
        } else {
          hasOpenQuestions = true;
          container.appendChild(buildOpenQuestion(question, index, audioSupported));
        }
      });

      const audioHint = document.getElementById('checkin-audio-hint');
      if (audioHint) {
        if (!hasOpenQuestions) {
          audioHint.classList.add('hidden');
        } else if (!audioSupported) {
          audioHint.textContent = 'üéß –ê—É–¥—ñ–æ–∑–∞–ø–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π —É —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç.';
          audioHint.classList.remove('hidden');
        } else {
          audioHint.textContent = 'üéß –ê—É–¥—ñ–æ –¥–æ—Å—Ç—É–ø–Ω–µ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –ø–∏—Ç–∞–Ω—å (–ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞).';
          audioHint.classList.remove('hidden');
        }
      }
    }

    function buildScaleQuestion(question, index) {
      const card = document.createElement('div');
      card.className = 'checkin-question';

      const header = document.createElement('div');
      header.className = 'checkin-question-header';
      const emoji = document.createElement('div');
      emoji.className = 'checkin-question-emoji';
      emoji.textContent = question.emoji || 'üìù';
      const headerText = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'checkin-question-text';
      title.textContent = question.text;
      const meta = document.createElement('div');
      meta.className = 'checkin-question-type';
      meta.textContent = `–®–∫–∞–ª–∞ 1‚Äì10 ¬∑ –ü–∏—Ç–∞–Ω–Ω—è ${index + 1}`;
      headerText.appendChild(title);
      headerText.appendChild(meta);
      header.appendChild(emoji);
      header.appendChild(headerText);

      const scaleWrap = document.createElement('div');
      scaleWrap.className = 'checkin-scale';
      const input = document.createElement('input');
      input.type = 'range';
      input.min = '1';
      input.max = '10';
      input.step = '1';
      input.value = '5';
      input.setAttribute('data-checkin-scale', question.id);
      const valueEl = document.createElement('div');
      valueEl.className = 'checkin-scale-value';
      valueEl.textContent = input.value;

      input.addEventListener('input', () => {
        valueEl.textContent = input.value;
      });

      scaleWrap.appendChild(input);
      scaleWrap.appendChild(valueEl);

      const labels = document.createElement('div');
      labels.className = 'checkin-scale-labels';
      const left = document.createElement('span');
      left.textContent = '1 ‚Äî –º—ñ–Ω—ñ–º—É–º';
      const right = document.createElement('span');
      right.textContent = '10 ‚Äî –º–∞–∫—Å–∏–º—É–º';
      labels.appendChild(left);
      labels.appendChild(right);

      card.appendChild(header);
      card.appendChild(scaleWrap);
      card.appendChild(labels);
      return card;
    }

    function buildOpenQuestion(question, index, audioSupported) {
      const card = document.createElement('div');
      card.className = 'checkin-question';

      const header = document.createElement('div');
      header.className = 'checkin-question-header';
      const emoji = document.createElement('div');
      emoji.className = 'checkin-question-emoji';
      emoji.textContent = question.emoji || 'üìù';
      const headerText = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'checkin-question-text';
      title.textContent = question.text;
      const meta = document.createElement('div');
      meta.className = 'checkin-question-type';
      meta.textContent = `–í—ñ–¥–∫—Ä–∏—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è ¬∑ –ü–∏—Ç–∞–Ω–Ω—è ${index + 1}`;
      headerText.appendChild(title);
      headerText.appendChild(meta);
      header.appendChild(emoji);
      header.appendChild(headerText);

      const textarea = document.createElement('textarea');
      textarea.className = 'checkin-textarea';
      textarea.placeholder = '–ö–æ—Ä–æ—Ç–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–∞–±–æ –∑–∞–ª–∏—à—Ç–µ –ø—É—Å—Ç–∏–º —ñ –∑–∞–ø–∏—à—ñ—Ç—å –∞—É–¥—ñ–æ)...';
      textarea.maxLength = 1500;
      textarea.setAttribute('data-checkin-text', question.id);

      const hint = document.createElement('div');
      hint.className = 'form-hint';
      hint.textContent = '–ú–æ–∂–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–æ–º –∞–±–æ –∞—É–¥—ñ–æ. –û–¥–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É –¥–æ—Å—Ç–∞—Ç–Ω—å–æ.';

      card.appendChild(header);
      card.appendChild(textarea);
      card.appendChild(hint);

      if (audioSupported) {
        const audioBlock = document.createElement('div');
        audioBlock.className = 'audio-block';
        const controls = document.createElement('div');
        controls.className = 'audio-controls';

        const recordBtn = document.createElement('button');
        recordBtn.type = 'button';
        recordBtn.className = 'audio-record-btn';
        recordBtn.textContent = '‚óè';
        recordBtn.title = '–ü–æ—á–∞—Ç–∏ –∑–∞–ø–∏—Å';

        const stopBtn = document.createElement('button');
        stopBtn.type = 'button';
        stopBtn.className = 'audio-btn';
        stopBtn.textContent = '–ó—É–ø–∏–Ω–∏—Ç–∏';
        stopBtn.disabled = true;

        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'audio-btn';
        clearBtn.textContent = '–û—á–∏—Å—Ç–∏—Ç–∏';
        clearBtn.disabled = true;

        const statusEl = document.createElement('span');
        statusEl.className = 'audio-status';
        statusEl.textContent = '00:00';

        const audioEl = document.createElement('audio');
        audioEl.className = 'audio-player';
        audioEl.controls = true;
        audioEl.style.display = 'none';

        controls.appendChild(recordBtn);
        controls.appendChild(stopBtn);
        controls.appendChild(clearBtn);
        controls.appendChild(statusEl);
        audioBlock.appendChild(controls);
        audioBlock.appendChild(audioEl);
        card.appendChild(audioBlock);

        setupAudioRecorder(question.id, recordBtn, stopBtn, clearBtn, statusEl, audioEl);
      }

      return card;
    }

    async function startCheckin(force = false) {
      if (!isTestCheckinUser()) return;
      const startBtn = document.getElementById('checkin-start-btn');
      const forceBtn = document.getElementById('checkin-force-btn');
      const hintEl = document.getElementById('checkin-start-hint');
      const submitStatus = document.getElementById('checkin-submit-status');
      if (hintEl) hintEl.textContent = '';
      if (submitStatus) submitStatus.textContent = '';
      if (startBtn) {
        startBtn.disabled = true;
        startBtn.textContent = force ? '–ì–æ—Ç—É—î–º–æ —Ç–µ—Å—Ç...' : '–ì–æ—Ç—É—î–º–æ...';
      }
      if (forceBtn) {
        forceBtn.disabled = true;
      }

      try {
        const endpoint = force ? '/checkin/start?force=1' : '/checkin/start';
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
        });
        const payload = await response.json().catch(() => null);

        if (!response.ok) {
          if (payload?.error === 'not_due') {
            if (hintEl) {
              hintEl.textContent = `–ù–∞—Å—Ç—É–ø–Ω–∏–π —á–µ–∫—ñ–Ω ${payload.next_due_date || ''}`;
            }
          } else {
            if (hintEl) hintEl.textContent = '‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø–æ—á–∞—Ç–∏ —á–µ–∫—ñ–Ω';
          }
          await loadCheckinStatus();
          return;
        }

        checkinSession = payload;
        renderCheckinQuestions(payload.questions || []);
        const formCard = document.getElementById('checkin-form-card');
        const introEl = document.getElementById('checkin-intro');
        if (introEl) {
          const count = payload.questions ? payload.questions.length : 0;
          const countLabel = count ? `, ${count} –ø–∏—Ç–∞–Ω—å` : '';
          introEl.textContent = `${payload.intro_message} (‚âà ${payload.estimated_time}${countLabel})`;
        }
        if (formCard) {
          formCard.classList.remove('hidden');
          formCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        if (startBtn) {
          startBtn.textContent = '–ß–µ–∫—ñ–Ω —É –ø—Ä–æ—Ü–µ—Å—ñ';
          startBtn.disabled = true;
        }
        if (forceBtn) {
          forceBtn.classList.add('hidden');
          forceBtn.disabled = true;
        }
        if (hintEl) hintEl.textContent = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–∏—Ç–∞–Ω–Ω—è —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ".';
      } catch (error) {
        if (hintEl) hintEl.textContent = `‚ùå ${error.message}`;
        await loadCheckinStatus();
      }
    }

    function collectCheckinAnswers() {
      if (!checkinSession?.questions) {
        throw new Error('–ß–µ–∫—ñ–Ω –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏–π.');
      }

      for (const state of checkinAudioStates.values()) {
        if (state.recording) {
          throw new Error('–ó—É–ø–∏–Ω—ñ—Ç—å –∑–∞–ø–∏—Å –∞—É–¥—ñ–æ –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é.');
        }
      }

      const answers = [];
      const missing = [];

      checkinSession.questions.forEach((question, index) => {
        if (question.scale === '1-10') {
          const input = document.querySelector(`[data-checkin-scale="${question.id}"]`);
          const value = input ? parseInt(input.value, 10) : NaN;
          if (!Number.isFinite(value) || value < 1 || value > 10) {
            missing.push(index + 1);
            return;
          }
          answers.push({
            question_id: question.id,
            value,
          });
        } else {
          const textarea = document.querySelector(`[data-checkin-text="${question.id}"]`);
          const text = textarea ? textarea.value.trim() : '';
          const audioState = checkinAudioStates.get(question.id);
          const hasAudio = !!audioState?.audioBase64;

          if (!text && !hasAudio) {
            missing.push(index + 1);
            return;
          }

          const payload = {
            question_id: question.id,
            text: text || null,
            audio_base64: text ? null : audioState?.audioBase64 || null,
            audio_mime: text ? null : audioState?.audioMime || null,
            audio_duration_seconds: text ? null : audioState?.durationSeconds || null,
          };
          answers.push(payload);
        }
      });

      if (missing.length) {
        throw new Error(`–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è: ${missing.join(', ')}`);
      }

      return answers;
    }

    async function submitCheckin() {
      if (!checkinSession) return;
      const submitBtn = document.getElementById('checkin-submit-btn');
      const statusEl = document.getElementById('checkin-submit-status');
      if (submitBtn) submitBtn.disabled = true;
      if (statusEl) statusEl.textContent = '–ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ...';

      try {
        const answers = collectCheckinAnswers();
        const response = await fetch('/checkin/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            checkin_id: checkinSession.checkin_id,
            answers,
          }),
        });
        const payload = await response.json().catch(() => null);

        if (!response.ok) {
          if (statusEl) {
            statusEl.textContent = payload?.error
              ? `‚ùå ${payload.error}`
              : '‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ';
          }
          return;
        }

        const advice = payload?.advice ? ` ${payload.advice}` : '';
        const message = payload?.urgent
          ? `‚ö†Ô∏è –Ñ —Å–∏–≥–Ω–∞–ª —Ä–∏–∑–∏–∫—É.${advice}`
          : `‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ.${advice}`;
        if (statusEl) {
          statusEl.textContent = message;
        }
        resetCheckinForm();
        await loadCheckinStatus();
        const hintEl = document.getElementById('checkin-start-hint');
        if (hintEl) {
          hintEl.textContent = message;
        }
      } catch (error) {
        if (statusEl) statusEl.textContent = `‚ùå ${error.message}`;
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const result = reader.result ? reader.result.toString() : '';
          const base64 = result.includes(',') ? result.split(',')[1] : '';
          resolve(base64);
        };
        reader.onerror = () => reject(new Error('File read failed'));
        reader.readAsDataURL(blob);
      });
    }

    function renderOnboarding() {
      const card = document.getElementById('onboarding-card');
      if (!card || !telegramStatus) return;

      if (telegramStatus.onboarding_completed) {
        card.classList.add('hidden');
        return;
      }

      card.classList.remove('hidden');

      const step2 = document.getElementById('onboarding-step-2');
      const step3 = document.getElementById('onboarding-step-3');
      const statusChip = document.getElementById('onboarding-telegram-status');
      const reminderPreview = document.getElementById('onboarding-reminder-preview');
      const completeBtn = document.getElementById('complete-onboarding-btn');

      if (telegramStatus.connected) {
        if (statusChip) {
          statusChip.textContent = 'Telegram –ø—Ä–∏–≤ º—è–∑–∞–Ω–æ';
          statusChip.className = 'status-chip';
        }
        if (step2) step2.classList.add('complete');
      } else {
        if (statusChip) {
          statusChip.textContent = '–ù–µ –ø—Ä–∏–≤ º—è–∑–∞–Ω–æ';
          statusChip.className = 'status-chip';
        }
        if (step2) step2.classList.remove('complete');
      }

      if (reminderPreview) {
        const time = `${String(telegramStatus.reminder_hour).padStart(2, '0')}:${String(telegramStatus.reminder_minute).padStart(2, '0')}`;
        reminderPreview.textContent = `–ü–æ—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è: ${time} ¬∑ ${telegramStatus.timezone}`;
      }

      if (step3) {
        step3.classList.add('complete');
      }

      if (completeBtn) {
        completeBtn.disabled = !telegramStatus.connected;
      }
    }

    const checkinStartBtn = document.getElementById('checkin-start-btn');
    if (checkinStartBtn) {
      checkinStartBtn.addEventListener('click', () => {
        startCheckin();
      });
    }

    const checkinForceBtn = document.getElementById('checkin-force-btn');
    if (checkinForceBtn) {
      checkinForceBtn.addEventListener('click', () => {
        startCheckin(true);
      });
    }

    const checkinSubmitBtn = document.getElementById('checkin-submit-btn');
    if (checkinSubmitBtn) {
      checkinSubmitBtn.addEventListener('click', () => {
        submitCheckin();
      });
    }

    document.querySelectorAll('input[name="checkin-frequency"]').forEach(input => {
      input.addEventListener('change', () => {
        updateCheckinFrequency(input.value);
        updateCheckinFrequencyCards();
      });
    });

    const onboardingScrollBtn = document.getElementById('onboarding-scroll-settings');
    if (onboardingScrollBtn) {
      onboardingScrollBtn.addEventListener('click', () => {
        const target = document.getElementById('telegram-settings-card');
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    const onboardingRefreshBtn = document.getElementById('onboarding-refresh');
    if (onboardingRefreshBtn) {
      onboardingRefreshBtn.addEventListener('click', async () => {
        const statusEl = document.getElementById('onboarding-status');
        if (statusEl) statusEl.textContent = '‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ...';
        onboardingRefreshBtn.disabled = true;

        try {
          await loadTelegramStatus();
          if (statusEl) {
            if (telegramStatus?.connected) {
              statusEl.textContent = '‚úÖ Telegram –ø—Ä–∏–≤ º—è–∑–∞–Ω–æ!';
            } else {
              statusEl.textContent = '‚ö†Ô∏è Telegram —â–µ –Ω–µ –ø—Ä–∏–≤ º—è–∑–∞–Ω–∏–π';
            }
          }
        } catch (error) {
          if (statusEl) statusEl.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏';
        } finally {
          onboardingRefreshBtn.disabled = false;
        }
      });
    }

    const onboardingCompleteBtn = document.getElementById('complete-onboarding-btn');
    if (onboardingCompleteBtn) {
      onboardingCompleteBtn.addEventListener('click', async () => {
        const statusEl = document.getElementById('onboarding-status');
        if (statusEl) statusEl.textContent = '‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ...';
        onboardingCompleteBtn.disabled = true;

        if (!telegramStatus?.connected) {
          if (statusEl) statusEl.textContent = '‚ùå –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏–≤ º—è–∂—ñ—Ç—å Telegram —É –±–æ—Ç—ñ';
          onboardingCompleteBtn.disabled = false;
          return;
        }

        const reminderTime = document.getElementById('reminder-time')?.value;
        const timezone = document.getElementById('timezone-input')?.value?.trim();
        const notificationsEnabled = document.getElementById('notifications-enabled')?.checked ?? true;

        if (!reminderTime || !timezone) {
          if (statusEl) statusEl.textContent = '‚ùå –ù–∞–ª–∞—à—Ç—É–π—Ç–µ —á–∞—Å –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å —Ç–∞ —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å';
          onboardingCompleteBtn.disabled = false;
          return;
        }

        const payload = {
          onboarding_complete: true,
          notification_enabled: notificationsEnabled,
        };
        if (reminderTime) payload.reminder_time = reminderTime;
        if (timezone) payload.timezone = timezone;

        try {
          if (statusEl) statusEl.textContent = '‚è≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è...';
          await apiCall('/telegram/preferences', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          if (statusEl) statusEl.textContent = '‚úÖ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ö–∞—Ä—Ç–∫–∞ –∑–Ω–∏–∫–Ω–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫...';

          setTimeout(async () => {
            await loadTelegramStatus();
          }, 2000);
        } catch (error) {
          if (statusEl) statusEl.textContent = `‚ùå ${error.message}`;
          onboardingCompleteBtn.disabled = false;
        }
      });
    }

    document.getElementById('telegram-settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById('telegram-settings-status');
      statusEl.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

      const reminderTime = document.getElementById('reminder-time').value;
      const timezone = document.getElementById('timezone-input').value.trim();
      const notificationsEnabled = document.getElementById('notifications-enabled').checked;

      const payload = {
        notification_enabled: notificationsEnabled,
      };

      if (reminderTime) {
        payload.reminder_time = reminderTime;
      }
      if (timezone) {
        payload.timezone = timezone;
      }

      try {
        await apiCall('/telegram/preferences', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        statusEl.textContent = '‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ';
        await loadTelegramStatus();
      } catch (error) {
        statusEl.textContent = '‚ùå ' + error.message;
      }
    });

    // ===== ADMIN HEATMAP =====
    async function loadTeamHeatmap() {
      if (!isAdmin()) return;
      try {
        const data = await apiCall('/admin/heatmap');
        teamHeatmap = data;
        renderTeamHeatmap(data);
      } catch (error) {
        const container = document.getElementById('team-heatmap');
        if (container) {
          container.innerHTML = '<div class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ heatmap</div>';
        }
      }
    }

    function renderTeamHeatmap(data) {
      const container = document.getElementById('team-heatmap');
      container.innerHTML = '';

      if (!data || !data.users || data.users.length === 0) {
        container.innerHTML = '<div class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>';
        return;
      }

      const statusLabel = (status) => {
        switch (status) {
          case 'CRITICAL': return { label: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π', color: 'var(--danger)' };
          case 'CONCERNING': return { label: '–†–∏–∑–∏–∫', color: 'var(--warning)' };
          case 'GOOD': return { label: '–î–æ–±—Ä–µ', color: 'var(--success)' };
          case 'EXCELLENT': return { label: '–í—ñ–¥–º—ñ–Ω–Ω–æ', color: 'var(--success)' };
          default: return { label: '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö', color: 'var(--gray)' };
        }
      };

      data.users.forEach(user => {
        const card = document.createElement('div');
        card.className = 'metric-card clickable';
        card.style.cursor = 'pointer';
        card.onclick = () => openEmployeeModal(user.user_id);

        const status = statusLabel(user.status);
        const earlySignal = user.early_signal
          ? `‚ö° ${user.early_signal.level} ¬∑ ${(user.early_signal.indicators || []).slice(0, 2).join(', ')}`
          : '';
        const actionCards = (user.action_cards || [])
          .map(card => `<div class="action-card"><strong>${card.title}</strong><br>${card.description}</div>`)
          .join('');

        const pinpoints = [];
        if (user.who5_score < 50) pinpoints.push('–ù–∏–∑—å–∫–∏–π WHO-5');
        if (user.burnout_percentage > 50) pinpoints.push('–†–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è');
        if (user.phq9_score >= 10) pinpoints.push('–ü—ñ–¥–≤–∏—â–µ–Ω–∞ –¥–µ–ø—Ä–µ—Å—ñ—è');
        if (user.gad7_score >= 10) pinpoints.push('–í–∏—Å–æ–∫–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å');

        const pinpointsHtml = pinpoints.length
          ? `<div class="heatmap-pinpoints">${pinpoints.map(p => `<span class="pinpoint-badge">${p}</span>`).join('')}</div>`
          : '';

        card.innerHTML = `
          <div class="metric-label">${user.name}</div>
          <div class="metric-desc" style="color:${status.color}; font-weight:700;">${status.label}</div>
          <div class="form-hint">WHO-5: ${user.who5_score.toFixed(1)} ¬∑ Burnout: ${user.burnout_percentage.toFixed(1)}%</div>
          <div class="form-hint">Streak: ${user.streak} –¥–Ω—ñ–≤</div>
          ${earlySignal ? `<div class="form-hint">${earlySignal}</div>` : ''}
          ${pinpointsHtml}
          ${actionCards}
        `;

        container.appendChild(card);
      });
    }

    // ===== ADMIN USERS =====
    async function loadAdminUsers() {
      if (!isAdmin()) return;
      try {
        const data = await apiCall('/admin/users');
        adminUsers = Array.isArray(data) ? data : [];
        renderAdminUsers();
      } catch (error) {
        const tbody = document.getElementById('admin-users-table');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</td></tr>';
        }
      }
    }

    function renderAdminUsers() {
      const tbody = document.getElementById('admin-users-table');
      if (!tbody) return;

      const term = adminSearch.trim().toLowerCase();
      const filtered = adminUsers.filter(user => {
        if (!showInactiveUsers && !user.is_active) return false;
        if (!term) return true;
        return user.name.toLowerCase().includes(term) || user.email.toLowerCase().includes(term);
      });

      tbody.innerHTML = '';

      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7">–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–∞ —Ü–∏–º —Ñ—ñ–ª—å—Ç—Ä–æ–º</td></tr>';
        return;
      }

      const canManageTarget = (target) => {
        if (!currentUser) return false;
        if (target.id === currentUser.user_id) return false;
        if ((target.role === 'ADMIN' || target.role === 'FOUNDER') && currentUser.role !== 'FOUNDER') {
          return false;
        }
        return true;
      };

      filtered.forEach(user => {
        const tr = document.createElement('tr');
        if (!user.is_active) tr.classList.add('admin-row-inactive');

        const userCell = document.createElement('td');
        userCell.dataset.label = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
        const nameEl = document.createElement('div');
        nameEl.style.fontWeight = '700';
        nameEl.textContent = user.name;
        const emailEl = document.createElement('div');
        emailEl.className = 'form-hint';
        emailEl.textContent = user.email;
        userCell.appendChild(nameEl);
        userCell.appendChild(emailEl);
        if (user.note) {
          const noteEl = document.createElement('div');
          noteEl.className = 'form-hint';
          noteEl.textContent = user.note;
          userCell.appendChild(noteEl);
        }

        const roleCell = document.createElement('td');
        roleCell.dataset.label = '–†–æ–ª—å';
        roleCell.textContent = user.role;

        const statusCell = document.createElement('td');
        statusCell.dataset.label = '–°—Ç–∞—Ç—É—Å';
        const statusChip = document.createElement('span');
        statusChip.className = 'status-chip';
        statusChip.textContent = user.is_active ? '–ê–∫—Ç–∏–≤–Ω–∏–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π';
        statusCell.appendChild(statusChip);

        const telegramCell = document.createElement('td');
        telegramCell.dataset.label = 'Telegram';
        telegramCell.textContent = user.telegram_id ? '–ü—Ä–∏–≤ º—è–∑–∞–Ω–æ' : '‚Äî';

        const createdCell = document.createElement('td');
        createdCell.dataset.label = '–°—Ç–≤–æ—Ä–µ–Ω–æ';
        createdCell.textContent = user.created_at
          ? new Date(user.created_at).toLocaleDateString('uk-UA')
          : '‚Äî';

        const offboardedCell = document.createElement('td');
        offboardedCell.dataset.label = '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ';
        offboardedCell.textContent = user.offboarded_at
          ? new Date(user.offboarded_at).toLocaleDateString('uk-UA')
          : '‚Äî';
        if (user.offboarded_reason) {
          const reasonEl = document.createElement('div');
          reasonEl.className = 'form-hint';
          reasonEl.textContent = user.offboarded_reason;
          offboardedCell.appendChild(reasonEl);
        }

        const actionsCell = document.createElement('td');
        actionsCell.dataset.label = '–î—ñ—ó';
        actionsCell.className = 'admin-actions';

        const canManage = canManageTarget(user);
        if (user.is_active) {
          const deactivateBtn = document.createElement('button');
          deactivateBtn.className = 'btn btn-secondary';
          deactivateBtn.textContent = '–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏';
          deactivateBtn.dataset.action = 'deactivate';
          deactivateBtn.dataset.id = user.id;
          if (!canManage) deactivateBtn.disabled = true;
          actionsCell.appendChild(deactivateBtn);
        } else {
          const reactivateBtn = document.createElement('button');
          reactivateBtn.className = 'btn btn-success';
          reactivateBtn.textContent = '–í—ñ–¥–Ω–æ–≤–∏—Ç–∏';
          reactivateBtn.dataset.action = 'reactivate';
          reactivateBtn.dataset.id = user.id;
          if (!canManage) reactivateBtn.disabled = true;
          actionsCell.appendChild(reactivateBtn);
        }

        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn btn-primary';
        resetBtn.textContent = '–°–∫–∏–Ω—É—Ç–∏ –∫–æ–¥';
        resetBtn.dataset.action = 'reset';
        resetBtn.dataset.id = user.id;
        if (!canManage) resetBtn.disabled = true;
        actionsCell.appendChild(resetBtn);

        const resetTelegramBtn = document.createElement('button');
        resetTelegramBtn.className = 'btn btn-secondary';
        resetTelegramBtn.textContent = '–°–∫–∏–Ω—É—Ç–∏ Telegram';
        resetTelegramBtn.dataset.action = 'reset-telegram';
        resetTelegramBtn.dataset.id = user.id;
        if (!canManage || !user.telegram_id) resetTelegramBtn.disabled = true;
        actionsCell.appendChild(resetTelegramBtn);

        tr.appendChild(userCell);
        tr.appendChild(roleCell);
        tr.appendChild(statusCell);
        tr.appendChild(telegramCell);
        tr.appendChild(createdCell);
        tr.appendChild(offboardedCell);
        tr.appendChild(actionsCell);
        tbody.appendChild(tr);
      });
    }

    const adminSearchInput = document.getElementById('admin-user-search');
    if (adminSearchInput) {
      adminSearchInput.addEventListener('input', (e) => {
        adminSearch = e.target.value || '';
        renderAdminUsers();
      });
    }

    const adminShowInactive = document.getElementById('admin-show-inactive');
    if (adminShowInactive) {
      adminShowInactive.addEventListener('change', (e) => {
        showInactiveUsers = !!e.target.checked;
        renderAdminUsers();
      });
    }

    const generateUserCodeBtn = document.getElementById('generate-user-code');
    if (generateUserCodeBtn) {
      generateUserCodeBtn.addEventListener('click', () => {
        const code = String(Math.floor(1000 + Math.random() * 9000));
        const codeInput = document.getElementById('admin-user-code');
        if (codeInput) {
          codeInput.value = code;
        }
      });
    }

    const adminUserForm = document.getElementById('admin-user-form');
    if (adminUserForm) {
      adminUserForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('admin-user-status');
        if (statusEl) statusEl.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

        const name = document.getElementById('admin-user-name').value.trim();
        const email = document.getElementById('admin-user-email').value.trim();
        const role = document.getElementById('admin-user-role').value;
        const code = document.getElementById('admin-user-code').value.trim();
        const note = document.getElementById('admin-user-note').value.trim();

        if (!name || !email || !code) {
          if (statusEl) statusEl.textContent = '‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è';
          return;
        }

        try {
          await apiCall('/admin/users', {
            method: 'POST',
            body: JSON.stringify({
              name,
              email,
              code,
              role: role || 'EMPLOYEE',
              note: note || null
            }),
          });
          if (statusEl) statusEl.textContent = '‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Å—Ç–≤–æ—Ä–µ–Ω–æ';
          adminUserForm.reset();
          await loadAdminUsers();
        } catch (error) {
          if (statusEl) statusEl.textContent = `‚ùå ${error.message}`;
        }
      });
    }

    const adminUsersTable = document.getElementById('admin-users-table');
    if (adminUsersTable) {
      adminUsersTable.addEventListener('click', async (e) => {
        const target = e.target.closest('button[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const userId = target.dataset.id;
        if (!userId) return;

        try {
          if (action === 'deactivate') {
            const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó (–æ–ø—Ü—ñ–π–Ω–æ):') || null;
            if (!confirm('–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) return;
            await apiCall(`/admin/users/${userId}/deactivate`, {
              method: 'POST',
              body: JSON.stringify({ reason }),
            });
          } else if (action === 'reactivate') {
            if (!confirm('–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–æ—Å—Ç—É–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É?')) return;
            await apiCall(`/admin/users/${userId}/reactivate`, {
              method: 'POST',
            });
          } else if (action === 'reset') {
            const code = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π 4-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø—É:');
            if (!code) return;
            await apiCall(`/admin/users/${userId}/reset-code`, {
              method: 'POST',
              body: JSON.stringify({ code: code.trim() }),
            });
            alert('–ö–æ–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ');
          } else if (action === 'reset-telegram') {
            if (!confirm('–°–∫–∏–Ω—É—Ç–∏ Telegram –ø—Ä–∏–≤ º—è–∑–∫—É?')) return;
            await apiCall(`/admin/users/${userId}/reset-telegram`, {
              method: 'POST',
            });
            alert('Telegram –ø—Ä–∏–≤ º—è–∑–∫—É –æ—á–∏—â–µ–Ω–æ');
          }

          await loadAdminUsers();
        } catch (error) {
          alert(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`);
        }
      });
    }

    async function loginWithToken(token, openCheckin) {
      const data = await apiCall('/auth/token-login', {
        method: 'POST',
        body: JSON.stringify({ token }),
      });
      currentUser = data;
      window.history.replaceState({}, document.title, window.location.pathname);
      if (openCheckin) {
        checkinPendingSection = 'checkin';
        checkinAutoStart = true;
      }
      await loadApp();
    }

    // ===== MASLO PAGE =====
    function showMASLOPage() {
      const modal = document.getElementById('maslo-modal');
      if (modal) {
        modal.style.display = 'flex';
        // Add click outside to close
        setTimeout(() => {
          modal.onclick = (e) => {
            if (e.target === modal) {
              closeMASLOPage();
            }
          };
        }, 100);
      }
    }

    function closeMASLOPage() {
      const modal = document.getElementById('maslo-modal');
      if (modal) {
        modal.style.display = 'none';
        modal.onclick = null;
      }
    }

    // ===== AUTO-LOAD ON SESSION =====
    (async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      const openCheckin = urlParams.get('checkin') === '1';
      if (openCheckin) {
        checkinPendingSection = 'checkin';
        checkinAutoStart = true;
      }
      if (token) {
        try {
          await loginWithToken(token, openCheckin);
          return;
        } catch (error) {
          showLogin();
          return;
        }
      }

      try {
        const user = await apiCall('/dashboard/me');
        currentUser = user;
        await loadApp();
      } catch (error) {
        showLogin();
      }
    })();

    // Auto-hide header (desktop only)
    (() => {
      const nav = document.querySelector('.nav');
      if (!nav) return;

      // Disable auto-hide on mobile
      const isMobile = () => window.innerWidth <= 980;

      let hideTimer = null;
      let isNearTop = false;

      const scheduleHide = () => {
        if (isMobile()) return; // Don't hide on mobile
        clearTimeout(hideTimer);
        hideTimer = setTimeout(() => {
          if (!isNearTop) {
            nav.classList.add('hidden');
          }
        }, 2000);
      };

      const showNav = () => {
        nav.classList.remove('hidden');
        clearTimeout(hideTimer);
      };

      // Track mouse position to show header when near top (desktop only)
      document.addEventListener('mousemove', (e) => {
        if (isMobile()) return;
        isNearTop = e.clientY < 100;
        if (isNearTop) {
          showNav();
        } else if (!nav.matches(':hover')) {
          scheduleHide();
        }
      });

      // Start hide timer on page load (desktop only)
      if (!isMobile()) {
        scheduleHide();
      }

      // Show nav on hover
      nav.addEventListener('mouseenter', () => {
        if (isMobile()) return;
        showNav();
        isNearTop = true;
      });

      // Restart timer when leaving nav
      nav.addEventListener('mouseleave', () => {
        if (isMobile()) return;
        isNearTop = false;
        scheduleHide();
      });

      // Re-check on resize
      window.addEventListener('resize', () => {
        if (isMobile()) {
          showNav(); // Always show on mobile
        }
      });
    })();
  </script>

</body>
</html>
