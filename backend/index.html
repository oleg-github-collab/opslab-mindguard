<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpsLab Mindguard ¬∑ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ú–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –ó–¥–æ—Ä–æ–≤'—è —Ç–∞ –§—ñ–¥–±–µ–∫—É</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ===== NEOBRUTAL DESIGN SYSTEM ===== */
    :root {
      --primary: #FF6B35;
      --secondary: #FFB347;
      --accent: #00D9FF;
      --success: #00F5A0;
      --warning: #FFB800;
      --danger: #FF4B4B;
      --dark: #1a1a1a;
      --white: #ffffff;
      --gray-light: #f5f5f5;
      --gray: #666666;
      --border: 4px;
      --shadow: 8px 8px 0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--gray-light);
      color: var(--dark);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .mono { font-family: 'Space Mono', monospace; }

    /* ===== NAVIGATION ===== */
    .nav {
      background: var(--white);
      border-bottom: var(--border) solid var(--dark);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 0 var(--dark);
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .nav-logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-menu {
      display: flex;
      gap: 1rem;
      list-style: none;
      flex: 1;
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .nav-link {
      padding: 0.75rem 1.5rem;
      border: 3px solid var(--dark);
      background: var(--white);
      color: var(--dark);
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 4px 4px 0 var(--dark);
    }

    .nav-link:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .nav-link.active {
      background: var(--primary);
      color: var(--white);
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: 3px solid var(--dark);
      font-weight: 700;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
    }

    .btn-primary:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .btn-secondary {
      background: var(--white);
      color: var(--dark);
      box-shadow: 4px 4px 0 var(--dark);
    }

    .btn-success {
      background: var(--success);
      color: var(--dark);
      box-shadow: 4px 4px 0 var(--dark);
    }

    /* ===== CONTAINERS ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .section { display: none; }
    .section.active { display: block; }
    .hidden { display: none !important; }

    /* ===== CARDS ===== */
    .card {
      background: var(--white);
      border: var(--border) solid var(--dark);
      padding: 2rem;
      box-shadow: var(--shadow) var(--dark);
      margin-bottom: 2rem;
    }

    .card-header {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid var(--dark);
    }

    /* ===== GRID ===== */
    .grid {
      display: grid;
      gap: 1.5rem;
    }

    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

    /* ===== METRIC CARDS ===== */
    .metric-card {
      background: var(--white);
      border: 3px solid var(--dark);
      padding: 1.5rem;
      box-shadow: 6px 6px 0 var(--dark);
      position: relative;
      overflow: hidden;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
    }

    .metric-card.positive::before { background: var(--success); }
    .metric-card.warning::before { background: var(--warning); }
    .metric-card.danger::before { background: var(--danger); }

    .metric-label {
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--gray);
      margin-bottom: 0.5rem;
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      font-family: 'Space Mono', monospace;
      margin-bottom: 0.5rem;
    }

    .metric-desc {
      font-size: 0.875rem;
      color: var(--gray);
    }

    .metric-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border: 2px solid var(--dark);
      font-size: 0.75rem;
      font-weight: 700;
      margin-top: 0.5rem;
    }

    .badge-success { background: var(--success); }
    .badge-warning { background: var(--warning); }
    .badge-danger { background: var(--danger); }

    /* ===== LOGIN SCREEN ===== */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      padding: 2rem;
    }

    .login-container {
      max-width: 450px;
      width: 100%;
      background: var(--white);
      border: var(--border) solid var(--dark);
      padding: 3rem;
      box-shadow: 12px 12px 0 var(--dark);
    }

    .login-container h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .login-container p {
      color: var(--gray);
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 3px solid var(--dark);
      font-family: inherit;
      font-size: 1rem;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .error-message {
      padding: 1rem;
      background: #FFE5E5;
      border: 3px solid var(--danger);
      margin-bottom: 1rem;
      font-weight: 700;
      color: var(--danger);
    }

    /* ===== MONTH SELECTOR ===== */
    .month-selector {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .month-btn {
      padding: 0.75rem 1.5rem;
      border: 3px solid var(--dark);
      background: var(--white);
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--dark);
      transition: all 0.2s;
    }

    .month-btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .month-btn.active {
      background: var(--accent);
      color: var(--dark);
    }

    /* ===== DASHBOARD / ADVANCED UI ===== */
    .dashboard-block {
      background: var(--white);
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 800;
      margin-bottom: 1rem;
    }

    .section-heading {
      margin-bottom: 1.25rem;
    }

    .section-subtitle {
      color: var(--gray);
      margin-top: 0.25rem;
    }

    .metrics-section {
      margin-top: 1rem;
    }

    .metrics-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .metric-label-wrapper {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .metric-description {
      color: var(--gray);
      font-size: 0.85rem;
    }

    .employee-month-selector {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .employee-month-btn {
      padding: 0.6rem 1.1rem;
      border: 3px solid var(--dark);
      background: var(--white);
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--dark);
      transition: all 0.2s;
    }

    .employee-month-btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .employee-month-btn.active {
      background: var(--accent);
      color: var(--dark);
    }

    .info-icon {
      width: 20px;
      height: 20px;
      border: 2px solid var(--dark);
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 800;
      cursor: help;
      position: relative;
      background: var(--accent);
    }

    .info-icon::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 50%;
      bottom: 130%;
      transform: translateX(-50%);
      background: var(--white);
      color: var(--dark);
      border: 2px solid var(--dark);
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      width: 220px;
      box-shadow: 4px 4px 0 var(--dark);
      opacity: 0;
      pointer-events: none;
      z-index: 5;
    }

    .info-icon:hover::after {
      opacity: 1;
    }

    .risk-indicator {
      display: inline-flex;
      padding: 0.25rem 0.6rem;
      border: 2px solid var(--dark);
      font-weight: 700;
      margin-top: 0.5rem;
      background: var(--gray-light);
      font-size: 0.75rem;
    }

    .risk-low { background: var(--success); }
    .risk-medium { background: var(--warning); }
    .risk-high { background: var(--danger); color: var(--white); }
    .risk-critical { background: var(--danger); color: var(--white); }

    .chart-container {
      border: 3px solid var(--dark);
      background: var(--white);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1rem;
    }

    .table-container {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      overflow-x: auto;
      background: var(--white);
    }

    #employee-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    #employee-table th,
    #employee-table td {
      border: 2px solid var(--dark);
      padding: 0.6rem;
      text-align: center;
      white-space: nowrap;
    }

    #employee-table th {
      background: var(--gray-light);
      font-weight: 800;
    }

    .employee-name.clickable {
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .score-good { background: #e8f9e8; }
    .score-warning { background: #fff0c2; }
    .score-danger { background: #ffd6d6; }

    .risk-items {
      display: grid;
      gap: 1rem;
    }

    .risk-item {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1rem;
      background: var(--white);
    }

    .risk-item.high { background: #ffd6d6; }
    .risk-item.medium { background: #fff1c2; }
    .risk-item.low { background: #e8f9e8; }

    /* ===== MODAL ===== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 50;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .modal-content {
      background: var(--white);
      border: 4px solid var(--dark);
      box-shadow: 8px 8px 0 var(--dark);
      padding: 1.5rem;
      max-width: 860px;
      width: 100%;
      max-height: 85vh;
      overflow: auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      right: 1rem;
      top: 0.75rem;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-metrics-grid {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .modal-metric {
      border: 2px solid var(--dark);
      padding: 0.75rem;
      background: var(--gray-light);
    }

    /* ===== ADVANCED ===== */
    .health-score-card {
      border: 4px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1.5rem;
      background: var(--white);
      text-align: center;
    }

    .health-score-value {
      font-size: 3rem;
      font-weight: 900;
    }

    .health-score-label,
    .health-score-indicator,
    .benchmark-status {
      font-weight: 700;
      color: var(--gray);
    }

    .benchmark-grid,
    .roi-grid,
    .forecast-grid,
    .sleep-debt-summary,
    .insight-grid,
    .recommendations-grid,
    .playbooks-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .benchmark-card,
    .forecast-card,
    .roi-card,
    .insight-card,
    .recommendation-card,
    .playbook-card {
      border: 3px solid var(--dark);
      box-shadow: 6px 6px 0 var(--dark);
      padding: 1rem;
      background: var(--white);
    }

    .benchmark-bar {
      position: relative;
      height: 14px;
      border: 2px solid var(--dark);
      background: var(--gray-light);
      margin: 0.75rem 0;
    }

    .benchmark-your {
      height: 100%;
      background: var(--primary);
    }

    .benchmark-industry {
      position: absolute;
      top: 0;
      height: 100%;
      background: var(--accent);
      opacity: 0.7;
    }

    .benchmark-values {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--gray);
    }

    .chart-note,
    .chart-comment {
      color: var(--gray);
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    .forecast-value {
      font-size: 1.4rem;
      font-weight: 800;
      margin: 0.5rem 0;
    }

    .forecast-trend,
    .forecast-change {
      font-size: 0.85rem;
      color: var(--gray);
    }

    .chart-card.full-width {
      margin-top: 1rem;
    }

    .chart-card.lift {
      cursor: pointer;
    }

    .chart-title {
      font-weight: 800;
      margin-bottom: 0.75rem;
    }

    .forecast-warning {
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .sleep-debt-summary {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-bottom: 1rem;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 800;
    }

    .insight-pill {
      display: inline-flex;
      border: 2px solid var(--dark);
      padding: 0.25rem 0.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: var(--accent);
    }

    .rec-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .rec-category {
      font-weight: 800;
      padding: 0.2rem 0.5rem;
      border: 2px solid var(--dark);
      background: var(--gray-light);
    }

    .rec-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .copy-btn {
      border: 2px solid var(--dark);
      background: var(--white);
      padding: 0.4rem 0.8rem;
      font-weight: 700;
      cursor: pointer;
    }

    .call-kit {
      display: none;
      margin-top: 0.75rem;
      border-top: 2px solid var(--dark);
      padding-top: 0.75rem;
    }

    .call-kit.open {
      display: block;
    }

    .insight-title {
      font-weight: 800;
      margin: 0.5rem 0;
    }

    .insight-list {
      margin: 0.5rem 0 0;
      padding-left: 1.2rem;
    }

    .insight-plan {
      margin-top: 0.75rem;
      font-weight: 700;
    }

    .rec-message {
      margin-top: 0.5rem;
    }

    .rec-action {
      font-weight: 700;
    }

    .playbook-employee-name {
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .playbook-risk-level {
      padding: 0.4rem 0.6rem;
      border: 2px solid var(--dark);
      font-weight: 700;
      background: var(--gray-light);
      margin-bottom: 0.75rem;
    }

    .playbook-section h4 {
      margin: 0.5rem 0;
      font-weight: 800;
    }

    .playbook-bullets,
    .playbook-microactions {
      padding-left: 1.2rem;
      margin: 0.5rem 0 0.75rem;
    }

    .call-kit-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .call-block {
      border: 2px solid var(--dark);
      padding: 0.75rem;
      background: var(--gray-light);
    }

    .december-notice {
      margin-top: 1rem;
      border: 3px solid var(--dark);
      background: #fff1c2;
      padding: 0.75rem 1rem;
      font-weight: 700;
    }

    .form-hint {
      color: var(--gray);
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .toggle-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .status-chip {
      padding: 0.25rem 0.6rem;
      border: 2px solid var(--dark);
      background: var(--gray-light);
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* ===== ADMIN USERS ===== */
    .admin-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin: 1.5rem 0 1rem;
    }

    .admin-table-wrap {
      overflow-x: auto;
      border: 3px solid var(--dark);
      background: var(--white);
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    .admin-table th,
    .admin-table td {
      border: 2px solid var(--dark);
      padding: 0.75rem 0.9rem;
      text-align: left;
      vertical-align: top;
    }

    .admin-table th {
      background: var(--gray-light);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.04em;
    }

    .admin-row-inactive {
      opacity: 0.6;
      background: #fff7f7;
    }

    .admin-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* ===== WELLNESS + INSIGHTS ===== */
    .plan-list,
    .insight-list,
    .kudos-list,
    .pulse-list,
    .moderation-queue {
      display: grid;
      gap: 0.75rem;
    }

    .plan-item,
    .kudos-item,
    .pulse-message,
    .insight-item,
    .moderation-card {
      border: 3px solid var(--dark);
      padding: 1rem;
      background: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
    }

    .plan-title,
    .kudos-message,
    .insight-title {
      font-weight: 700;
    }

    .plan-meta,
    .kudos-meta,
    .insight-meta {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.35rem;
    }

    .tag-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .tag-chip {
      padding: 0.25rem 0.6rem;
      border: 2px solid var(--dark);
      background: var(--accent);
      font-size: 0.75rem;
      font-weight: 700;
    }

    .insight-banner {
      margin-top: 1rem;
      border: 3px solid var(--dark);
      padding: 1rem;
      font-weight: 700;
    }

    .insight-banner.level-critical { background: #ffe5e5; }
    .insight-banner.level-alert { background: #fff3e0; }
    .insight-banner.level-watch { background: #f0f6ff; }

    /* ===== ONBOARDING ===== */
    .onboarding-card { border: 3px dashed var(--dark); background: #fff7d6; }
    .onboarding-steps { display: grid; gap: 0.75rem; }
    .onboarding-step {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border: 3px solid var(--dark);
      background: var(--light);
      font-weight: 600;
      flex-wrap: wrap;
    }
    .onboarding-step.complete {
      background: #d9f7da;
    }
    .step-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 2px solid var(--dark);
      background: var(--accent);
      font-weight: 800;
    }
    #onboarding-telegram-status {
      margin-left: auto;
    }
    #onboarding-reminder-preview {
      display: block;
      width: 100%;
      margin-top: 0.25rem;
    }

    /* ===== PULSE ROOMS ===== */
    .pulse-room-card {
      border: 3px solid var(--dark);
      padding: 1rem;
      background: var(--white);
      box-shadow: 4px 4px 0 var(--dark);
      cursor: pointer;
      transition: all 0.2s;
    }

    .pulse-room-card:hover {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--dark);
    }

    .pulse-room-card.active {
      background: var(--accent);
    }

    .pulse-message.pending {
      background: #fff3e0;
    }

    .moderation-card {
      border-style: dashed;
      background: #fff7f7;
    }

    .action-card {
      border: 2px dashed var(--dark);
      padding: 0.65rem;
      margin-top: 0.5rem;
      background: #fff7f7;
      font-size: 0.85rem;
    }

    /* ===== ANIMATIONS ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in { animation: fadeIn 0.5s ease-out; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .nav-container { flex-direction: column; align-items: flex-start; }
      .nav-menu { width: 100%; justify-content: flex-start; }
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .month-selector { justify-content: center; }
      .login-container { padding: 2rem; }
      .card { padding: 1.5rem; }
      .admin-table thead { display: none; }
      .admin-table tr { display: block; margin-bottom: 1rem; }
      .admin-table td { display: flex; justify-content: space-between; gap: 1rem; }
      .admin-table td::before { content: attr(data-label); font-weight: 700; }
    }

    @media (max-width: 560px) {
      .nav-menu { flex-direction: column; }
      .nav-link { width: 100%; text-align: center; }
      .container { padding: 1.25rem; }
    }

    /* ===== LOADING ===== */
    .loading {
      text-align: center;
      padding: 3rem;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--dark);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- ===== LOGIN SCREEN ===== -->
  <div id="login-screen" class="login-screen">
    <div class="login-container fade-in">
      <h1>üß† OpsLab Mindguard</h1>
      <p>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤'—è —Ç–∞ —Ñ—ñ–¥–±–µ–∫—É –∫–æ–º–∞–Ω–¥–∏</p>

      <div id="error-container"></div>

      <form id="login-form">
        <div class="form-group">
          <label for="email">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–æ—à—Ç–∞</label>
          <input type="email" id="email" name="email" required placeholder="your@opslab.uk" autocomplete="email" />
        </div>

        <div class="form-group">
          <label for="code">–í–∞—à —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π 4-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥</label>
          <input type="password" id="code" name="code" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" autocomplete="current-password" />
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%;">–£–≤—ñ–π—Ç–∏</button>
        <div class="form-hint" style="margin-top: 0.75rem;">
          üîó –ü—Ä–∏–≤ º—è–∑–∫–∞ Telegram: <span class="mono">/start email@opslab.uk 1234</span>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== MAIN APP ===== -->
  <div id="app" class="hidden">

    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-container">
        <a href="#" class="nav-logo">üß† OpsLab Mindguard</a>

        <ul class="nav-menu">
          <li><a href="#" class="nav-link active" data-section="mindguard">üìä Mindguard</a></li>
          <li><a href="#" class="nav-link hidden" data-section="advanced" id="advanced-link">üß† Advanced</a></li>
          <li><a href="#" class="nav-link" data-section="pulse">üó£ Pulse Rooms</a></li>
          <li><a href="https://opslab-feedback-production.up.railway.app/" class="nav-link nav-link-external" target="_blank" rel="noopener">üí¨ OpsLab Feedback</a></li>
          <li><a href="#" class="nav-link hidden" data-section="admin" id="admin-link">üß© –ö–æ–º–∞–Ω–¥–∞</a></li>
        </ul>

        <div class="nav-actions">
          <span id="user-name" class="mono"></span>
          <span id="user-role" class="status-chip"></span>
          <button id="logout-btn" class="btn btn-secondary">–í–∏–π—Ç–∏</button>
        </div>
      </div>
    </nav>

    <!-- ===== MINDGUARD SECTION ===== -->
    <div id="mindguard-section" class="section active">
      <div class="container">
        <div class="card onboarding-card hidden" id="onboarding-card">
          <div class="card-header">üöÄ –°—Ç–∞—Ä—Ç —É Mindguard</div>
          <p style="color: var(--gray); margin-bottom: 1rem;">
            –ö–æ—Ä–æ—Ç–∫–∏–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ –¥–æ–ø–æ–º–æ–∂–µ —É–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Ç–∞ –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —è–∫ –ø—Ä–∞—Ü—é—î —Å–∏—Å—Ç–µ–º–∞.
          </p>
          <div class="onboarding-steps">
            <div class="onboarding-step complete" id="onboarding-step-1">
              <span class="step-badge">1</span>
              –û–∑–Ω–∞–π–æ–º—Ç–µ—Å—å –∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ—é —Ç–∞ —Å–≤–æ—ó–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∑–∞ –º–∏–Ω—É–ª—ñ –º—ñ—Å—è—Ü—ñ.
            </div>
            <div class="onboarding-step" id="onboarding-step-2">
              <span class="step-badge">2</span>
              –ü—Ä–∏–≤ º—è–∂—ñ—Ç—å Telegram: <span class="mono">/link email@opslab.uk 1234</span>
              <span id="onboarding-telegram-status" class="status-chip">–°—Ç–∞—Ç—É—Å...</span>
            </div>
            <div class="onboarding-step" id="onboarding-step-3">
              <span class="step-badge">3</span>
              –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —á–∞—Å –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å —Ç–∞ —á–∞—Å–æ–≤–∏–π –ø–æ—è—Å.
              <span id="onboarding-reminder-preview" class="form-hint"></span>
              <button id="onboarding-scroll-settings" class="btn btn-secondary" type="button">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å</button>
            </div>
            <div class="onboarding-step" id="onboarding-step-4">
              <span class="step-badge">4</span>
              –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥—É –±–æ—Ç –ø–æ—á–Ω–µ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —á–µ–∫—ñ–Ω–∏ —Ç–∞ –∑–≤—ñ—Ç–∏.
            </div>
          </div>
          <div class="toggle-row" style="margin-top: 1rem;">
            <button id="onboarding-refresh" class="btn btn-secondary" type="button">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–∏–≤ º—è–∑–∫—É</button>
            <button id="complete-onboarding-btn" class="btn btn-primary" type="button">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥</button>
            <span id="onboarding-status" class="form-hint"></span>
          </div>
        </div>

        <div class="card" id="team-dashboard-card">
          <div class="card-header">üìä TeamPulse Mindguard Analytics</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –ü–æ–≤–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤'—è –∑–∞ –≤—Å—ñ –º—ñ—Å—è—Ü—ñ –∑ –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ –∫–ª—é—á–æ–≤–∏—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö.
          </p>

          <div id="team-month-selector" class="month-selector"></div>
          <div class="december-notice" id="dashboardDecemberNotice" style="display: none;">
            ‚ö†Ô∏è –ì—Ä—É–¥–µ–Ω—å: —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–æ –≤–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∏ —Ç–∞ –ø—ñ–¥—Å—É–º–∫–∏ —Ä–æ–∫—É.
          </div>

          <section class="metrics-section">
            <h3 class="section-title">–ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h3>
            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">WHO-5 –ë–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</span>
                    <span class="info-icon" data-tooltip="–Ü–Ω–¥–µ–∫—Å –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è –í–û–û–ó (0-100). <50 ‚Äî –Ω–∏–∑—å–∫–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="who5-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                <span class="risk-indicator" id="who5-risk">‚Äî</span>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">PHQ-9 –î–µ–ø—Ä–µ—Å—ñ—è</span>
                    <span class="info-icon" data-tooltip="PHQ-9 (0-27). 5-9: –ª–µ–≥–∫–∞, 10-14: –ø–æ–º—ñ—Ä–Ω–∞, 15+: —Ç—è–∂–∫–∞.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="phq9-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                <span class="risk-indicator" id="phq9-risk">‚Äî</span>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">GAD-7 –¢—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å</span>
                    <span class="info-icon" data-tooltip="GAD-7 (0-21). 5-9: –ª–µ–≥–∫–∞, 10-14: –ø–æ–º—ñ—Ä–Ω–∞, 15+: —Ç—è–∂–∫–∞.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="gad7-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫</div>
                <span class="risk-indicator" id="gad7-risk">‚Äî</span>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">MBI –í–∏–≥–æ—Ä–∞–Ω–Ω—è</span>
                    <span class="info-icon" data-tooltip="MBI (0-100%). 25-50%: —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫, >50%: –≤–∏—Å–æ–∫–∏–π.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="mbi-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫ (%)</div>
                <span class="risk-indicator" id="mbi-risk">‚Äî</span>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É</span>
                    <span class="info-icon" data-tooltip="–°–µ—Ä–µ–¥–Ω—è —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ 7-9 –≥–æ–¥.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="sleep-duration-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ–¥–∏–Ω</div>
                <span class="risk-indicator" id="sleep-duration-risk">‚Äî</span>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">–Ø–∫—ñ—Å—Ç—å —Å–Ω—É</span>
                    <span class="info-icon" data-tooltip="–Ø–∫—ñ—Å—Ç—å —Å–Ω—É (1-10). 7-10: –¥–æ–±—Ä–∞, <4: –ø–æ–≥–∞–Ω–∞.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="sleep-quality-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞ (1-10)</div>
                <span class="risk-indicator" id="sleep-quality-risk">‚Äî</span>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">–ë–∞–ª–∞–Ω—Å –∂–∏—Ç—Ç—è</span>
                    <span class="info-icon" data-tooltip="–ë–∞–ª–∞–Ω—Å —Ä–æ–±–æ—Ç–∞/–∂–∏—Ç—Ç—è (1-10). 7-10: –∑–¥–æ—Ä–æ–≤–∏–π.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="work-life-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞ (1-10)</div>
                <span class="risk-indicator" id="work-life-risk">‚Äî</span>
              </div>

              <div class="metric-card">
                <div class="metric-header">
                  <div class="metric-label-wrapper">
                    <span class="metric-label">–†—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É</span>
                    <span class="info-icon" data-tooltip="PSS (0-40). 0-13: –Ω–∏–∑—å–∫–∏–π, 14-26: –ø–æ–º—ñ—Ä–Ω–∏–π, 27-40: –≤–∏—Å–æ–∫–∏–π.">i</span>
                  </div>
                </div>
                <div class="metric-value" id="stress-value">‚Äî</div>
                <div class="metric-description">–°–µ—Ä–µ–¥–Ω—ñ–π –ø–æ–∫–∞–∑–Ω–∏–∫ (0-40)</div>
                <span class="risk-indicator" id="stress-risk">‚Äî</span>
              </div>
            </div>
          </section>
        </div>

        <div class="card">
          <div class="card-header">üìà –î–∏–Ω–∞–º—ñ–∫–∞ –∫–æ–º–∞–Ω–¥–∏</div>
          <div class="chart-container" style="position: relative; height: 420px;">
            <canvas id="teamTrendChart"></canvas>
          </div>
        </div>

        <div class="card" id="employee-analysis-card">
          <div class="card-header">üßë‚Äçü§ù‚Äçüßë –ê–Ω–∞–ª—ñ–∑ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤</div>
          <div id="employee-month-selector" class="employee-month-selector"></div>
          <div class="table-container">
            <table id="employee-table">
              <thead>
                <tr>
                  <th>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</th>
                  <th>WHO-5</th>
                  <th>PHQ-9</th>
                  <th>GAD-7</th>
                  <th>MBI (%)</th>
                  <th>–°–æ–Ω (–≥–æ–¥)</th>
                  <th>–Ø–∫—ñ—Å—Ç—å —Å–Ω—É</th>
                  <th>–ë–∞–ª–∞–Ω—Å</th>
                  <th>–°—Ç—Ä–µ—Å</th>
                  <th>–†–∏–∑–∏–∫</th>
                </tr>
              </thead>
              <tbody id="employee-table-body">
                <tr>
                  <td colspan="10" style="text-align: center; padding: 2rem;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" id="risk-assessment-card">
          <div class="card-header">‚ö†Ô∏è –û—Ü—ñ–Ω–∫–∞ —Ä–∏–∑–∏–∫—ñ–≤</div>
          <div class="risk-items" id="risk-items">
            <div class="risk-item medium">
              <div class="risk-item-title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
              <div class="risk-item-description">–ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞</div>
            </div>
          </div>
        </div>

        <!-- Employee Details Modal -->
        <div id="employeeModal" class="modal">
          <div class="modal-content">
            <span class="modal-close" onclick="closeEmployeeModal()">&times;</span>
            <h2 id="modalEmployeeName" class="modal-title"></h2>

            <div class="modal-metrics">
              <h3>–ü–æ—Ç–æ—á–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h3>
              <div class="modal-metrics-grid" id="modalMetrics"></div>
            </div>

            <div class="modal-chart">
              <h3>–î–∏–Ω–∞–º—ñ–∫–∞ –∑–∞ 4 –º—ñ—Å—è—Ü—ñ</h3>
              <div class="chart-container" style="position: relative; height: 300px; max-height: 300px;">
                <canvas id="modalTrendChart"></canvas>
              </div>
            </div>

            <div class="modal-risk">
              <h3>–†—ñ–≤–µ–Ω—å —Ä–∏–∑–∏–∫—É</h3>
              <p id="modalRiskLevel"></p>
            </div>

            <div class="modal-notes">
              <h3>–ü—Ä–∏–º—ñ—Ç–∫–∏</h3>
              <p id="modalNotes"></p>
            </div>
          </div>
        </div>

        <div class="card" id="wellness-card">
          <div class="card-header">üåø Wellness OS ¬∑ –ü–ª–∞–Ω + –¶—ñ–ª—ñ</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ø–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å, —è–∫–∏–π –∞–¥–∞–ø—Ç—É—î—Ç—å—Å—è –¥–æ –º–µ—Ç—Ä–∏–∫, —Å–Ω—É —Ç–∞ —Å—Ç—Ä–µ—Å—É.
          </p>
          <div class="grid grid-2">
            <div>
              <h4 style="margin-bottom: 0.5rem;">–ü–ª–∞–Ω –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h4>
              <div id="wellness-plan" class="plan-list">
                <div class="form-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–ª–∞–Ω—É...</div>
              </div>
              <div class="toggle-row">
                <button id="complete-plan-btn" class="btn btn-secondary" type="button">–ü–æ–∑–Ω–∞—á–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–∏–º</button>
                <span id="wellness-plan-status" class="form-hint"></span>
              </div>
            </div>
            <div>
              <h4 style="margin-bottom: 0.5rem;">Wellbeing goals</h4>
              <form id="wellness-goals-form">
                <div class="form-group">
                  <label for="goal-sleep">–°–æ–Ω (–≥–æ–¥/–Ω—ñ—á)</label>
                  <input id="goal-sleep" type="number" min="4" max="10" step="1" />
                </div>
                <div class="form-group">
                  <label for="goal-breaks">–ü–∞—É–∑–∞ / –¥–µ–Ω—å (–∫—ñ–ª—å–∫—ñ—Å—Ç—å)</label>
                  <input id="goal-breaks" type="number" min="1" max="10" step="1" />
                </div>
                <div class="form-group">
                  <label for="goal-move">–†—É—Ö (—Ö–≤ / –¥–µ–Ω—å)</label>
                  <input id="goal-move" type="number" min="5" max="120" step="5" />
                </div>
                <div class="toggle-row">
                  <input type="checkbox" id="goal-notifications" />
                  <label for="goal-notifications">Gentle nudges</label>
                </div>
                <div class="toggle-row">
                  <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ü—ñ–ª—ñ</button>
                  <span id="wellness-goals-status" class="form-hint"></span>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="card" id="insights-card">
          <div class="card-header">üîç –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —ñ–Ω—Å–∞–π—Ç–∏</div>
          <div class="grid grid-2">
            <div>
              <h4 style="margin-bottom: 0.5rem;">Self-benchmark ¬∑ —Ç–∏ vs —Ç–∏</h4>
              <div id="self-benchmark" class="insight-list">
                <div class="form-hint">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö</div>
              </div>
            </div>
            <div>
              <h4 style="margin-bottom: 0.5rem;">–ö–æ—Ä–µ–ª—è—Ü—ñ—ó + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h4>
              <div id="correlations-list" class="insight-list">
                <div class="form-hint">–î–∞–Ω—ñ —â–µ –∑–±–∏—Ä–∞—é—Ç—å—Å—è</div>
              </div>
            </div>
          </div>
          <div id="early-signal-banner" class="insight-banner hidden"></div>
        </div>

        <div class="card" id="kudos-card">
          <div class="card-header">üéâ Kudos + Recognition</div>
          <p style="color: var(--gray); margin-bottom: 1rem;">
            –ü—ñ–¥—Ç—Ä–∏–º—É–π—Ç–µ –æ–¥–Ω–µ –æ–¥–Ω–æ–≥–æ. –ü–æ–¥—è–∫–∞ –ø—ñ–¥—Å–∏–ª—é—î –º–æ—Ç–∏–≤–∞—Ü—ñ—é –π –∫—É–ª—å—Ç—É—Ä—É.
          </p>
          <div class="grid grid-2">
            <form id="kudos-form">
              <div class="form-group">
                <label for="kudos-email">Email –∫–æ–ª–µ–≥–∏</label>
                <input id="kudos-email" type="email" placeholder="colleague@opslab.uk" required />
              </div>
              <div class="form-group">
                <label for="kudos-message">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</label>
                <textarea id="kudos-message" rows="3" maxlength="500" placeholder="–î—è–∫—É—é –∑–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫—É..."></textarea>
              </div>
              <div class="toggle-row">
                <button type="submit" class="btn btn-success">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ kudos</button>
                <span id="kudos-status" class="form-hint"></span>
              </div>
            </form>
            <div>
              <h4 style="margin-bottom: 0.5rem;">–Ü–Ω—Å–∞–π—Ç–∏ –≤–∏–∑–Ω–∞–Ω–Ω—è</h4>
              <div id="kudos-insights" class="tag-row">
                <span class="form-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
              </div>
              <div id="kudos-summary" class="form-hint" style="margin-top: 0.75rem;"></div>
              <div class="form-hint">–¢–æ–ø —Ç–µ–º–∏ —Ç–∞ –ª—é–¥–∏, —è–∫—ñ –Ω–∞–π—á–∞—Å—Ç—ñ—à–µ –¥—è–∫—É—é—Ç—å.</div>
            </div>
          </div>
          <div class="grid grid-2" style="margin-top: 1.5rem;">
            <div>
              <h4 style="margin-bottom: 0.5rem;">–û—Ç—Ä–∏–º–∞–Ω—ñ kudos</h4>
              <div id="kudos-received" class="kudos-list"></div>
            </div>
            <div>
              <h4 style="margin-bottom: 0.5rem;">–ù–∞–¥—ñ—Å–ª–∞–Ω—ñ kudos</h4>
              <div id="kudos-sent" class="kudos-list"></div>
            </div>
          </div>
        </div>

        <!-- Telegram Bot Info -->
        <div class="card">
          <div class="card-header">ü§ñ Telegram Bot Integration</div>
          <p style="margin-bottom: 1rem;">
            –©–æ–¥–µ–Ω–Ω—ñ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—é –∞–Ω–∞–ª—ñ—Ç–∏–∫–æ—é —Ç–∞ AI-–ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é.
          </p>
          <div class="grid grid-2">
            <div>
              <h4 style="margin-bottom: 0.5rem;">–î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:</h4>
              <ul style="list-style: none; padding-left: 0;">
                <li class="mono" style="margin: 0.5rem 0;">üìã /help - –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥</li>
                <li class="mono" style="margin: 0.5rem 0;">‚úÖ /checkin - –©–æ–¥–µ–Ω–Ω–∏–π —á–µ–∫—ñ–Ω</li>
                <li class="mono" style="margin: 0.5rem 0;">üìä /status - –í–∞—à —Å—Ç–∞–Ω</li>
                <li class="mono" style="margin: 0.5rem 0;">üîó /weblogin - –í—Ö—ñ–¥ –≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</li>
                <li class="mono" style="margin: 0.5rem 0;">üí¨ /wall - OpsLab Feedback</li>
                <li class="mono" style="margin: 0.5rem 0;">‚è∞ /settime - –ß–∞—Å –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å</li>
                <li class="mono" style="margin: 0.5rem 0;">üåç /timezone - –ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å</li>
                <li class="mono" style="margin: 0.5rem 0;">üîî /notify - –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è on/off</li>
                <li class="mono" style="margin: 0.5rem 0;">‚öôÔ∏è /settings - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</li>
                <li class="mono" style="margin: 0.5rem 0;">üéâ /kudos - –ü–æ–¥—è–∫–∞ –∫–æ–ª–µ–∑—ñ</li>
                <li class="mono" style="margin: 0.5rem 0;">üåø /plan - –ü–ª–∞–Ω Wellness OS</li>
                <li class="mono" style="margin: 0.5rem 0;">üéØ /goals - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —Ü—ñ–ª—ñ</li>
                <li class="mono" style="margin: 0.5rem 0;">üó£ /pulse - Pulse rooms</li>
                <li class="mono" style="margin: 0.5rem 0;">‚ú® /insight - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π —ñ–Ω—Å–∞–π—Ç</li>
              </ul>
            </div>
            <div>
              <h4 style="margin-bottom: 0.5rem;">–ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:</h4>
              <ul style="padding-left: 1.5rem;">
                <li>–ì–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—î—é</li>
                <li>AI-–∞–Ω–∞–ª—ñ–∑ –µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ —Å—Ç–∞–Ω—É</li>
                <li>–û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞ –ø—Ä–∏–≤ º—è–∑–∫–∞: /start email –∫–æ–¥</li>
                <li>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è</li>
                <li>–©–æ—Ç–∏–∂–Ω–µ–≤—ñ –∑–≤—ñ—Ç–∏ (–ü'—è—Ç–Ω–∏—Ü—è 17:00)</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card" id="telegram-settings-card">
          <div class="card-header">üîî –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å</div>
          <div class="grid grid-2">
            <div>
              <h4 style="margin-bottom: 0.5rem;">–°—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</h4>
              <div id="telegram-connection-status" class="form-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
              <div id="telegram-pin-info" class="form-hint"></div>
              <div class="form-hint">–ü—Ä–∏–≤ º—è–∑–∫–∞: <span class="mono">/start email@opslab.uk 1234</span>.</div>
              <div class="form-hint">–ö–æ–¥ –¥–æ—Å—Ç—É–ø—É –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ –∑–≤ º—è–∑—É—î Telegram –∑ –∞–∫–∞—É–Ω—Ç–æ–º.</div>
            </div>
            <div>
              <h4 style="margin-bottom: 0.5rem;">–û—Å–æ–±–∏—Å—Ç—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h4>
              <form id="telegram-settings-form">
                <div class="form-group">
                  <label for="reminder-time">–ß–∞—Å –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å</label>
                  <input type="time" id="reminder-time" />
                </div>
                <div class="form-group">
                  <label for="timezone-input">–ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å</label>
                  <input type="text" id="timezone-input" placeholder="Europe/Kyiv –∞–±–æ UTC+2" />
                </div>
                <div class="toggle-row">
                  <input type="checkbox" id="notifications-enabled" />
                  <label for="notifications-enabled">–£–≤—ñ–º–∫–Ω—É—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è</label>
                </div>
                <div class="toggle-row">
                  <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                  <span id="telegram-settings-status" class="form-hint"></span>
                </div>
              </form>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ===== ADVANCED ANALYTICS SECTION ===== -->
    <div id="advanced-section" class="section">
      <div class="container">
        <div class="card">
          <div class="card-header">üß† Advanced Analytics</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –†–æ–∑—à–∏—Ä–µ–Ω—ñ —ñ–Ω—Å–∞–π—Ç–∏, —Ä–∏–∑–∏–∫–∏ —Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏ –¥–ª—è –≥–ª–∏–±–æ–∫–æ—ó —Ä–æ–±–æ—Ç–∏ –∑ –∫–æ–º–∞–Ω–¥–æ—é.
          </p>
        </div>

        <section class="health-score-section dashboard-block">
          <h2 class="section-title">Team Health Score</h2>
          <div class="health-score-card">
            <div class="health-score-value" id="healthScore">‚Äî</div>
            <div class="health-score-label">–∑ 100</div>
            <div class="health-score-indicator" id="healthIndicator"></div>
          </div>
          <div class="december-notice" id="decemberNotice" style="display: none;">
            ‚ö†Ô∏è –ì—Ä—É–¥–µ–Ω—å: —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–æ –≤–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∏ —Ç–∞ –ø—ñ–¥—Å—É–º–∫–∏ —Ä–æ–∫—É.
          </div>
        </section>

        <section class="benchmarking-section dashboard-block">
          <h2 class="section-title">–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ —ñ–Ω–¥—É—Å—Ç—Ä—ñ—î—é</h2>
          <div class="benchmark-grid">
            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>WHO-5 –ë–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</h3>
                <span class="benchmark-status" id="who5Status"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="who5Your"></div>
                  <div class="benchmark-industry" id="who5Industry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="who5YourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong>62</strong></span>
                </div>
              </div>
            </div>

            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>PHQ-9 –î–µ–ø—Ä–µ—Å—ñ—è</h3>
                <span class="benchmark-status" id="phq9Status"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="phq9Your"></div>
                  <div class="benchmark-industry" id="phq9Industry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="phq9YourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong>6.8</strong></span>
                </div>
              </div>
            </div>

            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>GAD-7 –¢—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å</h3>
                <span class="benchmark-status" id="gad7Status"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="gad7Your"></div>
                  <div class="benchmark-industry" id="gad7Industry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="gad7YourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong>7.5</strong></span>
                </div>
              </div>
            </div>

            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>MBI –í–∏–≥–æ—Ä–∞–Ω–Ω—è</h3>
                <span class="benchmark-status" id="mbiStatus"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="mbiYour"></div>
                  <div class="benchmark-industry" id="mbiIndustry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="mbiYourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong>42</strong></span>
                </div>
              </div>
            </div>

            <div class="benchmark-card">
              <div class="benchmark-header">
                <h3>–†—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É</h3>
                <span class="benchmark-status" id="stressStatus"></span>
              </div>
              <div class="benchmark-comparison">
                <div class="benchmark-bar">
                  <div class="benchmark-your" id="stressYour"></div>
                  <div class="benchmark-industry" id="stressIndustry"></div>
                </div>
                <div class="benchmark-values">
                  <span>–í–∏: <strong id="stressYourValue">‚Äî</strong></span>
                  <span>–Ü–Ω–¥—É—Å—Ç—Ä—ñ—è: <strong>18</strong></span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="charts-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–î–∏–Ω–∞–º—ñ–∫–∞ —Ç–∞ —Ä–∏–∑–∏–∫–∏</h2>
            <p class="section-subtitle">–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è, —Ä–∞–Ω–Ω—ñ —Å–∏–≥–Ω–∞–ª–∏ —Ç–∞ –º–∞—Ç—Ä–∏—Ü—è —Ä–∏–∑–∏–∫—ñ–≤.</p>
          </div>

          <div class="chart-card full-width lift" onclick="openChartModal('trajectoryModal')">
            <div class="chart-title">–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</div>
            <div class="chart-container trajectory-container">
              <canvas id="trajectoryChart"></canvas>
            </div>
            <p class="chart-note">WHO-5, —Å—Ç—Ä–µ—Å —ñ —Å–æ–Ω –Ω–æ—Ä–º–æ–≤–∞–Ω—ñ –¥–æ 100 –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.</p>
            <p class="chart-comment" id="trajectoryComment">–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è...</p>
          </div>

          <div class="chart-card full-width lift" onclick="openChartModal('riskModal')">
            <div class="chart-title">–ú–∞—Ç—Ä–∏—Ü—è —Ä–∏–∑–∏–∫—ñ–≤ 1:1</div>
            <div class="chart-container risk-matrix-container">
              <canvas id="riskBubbleChart"></canvas>
            </div>
            <p class="chart-comment" id="riskComment">–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è...</p>
          </div>
        </section>

        <section class="forecast-section dashboard-block">
          <h2 class="section-title">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –º—ñ—Å—è—Ü—å</h2>
          <div class="forecast-warning">‚ö†Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ç–æ—á–Ω—ñ–π –¥–∏–Ω–∞–º—ñ—Ü—ñ</div>
          <div class="forecast-grid" id="forecastGrid"></div>
        </section>

        <section class="sleep-debt-section dashboard-block">
          <h2 class="section-title">–ê–Ω–∞–ª—ñ–∑ –±–æ—Ä–≥—É —Å–Ω—É</h2>
          <div class="sleep-debt-summary">
            <div class="sleep-debt-stat">
              <div class="stat-value" id="totalSleepDebt">‚Äî</div>
              <div class="stat-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –±–æ—Ä–≥ —Å–Ω—É (–≥–æ–¥)</div>
            </div>
            <div class="sleep-debt-stat">
              <div class="stat-value" id="avgSleepDebt">‚Äî</div>
              <div class="stat-label">–°–µ—Ä–µ–¥–Ω—ñ–π –±–æ—Ä–≥ –Ω–∞ –ª—é–¥–∏–Ω—É (–≥–æ–¥/—Ç–∏–∂–¥–µ–Ω—å)</div>
            </div>
            <div class="sleep-debt-stat">
              <div class="stat-value" id="atRiskCount">‚Äî</div>
              <div class="stat-label">–õ—é–¥–µ–π —É –∑–æ–Ω—ñ —Ä–∏–∑–∏–∫—É</div>
            </div>
          </div>
          <div class="chart-container" style="height: 320px;">
            <canvas id="sleepDebtChart"></canvas>
          </div>
        </section>

        <section class="insights-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–ö–ª—é—á–æ–≤—ñ —ñ–Ω—Å–∞–π—Ç–∏ –ø–æ –ª—é–¥—è–º</h2>
            <p class="section-subtitle">–¢–æ–ø-—Ä–∏–∑–∏–∫–∏, –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –µ—Ç–∞–ª–æ–Ω–Ω—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏.</p>
          </div>
          <div class="insight-grid" id="insightGrid"></div>
        </section>

        <section class="roi-section dashboard-block">
          <h2 class="section-title">ROI Calculator</h2>
          <div class="roi-grid">
            <div class="roi-card">
              <div class="roi-label">–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å–Ω—É</div>
              <div class="roi-value" id="roiSleep">+1.2 –≥–æ–¥/–¥–µ–Ω—å</div>
            </div>
            <div class="roi-card">
              <div class="roi-label">–ó—Ä–æ—Å—Ç–∞–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>
              <div class="roi-value" id="roiProductivity">+18%</div>
            </div>
            <div class="roi-card">
              <div class="roi-label">–ó–Ω–∏–∂–µ–Ω–Ω—è –≤–∏–≥–æ—Ä–∞–Ω–Ω—è</div>
              <div class="roi-value" id="roiBurnout">-35%</div>
            </div>
            <div class="roi-card roi-highlight">
              <div class="roi-label">–†—ñ—á–Ω–∞ –µ–∫–æ–Ω–æ–º—ñ—è</div>
              <div class="roi-value" id="roiSavings">$21,500</div>
            </div>
          </div>
        </section>

        <section class="playbooks-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">üéØ 1:1 –ü–ª–µ–π–±—É–∫–∏ —Ç–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏</h2>
            <p class="section-subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó 1:1 –¥–ª—è —Ñ–æ–∫—É—Å—É –Ω–∞ —Ä–∏–∑–∏–∫–∞—Ö.</p>
          </div>
          <div id="playbooks-grid" class="playbooks-grid"></div>
        </section>

        <section class="recommendations-section dashboard-block">
          <div class="section-heading">
            <h2 class="section-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</h2>
            <p class="section-subtitle">–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –º–µ—Ç—Ä–∏–∫ —Ç–∞ —Ç—Ä–µ–Ω–¥—ñ–≤.</p>
          </div>
          <div class="recommendations-grid" id="recommendationsGrid"></div>
        </section>

        <div id="trajectoryModal" class="modal" onclick="modalBgClick(event, 'trajectoryModal')">
          <div class="modal-content">
            <span class="modal-close" onclick="closeChartModal('trajectoryModal')">&times;</span>
            <h2 class="modal-title">–¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—è –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è</h2>
            <div class="modal-notes">
              <p id="trajectorySummary">–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è...</p>
            </div>
            <div class="modal-metrics">
              <h3>–ö–ª—é—á–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h3>
              <div class="modal-metrics-grid" id="trajectoryMetrics"></div>
            </div>
          </div>
        </div>

        <div id="riskModal" class="modal" onclick="modalBgClick(event, 'riskModal')">
          <div class="modal-content">
            <span class="modal-close" onclick="closeChartModal('riskModal')">&times;</span>
            <h2 class="modal-title">–ú–∞—Ç—Ä–∏—Ü—è —Ä–∏–∑–∏–∫—ñ–≤ 1:1</h2>
            <div class="modal-notes">
              <p id="riskSummary">–î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è...</p>
            </div>
            <div class="modal-metrics">
              <h3>–†–æ–∑–∫–ª–∞–¥–∞–Ω–Ω—è —Ä–∏–∑–∏–∫—É</h3>
              <div class="modal-metrics-grid" id="riskMetrics"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PULSE ROOMS SECTION ===== -->
    <div id="pulse-section" class="section">
      <div class="container">
        <div class="card">
          <div class="card-header">üó£ Pulse Rooms</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –ê–Ω–æ–Ω—ñ–º–Ω—ñ –∫–æ–º–∞–Ω–¥–Ω—ñ pulse-–∫—ñ–º–Ω–∞—Ç–∏ –∑ –º–æ–¥–µ—Ä–∞—Ü—ñ—î—é –¥–ª—è —á–µ—Å–Ω–∏—Ö –æ–±–≥–æ–≤–æ—Ä–µ–Ω—å.
          </p>
          <div id="pulse-rooms" class="grid grid-3"></div>
        </div>

        <div class="card">
          <div class="card-header">üí¨ –û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏</div>
          <div id="pulse-room-meta" class="form-hint">–û–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É</div>
          <div id="pulse-messages" class="pulse-list"></div>
          <form id="pulse-message-form" style="margin-top: 1rem;">
            <div class="form-group">
              <label for="pulse-message-content">–í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</label>
              <textarea id="pulse-message-content" rows="3" maxlength="3000" placeholder="–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –¥—É–º–∫–∞–º–∏..."></textarea>
              <div class="toggle-row">
                <input type="checkbox" id="pulse-anonymous" checked />
                <label for="pulse-anonymous">–ù–∞–¥—Å–∏–ª–∞—Ç–∏ –∞–Ω–æ–Ω—ñ–º–Ω–æ</label>
              </div>
            </div>
            <div class="toggle-row">
              <button type="submit" class="btn btn-success">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
              <span id="pulse-message-status" class="form-hint"></span>
            </div>
          </form>
        </div>

        <div class="card hidden" id="pulse-moderation-card">
          <div class="card-header">üõ°Ô∏è –ß–µ—Ä–≥–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó</div>
          <div id="pulse-moderation-queue" class="moderation-queue"></div>
        </div>
      </div>
    </div>

    <!-- ===== ADMIN SECTION ===== -->
    <div id="admin-section" class="section">
      <div class="container">
        <div class="card">
          <div class="card-header">üë• –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –°—Ç–≤–æ—Ä—é–π—Ç–µ –Ω–æ–≤—ñ –∞–∫–∞—É–Ω—Ç–∏, –¥–µ–∞–∫—Ç–∏–≤—É–π—Ç–µ –∑–≤—ñ–ª—å–Ω–µ–Ω–∏—Ö —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª—é–π—Ç–µ –¥–æ—Å—Ç—É–ø –∑–∞ –ø–æ—Ç—Ä–µ–±–∏.
            –î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º—ñ –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.
          </p>

          <div class="grid grid-2">
            <form id="admin-user-form">
              <div class="form-group">
                <label for="admin-user-name">–Ü–º º—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</label>
                <input id="admin-user-name" type="text" placeholder="–Ü–º º—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" required />
              </div>
              <div class="form-group">
                <label for="admin-user-email">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞ –ø–æ—à—Ç–∞</label>
                <input id="admin-user-email" type="email" placeholder="user@opslab.uk" required />
              </div>
              <div class="form-group">
                <label for="admin-user-role">–†–æ–ª—å</label>
                <select id="admin-user-role">
                  <option value="EMPLOYEE">EMPLOYEE</option>
                  <option value="FOUNDER">FOUNDER</option>
                  <option value="ADMIN">ADMIN</option>
                </select>
              </div>
              <div class="form-group">
                <label for="admin-user-code">4-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥</label>
                <div class="toggle-row">
                  <input id="admin-user-code" type="text" maxlength="4" placeholder="1234" />
                  <button id="generate-user-code" class="btn btn-secondary" type="button">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
                </div>
              </div>
              <div class="form-group">
                <label for="admin-user-note">–ù–æ—Ç–∞—Ç–∫–∞ (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                <input id="admin-user-note" type="text" placeholder="–ö–æ–º–∞–Ω–¥–∞, –≤—ñ–¥–¥—ñ–ª –∞–±–æ —Ä–æ–ª—å" />
              </div>
              <div class="toggle-row">
                <button type="submit" class="btn btn-primary">–î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
                <span id="admin-user-status" class="form-hint"></span>
              </div>
            </form>
            <div>
              <h4 style="margin-bottom: 0.75rem;">–ü—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h4>
              <ul style="padding-left: 1.2rem;">
                <li>–ö–æ–¥ –¥–æ—Å—Ç—É–ø—É –ø–æ–≤—ñ–¥–æ–º–ª—è—î—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –æ–∫—Ä–µ–º–∏–º –∫–∞–Ω–∞–ª–æ–º.</li>
                <li>–¶–µ–π –∫–æ–¥ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—ó –ø—Ä–∏–≤ º—è–∑–∫–∏ Telegram: /start email –∫–æ–¥.</li>
                <li>–ü—Ä–∏–≤ º—è–∑–∫—É Telegram –º–æ–∂–Ω–∞ —Å–∫–∏–Ω—É—Ç–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó.</li>
                <li>–ü—ñ—Å–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó Telegram ID –æ—á–∏—â—É—î—Ç—å—Å—è –¥–ª—è –±–µ–∑–ø–µ–∫–∏.</li>
                <li>–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É –Ω–µ –≤–∏–¥–∞–ª—è—î —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –¥–∞–Ω—ñ.</li>
              </ul>
            </div>
          </div>

          <div class="admin-toolbar">
            <input id="admin-user-search" type="text" placeholder="–ü–æ—à—É–∫ –∑–∞ —ñ–º º—è–º –∞–±–æ email" />
            <label class="toggle-row" style="margin: 0;">
              <input type="checkbox" id="admin-show-inactive" checked />
              <span>–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö</span>
            </label>
          </div>

          <div class="admin-table-wrap">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                  <th>–†–æ–ª—å</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>Telegram</th>
                  <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
                  <th>–í—ñ–¥–∫–ª—é—á–µ–Ω–æ</th>
                  <th>–î—ñ—ó</th>
                </tr>
              </thead>
              <tbody id="admin-users-table"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">üß© –ö–æ–º–∞–Ω–¥–Ω–∏–π Heatmap</div>
          <p style="color: var(--gray); margin-bottom: 1.5rem;">
            –°—Ç–∞–Ω –∫–æ–º–∞–Ω–¥–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —â–æ–¥–µ–Ω–Ω–∏—Ö —á–µ–∫—ñ–Ω—ñ–≤ (–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è Admin/Founder).
          </p>
          <div id="team-heatmap" class="grid grid-3"></div>
        </div>

      </div>
    </div>

  </div>

  <script>
    // ===== GLOBAL STATE =====
    let currentUser = null;
    let currentSection = 'mindguard';
    let teamDashboardData = null;
    let teamDashboardSelectedKey = null;
    let teamDashboardEmployeeKey = null;
    let teamDashboardCharts = {};
    let advancedCharts = {};
    let advancedData = null;
    let telegramStatus = null;
    let teamHeatmap = null;
    let adminUsers = [];
    let adminSearch = '';
    let showInactiveUsers = true;
    let wellnessPlan = null;
    let wellnessGoals = null;
    let insights = { selfBenchmark: null, correlations: [], earlySignal: null };
    let kudosData = null;
    let pulseRooms = [];
    let activePulseRoom = null;
    let pulseMessages = [];
    let pulseModerationQueue = [];

    // ===== API HELPERS =====
    async function apiCall(endpoint, options = {}) {
      const response = await fetch(endpoint, {
        ...options,
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...options.headers,
        },
      });

      if (response.status === 401) {
        showLogin();
        throw new Error('Unauthorized');
      }

      if (response.status === 204) {
        return null;
      }

      if (!response.ok) {
        const text = await response.text().catch(() => '');
        throw new Error(text || `HTTP ${response.status}`);
      }

      const contentType = response.headers.get('content-type') || '';
      if (contentType.includes('application/json')) {
        return response.json();
      }
      return null;
    }

    // ===== LOGIN =====
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value;
      const code = document.getElementById('code').value;
      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = '';

      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code }),
          credentials: 'include',
        });

        if (!response.ok) {
          throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –∫–æ–¥');
        }

        currentUser = await response.json();
        await loadApp();

      } catch (error) {
        errorContainer.innerHTML = `
          <div class="error-message">
            ‚ùå ${error.message}
          </div>
        `;
      }
    });

    // ===== LOGOUT =====
    document.getElementById('logout-btn').addEventListener('click', async () => {
      try {
        await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
      } finally {
        showLogin();
      }
    });

    // ===== NAVIGATION =====
    document.querySelectorAll('.nav-link[data-section]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = link.dataset.section;
        switchSection(section);
      });
    });

    function switchSection(section) {
      if ((section === 'admin' || section === 'advanced') && !isAdmin()) {
        return;
      }
      currentSection = section;

      // Update nav
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`[data-section="${section}"]`).classList.add('active');

      // Update sections
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(`${section}-section`).classList.add('active');

      // Load data
      if (section === 'mindguard') {
        loadMindguardData();
      } else if (section === 'advanced') {
        loadAdvancedAnalytics();
      } else if (section === 'pulse') {
        loadPulseRooms();
        if (isAdmin()) {
          loadPulseModeration();
        }
      } else if (section === 'admin') {
        loadTeamHeatmap();
        loadAdminUsers();
      }
    }

    // ===== LOAD APP =====
    async function loadApp() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');

      // Set user name
      document.getElementById('user-name').textContent = currentUser?.name || 'User';
      document.getElementById('user-role').textContent = currentUser?.role || '';

      const adminLink = document.getElementById('admin-link');
      const advancedLink = document.getElementById('advanced-link');
      if (isAdmin()) {
        adminLink.classList.remove('hidden');
        if (advancedLink) {
          advancedLink.classList.remove('hidden');
        }
      } else {
        adminLink.classList.add('hidden');
        if (advancedLink) {
          advancedLink.classList.add('hidden');
        }
      }

      // Load initial data
      await loadMindguardData();
    }

    function showLogin() {
      document.getElementById('app').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      currentUser = null;
    }

    function isAdmin() {
      return currentUser?.role === 'ADMIN' || currentUser?.role === 'FOUNDER';
    }

    // ===== MINDGUARD DATA =====
    async function loadMindguardData() {
      await loadTeamDashboardData();
      await loadTelegramStatus();
      await Promise.all([
        loadWellnessData(),
        loadInsights(),
        loadKudos(),
      ]);

      if (isAdmin()) {
        await loadTeamHeatmap();
      }
    }

    // ===== TEAM DASHBOARD =====
    const MONTH_LABELS = {
      1: '–°—ñ—á–µ–Ω—å',
      2: '–õ—é—Ç–∏–π',
      3: '–ë–µ—Ä–µ–∑–µ–Ω—å',
      4: '–ö–≤—ñ—Ç–µ–Ω—å',
      5: '–¢—Ä–∞–≤–µ–Ω—å',
      6: '–ß–µ—Ä–≤–µ–Ω—å',
      7: '–õ–∏–ø–µ–Ω—å',
      8: '–°–µ—Ä–ø–µ–Ω—å',
      9: '–í–µ—Ä–µ—Å–µ–Ω—å',
      10: '–ñ–æ–≤—Ç–µ–Ω—å',
      11: '–õ–∏—Å—Ç–æ–ø–∞–¥',
      12: '–ì—Ä—É–¥–µ–Ω—å',
    };

    const MONTH_LABELS_SHORT = {
      1: '–°—ñ—á',
      2: '–õ—é—Ç',
      3: '–ë–µ—Ä',
      4: '–ö–≤—ñ—Ç',
      5: '–¢—Ä–∞–≤',
      6: '–ß–µ—Ä–≤',
      7: '–õ–∏–ø',
      8: '–°–µ—Ä–ø',
      9: '–í–µ—Ä',
      10: '–ñ–æ–≤—Ç',
      11: '–õ–∏—Å—Ç',
      12: '–ì—Ä—É–¥',
    };

    const METRIC_HINTS = {
      who5: 'WHO-5: 0-100, <50 ‚Äî —Ä–∏–∑–∏–∫ –Ω–∏–∑—å–∫–æ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è',
      phq9: 'PHQ-9: 0-27, >10 ‚Äî –ø–æ–º—ñ—Ä–Ω–∞/–≤–∏—Å–æ–∫–∞ –¥–µ–ø—Ä–µ—Å–∏–≤–Ω–∞ —Å–∏–º–ø—Ç–æ–º–∞—Ç–∏–∫–∞',
      gad7: 'GAD-7: 0-21, >10 ‚Äî –ø–æ–º—ñ—Ä–Ω–∞/–≤–∏—Å–æ–∫–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å',
      mbi: 'MBI: 0-100%, >40% ‚Äî –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è',
      sleepDuration: '–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É: —Ü—ñ–ª—å 7-9 –≥–æ–¥',
      sleepQuality: '–Ø–∫—ñ—Å—Ç—å —Å–Ω—É: 1-10, <6 ‚Äî –ø–æ–≥—ñ—Ä—à–µ–Ω–Ω—è',
      workLifeBalance: '–ë–∞–ª–∞–Ω—Å: 1-10, <6 ‚Äî –¥–∏—Å–±–∞–ª–∞–Ω—Å',
      stressLevel: '–°—Ç—Ä–µ—Å: 0-40, >20 ‚Äî –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π',
    };

    function monthKeyFromParts(year, month) {
      return `${year}-${String(month).padStart(2, '0')}`;
    }

    function parseMonthKey(key) {
      const [year, month] = key.split('-').map(Number);
      return { year, month };
    }

    function monthLabelFromKey(key, short = false) {
      const { year, month } = parseMonthKey(key);
      const label = short ? MONTH_LABELS_SHORT[month] : MONTH_LABELS[month];
      return `${label || '–ú—ñ—Å—è—Ü—å'} ${year}`;
    }

    function compareMonthKeys(a, b) {
      const pa = parseMonthKey(a);
      const pb = parseMonthKey(b);
      if (pa.year !== pb.year) return pa.year - pb.year;
      return pa.month - pb.month;
    }

    function getTeamMonthList() {
      if (!teamDashboardData?.months) return [];
      return [...teamDashboardData.months].sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
      });
    }

    function getTeamMonthByKey(key) {
      const months = getTeamMonthList();
      return months.find(m => monthKeyFromParts(m.year, m.month) === key) || null;
    }

    async function loadTeamDashboardData() {
      const monthSelector = document.getElementById('team-month-selector');
      const employeeBody = document.getElementById('employee-table-body');
      try {
        teamDashboardData = await apiCall('/api/team-data');
      } catch (error) {
        if (monthSelector) {
          monthSelector.innerHTML = '<span class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ</span>';
        }
        if (employeeBody) {
          employeeBody.innerHTML = '<tr><td colspan="10">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</td></tr>';
        }
        return;
      }

      const months = getTeamMonthList();
      if (!months.length) {
        if (monthSelector) {
          monthSelector.innerHTML = '<span class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</span>';
        }
        return;
      }

      const latest = months[months.length - 1];
      const latestKey = monthKeyFromParts(latest.year, latest.month);
      if (!teamDashboardSelectedKey || !months.some(m => monthKeyFromParts(m.year, m.month) === teamDashboardSelectedKey)) {
        teamDashboardSelectedKey = latestKey;
      }
      if (!teamDashboardEmployeeKey || !months.some(m => monthKeyFromParts(m.year, m.month) === teamDashboardEmployeeKey)) {
        teamDashboardEmployeeKey = latestKey;
      }

      renderTeamMonthSelector();
      renderEmployeeMonthSelector();
      renderTeamMetrics();
      renderTeamTrendChart();
      renderEmployeeTable();
      renderRiskAssessment();
    }

    function renderTeamMonthSelector() {
      const container = document.getElementById('team-month-selector');
      if (!container) return;
      container.innerHTML = '';

      const months = getTeamMonthList();
      const display = [...months].reverse();
      display.forEach(month => {
        const key = monthKeyFromParts(month.year, month.month);
        const button = document.createElement('button');
        button.className = `month-btn${key === teamDashboardSelectedKey ? ' active' : ''}`;
        button.textContent = monthLabelFromKey(key);
        button.addEventListener('click', () => {
          teamDashboardSelectedKey = key;
          renderTeamMonthSelector();
          renderTeamMetrics();
          renderRiskAssessment();
        });
        container.appendChild(button);
      });

      updateDashboardDecemberNotice();
    }

    function updateDashboardDecemberNotice() {
      const notice = document.getElementById('dashboardDecemberNotice');
      if (!notice || !teamDashboardSelectedKey) return;
      const { month } = parseMonthKey(teamDashboardSelectedKey);
      notice.style.display = month === 12 ? 'block' : 'none';
    }

    function renderEmployeeMonthSelector() {
      const container = document.getElementById('employee-month-selector');
      if (!container) return;
      container.innerHTML = '';

      const months = getTeamMonthList();
      const display = [...months].reverse();
      display.forEach(month => {
        const key = monthKeyFromParts(month.year, month.month);
        const button = document.createElement('button');
        button.className = `employee-month-btn${key === teamDashboardEmployeeKey ? ' active' : ''}`;
        button.textContent = monthLabelFromKey(key);
        button.addEventListener('click', () => {
          teamDashboardEmployeeKey = key;
          renderEmployeeMonthSelector();
          renderEmployeeTable();
        });
        container.appendChild(button);
      });
    }

    function getSelectedTeamMonth() {
      if (!teamDashboardSelectedKey) return null;
      return getTeamMonthByKey(teamDashboardSelectedKey);
    }

    function getRiskLevel(metric, value) {
      const thresholds = {
        who5: { low: 50, medium: 75 },
        phq9: { low: 5, medium: 10 },
        gad7: { low: 5, medium: 10 },
        mbi: { low: 25, medium: 50 },
        sleepDuration: { low: 6, medium: 7 },
        sleepQuality: { low: 4, medium: 7 },
        workLifeBalance: { low: 4, medium: 7 },
        stressLevel: { low: 14, medium: 27 },
      };

      const t = thresholds[metric];
      if (!t || value === null || value === undefined) return 'low';

      if (['who5', 'sleepDuration', 'sleepQuality', 'workLifeBalance'].includes(metric)) {
        if (value >= t.medium) return 'low';
        if (value >= t.low) return 'medium';
        return 'high';
      }

      if (value < t.low) return 'low';
      if (value < t.medium) return 'medium';
      return 'high';
    }

    function updateRiskIndicator(elementId, riskLevel) {
      const element = document.getElementById(elementId);
      if (!element) return;
      const labels = {
        low: '–ù–∏–∑—å–∫–∏–π —Ä–∏–∑–∏–∫',
        medium: '–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫',
        high: '–í–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫',
      };
      element.textContent = labels[riskLevel] || '–ù/–î';
      element.className = `risk-indicator risk-${riskLevel}`;
    }

    function renderTeamMetrics() {
      const data = getSelectedTeamMonth();
      if (!data || !data.averages) return;
      const avg = data.averages;

      document.getElementById('who5-value').textContent = avg.who5?.toFixed(1) ?? '‚Äî';
      updateRiskIndicator('who5-risk', getRiskLevel('who5', avg.who5));

      document.getElementById('phq9-value').textContent = avg.phq9?.toFixed(1) ?? '‚Äî';
      updateRiskIndicator('phq9-risk', getRiskLevel('phq9', avg.phq9));

      document.getElementById('gad7-value').textContent = avg.gad7?.toFixed(1) ?? '‚Äî';
      updateRiskIndicator('gad7-risk', getRiskLevel('gad7', avg.gad7));

      document.getElementById('mbi-value').textContent = avg.mbi !== undefined
        ? `${avg.mbi.toFixed(1)}%`
        : '‚Äî';
      updateRiskIndicator('mbi-risk', getRiskLevel('mbi', avg.mbi));

      document.getElementById('sleep-duration-value').textContent = avg.sleepDuration !== undefined
        ? `${avg.sleepDuration.toFixed(1)} –≥–æ–¥`
        : '‚Äî';
      updateRiskIndicator('sleep-duration-risk', getRiskLevel('sleepDuration', avg.sleepDuration));

      document.getElementById('sleep-quality-value').textContent = avg.sleepQuality?.toFixed(1) ?? '‚Äî';
      updateRiskIndicator('sleep-quality-risk', getRiskLevel('sleepQuality', avg.sleepQuality));

      document.getElementById('work-life-value').textContent = avg.workLifeBalance?.toFixed(1) ?? '‚Äî';
      updateRiskIndicator('work-life-risk', getRiskLevel('workLifeBalance', avg.workLifeBalance));

      document.getElementById('stress-value').textContent = avg.stressLevel?.toFixed(1) ?? '‚Äî';
      updateRiskIndicator('stress-risk', getRiskLevel('stressLevel', avg.stressLevel));
    }

    function getScoreClass(metric, value) {
      const risk = getRiskLevel(metric, value);
      if (risk === 'low') return 'score-good';
      if (risk === 'medium') return 'score-warning';
      return 'score-danger';
    }

    function getRiskLabel(risk) {
      const labels = {
        low: '–ù–∏–∑—å–∫–∏–π',
        medium: '–°–µ—Ä–µ–¥–Ω—ñ–π',
        high: '–í–∏—Å–æ–∫–∏–π',
        critical: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π',
      };
      return labels[risk] || '–ù–µ–≤—ñ–¥–æ–º–æ';
    }

    function renderTeamTrendChart() {
      const months = getTeamMonthList();
      if (!months.length) return;

      const labels = months.map(m => monthLabelFromKey(monthKeyFromParts(m.year, m.month), true));
      const ctx = document.getElementById('teamTrendChart');
      if (!ctx) return;

      if (teamDashboardCharts.teamTrend) {
        teamDashboardCharts.teamTrend.destroy();
      }

      teamDashboardCharts.teamTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'WHO-5',
              metricKey: 'who5',
              data: months.map(m => m.averages?.who5 ?? 0),
              borderColor: '#1f8f3a',
              tension: 0.35,
              borderWidth: 3,
            },
            {
              label: 'PHQ-9',
              metricKey: 'phq9',
              data: months.map(m => m.averages?.phq9 ?? 0),
              borderColor: '#ffb000',
              tension: 0.35,
              borderWidth: 3,
            },
            {
              label: 'GAD-7',
              metricKey: 'gad7',
              data: months.map(m => m.averages?.gad7 ?? 0),
              borderColor: '#ff595e',
              tension: 0.35,
              borderWidth: 3,
            },
            {
              label: 'MBI (%)',
              metricKey: 'mbi',
              data: months.map(m => m.averages?.mbi ?? 0),
              borderColor: '#6a4c93',
              tension: 0.35,
              borderWidth: 3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: (context) => {
                  const key = context.dataset.metricKey;
                  const hint = METRIC_HINTS[key] || '';
                  return `${context.dataset.label}: ${context.parsed.y}${hint ? ' (' + hint + ')' : ''}`;
                }
              }
            }
          },
          scales: {
            y: { beginAtZero: true },
          },
        },
      });
    }

    function renderEmployeeTable() {
      const data = teamDashboardEmployeeKey ? getTeamMonthByKey(teamDashboardEmployeeKey) : null;
      const tbody = document.getElementById('employee-table-body');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!data || !data.employees || data.employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>';
        return;
      }

      data.employees.forEach(emp => {
        const risks = [
          getRiskLevel('who5', emp.who5),
          getRiskLevel('phq9', emp.phq9),
          getRiskLevel('gad7', emp.gad7),
          getRiskLevel('mbi', emp.mbi),
          getRiskLevel('sleepDuration', emp.sleepDuration),
          getRiskLevel('sleepQuality', emp.sleepQuality),
          getRiskLevel('workLifeBalance', emp.workLifeBalance),
          getRiskLevel('stressLevel', emp.stressLevel),
        ];

        const highCount = risks.filter(r => r === 'high').length;
        const mediumCount = risks.filter(r => r === 'medium').length;

        let overallRisk = 'low';
        if (highCount >= 3 || (highCount >= 2 && mediumCount >= 3)) {
          overallRisk = 'high';
        } else if (highCount >= 1 || mediumCount >= 3) {
          overallRisk = 'medium';
        }

        const row = document.createElement('tr');
        const userId = emp.userId || emp.user_id || emp.id || '';
        row.innerHTML = `
          <td class="employee-name clickable" onclick="openEmployeeModal('${userId}')">${emp.name}</td>
          <td class="score-cell ${getScoreClass('who5', emp.who5)}">${emp.who5.toFixed(1)}</td>
          <td class="score-cell ${getScoreClass('phq9', emp.phq9)}">${emp.phq9.toFixed(1)}</td>
          <td class="score-cell ${getScoreClass('gad7', emp.gad7)}">${emp.gad7.toFixed(1)}</td>
          <td class="score-cell ${getScoreClass('mbi', emp.mbi)}">${emp.mbi.toFixed(1)}%</td>
          <td class="score-cell ${getScoreClass('sleepDuration', emp.sleepDuration)}">${emp.sleepDuration.toFixed(1)}</td>
          <td class="score-cell ${getScoreClass('sleepQuality', emp.sleepQuality)}">${emp.sleepQuality.toFixed(1)}</td>
          <td class="score-cell ${getScoreClass('workLifeBalance', emp.workLifeBalance)}">${emp.workLifeBalance.toFixed(1)}</td>
          <td class="score-cell ${getScoreClass('stressLevel', emp.stressLevel)}">${emp.stressLevel.toFixed(1)}</td>
          <td class="score-cell"><span class="risk-indicator risk-${overallRisk}">${getRiskLabel(overallRisk)}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderRiskAssessment() {
      const data = getSelectedTeamMonth();
      if (!data || !data.averages) return;

      const container = document.getElementById('risk-items');
      if (!container) return;
      container.innerHTML = '';

      const avg = data.averages;
      const risks = [];

      if (avg.who5 < 50) {
        risks.push({ level: 'high', title: '–ö—Ä–∏—Ç–∏—á–Ω–æ –Ω–∏–∑—å–∫–∏–π —Ä—ñ–≤–µ–Ω—å –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è', description: `WHO-5: ${avg.who5.toFixed(1)}.` });
      } else if (avg.who5 < 75) {
        risks.push({ level: 'medium', title: '–ó–Ω–∏–∂–µ–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è', description: `WHO-5: ${avg.who5.toFixed(1)}.` });
      }

      if (avg.phq9 >= 10) {
        risks.push({ level: 'high', title: '–ü—ñ–¥–≤–∏—â–µ–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –¥–µ–ø—Ä–µ—Å—ñ—ó', description: `PHQ-9: ${avg.phq9.toFixed(1)}.` });
      } else if (avg.phq9 >= 5) {
        risks.push({ level: 'medium', title: '–ü–æ–º—ñ—Ä–Ω—ñ –æ–∑–Ω–∞–∫–∏ –¥–µ–ø—Ä–µ—Å—ñ—ó', description: `PHQ-9: ${avg.phq9.toFixed(1)}.` });
      }

      if (avg.gad7 >= 10) {
        risks.push({ level: 'high', title: '–í–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Ç—Ä–∏–≤–æ–∂–Ω–æ—Å—Ç—ñ', description: `GAD-7: ${avg.gad7.toFixed(1)}.` });
      } else if (avg.gad7 >= 5) {
        risks.push({ level: 'medium', title: '–ü—ñ–¥–≤–∏—â–µ–Ω–∞ —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å', description: `GAD-7: ${avg.gad7.toFixed(1)}.` });
      }

      if (avg.mbi >= 50) {
        risks.push({ level: 'high', title: '–í–∏—Å–æ–∫–∏–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è', description: `MBI: ${avg.mbi.toFixed(1)}%.` });
      } else if (avg.mbi >= 25) {
        risks.push({ level: 'medium', title: '–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–∏–∑–∏–∫ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è', description: `MBI: ${avg.mbi.toFixed(1)}%.` });
      }

      if (avg.sleepDuration < 6) {
        risks.push({ level: 'high', title: '–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—è —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É', description: `–°–æ–Ω: ${avg.sleepDuration.toFixed(1)} –≥–æ–¥.` });
      } else if (avg.sleepDuration < 7) {
        risks.push({ level: 'medium', title: '–ó–Ω–∏–∂–µ–Ω–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–Ω—É', description: `–°–æ–Ω: ${avg.sleepDuration.toFixed(1)} –≥–æ–¥.` });
      }

      if (avg.sleepQuality < 4) {
        risks.push({ level: 'high', title: '–ü–æ–≥–∞–Ω–∞ —è–∫—ñ—Å—Ç—å —Å–Ω—É', description: `–Ø–∫—ñ—Å—Ç—å —Å–Ω—É: ${avg.sleepQuality.toFixed(1)}.` });
      } else if (avg.sleepQuality < 7) {
        risks.push({ level: 'medium', title: '–ó–∞–¥–æ–≤—ñ–ª—å–Ω–∞ —è–∫—ñ—Å—Ç—å —Å–Ω—É', description: `–Ø–∫—ñ—Å—Ç—å —Å–Ω—É: ${avg.sleepQuality.toFixed(1)}.` });
      }

      if (avg.workLifeBalance < 4) {
        risks.push({ level: 'high', title: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π –¥–∏—Å–±–∞–ª–∞–Ω—Å –∂–∏—Ç—Ç—è', description: `–ë–∞–ª–∞–Ω—Å: ${avg.workLifeBalance.toFixed(1)}.` });
      } else if (avg.workLifeBalance < 7) {
        risks.push({ level: 'medium', title: '–ü–æ—Ç—Ä–µ–±—É—î –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É', description: `–ë–∞–ª–∞–Ω—Å: ${avg.workLifeBalance.toFixed(1)}.` });
      }

      if (avg.stressLevel >= 27) {
        risks.push({ level: 'high', title: '–í–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É', description: `–°—Ç—Ä–µ—Å: ${avg.stressLevel.toFixed(1)}.` });
      } else if (avg.stressLevel >= 14) {
        risks.push({ level: 'medium', title: '–ü–æ–º—ñ—Ä–Ω–∏–π —Ä—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É', description: `–°—Ç—Ä–µ—Å: ${avg.stressLevel.toFixed(1)}.` });
      }

      if (!risks.length) {
        risks.push({ level: 'low', title: '–ö–æ–º–∞–Ω–¥–∞ –≤ —Ö–æ—Ä–æ—à–æ–º—É —Å—Ç–∞–Ω—ñ', description: '–í—Å—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤ –º–µ–∂–∞—Ö –Ω–æ—Ä–º–∏.' });
      }

      risks.sort((a, b) => {
        const order = { high: 0, medium: 1, low: 2 };
        return order[a.level] - order[b.level];
      });

      risks.forEach(risk => {
        const item = document.createElement('div');
        item.className = `risk-item ${risk.level}`;
        item.innerHTML = `
          <div class="risk-item-title">${risk.title}</div>
          <div class="risk-item-description">${risk.description}</div>
        `;
        container.appendChild(item);
      });
    }

    async function openEmployeeModal(employeeId) {
      if (!employeeId) return;
      try {
        if (!advancedData) {
          advancedData = await apiCall('/api/employee-data');
        }
      } catch (error) {
        return;
      }

      const employee = advancedData?.employees?.find(e => e.userId === employeeId || e.user_id === employeeId || e.id === employeeId);
      if (!employee) return;

      document.getElementById('modalEmployeeName').textContent = employee.name;

      const metricsHtml = `
        <div class="modal-metric"><span class="metric-label">WHO-5</span><span class="metric-value ${getScoreClass('who5', employee.metrics.who5)}">${employee.metrics.who5.toFixed(1)}</span></div>
        <div class="modal-metric"><span class="metric-label">PHQ-9</span><span class="metric-value ${getScoreClass('phq9', employee.metrics.phq9)}">${employee.metrics.phq9.toFixed(1)}</span></div>
        <div class="modal-metric"><span class="metric-label">GAD-7</span><span class="metric-value ${getScoreClass('gad7', employee.metrics.gad7)}">${employee.metrics.gad7.toFixed(1)}</span></div>
        <div class="modal-metric"><span class="metric-label">MBI</span><span class="metric-value ${getScoreClass('mbi', employee.metrics.mbi)}">${employee.metrics.mbi.toFixed(1)}%</span></div>
        <div class="modal-metric"><span class="metric-label">–°–æ–Ω</span><span class="metric-value ${getScoreClass('sleepDuration', employee.metrics.sleepDuration)}">${employee.metrics.sleepDuration.toFixed(1)} –≥–æ–¥</span></div>
        <div class="modal-metric"><span class="metric-label">–Ø–∫—ñ—Å—Ç—å —Å–Ω—É</span><span class="metric-value ${getScoreClass('sleepQuality', employee.metrics.sleepQuality)}">${employee.metrics.sleepQuality.toFixed(1)}</span></div>
        <div class="modal-metric"><span class="metric-label">–ë–∞–ª–∞–Ω—Å</span><span class="metric-value ${getScoreClass('workLifeBalance', employee.metrics.workLifeBalance)}">${employee.metrics.workLifeBalance.toFixed(1)}</span></div>
        <div class="modal-metric"><span class="metric-label">–°—Ç—Ä–µ—Å</span><span class="metric-value ${getScoreClass('stressLevel', employee.metrics.stressLevel)}">${employee.metrics.stressLevel.toFixed(1)}</span></div>
      `;
      document.getElementById('modalMetrics').innerHTML = metricsHtml;

      const riskLevel = employee.riskLevel || 'low';
      document.getElementById('modalRiskLevel').innerHTML = `<span class="risk-indicator risk-${riskLevel}">${getRiskLabel(riskLevel)}</span>`;
      document.getElementById('modalNotes').textContent = employee.notes || '–ù–æ—Ç–∞—Ç–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ';

      createModalTrendChart(employee);
      document.getElementById('employeeModal').style.display = 'flex';
    }

    function closeEmployeeModal() {
      const modal = document.getElementById('employeeModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function createModalTrendChart(employee) {
      const ctx = document.getElementById('modalTrendChart');
      if (!ctx) return;

      if (teamDashboardCharts.modalTrend) {
        teamDashboardCharts.modalTrend.destroy();
      }

      const months = getTeamMonthList();
      const recent = months.slice(Math.max(0, months.length - 4));
      const labels = recent.map(m => monthLabelFromKey(monthKeyFromParts(m.year, m.month), true));

      const history = employee.history || {};
      const values = (key) => recent.map(m => {
        const monthKey = monthKeyFromParts(m.year, m.month);
        return history[monthKey]?.[key] ?? 0;
      });

      teamDashboardCharts.modalTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'WHO-5', data: values('who5'), borderColor: '#1f8f3a', tension: 0.35, borderWidth: 2 },
            { label: 'PHQ-9', data: values('phq9'), borderColor: '#ffb000', tension: 0.35, borderWidth: 2 },
            { label: 'GAD-7', data: values('gad7'), borderColor: '#ff595e', tension: 0.35, borderWidth: 2 },
            { label: 'MBI', data: values('mbi'), borderColor: '#6a4c93', tension: 0.35, borderWidth: 2 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
        },
      });
    }

    // ===== ADVANCED ANALYTICS =====
    async function loadAdvancedAnalytics() {
      if (!isAdmin()) return;
      const container = document.getElementById('advanced-section');
      try {
        advancedData = await apiCall('/api/employee-data');
      } catch (error) {
        if (container) {
          const banner = document.createElement('div');
          banner.className = 'error-message';
          banner.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ advanced –∞–Ω–∞–ª—ñ—Ç–∏–∫—É.';
          container.prepend(banner);
        }
        return;
      }

      checkAndShowDecemberNotice();
      calculateTeamHealthScore();
      updateBenchmarking();
      renderTrajectoryChart();
      renderRiskBubbleChart();
      calculateForecast();
      analyzeSleepDebt();
      renderEmployeeInsights();
      renderPlaybooks();
      generateRecommendations();
    }

    function getAdvancedMonthKeys() {
      if (!advancedData?.teamAverages) return [];
      return Object.keys(advancedData.teamAverages)
        .filter(key => key !== 'current')
        .sort(compareMonthKeys);
    }

    function getLatestMonthKey() {
      const months = getAdvancedMonthKeys();
      return months.length ? months[months.length - 1] : null;
    }

    function getPrevMonthKey() {
      const months = getAdvancedMonthKeys();
      if (!months.length) return null;
      return months.length >= 2 ? months[months.length - 2] : months[0];
    }

    function getRecentMonths(limit) {
      const months = getAdvancedMonthKeys();
      return months.slice(Math.max(0, months.length - limit));
    }

    function labelFromKey(key) {
      return monthLabelFromKey(key, true);
    }

    function getLatestAverage() {
      const latestKey = getLatestMonthKey();
      if (latestKey && advancedData.teamAverages[latestKey]) {
        return advancedData.teamAverages[latestKey];
      }
      return advancedData.teamAverages.current || null;
    }

    function checkAndShowDecemberNotice() {
      const noticeEl = document.getElementById('decemberNotice');
      if (!noticeEl || !advancedData) return;
      const months = getAdvancedMonthKeys();
      const hasDecember = months.some(key => parseMonthKey(key).month === 12);
      noticeEl.style.display = hasDecember ? 'block' : 'none';
    }

    function calculateTeamHealthScore() {
      if (!advancedData?.employees?.length) return;

      let totalScore = 0;
      advancedData.employees.forEach(emp => {
        const m = emp.metrics;
        const who5Score = m.who5;
        const phq9Score = 100 - (m.phq9 / 27 * 100);
        const gad7Score = 100 - (m.gad7 / 21 * 100);
        const mbiScore = 100 - m.mbi;
        const sleepScore = (m.sleepDuration / 9) * 100;
        const qualityScore = (m.sleepQuality / 10) * 100;
        const balanceScore = (m.workLifeBalance / 10) * 100;
        const stressScore = 100 - (m.stressLevel / 40 * 100);

        const empScore = (who5Score + phq9Score + gad7Score + mbiScore + sleepScore + qualityScore + balanceScore + stressScore) / 8;
        totalScore += empScore;
      });

      const healthScore = Math.round(totalScore / advancedData.employees.length);
      const scoreEl = document.getElementById('healthScore');
      if (scoreEl) scoreEl.textContent = healthScore;

      let indicator = '';
      if (healthScore >= 70) {
        indicator = 'üü¢ –í—ñ–¥–º—ñ–Ω–Ω–æ';
      } else if (healthScore >= 50) {
        indicator = 'üü° –ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ';
      } else {
        indicator = 'üî¥ –ü–æ—Ç—Ä–µ–±—É—î —É–≤–∞–≥–∏';
      }
      const indicatorEl = document.getElementById('healthIndicator');
      if (indicatorEl) indicatorEl.textContent = indicator;
    }

    function updateBenchmarking() {
      if (!advancedData) return;
      const avg = getLatestAverage();
      if (!avg) return;
      const benchmarks = {
        who5: { your: avg.who5, industry: 62, higherIsBetter: true, max: 100 },
        phq9: { your: avg.phq9, industry: 6.8, higherIsBetter: false, max: 27 },
        gad7: { your: avg.gad7, industry: 7.5, higherIsBetter: false, max: 21 },
        mbi: { your: avg.mbi, industry: 42, higherIsBetter: false, max: 100 },
        stress: { your: avg.stressLevel, industry: 18, higherIsBetter: false, max: 40 },
      };

      Object.keys(benchmarks).forEach(key => {
        const data = benchmarks[key];
        const yourValue = data.your?.toFixed(1) ?? '‚Äî';

        document.getElementById(key + 'YourValue').textContent = yourValue;

        const yourWidth = Math.min(100, (data.your / data.max) * 100);
        const industryWidth = Math.min(100, (data.industry / data.max) * 100);

        document.getElementById(key + 'Your').style.width = yourWidth + '%';
        document.getElementById(key + 'Industry').style.width = industryWidth + '%';

        let status = '';
        if (data.higherIsBetter) {
          if (data.your >= data.industry * 0.95) status = '‚úÖ –∫—Ä–∞—â–µ';
          else if (data.your >= data.industry * 0.85) status = '‚âà —Å–µ—Ä–µ–¥–Ω—î';
          else status = 'üìâ –≥—ñ—Ä—à–µ';
        } else {
          if (data.your <= data.industry * 1.05) status = '‚úÖ –∫—Ä–∞—â–µ';
          else if (data.your <= data.industry * 1.15) status = '‚âà —Å–µ—Ä–µ–¥–Ω—î';
          else status = 'üìâ –≥—ñ—Ä—à–µ';
        }

        document.getElementById(key + 'Status').textContent = status;
      });
    }

    function calculateEmployeeRisk(metrics) {
      if (metrics.who5 < 28 || metrics.phq9 > 15 || metrics.gad7 > 15) return 'critical';
      if (metrics.who5 < 50 || metrics.phq9 > 10 || metrics.gad7 > 10 || metrics.mbi > 40) return 'high';
      if (metrics.mbi > 30 || metrics.stressLevel > 20) return 'medium';
      return 'low';
    }

    function renderTrajectoryChart() {
      if (!advancedData) return;
      const ctxEl = document.getElementById('trajectoryChart');
      if (!ctxEl) return;

      const months = getRecentMonths(4);
      if (!months.length) return;
      const averages = advancedData.teamAverages;
      const labels = months.map(labelFromKey);

      const who5 = months.map(m => averages[m]?.who5 ?? 0);
      const stressRaw = months.map(m => averages[m]?.stressLevel ?? 0);
      const stress = stressRaw.map(v => (v / 40) * 100);
      const sleepRaw = months.map(m => averages[m]?.sleepDuration ?? 0);
      const sleep = sleepRaw.map(v => (v / 9) * 100);

      if (advancedCharts.trajectory) advancedCharts.trajectory.destroy();

      advancedCharts.trajectory = new Chart(ctxEl, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'WHO-5', data: who5, borderColor: '#1f8f3a', tension: 0.3, borderWidth: 3 },
            { label: '–°—Ç—Ä–µ—Å', data: stress, borderColor: '#ffb000', tension: 0.3, borderWidth: 2, borderDash: [6, 6] },
            { label: '–°–æ–Ω', data: sleep, borderColor: '#2b59c3', tension: 0.3, borderWidth: 2 },
          ],
        },
        options: { responsive: true, maintainAspectRatio: false },
      });

      const latestKey = getLatestMonthKey();
      const prevKey = getPrevMonthKey();
      if (!latestKey || !prevKey) return;
      const latestIdx = months.indexOf(latestKey);
      const prevIdx = Math.max(0, latestIdx - 1);
      const whoDelta = who5[latestIdx] - who5[prevIdx];
      const stressDelta = stressRaw[latestIdx] - stressRaw[prevIdx];
      const sleepDelta = sleepRaw[latestIdx] - sleepRaw[prevIdx];
      const comment = `–û—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å (${labelFromKey(latestKey)}): WHO-5 ${who5[latestIdx]?.toFixed(1)}, —Å–æ–Ω ${sleepRaw[latestIdx]?.toFixed(1)} –≥–æ–¥, —Å—Ç—Ä–µ—Å ${stressRaw[latestIdx]?.toFixed(1)}/40. Œî vs ${labelFromKey(prevKey)}: WHO-5 ${(whoDelta>=0?'+':'') + whoDelta.toFixed(1)}, —Å–æ–Ω ${(sleepDelta>=0?'+':'') + sleepDelta.toFixed(1)} –≥–æ–¥, —Å—Ç—Ä–µ—Å ${(stressDelta>=0?'+':'') + stressDelta.toFixed(1)}.`;
      const commentEl = document.getElementById('trajectoryComment');
      if (commentEl) commentEl.textContent = comment;

      const modalMetrics = [
        { key: 'who5', label: 'WHO-5', value: who5[latestIdx]?.toFixed(1) ?? '‚Äî' },
        { key: 'sleep', label: '–°–æ–Ω (–≥–æ–¥)', value: sleepRaw[latestIdx]?.toFixed(1) ?? '‚Äî' },
        { key: 'stress', label: '–°—Ç—Ä–µ—Å (0-40)', value: stressRaw[latestIdx]?.toFixed(1) ?? '‚Äî' },
      ];
      fillMetricsGrid('trajectoryMetrics', modalMetrics);
      const summary = document.getElementById('trajectorySummary');
      if (summary) summary.textContent = '–§–æ–∫—É—Å: –∑–º—ñ–Ω–∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á—á—è, —Å–Ω—É —Ç–∞ —Å—Ç—Ä–µ—Å—É –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å.';
    }

    function renderRiskBubbleChart() {
      if (!advancedData) return;
      const ctxEl = document.getElementById('riskBubbleChart');
      if (!ctxEl) return;

      if (advancedCharts.riskBubble) advancedCharts.riskBubble.destroy();

      const points = advancedData.employees.map(emp => {
        const risk = calculateEmployeeRisk(emp.metrics);
        return {
          x: emp.metrics.stressLevel,
          y: emp.metrics.mbi,
          r: Math.min(26, Math.max(10, emp.metrics.phq9 * 1.2)),
          name: emp.name,
          risk,
          phq9: emp.metrics.phq9,
        };
      });

      advancedCharts.riskBubble = new Chart(ctxEl, {
        type: 'bubble',
        data: {
          datasets: [{
            data: points,
            backgroundColor: points.map(p => p.risk === 'critical' ? 'rgba(239, 68, 68, 0.8)'
              : p.risk === 'high' ? 'rgba(239, 68, 68, 0.6)'
              : p.risk === 'medium' ? 'rgba(251, 191, 36, 0.6)'
              : 'rgba(34, 197, 94, 0.6)'),
            borderColor: points.map(p => p.risk === 'critical' ? '#dc2626'
              : p.risk === 'high' ? '#ef4444'
              : p.risk === 'medium' ? '#f59e0b'
              : '#22c55e'),
            borderWidth: 2,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            x: { beginAtZero: true, max: 40 },
            y: { beginAtZero: true, max: 100 },
          },
        },
      });

      const counts = points.reduce((acc, p) => {
        acc[p.risk] = (acc[p.risk] || 0) + 1;
        return acc;
      }, {});
      const topRisk = points.slice().sort((a, b) => (b.y + b.x) - (a.y + a.x))[0];
      const riskComment = `–†–∏–∑–∏–∫–∏: high ${counts.high || 0}, medium ${counts.medium || 0}, low ${counts.low || 0}. –ù–∞–π–≤–∏—â–∏–π —Ä–∏–∑–∏–∫: ${topRisk?.name || '‚Äî'}.`;
      const riskEl = document.getElementById('riskComment');
      if (riskEl) riskEl.textContent = riskComment;

      const modalMetrics = [
        { key: 'mbi', label: 'High', value: counts.high || 0 },
        { key: 'mbi', label: 'Medium', value: counts.medium || 0 },
        { key: 'mbi', label: 'Low', value: counts.low || 0 },
        { key: 'mbi', label: '–ù–∞–π–≤–∏—â–∏–π —Ä–∏–∑–∏–∫', value: topRisk ? `${topRisk.name} ¬∑ MBI ${topRisk.y.toFixed(0)}%, —Å—Ç—Ä–µ—Å ${topRisk.x}/40` : '‚Äî' },
      ];
      fillMetricsGrid('riskMetrics', modalMetrics);
      const riskSummary = document.getElementById('riskSummary');
      if (riskSummary) riskSummary.textContent = '–ú–∞—Ç—Ä–∏—Ü—è –ø–æ—î–¥–Ω—É—î —Å—Ç—Ä–µ—Å, –≤–∏–≥–æ—Ä–∞–Ω–Ω—è —Ç–∞ PHQ-9 –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø—Ä—ñ–æ—Ä–∏—Ç–∏–∑—É–≤–∞–Ω–Ω—è 1:1.';
    }

    function calculateForecast() {
      if (!advancedData) return;
      const history = advancedData.teamAverages;
      const latestKey = getLatestMonthKey();
      const prevKey = getPrevMonthKey();
      if (!latestKey || !prevKey) return;
      const metrics = [
        { key: 'who5', name: 'WHO-5 –ë–ª–∞–≥–æ–ø–æ–ª—É—á—á—è' },
        { key: 'phq9', name: 'PHQ-9 –î–µ–ø—Ä–µ—Å—ñ—è' },
        { key: 'mbi', name: 'MBI –í–∏–≥–æ—Ä–∞–Ω–Ω—è' },
      ];

      const forecastGrid = document.getElementById('forecastGrid');
      if (!forecastGrid) return;
      forecastGrid.innerHTML = '';

      metrics.forEach(metric => {
        const prev = history[prevKey]?.[metric.key] ?? history[latestKey]?.[metric.key] ?? 0;
        const curr = history[latestKey]?.[metric.key] ?? prev;
        const trend = curr - prev;
        const forecast = curr + trend;

        const trendArrow = trend > 0 ? 'üìà' : trend < 0 ? 'üìâ' : '‚û°Ô∏è';
        const trendText = trend > 0 ? '–ó—Ä–æ—Å—Ç–∞–Ω–Ω—è' : trend < 0 ? '–ó–Ω–∏–∂–µ–Ω–Ω—è' : '–°—Ç–∞–±—ñ–ª—å–Ω–æ';

        const card = document.createElement('div');
        card.className = 'forecast-card';
        card.innerHTML = `
          <h3>${metric.name}</h3>
          <div class="forecast-value">${forecast.toFixed(1)}</div>
          <div class="forecast-trend">${trendArrow} ${trendText} (${labelFromKey(prevKey)} ‚Üí ${labelFromKey(latestKey)})</div>
          <div class="forecast-change">–ó–º—ñ–Ω–∞: ${(trend > 0 ? '+' : '') + trend.toFixed(1)}</div>
        `;
        forecastGrid.appendChild(card);
      });
    }

    function analyzeSleepDebt() {
      if (!advancedData) return;
      const employees = advancedData.employees || [];
      const optimalSleep = 7.5;
      let totalDebt = 0;
      let atRisk = 0;

      const debtData = employees.map(emp => {
        const debt = Math.max(0, (optimalSleep - emp.metrics.sleepDuration) * 7);
        totalDebt += debt;
        if (emp.metrics.sleepDuration < 6.5) atRisk += 1;
        return { name: emp.name, debt };
      });

      const avgDebt = employees.length ? totalDebt / employees.length : 0;

      document.getElementById('totalSleepDebt').textContent = totalDebt.toFixed(0);
      document.getElementById('avgSleepDebt').textContent = avgDebt.toFixed(1);
      document.getElementById('atRiskCount').textContent = atRisk;

      const ctx = document.getElementById('sleepDebtChart');
      if (!ctx) return;
      if (advancedCharts.sleepDebt) advancedCharts.sleepDebt.destroy();

      advancedCharts.sleepDebt = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: debtData.map(d => d.name.split(' ')[0]),
          datasets: [{
            label: '–ë–æ—Ä–≥ —Å–Ω—É (–≥–æ–¥/—Ç–∏–∂–¥–µ–Ω—å)',
            data: debtData.map(d => d.debt),
            backgroundColor: debtData.map(d => d.debt > 10 ? 'rgba(239, 68, 68, 0.8)' : d.debt > 5 ? 'rgba(251, 191, 36, 0.8)' : 'rgba(34, 197, 94, 0.8)'),
            borderColor: debtData.map(d => d.debt > 10 ? '#ef4444' : d.debt > 5 ? '#fbbf24' : '#22c55e'),
            borderWidth: 2,
          }],
        },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' },
      });
    }

    function renderEmployeeInsights() {
      if (!advancedData) return;
      const grid = document.getElementById('insightGrid');
      if (!grid) return;
      const employees = advancedData.employees || [];

      const latestKey = getLatestMonthKey();
      const prevKey = getPrevMonthKey();
      if (!latestKey || !prevKey) return;

      const riskSorted = [...employees].sort((a, b) =>
        (b.metrics.mbi + b.metrics.phq9) - (a.metrics.mbi + a.metrics.phq9)
      );
      const topRiskNames = riskSorted.slice(0, 2)
        .map(e => `${e.name.split(' ')[0]} (MBI ${e.metrics.mbi.toFixed(0)}%, PHQ-9 ${e.metrics.phq9})`)
        .join(', ');

      const improvements = employees.map(emp => {
        const prev = emp.history?.[prevKey]?.who5 ?? emp.metrics.who5;
        const latest = emp.history?.[latestKey]?.who5 ?? emp.metrics.who5;
        return { name: emp.name, delta: latest - prev };
      }).sort((a, b) => b.delta - a.delta);

      const topRecovery = improvements.filter(i => i.delta > 0).slice(0, 2)
        .map(i => `${i.name.split(' ')[0]} (+${i.delta.toFixed(0)} WHO-5)`).join(', ');

      const declines = improvements.filter(i => i.delta < 0).slice(0, 2)
        .map(i => `${i.name.split(' ')[0]} (${i.delta.toFixed(0)})`).join(', ');

      const sleepDebt = employees.map(emp => {
        const debt = Math.max(0, (7.5 - emp.metrics.sleepDuration) * 7);
        return { name: emp.name, debt };
      }).sort((a, b) => b.debt - a.debt).slice(0, 2);

      const balanced = [...employees].sort((a, b) =>
        b.metrics.workLifeBalance - a.metrics.workLifeBalance
      ).slice(0, 2);

      const cards = [
        {
          pill: 'CRITICAL',
          title: '–¢–µ—Ä–º—ñ–Ω–æ–≤–∏–π —Ñ–æ–∫—É—Å 1:1',
          body: topRiskNames || '–ù–µ–º–∞—î —á–µ—Ä–≤–æ–Ω–∏—Ö –ø—Ä–∞–ø–æ—Ä—Ü—ñ–≤ —Ü—å–æ–≥–æ –º—ñ—Å—è—Ü—è.',
          bullets: [
            topRiskNames ? '–§–æ–∫—É—Å –Ω–∞ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞—Ö –∑ –Ω–∞–π–≤–∏—â–∏–º MBI/PHQ-9.' : '–ö–æ–º–∞–Ω–¥–∞ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ç—Ä–∏–≥–µ—Ä—ñ–≤.',
            '–£—Ç–æ—á–Ω–∏—Ç–∏, —á–∏ —î —Ä–∞–Ω–Ω—ñ —Å–∏–º–ø—Ç–æ–º–∏ (—Å–æ–Ω <6.5 –≥–æ–¥, PHQ-9>10).'
          ],
          plan: '–ü–ª–∞–Ω: –∫–æ—Ä–æ—Ç–∫—ñ check-in –∑ –≥—Ä—É–ø–æ—é —Ä–∏–∑–∏–∫—É —Ç–∞ —Ñ—ñ–∫—Å–∞—Ü—ñ—è 1-2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –∑–º—ñ–Ω.'
        },
        {
          pill: 'RECOVERY',
          title: '–ù–∞–π–±—ñ–ª—å—à–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è',
          body: topRecovery || '–†—ñ–∑–∫–∏—Ö –ø—ñ–¥–π–æ–º—ñ–≤ –Ω–µ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ.',
          bullets: [
            topRecovery ? '–Ñ —ñ—Å—Ç–æ—Ä—ñ—ó –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è ‚Äî –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ best practices.' : '–ë–µ–∑ —Å—Ç—Ä–∏–±–∫—ñ–≤ ‚Äî –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å.',
            '–ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏, —â–æ —Å–∞–º–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ.'
          ],
          plan: '–ü–ª–∞–Ω: –∫–æ—Ä–æ—Ç–∫–∏–π peer sharing —Ç–∞ –∑–±—ñ—Ä –ø—Ä–∞–∫—Ç–∏–∫ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è.'
        },
        {
          pill: 'DROP',
          title: '–ù–µ–≥–∞—Ç–∏–≤–Ω–∞ –¥–∏–Ω–∞–º—ñ–∫–∞',
          body: declines || '–ù–µ–º–∞—î —Ä—ñ–∑–∫–∏—Ö —Å–ø–∞–¥—ñ–≤.',
          bullets: [
            declines ? '–Ñ –ø–∞–¥—ñ–Ω–Ω—è WHO-5 ‚Äî –ª–æ–∫–∞–ª—å–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏.' : '–ë–µ–∑ —Å—É—Ç—Ç—î–≤–∏—Ö —Å–ø–∞–¥—ñ–≤ ‚Äî —Ç—Ä–∏–º–∞—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥.',
            '–ô–º–æ–≤—ñ—Ä–Ω—ñ –ø—Ä–∏—á–∏–Ω–∏: –ø—ñ–∫–æ–≤–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–±–æ –Ω–µ–¥–æ—Å–∏–ø.'
          ],
          plan: '–ü–ª–∞–Ω: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏ —Ç–∞ –∑–Ω–∏–∑–∏—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–ª—è –≥—Ä—É–ø–∏ —Ä–∏–∑–∏–∫—É.'
        },
        {
          pill: 'SLEEP',
          title: '–ë–æ—Ä–≥ —Å–Ω—É —Ç–∞ –µ–Ω–µ—Ä–≥—ñ—è',
          body: sleepDebt.length
            ? sleepDebt.map(d => `${d.name.split(' ')[0]} (+${d.debt.toFixed(0)} –≥–æ–¥/—Ç–∏–∂–¥)`).join(', ')
            : '–ë–æ—Ä–≥ —Å–Ω—É –≤ –Ω–æ—Ä–º—ñ.',
          bullets: [
            sleepDebt.length ? '–Ñ –ø–æ–º—ñ—Ç–Ω–∏–π –±–æ—Ä–≥ —Å–Ω—É ‚Äî —Ä–∏–∑–∏–∫ –ø–∞–¥—ñ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.' : '–°–æ–Ω —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π ‚Äî –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ä–µ–∂–∏–º.',
            '–ù–µ–¥–æ—Å–∏–ø –∫–æ—Ä–µ–ª—é—î –∑ –≤–∏–≥–æ—Ä–∞–Ω–Ω—è–º —ñ PHQ-9.'
          ],
          plan: '–ü–ª–∞–Ω: –ø—Ä–∞–≤–∏–ª–æ ¬´–±–µ–∑ –ø—ñ–Ω–≥—ñ–≤ –ø—ñ—Å–ª—è 19:00¬ª + –≥–Ω—É—á–∫–∏–π —Å—Ç–∞—Ä—Ç –¥–ª—è –≥—Ä—É–ø–∏ —Ä–∏–∑–∏–∫—É.'
        },
        {
          pill: 'BALANCE',
          title: '–ï—Ç–∞–ª–æ–Ω–Ω–∏–π –±–∞–ª–∞–Ω—Å',
          body: balanced.map(b =>
            `${b.name.split(' ')[0]} (–±–∞–ª–∞–Ω—Å ${b.metrics.workLifeBalance}/10, —Å—Ç—Ä–µ—Å ${b.metrics.stressLevel}/40)`
          ).join(', '),
          bullets: [
            '–Ñ –µ—Ç–∞–ª–æ–Ω–Ω—ñ –ø—Ä–∞–∫—Ç–∏–∫–∏ work-life balance.',
            '–¶—ñ –ª—é–¥–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ buddy –¥–ª—è –≥—Ä—É–ø–∏ —Ä–∏–∑–∏–∫—É.'
          ],
          plan: '–ü–ª–∞–Ω: –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ —è–∫ buddy —Ç–∞ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç—É–≤–∞—Ç–∏ —Ä–∏—Ç—É–∞–ª–∏.'
        }
      ];

      grid.innerHTML = '';
      cards.forEach(card => {
        const el = document.createElement('div');
        el.className = 'insight-card lift';
        el.innerHTML = `
          <span class="insight-pill">‚òÖ ${card.pill}</span>
          <div class="insight-title">${card.title}</div>
          <div class="insight-body">${card.body}</div>
          <ul class="insight-list">${(card.bullets || []).map(b => `<li>${b}</li>`).join('')}</ul>
          <div class="insight-plan">${card.plan}</div>
        `;
        grid.appendChild(el);
      });
    }

    function renderPlaybooks() {
      const container = document.getElementById('playbooks-grid');
      if (!container) return;
      container.innerHTML = '';

      if (!advancedData?.employees?.length) {
        container.innerHTML = '<div class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –ø–ª–µ–π–±—É–∫—ñ–≤</div>';
        return;
      }

      const ranked = [...advancedData.employees]
        .sort((a, b) => (b.metrics.mbi + b.metrics.phq9 + b.metrics.gad7) - (a.metrics.mbi + a.metrics.phq9 + a.metrics.gad7))
        .slice(0, 3);

      ranked.forEach(emp => {
        const level = calculateEmployeeRisk(emp.metrics);
        const card = document.createElement('div');
        card.className = 'playbook-card';
        card.innerHTML = `
          <h3 class="playbook-employee-name">${emp.name}</h3>
          <div class="playbook-risk-level">–†–∏–∑–∏–∫: ${getRiskLabel(level)} ¬∑ PHQ-9 ${emp.metrics.phq9} ¬∑ MBI ${emp.metrics.mbi.toFixed(1)}%</div>
          <div class="playbook-section">
            <h4>üìû –°—Ü–µ–Ω–∞—Ä—ñ–π —Ä–æ–∑–º–æ–≤–∏</h4>
            <ul class="playbook-bullets">
              <li>–ó–∞–ø–∏—Ç–∞–π—Ç–µ –ø—Ä–æ —Å–∞–º–æ–ø–æ—á—É—Ç—Ç—è —Ç–∞ –∫–ª—é—á–æ–≤—ñ —Å—Ç—Ä–µ—Å–æ—Ä–∏.</li>
              <li>–£—Ç–æ—á–Ω—ñ—Ç—å, —â–æ –¥–æ–ø–æ–º–æ–∂–µ –∑–Ω–∏–∑–∏—Ç–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è.</li>
              <li>–î–æ–º–æ–≤—Ç–µ—Å—å –ø—Ä–æ 1-2 –∑–º—ñ–Ω–∏ —Ç–∞ follow-up —á–µ—Ä–µ–∑ 7 –¥–Ω—ñ–≤.</li>
            </ul>
          </div>
          <div class="playbook-section">
            <h4>üìã –ü–ª–∞–Ω –Ω–∞ 7 –¥–Ω—ñ–≤</h4>
            <ul class="playbook-microactions">
              <li>–°–∫–æ—Ä–æ—Ç–∏—Ç–∏ 1-2 –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ñ –∑–∞–¥–∞—á—ñ –∞–±–æ –º—ñ—Ç–∏–Ω–≥–∏.</li>
              <li>–î–æ–¥–∞—Ç–∏ 2 –±–ª–æ–∫–∏ —Ñ–æ–∫—É—Å—É –±–µ–∑ –ø—ñ–Ω–≥—ñ–≤.</li>
              <li>–ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫—É (buddy/–∫–æ—É—á) —ñ —á–∞—Å –∫–æ–Ω—Ç–∞–∫—Ç—É.</li>
            </ul>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function generateRecommendations() {
      if (!advancedData) return;
      const employees = advancedData.employees || [];
      const plans = employees.map(buildRecommendationPlan).filter(Boolean);

      const grid = document.getElementById('recommendationsGrid');
      if (!grid) return;
      grid.innerHTML = '';

      if (!plans.length) {
        grid.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;">–í—Å—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤ –Ω–æ—Ä–º—ñ! üéâ</p>';
        return;
      }

      plans.forEach(plan => {
        const kitId = 'call-kit-' + plan.id;
        const card = document.createElement('div');
        card.className = 'recommendation-card lift';

        card.innerHTML = `
          <div class="rec-header">
            <div>
              <span class="rec-category">${plan.category}</span>
              <div class="rec-insight">${plan.subtitle}</div>
            </div>
            <strong>${plan.employee}</strong>
          </div>
          <div class="rec-message">${plan.message}</div>
          <div class="rec-actions">
            <button class="copy-btn" onclick="toggleCallKit('${kitId}')">–ü–ª–∞–Ω 1:1 (${plan.duration} —Ö–≤)</button>
            <span class="rec-action">${plan.action}</span>
          </div>
          <div class="call-kit" id="${kitId}">
            ${plan.callKit}
          </div>
        `;

        grid.appendChild(card);
      });
    }

    function buildRecommendationPlan(emp) {
      const m = emp.metrics;
      const focusAreas = [];

      if (m.phq9 > 10 || m.gad7 > 10) focusAreas.push('mood');
      if (m.mbi > 35 || m.stressLevel > 17) focusAreas.push('burnout');
      if (m.sleepDuration < 6.5 || m.sleepQuality < 6) focusAreas.push('sleep');
      if (m.workLifeBalance < 6) focusAreas.push('load');

      const latestKey = getLatestMonthKey();
      const prevKey = getPrevMonthKey();
      if (!latestKey || !prevKey) return null;
      const who5Delta = (emp.history?.[latestKey]?.who5 ?? m.who5) - (emp.history?.[prevKey]?.who5 ?? m.who5);
      if (who5Delta >= 15) focusAreas.push('recovery');

      if (focusAreas.length === 0) return null;

      const severity = focusAreas.some(a => a === 'burnout' || a === 'mood') ? 'risk'
        : focusAreas.includes('recovery') && focusAreas.length === 1 ? 'positive'
        : 'focus';

      const category = severity === 'risk' ? 'üö® –†–∏–∑–∏–∫ 1:1'
        : severity === 'positive' ? 'üåü –ú–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ —É—Å–ø—ñ—Ö'
        : 'üõ† –ü—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∞';

      const triggers = [];
      if (focusAreas.includes('burnout')) triggers.push(`MBI ${m.mbi.toFixed(0)}% + —Å—Ç—Ä–µ—Å ${m.stressLevel}/40`);
      if (focusAreas.includes('mood')) triggers.push(`PHQ-9 ${m.phq9}/27, GAD-7 ${m.gad7}/21`);
      if (focusAreas.includes('sleep')) triggers.push(`—Å–æ–Ω ${m.sleepDuration} –≥–æ–¥, —è–∫—ñ—Å—Ç—å ${m.sleepQuality}/10`);
      if (focusAreas.includes('load')) triggers.push(`–±–∞–ª–∞–Ω—Å ${m.workLifeBalance}/10`);
      if (focusAreas.includes('recovery')) triggers.push(`–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è WHO-5 +${who5Delta.toFixed(0)}`);

      const message = `
        <div class="rec-insight">–¢—Ä–∏–≥–µ—Ä–∏: ${triggers.join(' ¬∑ ')}</div>
        <div>–§–æ–∫—É—Å 1:1: ${focusAreas.includes('recovery') ? '–∑–∞–∫—Ä—ñ–ø–∏—Ç–∏ —É—Å–ø—ñ—Ö —ñ –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏' : '–∑–Ω–∏–∑–∏—Ç–∏ —Å—Ç—Ä–µ—Å, –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Å–æ–Ω —Ç–∞ –±–∞–ª–∞–Ω—Å'}</div>
      `.trim();

      const action = severity === 'risk'
        ? '–ü—Ä–∏–∑–Ω–∞—á 1:1 –ø—Ä–æ—Ç—è–≥–æ–º 48 –≥–æ–¥–∏–Ω —Ç–∞ –∑–∞—Ñ—ñ–∫—Å—É–π 2 –∑–º—ñ–Ω–∏'
        : '–ü—Ä–æ–≤–µ—Å—Ç–∏ 1:1 —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è –∑ 7-–¥–µ–Ω–Ω–∏–º –ø–ª–∞–Ω–æ–º';

      return {
        id: emp.userId || emp.user_id || emp.id,
        employee: emp.name,
        category,
        subtitle: `–°—Ç—Ä–µ—Å ${m.stressLevel}/40 ¬∑ –°–æ–Ω ${m.sleepDuration.toFixed(1)} –≥–æ–¥ ¬∑ –ë–∞–ª–∞–Ω—Å ${m.workLifeBalance}/10`,
        message,
        action,
        duration: severity === 'risk' ? 15 : 12,
        callKit: buildCallKit(emp, focusAreas, who5Delta),
      };
    }

    function buildCallKit(emp, focusAreas, who5Delta) {
      const firstName = emp.name.split(' ')[0];
      const m = emp.metrics;

      const questions = [
        '–Ø–∫ —Ç–∏ –∑–∞—Ä–∞–∑ –ø–æ —à–∫–∞–ª—ñ 0-10?',
        '–©–æ –∑–∞–±–∏—Ä–∞—î –Ω–∞–π–±—ñ–ª—å—à–µ –µ–Ω–µ—Ä–≥—ñ—ó —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è?',
        '–©–æ –º–æ–∂–µ–º–æ –ø—Ä–∏–±—Ä–∞—Ç–∏/–¥–µ–ª–µ–≥—É–≤–∞—Ç–∏ –≤–∂–µ –∑–∞—Ä–∞–∑?',
        '–Ø–∫–∞ –æ–¥–Ω–∞ –∑–≤–∏—á–∫–∞ –¥–æ–ø–æ–º–æ–∂–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏—Å—å —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è?'
      ];

      if (focusAreas.includes('sleep')) questions.push('–©–æ –∑–∞–≤–∞–∂–∞—î –ª—è–≥–∞—Ç–∏ —Ä–∞–Ω—ñ—à–µ? –Ø–∫ –∫–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ —Ü–µ –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏?');
      if (focusAreas.includes('load')) questions.push('–Ø–∫—ñ –∑–∞–¥–∞—á—ñ –Ω–∞–π–º–µ–Ω—à –∫—Ä–∏—Ç–∏—á–Ω—ñ —Ç–∞ –≤–∏—Å–Ω–∞–∂—É—é—Ç—å?');
      if (focusAreas.includes('recovery') && who5Delta > 0) questions.push(`–©–æ –¥–∞–ª–æ +${who5Delta.toFixed(0)} –¥–æ WHO-5? –Ø–∫ —Ü–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏?`);

      const microActions = [];
      if (focusAreas.includes('burnout')) microActions.push('–í–∏–ª—É—á–∏—Ç–∏ 1 –Ω–µ-–∫—Ä–∏—Ç–∏—á–Ω–∏–π –º—ñ—Ç–∏–Ω–≥ —ñ –¥–æ–¥–∞—Ç–∏ 2—Ö2 –≥–æ–¥ —Ñ–æ–∫—É—Å—É –±–µ–∑ –ø—ñ–Ω–≥—ñ–≤.');
      if (focusAreas.includes('mood')) microActions.push('–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é –ø—Å–∏—Ö–æ–ª–æ–≥–∞/–∫–æ—É—á–∞ –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º —Å–ª–æ—Ç–æ–º.');
      if (focusAreas.includes('sleep')) microActions.push('2 –≤–µ—á–æ—Ä–∏ –±–µ–∑ —Ä–æ–±–æ—á–∏—Ö —á–∞—Ç—ñ–≤ –ø—ñ—Å–ª—è 19:00 + –ø—ñ–∑–Ω—ñ–π —Å—Ç–µ–Ω–¥–∞–ø 1 —Ä–∞–∑ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å.');
      if (focusAreas.includes('load')) microActions.push('–ü–µ—Ä–µ—Ä–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ 1 –∑–∞–¥–∞—á–∫—É —Ç–∞ –∑–∞–º–æ—Ä–æ–∑–∏—Ç–∏ 1 low-prio –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Å–ø—Ä–∏–Ω—Ç—É.');
      if (focusAreas.includes('recovery')) microActions.push('–ó–∞–¥–æ–∫—É–º–µ–Ω—Ç—É–≤–∞—Ç–∏ –ø—Ä–∞–∫—Ç–∏–∫—É —Ç–∞ –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—å –Ω–∞ —Ç—ñ–º-–º—ñ—Ç—ñ (5 —Ö–≤).');

      return `
        <h4>–§–ª–æ—É 1:1 –¥–ª—è ${firstName}</h4>
        <div class="rec-insight">–§–æ–∫—É—Å: ${focusAreas.join(' ‚Ä¢ ')}</div>
        <div class="call-kit-grid">
          <div class="call-block"><strong>12-15 —Ö–≤</strong>
            <ul>
              <li>1 —Ö–≤: –Ω–æ—Ä–º–∞–ª—ñ–∑—É–π —ñ –∑–∞–ø—Ä–æ—Å–∏ —á–µ—Å–Ω—ñ—Å—Ç—å.</li>
              <li>3 —Ö–≤: –≤—ñ–¥–∑–µ—Ä–∫–∞–ª—å –¥–∞–Ω—ñ (—Å—Ç—Ä–µ—Å ${m.stressLevel}/40, MBI ${m.mbi.toFixed(0)}%, —Å–æ–Ω ${m.sleepDuration} –≥–æ–¥).</li>
              <li>5 —Ö–≤: –¥–æ—Å–ª—ñ–¥–∂—É–π –∫–æ—Ä—ñ–Ω—å –ø—Ä–æ–±–ª–µ–º–∏ –ø–∏—Ç–∞–Ω–Ω—è–º–∏.</li>
              <li>3-4 —Ö–≤: –æ–±–µ—Ä—ñ—Ç—å 1-2 –∑–º—ñ–Ω–∏ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å.</li>
              <li>1 —Ö–≤: –∑–∞—Ñ—ñ–∫—Å—É–π –Ω–∞—Å—Ç—É–ø–Ω–∏–π —á–µ–∫–ø–æ–π–Ω—Ç.</li>
            </ul>
          </div>
          <div class="call-block"><strong>–ü–∏—Ç–∞–Ω–Ω—è</strong>
            <ul>${questions.map(q => '<li>' + q + '</li>').join('')}</ul>
          </div>
          <div class="call-block"><strong>–ú—ñ–∫—Ä–æ–¥—ñ—ó</strong>
            <ul>${microActions.map(a => '<li>' + a + '</li>').join('')}</ul>
          </div>
        </div>
      `;
    }

    function toggleCallKit(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('open');
    }

    function openChartModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'flex';
    }

    function closeChartModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    }

    function modalBgClick(event, id) {
      if (event.target.id === id) {
        closeChartModal(id);
      }
    }

    function fillMetricsGrid(id, metrics) {
      const grid = document.getElementById(id);
      if (!grid) return;
      grid.innerHTML = metrics.map(item => {
        const hint = METRIC_HINTS[item.key] || '';
        const tooltip = hint ? `<span class="info-icon" data-tooltip="${hint}">i</span>` : '';
        return `<div class="modal-metric"><span class="metric-label">${item.label} ${tooltip}</span><span class="metric-value">${item.value}</span></div>`;
      }).join('');
    }

    // ===== WELLNESS =====
    async function loadWellnessData() {
      try {
        const [goals, plan] = await Promise.all([
          apiCall('/wellness/goals'),
          apiCall('/wellness/plan'),
        ]);
        wellnessGoals = goals;
        wellnessPlan = plan;
        renderWellness();
      } catch (error) {
        const container = document.getElementById('wellness-plan');
        if (container) {
          container.innerHTML = '<div class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–ª–∞–Ω</div>';
        }
      }
    }

    function renderWellness() {
      const planContainer = document.getElementById('wellness-plan');
      const planStatus = document.getElementById('wellness-plan-status');
      const completeBtn = document.getElementById('complete-plan-btn');

      if (planContainer) {
        planContainer.innerHTML = '';
        const items = wellnessPlan?.items || [];
        if (!items.length) {
          planContainer.innerHTML = '<div class="form-hint">–ü–ª–∞–Ω –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—ñ—Å–ª—è —á–µ–∫—ñ–Ω—É</div>';
        } else {
          items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'plan-item';
            const duration = item.duration_minutes ? ` ¬∑ ${item.duration_minutes} —Ö–≤` : '';
            card.innerHTML = `
              <div class="plan-title">${item.title}${duration}</div>
              <div class="plan-meta">${item.description}</div>
            `;
            planContainer.appendChild(card);
          });
        }
      }

      if (planStatus && completeBtn) {
        if (wellnessPlan?.completed_at) {
          planStatus.textContent = '‚úÖ –ü–ª–∞–Ω –≤–∏–∫–æ–Ω–∞–Ω–æ';
          completeBtn.disabled = true;
        } else {
          planStatus.textContent = '';
          completeBtn.disabled = false;
        }
      }

      if (wellnessGoals) {
        const sleepInput = document.getElementById('goal-sleep');
        const breakInput = document.getElementById('goal-breaks');
        const moveInput = document.getElementById('goal-move');
        const notifyInput = document.getElementById('goal-notifications');
        if (sleepInput) sleepInput.value = wellnessGoals.sleep_target ?? 7;
        if (breakInput) breakInput.value = wellnessGoals.break_target ?? 3;
        if (moveInput) moveInput.value = wellnessGoals.move_target ?? 20;
        if (notifyInput) notifyInput.checked = !!wellnessGoals.notifications_enabled;
      }
    }

    // ===== INSIGHTS =====
    async function loadInsights() {
      try {
        const [benchmark, correlations, earlySignal] = await Promise.all([
          apiCall('/insights/self-benchmark'),
          apiCall('/insights/correlations'),
          apiCall('/insights/early-signal'),
        ]);
        insights.selfBenchmark = benchmark;
        insights.correlations = correlations || [];
        insights.earlySignal = earlySignal;
        renderInsights();
      } catch (error) {
        renderInsights();
      }
    }

    function renderInsights() {
      renderSelfBenchmark(insights.selfBenchmark);
      renderCorrelations(insights.correlations || []);
      renderEarlySignal(insights.earlySignal);
    }

    function renderSelfBenchmark(benchmark) {
      const container = document.getElementById('self-benchmark');
      if (!container) return;

      container.innerHTML = '';
      if (!benchmark) {
        container.innerHTML = '<div class="form-hint">–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è</div>';
        return;
      }

      const current = benchmark.current;
      const summary = document.createElement('div');
      summary.className = 'insight-item';
      summary.innerHTML = `
        <div class="insight-title">–û—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤</div>
        <div class="insight-meta">WHO-5: ${current.who5.toFixed(1)} ¬∑ Burnout: ${current.burnout.toFixed(1)}%</div>
      `;
      container.appendChild(summary);

      if (!benchmark.deltas || !benchmark.previous) {
        const note = document.createElement('div');
        note.className = 'form-hint';
        note.textContent = '–ó–±–∏—Ä–∞—î–º–æ —â–µ 7 –¥–Ω—ñ–≤ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è.';
        container.appendChild(note);
        return;
      }

      const metrics = [
        { key: 'who5', label: 'WHO-5', higherBetter: true, suffix: '' },
        { key: 'phq9', label: 'PHQ-9', higherBetter: false, suffix: '' },
        { key: 'gad7', label: 'GAD-7', higherBetter: false, suffix: '' },
        { key: 'burnout', label: 'Burnout', higherBetter: false, suffix: '%' },
        { key: 'stress', label: '–°—Ç—Ä–µ—Å', higherBetter: false, suffix: '' },
        { key: 'sleep', label: '–°–æ–Ω', higherBetter: true, suffix: 'h' },
        { key: 'balance', label: '–ë–∞–ª–∞–Ω—Å', higherBetter: true, suffix: '' },
      ];

      metrics.forEach(metric => {
        const delta = benchmark.deltas[metric.key];
        if (delta === null || delta === undefined || Math.abs(delta) < 0.4) return;
        const arrow = delta > 0 ? '‚Üë' : '‚Üì';
        const improving = metric.higherBetter ? delta > 0 : delta < 0;
        const color = improving ? 'var(--success)' : 'var(--warning)';
        const item = document.createElement('div');
        item.className = 'insight-item';
        item.innerHTML = `
          <div class="insight-title" style="color:${color};">${metric.label} ${arrow} ${delta.toFixed(1)}${metric.suffix}</div>
          <div class="insight-meta">–¢–µ–ø–µ—Ä: ${benchmark.current[metric.key].toFixed(1)}${metric.suffix} ¬∑ –ë—É–ª–æ: ${benchmark.previous[metric.key].toFixed(1)}${metric.suffix}</div>
        `;
        container.appendChild(item);
      });
    }

    function renderCorrelations(list) {
      const container = document.getElementById('correlations-list');
      if (!container) return;
      container.innerHTML = '';

      if (!list || list.length === 0) {
        container.innerHTML = '<div class="form-hint">–ö–æ—Ä–µ–ª—è—Ü—ñ—ó –∑ º—è–≤–ª—è—Ç—å—Å—è –ø—ñ—Å–ª—è 2-3 —Ç–∏–∂–Ω—ñ–≤ –¥–∞–Ω–∏—Ö</div>';
        return;
      }

      list.slice(0, 4).forEach(item => {
        const card = document.createElement('div');
        card.className = 'insight-item';
        card.innerHTML = `
          <div class="insight-title">${item.description}</div>
          <div class="insight-meta">${item.recommendation}</div>
        `;
        container.appendChild(card);
      });
    }

    function renderEarlySignal(signal) {
      const banner = document.getElementById('early-signal-banner');
      if (!banner) return;

      if (!signal) {
        banner.classList.add('hidden');
        return;
      }

      const labels = {
        critical: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π —Å–∏–≥–Ω–∞–ª',
        alert: '–£–≤–∞–≥–∞: —Ä–∞–Ω–Ω—ñ–π —Å–∏–≥–Ω–∞–ª',
        watch: '–°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—î–º–æ —Ç—Ä–µ–Ω–¥',
      };
      banner.classList.remove('hidden', 'level-critical', 'level-alert', 'level-watch');
      banner.classList.add(`level-${signal.level}`);
      banner.innerHTML = `
        ‚ö° ${labels[signal.level] || '–†–∞–Ω–Ω—ñ–π —Å–∏–≥–Ω–∞–ª'} ¬∑ confidence ${(signal.confidence * 100).toFixed(0)}%
        <div class="form-hint">–Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏: ${(signal.indicators || []).join(', ')}</div>
      `;
    }

    // ===== KUDOS =====
    async function loadKudos() {
      try {
        kudosData = await apiCall('/kudos');
        renderKudos();
      } catch (error) {
        const container = document.getElementById('kudos-received');
        if (container) {
          container.innerHTML = '<div class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ kudos</div>';
        }
      }
    }

    function renderKudos() {
      const receivedContainer = document.getElementById('kudos-received');
      const sentContainer = document.getElementById('kudos-sent');
      const insightsContainer = document.getElementById('kudos-insights');
      const summaryContainer = document.getElementById('kudos-summary');

      if (receivedContainer) receivedContainer.innerHTML = '';
      if (sentContainer) sentContainer.innerHTML = '';
      if (insightsContainer) insightsContainer.innerHTML = '';
      if (summaryContainer) summaryContainer.textContent = '';

      if (!kudosData) return;

      const topSenders = kudosData.insights?.top_senders || [];
      const topKeywords = kudosData.insights?.top_keywords || [];
      const receivedCount = kudosData.insights?.received_count_30d || 0;
      const sentCount = kudosData.insights?.sent_count_30d || 0;
      const summary = kudosData.insights?.summary || '';

      if (summaryContainer) {
        summaryContainer.textContent = summary;
      }

      if (insightsContainer) {
        if (receivedCount === 0 && sentCount === 0 && topSenders.length === 0 && topKeywords.length === 0) {
          insightsContainer.innerHTML = '<span class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è —ñ–Ω—Å–∞–π—Ç—ñ–≤</span>';
        } else {
          if (receivedCount > 0) {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.textContent = `–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞ 30 –¥–Ω—ñ–≤: ${receivedCount}`;
            insightsContainer.appendChild(chip);
          }
          if (sentCount > 0) {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.textContent = `–ù–∞–¥—ñ—Å–ª–∞–Ω–æ –∑–∞ 30 –¥–Ω—ñ–≤: ${sentCount}`;
            insightsContainer.appendChild(chip);
          }
          topSenders.forEach(name => {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.textContent = `‚≠ê ${name}`;
            insightsContainer.appendChild(chip);
          });
          topKeywords.forEach(word => {
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.textContent = `#${word}`;
            insightsContainer.appendChild(chip);
          });
        }
      }

      if (receivedContainer) {
        if (!kudosData.received || kudosData.received.length === 0) {
          receivedContainer.innerHTML = '<div class="form-hint">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö kudos</div>';
        } else {
          kudosData.received.forEach(entry => {
            const card = document.createElement('div');
            card.className = 'kudos-item';
            const date = entry.created_at ? new Date(entry.created_at).toLocaleDateString('uk-UA') : '–ù–µ—â–æ–¥–∞–≤–Ω–æ';
            card.innerHTML = `
              <div class="kudos-meta">–í—ñ–¥: ${entry.from_name} ¬∑ ${date}</div>
              <div class="kudos-message">${entry.message}</div>
            `;
            receivedContainer.appendChild(card);
          });
        }
      }

      if (sentContainer) {
        if (!kudosData.sent || kudosData.sent.length === 0) {
          sentContainer.innerHTML = '<div class="form-hint">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –Ω–∞–¥—ñ—Å–ª–∞–Ω–∏—Ö kudos</div>';
        } else {
          kudosData.sent.forEach(entry => {
            const card = document.createElement('div');
            card.className = 'kudos-item';
            const date = entry.created_at ? new Date(entry.created_at).toLocaleDateString('uk-UA') : '–ù–µ—â–æ–¥–∞–≤–Ω–æ';
            card.innerHTML = `
              <div class="kudos-meta">–ö–æ–º—É: ${entry.to_name} ¬∑ ${date}</div>
              <div class="kudos-message">${entry.message}</div>
            `;
            sentContainer.appendChild(card);
          });
        }
      }
    }

    // ===== PULSE ROOMS =====
    async function loadPulseRooms() {
      const container = document.getElementById('pulse-rooms');
      if (container) container.innerHTML = '<div class="form-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç...</div>';

      try {
        pulseRooms = await apiCall('/pulse/rooms');
        renderPulseRooms();
        if (!activePulseRoom && pulseRooms.length) {
          setActivePulseRoom(pulseRooms[0]);
        }
      } catch (error) {
        if (container) {
          container.innerHTML = '<div class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç–∏</div>';
        }
      }
    }

    function setActivePulseRoom(room) {
      activePulseRoom = room;
      renderPulseRooms();
      loadPulseMessages();
    }

    function renderPulseRooms() {
      const container = document.getElementById('pulse-rooms');
      if (!container) return;
      container.innerHTML = '';

      if (!pulseRooms || pulseRooms.length === 0) {
        container.innerHTML = '<div class="form-hint">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç</div>';
        return;
      }

      pulseRooms.forEach(room => {
        const card = document.createElement('div');
        card.className = `pulse-room-card${activePulseRoom?.id === room.id ? ' active' : ''}`;
        card.innerHTML = `
          <div class="plan-title">${room.title}</div>
          <div class="plan-meta">${room.description || ''}</div>
        `;
        card.addEventListener('click', () => setActivePulseRoom(room));
        container.appendChild(card);
      });
    }

    async function loadPulseMessages() {
      if (!activePulseRoom) return;
      const container = document.getElementById('pulse-messages');
      if (container) container.innerHTML = '<div class="form-hint">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å...</div>';

      try {
        pulseMessages = await apiCall(`/pulse/rooms/${activePulseRoom.slug}/messages`);
        renderPulseMessages();
      } catch (error) {
        if (container) {
          container.innerHTML = '<div class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>';
        }
      }
    }

    function renderPulseMessages() {
      const container = document.getElementById('pulse-messages');
      const meta = document.getElementById('pulse-room-meta');
      if (!container) return;

      if (meta) {
        meta.textContent = activePulseRoom
          ? `${activePulseRoom.title} ¬∑ ${activePulseRoom.description || ''}`
          : '–û–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É';
      }

      container.innerHTML = '';
      if (!pulseMessages || pulseMessages.length === 0) {
        container.innerHTML = '<div class="form-hint">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div>';
        return;
      }

      pulseMessages.forEach(message => {
        const card = document.createElement('div');
        card.className = `pulse-message${message.status === 'PENDING' ? ' pending' : ''}`;
        const created = message.created_at ? new Date(message.created_at).toLocaleString('uk-UA') : '–ù–µ—â–æ–¥–∞–≤–Ω–æ';
        const status = message.status === 'PENDING' ? ' ¬∑ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó' : '';
        const author = message.is_anonymous
          ? '–ê–Ω–æ–Ω—ñ–º'
          : (message.author_name || '–£—á–∞—Å–Ω–∏–∫');
        card.innerHTML = `
          <div class="plan-meta">${created}${status} ¬∑ ${author}</div>
          <div class="plan-title">${message.content}</div>
        `;
        container.appendChild(card);
      });
    }

    async function loadPulseModeration() {
      const card = document.getElementById('pulse-moderation-card');
      if (!card) return;
      if (!isAdmin()) {
        card.classList.add('hidden');
        return;
      }
      card.classList.remove('hidden');

      try {
        pulseModerationQueue = await apiCall('/pulse/moderation');
        renderPulseModeration();
      } catch (error) {
        const container = document.getElementById('pulse-moderation-queue');
        if (container) {
          container.innerHTML = '<div class="form-hint">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–µ—Ä–≥—É</div>';
        }
      }
    }

    function renderPulseModeration() {
      const container = document.getElementById('pulse-moderation-queue');
      if (!container) return;
      container.innerHTML = '';

      if (!pulseModerationQueue || pulseModerationQueue.length === 0) {
        container.innerHTML = '<div class="form-hint">–ß–µ—Ä–≥–∞ –ø–æ—Ä–æ–∂–Ω—è</div>';
        return;
      }

      pulseModerationQueue.forEach(item => {
        const card = document.createElement('div');
        card.className = 'moderation-card';
        const created = item.created_at ? new Date(item.created_at).toLocaleString('uk-UA') : '–ù–µ—â–æ–¥–∞–≤–Ω–æ';
        const reason = item.moderation_reason ? `<div class="form-hint">–ü—Ä–∏—á–∏–Ω–∞: ${item.moderation_reason}</div>` : '';
        card.innerHTML = `
          <div class="plan-title">${item.room_title}</div>
          <div class="plan-meta">${created} ¬∑ ${item.room_slug}</div>
          <div style="margin-top:0.5rem;">${item.content}</div>
          ${reason}
          <div class="toggle-row" style="margin-top:0.75rem;">
            <button class="btn btn-secondary" data-action="approve" data-id="${item.id}">Approve</button>
            <button class="btn btn-secondary" data-action="reject" data-id="${item.id}">Reject</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // ===== WELLNESS GOALS =====
    const wellnessGoalsForm = document.getElementById('wellness-goals-form');
    if (wellnessGoalsForm) {
      wellnessGoalsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('wellness-goals-status');
        statusEl.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

        const payload = {
          sleep_target: parseInt(document.getElementById('goal-sleep').value, 10),
          break_target: parseInt(document.getElementById('goal-breaks').value, 10),
          move_target: parseInt(document.getElementById('goal-move').value, 10),
          notifications_enabled: document.getElementById('goal-notifications').checked,
        };

        try {
          wellnessGoals = await apiCall('/wellness/goals', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          statusEl.textContent = '‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ';
          renderWellness();
        } catch (error) {
          statusEl.textContent = '‚ùå ' + error.message;
        }
      });
    }

    const completePlanBtn = document.getElementById('complete-plan-btn');
    if (completePlanBtn) {
      completePlanBtn.addEventListener('click', async () => {
        const statusEl = document.getElementById('wellness-plan-status');
        statusEl.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
        try {
          await apiCall('/wellness/plan/complete', { method: 'POST' });
          await loadWellnessData();
          statusEl.textContent = '‚úÖ –ü–ª–∞–Ω –≤–∏–∫–æ–Ω–∞–Ω–æ';
        } catch (error) {
          statusEl.textContent = '‚ùå ' + error.message;
        }
      });
    }

    // ===== KUDOS FORM =====
    const kudosForm = document.getElementById('kudos-form');
    if (kudosForm) {
      kudosForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('kudos-status');
        statusEl.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∫–∞...';

        const recipient = document.getElementById('kudos-email').value.trim();
        const message = document.getElementById('kudos-message').value.trim();
        if (!recipient || !message) {
          statusEl.textContent = '‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è';
          return;
        }

        try {
          await apiCall('/kudos', {
            method: 'POST',
            body: JSON.stringify({ recipient_email: recipient, message }),
          });
          statusEl.textContent = '‚úÖ Kudos –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ';
          document.getElementById('kudos-message').value = '';
          await loadKudos();
        } catch (error) {
          statusEl.textContent = '‚ùå ' + error.message;
        }
      });
    }

    // ===== PULSE MESSAGE FORM =====
    const pulseMessageForm = document.getElementById('pulse-message-form');
    if (pulseMessageForm) {
      pulseMessageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('pulse-message-status');
        statusEl.textContent = '';

        if (!activePulseRoom) {
          statusEl.textContent = '–û–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É';
          return;
        }

        const content = document.getElementById('pulse-message-content').value.trim();
        if (!content) {
          statusEl.textContent = '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—î';
          return;
        }

        try {
          const res = await apiCall(`/pulse/rooms/${activePulseRoom.slug}/messages`, {
            method: 'POST',
            body: JSON.stringify({
              content,
              is_anonymous: document.getElementById('pulse-anonymous').checked,
            }),
          });
          document.getElementById('pulse-message-content').value = '';
          if (res?.status === 'PENDING') {
            statusEl.textContent = '‚è≥ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü—ñ—ó';
          } else {
            statusEl.textContent = '‚úÖ –û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ';
            await loadPulseMessages();
          }
          if (isAdmin()) {
            await loadPulseModeration();
          }
        } catch (error) {
          statusEl.textContent = '‚ùå ' + error.message;
        }
      });
    }

    const moderationQueue = document.getElementById('pulse-moderation-queue');
    if (moderationQueue) {
      moderationQueue.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;
        if (!id) return;

        try {
          if (action === 'approve') {
            await apiCall(`/pulse/messages/${id}/approve`, { method: 'POST' });
          } else if (action === 'reject') {
            const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è (–æ–ø—Ü—ñ–π–Ω–æ):') || '';
            await apiCall(`/pulse/messages/${id}/reject`, {
              method: 'POST',
              body: JSON.stringify({ reason }),
            });
          }
          await loadPulseModeration();
          if (activePulseRoom) {
            await loadPulseMessages();
          }
        } catch (error) {
          console.error(error);
        }
      });
    }

    // ===== TELEGRAM SETTINGS =====
    async function loadTelegramStatus() {
      const status = await apiCall('/telegram/status');
      if (!status) return;
      telegramStatus = status;

      const connection = document.getElementById('telegram-connection-status');
      const pinInfo = document.getElementById('telegram-pin-info');

      if (status.connected) {
        connection.textContent = `‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ (ID ${status.telegram_id})`;
        pinInfo.textContent = 'Telegram —É–∂–µ –ø—Ä–∏–≤ º—è–∑–∞–Ω–∏–π. –î–ª—è –≤—Ö–æ–¥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ /weblogin.';
      } else {
        connection.textContent = '‚õî –ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ';
        pinInfo.textContent = '–î–ª—è –ø—Ä–∏–≤ º—è–∑–∫–∏ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —É –±–æ—Ç—ñ /start email@opslab.uk 1234.';
      }

      document.getElementById('reminder-time').value =
        `${String(status.reminder_hour).padStart(2, '0')}:${String(status.reminder_minute).padStart(2, '0')}`;
      document.getElementById('timezone-input').value = status.timezone || 'UTC';
      document.getElementById('notifications-enabled').checked = !!status.notification_enabled;

      renderOnboarding();
    }

    function renderOnboarding() {
      const card = document.getElementById('onboarding-card');
      if (!card || !telegramStatus) return;

      if (telegramStatus.onboarding_completed) {
        card.classList.add('hidden');
        return;
      }

      card.classList.remove('hidden');

      const step2 = document.getElementById('onboarding-step-2');
      const step3 = document.getElementById('onboarding-step-3');
      const statusChip = document.getElementById('onboarding-telegram-status');
      const reminderPreview = document.getElementById('onboarding-reminder-preview');
      const completeBtn = document.getElementById('complete-onboarding-btn');

      if (telegramStatus.connected) {
        if (statusChip) {
          statusChip.textContent = 'Telegram –ø—Ä–∏–≤ º—è–∑–∞–Ω–æ';
          statusChip.className = 'status-chip';
        }
        if (step2) step2.classList.add('complete');
      } else {
        if (statusChip) {
          statusChip.textContent = '–ù–µ –ø—Ä–∏–≤ º—è–∑–∞–Ω–æ';
          statusChip.className = 'status-chip';
        }
        if (step2) step2.classList.remove('complete');
      }

      if (reminderPreview) {
        const time = `${String(telegramStatus.reminder_hour).padStart(2, '0')}:${String(telegramStatus.reminder_minute).padStart(2, '0')}`;
        reminderPreview.textContent = `–ü–æ—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è: ${time} ¬∑ ${telegramStatus.timezone}`;
      }

      if (step3) {
        step3.classList.add('complete');
      }

      if (completeBtn) {
        completeBtn.disabled = !telegramStatus.connected;
      }
    }

    const onboardingScrollBtn = document.getElementById('onboarding-scroll-settings');
    if (onboardingScrollBtn) {
      onboardingScrollBtn.addEventListener('click', () => {
        const target = document.getElementById('telegram-settings-card');
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    const onboardingRefreshBtn = document.getElementById('onboarding-refresh');
    if (onboardingRefreshBtn) {
      onboardingRefreshBtn.addEventListener('click', async () => {
        await loadTelegramStatus();
      });
    }

    const onboardingCompleteBtn = document.getElementById('complete-onboarding-btn');
    if (onboardingCompleteBtn) {
      onboardingCompleteBtn.addEventListener('click', async () => {
        const statusEl = document.getElementById('onboarding-status');
        if (statusEl) statusEl.textContent = '–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ...';
        if (!telegramStatus?.connected) {
          if (statusEl) statusEl.textContent = '–°–ø–æ—á–∞—Ç–∫—É –ø—Ä–∏–≤ º—è–∂—ñ—Ç—å Telegram —É –±–æ—Ç—ñ.';
          return;
        }

        const reminderTime = document.getElementById('reminder-time')?.value;
        const timezone = document.getElementById('timezone-input')?.value?.trim();
        const notificationsEnabled = document.getElementById('notifications-enabled')?.checked ?? true;

        const payload = {
          onboarding_complete: true,
          notification_enabled: notificationsEnabled,
        };
        if (reminderTime) payload.reminder_time = reminderTime;
        if (timezone) payload.timezone = timezone;

        try {
          await apiCall('/telegram/preferences', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          if (statusEl) statusEl.textContent = '‚úÖ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–æ';
          await loadTelegramStatus();
        } catch (error) {
          if (statusEl) statusEl.textContent = `‚ùå ${error.message}`;
        }
      });
    }

    document.getElementById('telegram-settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById('telegram-settings-status');
      statusEl.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

      const reminderTime = document.getElementById('reminder-time').value;
      const timezone = document.getElementById('timezone-input').value.trim();
      const notificationsEnabled = document.getElementById('notifications-enabled').checked;

      const payload = {
        notification_enabled: notificationsEnabled,
      };

      if (reminderTime) {
        payload.reminder_time = reminderTime;
      }
      if (timezone) {
        payload.timezone = timezone;
      }

      try {
        await apiCall('/telegram/preferences', {
          method: 'POST',
          body: JSON.stringify(payload),
        });
        statusEl.textContent = '‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ';
        await loadTelegramStatus();
      } catch (error) {
        statusEl.textContent = '‚ùå ' + error.message;
      }
    });

    // ===== ADMIN HEATMAP =====
    async function loadTeamHeatmap() {
      if (!isAdmin()) return;
      const data = await apiCall('/admin/heatmap');
      teamHeatmap = data;
      renderTeamHeatmap(data);
    }

    function renderTeamHeatmap(data) {
      const container = document.getElementById('team-heatmap');
      container.innerHTML = '';

      if (!data || !data.users || data.users.length === 0) {
        container.innerHTML = '<div class="form-hint">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>';
        return;
      }

      const statusLabel = (status) => {
        switch (status) {
          case 'CRITICAL': return { label: '–ö—Ä–∏—Ç–∏—á–Ω–∏–π', color: 'var(--danger)' };
          case 'CONCERNING': return { label: '–†–∏–∑–∏–∫', color: 'var(--warning)' };
          case 'GOOD': return { label: '–î–æ–±—Ä–µ', color: 'var(--success)' };
          case 'EXCELLENT': return { label: '–í—ñ–¥–º—ñ–Ω–Ω–æ', color: 'var(--success)' };
          default: return { label: '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö', color: 'var(--gray)' };
        }
      };

      data.users.forEach(user => {
        const card = document.createElement('div');
        card.className = 'metric-card';

        const status = statusLabel(user.status);
        const earlySignal = user.early_signal
          ? `‚ö° ${user.early_signal.level} ¬∑ ${(user.early_signal.indicators || []).slice(0, 2).join(', ')}`
          : '';
        const actionCards = (user.action_cards || [])
          .map(card => `<div class="action-card"><strong>${card.title}</strong><br>${card.description}</div>`)
          .join('');
        card.innerHTML = `
          <div class="metric-label">${user.name}</div>
          <div class="metric-desc" style="color:${status.color}; font-weight:700;">${status.label}</div>
          <div class="form-hint">WHO-5: ${user.who5_score.toFixed(1)} ¬∑ Burnout: ${user.burnout_percentage.toFixed(1)}%</div>
          <div class="form-hint">Streak: ${user.streak} –¥–Ω—ñ–≤</div>
          ${earlySignal ? `<div class="form-hint">${earlySignal}</div>` : ''}
          ${actionCards}
        `;

        container.appendChild(card);
      });
    }

    // ===== ADMIN USERS =====
    async function loadAdminUsers() {
      if (!isAdmin()) return;
      try {
        const data = await apiCall('/admin/users');
        adminUsers = Array.isArray(data) ? data : [];
        renderAdminUsers();
      } catch (error) {
        const tbody = document.getElementById('admin-users-table');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</td></tr>';
        }
      }
    }

    function renderAdminUsers() {
      const tbody = document.getElementById('admin-users-table');
      if (!tbody) return;

      const term = adminSearch.trim().toLowerCase();
      const filtered = adminUsers.filter(user => {
        if (!showInactiveUsers && !user.is_active) return false;
        if (!term) return true;
        return user.name.toLowerCase().includes(term) || user.email.toLowerCase().includes(term);
      });

      tbody.innerHTML = '';

      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7">–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–∞ —Ü–∏–º —Ñ—ñ–ª—å—Ç—Ä–æ–º</td></tr>';
        return;
      }

      const canManageTarget = (target) => {
        if (!currentUser) return false;
        if (target.id === currentUser.user_id) return false;
        if ((target.role === 'ADMIN' || target.role === 'FOUNDER') && currentUser.role !== 'FOUNDER') {
          return false;
        }
        return true;
      };

      filtered.forEach(user => {
        const tr = document.createElement('tr');
        if (!user.is_active) tr.classList.add('admin-row-inactive');

        const userCell = document.createElement('td');
        userCell.dataset.label = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
        const nameEl = document.createElement('div');
        nameEl.style.fontWeight = '700';
        nameEl.textContent = user.name;
        const emailEl = document.createElement('div');
        emailEl.className = 'form-hint';
        emailEl.textContent = user.email;
        userCell.appendChild(nameEl);
        userCell.appendChild(emailEl);
        if (user.note) {
          const noteEl = document.createElement('div');
          noteEl.className = 'form-hint';
          noteEl.textContent = user.note;
          userCell.appendChild(noteEl);
        }

        const roleCell = document.createElement('td');
        roleCell.dataset.label = '–†–æ–ª—å';
        roleCell.textContent = user.role;

        const statusCell = document.createElement('td');
        statusCell.dataset.label = '–°—Ç–∞—Ç—É—Å';
        const statusChip = document.createElement('span');
        statusChip.className = 'status-chip';
        statusChip.textContent = user.is_active ? '–ê–∫—Ç–∏–≤–Ω–∏–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π';
        statusCell.appendChild(statusChip);

        const telegramCell = document.createElement('td');
        telegramCell.dataset.label = 'Telegram';
        telegramCell.textContent = user.telegram_id ? '–ü—Ä–∏–≤ º—è–∑–∞–Ω–æ' : '‚Äî';

        const createdCell = document.createElement('td');
        createdCell.dataset.label = '–°—Ç–≤–æ—Ä–µ–Ω–æ';
        createdCell.textContent = user.created_at
          ? new Date(user.created_at).toLocaleDateString('uk-UA')
          : '‚Äî';

        const offboardedCell = document.createElement('td');
        offboardedCell.dataset.label = '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ';
        offboardedCell.textContent = user.offboarded_at
          ? new Date(user.offboarded_at).toLocaleDateString('uk-UA')
          : '‚Äî';
        if (user.offboarded_reason) {
          const reasonEl = document.createElement('div');
          reasonEl.className = 'form-hint';
          reasonEl.textContent = user.offboarded_reason;
          offboardedCell.appendChild(reasonEl);
        }

        const actionsCell = document.createElement('td');
        actionsCell.dataset.label = '–î—ñ—ó';
        actionsCell.className = 'admin-actions';

        const canManage = canManageTarget(user);
        if (user.is_active) {
          const deactivateBtn = document.createElement('button');
          deactivateBtn.className = 'btn btn-secondary';
          deactivateBtn.textContent = '–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏';
          deactivateBtn.dataset.action = 'deactivate';
          deactivateBtn.dataset.id = user.id;
          if (!canManage) deactivateBtn.disabled = true;
          actionsCell.appendChild(deactivateBtn);
        } else {
          const reactivateBtn = document.createElement('button');
          reactivateBtn.className = 'btn btn-success';
          reactivateBtn.textContent = '–í—ñ–¥–Ω–æ–≤–∏—Ç–∏';
          reactivateBtn.dataset.action = 'reactivate';
          reactivateBtn.dataset.id = user.id;
          if (!canManage) reactivateBtn.disabled = true;
          actionsCell.appendChild(reactivateBtn);
        }

        const resetBtn = document.createElement('button');
        resetBtn.className = 'btn btn-primary';
        resetBtn.textContent = '–°–∫–∏–Ω—É—Ç–∏ –∫–æ–¥';
        resetBtn.dataset.action = 'reset';
        resetBtn.dataset.id = user.id;
        if (!canManage) resetBtn.disabled = true;
        actionsCell.appendChild(resetBtn);

        const resetTelegramBtn = document.createElement('button');
        resetTelegramBtn.className = 'btn btn-secondary';
        resetTelegramBtn.textContent = '–°–∫–∏–Ω—É—Ç–∏ Telegram';
        resetTelegramBtn.dataset.action = 'reset-telegram';
        resetTelegramBtn.dataset.id = user.id;
        if (!canManage || !user.telegram_id) resetTelegramBtn.disabled = true;
        actionsCell.appendChild(resetTelegramBtn);

        tr.appendChild(userCell);
        tr.appendChild(roleCell);
        tr.appendChild(statusCell);
        tr.appendChild(telegramCell);
        tr.appendChild(createdCell);
        tr.appendChild(offboardedCell);
        tr.appendChild(actionsCell);
        tbody.appendChild(tr);
      });
    }

    const adminSearchInput = document.getElementById('admin-user-search');
    if (adminSearchInput) {
      adminSearchInput.addEventListener('input', (e) => {
        adminSearch = e.target.value || '';
        renderAdminUsers();
      });
    }

    const adminShowInactive = document.getElementById('admin-show-inactive');
    if (adminShowInactive) {
      adminShowInactive.addEventListener('change', (e) => {
        showInactiveUsers = !!e.target.checked;
        renderAdminUsers();
      });
    }

    const generateUserCodeBtn = document.getElementById('generate-user-code');
    if (generateUserCodeBtn) {
      generateUserCodeBtn.addEventListener('click', () => {
        const code = String(Math.floor(1000 + Math.random() * 9000));
        const codeInput = document.getElementById('admin-user-code');
        if (codeInput) {
          codeInput.value = code;
        }
      });
    }

    const adminUserForm = document.getElementById('admin-user-form');
    if (adminUserForm) {
      adminUserForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('admin-user-status');
        if (statusEl) statusEl.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';

        const name = document.getElementById('admin-user-name').value.trim();
        const email = document.getElementById('admin-user-email').value.trim();
        const role = document.getElementById('admin-user-role').value;
        const code = document.getElementById('admin-user-code').value.trim();
        const note = document.getElementById('admin-user-note').value.trim();

        if (!name || !email || !code) {
          if (statusEl) statusEl.textContent = '‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è';
          return;
        }

        try {
          await apiCall('/admin/users', {
            method: 'POST',
            body: JSON.stringify({
              name,
              email,
              code,
              role: role || 'EMPLOYEE',
              note: note || null
            }),
          });
          if (statusEl) statusEl.textContent = '‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Å—Ç–≤–æ—Ä–µ–Ω–æ';
          adminUserForm.reset();
          await loadAdminUsers();
        } catch (error) {
          if (statusEl) statusEl.textContent = `‚ùå ${error.message}`;
        }
      });
    }

    const adminUsersTable = document.getElementById('admin-users-table');
    if (adminUsersTable) {
      adminUsersTable.addEventListener('click', async (e) => {
        const target = e.target.closest('button[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const userId = target.dataset.id;
        if (!userId) return;

        try {
          if (action === 'deactivate') {
            const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó (–æ–ø—Ü—ñ–π–Ω–æ):') || null;
            if (!confirm('–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞?')) return;
            await apiCall(`/admin/users/${userId}/deactivate`, {
              method: 'POST',
              body: JSON.stringify({ reason }),
            });
          } else if (action === 'reactivate') {
            if (!confirm('–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –¥–æ—Å—Ç—É–ø –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É?')) return;
            await apiCall(`/admin/users/${userId}/reactivate`, {
              method: 'POST',
            });
          } else if (action === 'reset') {
            const code = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π 4-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø—É:');
            if (!code) return;
            await apiCall(`/admin/users/${userId}/reset-code`, {
              method: 'POST',
              body: JSON.stringify({ code: code.trim() }),
            });
            alert('–ö–æ–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ');
          } else if (action === 'reset-telegram') {
            if (!confirm('–°–∫–∏–Ω—É—Ç–∏ Telegram –ø—Ä–∏–≤ º—è–∑–∫—É?')) return;
            await apiCall(`/admin/users/${userId}/reset-telegram`, {
              method: 'POST',
            });
            alert('Telegram –ø—Ä–∏–≤ º—è–∑–∫—É –æ—á–∏—â–µ–Ω–æ');
          }

          await loadAdminUsers();
        } catch (error) {
          alert(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`);
        }
      });
    }

    async function loginWithToken(token) {
      const data = await apiCall('/auth/token-login', {
        method: 'POST',
        body: JSON.stringify({ token }),
      });
      currentUser = data;
      window.history.replaceState({}, document.title, window.location.pathname);
      await loadApp();
    }

    // ===== AUTO-LOAD ON SESSION =====
    (async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      if (token) {
        try {
          await loginWithToken(token);
          return;
        } catch (error) {
          showLogin();
          return;
        }
      }

      try {
        const user = await apiCall('/dashboard/me');
        currentUser = user;
        await loadApp();
      } catch (error) {
        showLogin();
      }
    })();
  </script>

</body>
</html>
